#!/bin/bash
###############################################################################
# ì™„ë²½í•œ í† ê¸€ ìŠ¤í¬ë¦½íŠ¸
# - ì •ìƒ ì‚¬ì´íŠ¸ â†” í•´í‚¹ ì‚¬ì´íŠ¸ ì „í™˜
# - ìºì‹œ ë¬¸ì œ ì—†ìŒ
# - ê¹”ë”í•œ ì „í™˜
###############################################################################

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

WWW_DIR="/var/www/html/www"
INDEX_FILE="$WWW_DIR/index.php"
BACKUP_NORMAL="/tmp/index_NORMAL.php"
BACKUP_HACKED="/tmp/index_HACKED.php"

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ì™„ë²½í•œ ì‚¬ì´íŠ¸ í† ê¸€ (ì •ìƒ â†” í•´í‚¹)                       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ë£¨íŠ¸ ê¶Œí•œ í™•ì¸
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}[-] root ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤${NC}"
    echo "ì‚¬ìš©ë²•: sudo bash $0"
    exit 1
fi

# ì²« ì‹¤í–‰: ë°±ì—… ìƒì„±
if [ ! -f "$BACKUP_NORMAL" ]; then
    echo -e "${YELLOW}[*] ì²« ì‹¤í–‰ - ì›ë³¸ ì‚¬ì´íŠ¸ ë°±ì—… ì¤‘...${NC}"

    # ì •ìƒ ì‚¬ì´íŠ¸ ë°±ì—…
    if [ -f "$INDEX_FILE" ]; then
        cp "$INDEX_FILE" "$BACKUP_NORMAL"
        echo -e "${GREEN}[+] ì •ìƒ ì‚¬ì´íŠ¸ ë°±ì—… ì™„ë£Œ${NC}"
    else
        echo -e "${RED}[-] index.phpë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤${NC}"
        exit 1
    fi

    # í•´í‚¹ í˜ì´ì§€ ìƒì„± ë° ë°±ì—…
    cat > "$BACKUP_HACKED" << 'EOFHACKED'
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYSTEM COMPROMISED</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            overflow-x: hidden;
        }
        #matrix {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 0;
            opacity: 0.3;
        }
        .container {
            position: relative;
            z-index: 1;
            text-align: center;
            padding: 2rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        h1 {
            font-size: clamp(2rem, 8vw, 5rem);
            color: #f00;
            text-shadow: 0 0 20px #f00, 0 0 40px #f00;
            margin: 1rem 0;
            animation: glitch 2s infinite;
        }
        .skull {
            font-size: clamp(3rem, 15vw, 8rem);
            animation: pulse 1s infinite;
            filter: drop-shadow(0 0 30px #f00);
        }
        .warning {
            font-size: clamp(1rem, 3vw, 1.5rem);
            color: #ff0;
            margin: 1rem 0;
            animation: blink 1s infinite;
        }
        .info-box {
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid #f00;
            border-radius: 10px;
            padding: 2rem;
            margin: 2rem auto;
            max-width: 900px;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
        }
        .attack-chain {
            text-align: left;
            line-height: 1.8;
        }
        .attack-chain li {
            margin: 0.5rem 0;
            list-style: none;
            padding-left: 1.5rem;
            position: relative;
        }
        .attack-chain li:before {
            content: "â†’";
            position: absolute;
            left: 0;
            color: #0f0;
        }
        @keyframes glitch {
            0%, 100% { transform: translate(0); }
            20% { transform: translate(-3px, 3px); }
            40% { transform: translate(-3px, -3px); }
            60% { transform: translate(3px, 3px); }
            80% { transform: translate(3px, -3px); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.05); }
        }
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0; }
        }
    </style>
</head>
<body>
    <canvas id="matrix"></canvas>
    <div class="container">
        <div class="skull">â˜ ï¸</div>
        <h1>âš ï¸ SYSTEM COMPROMISED âš ï¸</h1>
        <div class="warning">UNAUTHORIZED ACCESS DETECTED</div>

        <div class="info-box">
            <h2 style="color:#f00;margin-bottom:1rem;">ğŸ”´ ê³µê²© ì²´ì¸ (Attack Chain)</h2>
            <div class="attack-chain">
                <ul>
                    <li>ì™„ë²½í•œ ë³´ì•ˆ ì‹œìŠ¤í…œ (ModSecurity WAF + Splunk SIEM)</li>
                    <li>ì‘ì€ í‹ˆ ë°œê²¬: /api/health.php (ModSecurity ì˜ˆì™¸)</li>
                    <li>SSRF ì·¨ì•½ì  ì•…ìš©</li>
                    <li>AWS IMDSv1 ì ‘ê·¼ â†’ IAM Credentials íƒˆì·¨</li>
                    <li>AWS Systems Managerë¡œ ì„œë²„ ì ‘ê·¼</li>
                    <li>Root ê¶Œí•œ íšë“</li>
                    <li>ì›¹ì‚¬ì´íŠ¸ ë³€ì¡° ì™„ë£Œ</li>
                </ul>
            </div>
            <div style="margin-top:2rem;font-size:0.9rem;">
                <strong style="color:#0f0;">í•µì‹¬ êµí›ˆ:</strong><br>
                Perfect Security + One Small Gap = Total Compromise
            </div>
        </div>

        <div style="margin-top:2rem;color:#666;font-size:0.8rem;">
            <p>Compromised at: <?php echo date('Y-m-d H:i:s'); ?> UTC</p>
            <p>Server: <?php echo gethostname(); ?></p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('matrix');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789ã‚¢ã‚¤ã‚¦ã‚¨ã‚ª';
        const fontSize = 14;
        const columns = canvas.width / fontSize;
        const drops = [];
        for (let i = 0; i < columns; i++) drops[i] = Math.random() * canvas.height / fontSize;
        function draw() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#0f0';
            ctx.font = fontSize + 'px monospace';
            for (let i = 0; i < drops.length; i++) {
                const char = chars[Math.floor(Math.random() * chars.length)];
                ctx.fillText(char, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.95) drops[i] = 0;
                drops[i]++;
            }
        }
        setInterval(draw, 33);
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
</body>
</html>
EOFHACKED

    echo -e "${GREEN}[+] í•´í‚¹ í˜ì´ì§€ ë°±ì—… ìƒì„± ì™„ë£Œ${NC}"
    echo ""
fi

# í˜„ì¬ ìƒíƒœ í™•ì¸ (íŒŒì¼ ë‚´ìš©ìœ¼ë¡œ íŒë‹¨)
if grep -q "SYSTEM COMPROMISED" "$INDEX_FILE" 2>/dev/null; then
    CURRENT_STATE="HACKED"
else
    CURRENT_STATE="NORMAL"
fi

echo -e "${CYAN}[*] í˜„ì¬ ìƒíƒœ: $CURRENT_STATE${NC}"
echo ""

# í† ê¸€
if [ "$CURRENT_STATE" = "HACKED" ]; then
    # ì •ìƒìœ¼ë¡œ ë³µêµ¬
    echo -e "${YELLOW}[â†’] ì •ìƒ ì‚¬ì´íŠ¸ë¡œ ë³µêµ¬ ì¤‘...${NC}"
    cp "$BACKUP_NORMAL" "$INDEX_FILE"
    chown apache:apache "$INDEX_FILE"
    chmod 644 "$INDEX_FILE"
    systemctl restart httpd

    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘   âœ… ì •ìƒ ì‚¬ì´íŠ¸ë¡œ ë³µêµ¬ ì™„ë£Œ!                             â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo "YOUR_SERVER_IP")
    echo -e "${GREEN}[+] ì‚¬ì´íŠ¸ í™•ì¸: http://$IP${NC}"
    echo -e "${YELLOW}[*] Ctrl+F5ë¡œ ìºì‹œ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”${NC}"

else
    # í•´í‚¹ ëª¨ë“œë¡œ ì „í™˜
    echo -e "${YELLOW}[â†’] í•´í‚¹ ì‚¬ì´íŠ¸ë¡œ ì „í™˜ ì¤‘...${NC}"
    cp "$BACKUP_HACKED" "$INDEX_FILE"
    chown apache:apache "$INDEX_FILE"
    chmod 644 "$INDEX_FILE"
    systemctl restart httpd

    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘   âš ï¸  í•´í‚¹ ì‚¬ì´íŠ¸ë¡œ ì „í™˜ ì™„ë£Œ!                            â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo "YOUR_SERVER_IP")
    echo -e "${RED}[+] í•´í‚¹ ì‚¬ì´íŠ¸ í™•ì¸: http://$IP${NC}"
    echo -e "${YELLOW}[*] Ctrl+F5ë¡œ ìºì‹œ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”${NC}"
fi

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}ë‹¤ì‹œ í† ê¸€í•˜ë ¤ë©´: sudo bash $0${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
