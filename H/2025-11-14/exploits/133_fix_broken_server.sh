#!/bin/bash
###############################################################################
# 망가진 서버 수리 스크립트
# 스크립트 실행 후 서버가 응답하지 않을 때 사용
###############################################################################

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   망가진 서버 긴급 수리                                   ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}[-] root 권한이 필요합니다${NC}"
    echo "sudo bash $0"
    exit 1
fi

# 1. 에러 로그 확인
echo -e "${YELLOW}[1] 최근 에러 로그 확인 중...${NC}"
echo ""
tail -20 /var/log/httpd/error_log
echo ""

# 2. .htaccess 제거
echo -e "${YELLOW}[2] .htaccess 파일 제거 중...${NC}"
find /var/www/html -name ".htaccess" -type f -exec rm -v {} \;
echo -e "${GREEN}[+] .htaccess 제거 완료${NC}"
echo ""

# 3. 백업 파일 복구
echo -e "${YELLOW}[3] 백업 파일 복구 중...${NC}"
find /var/www/html/www -name "*.backup" -type f | while read backup; do
    original="${backup%.backup}"
    if [ -f "$backup" ]; then
        cp "$backup" "$original"
        echo -e "${GREEN}[+] 복구: $(basename $original)${NC}"
    fi
done
echo ""

# 4. 의심스러운 PHP 파일 제거
echo -e "${YELLOW}[4] 악성 파일 제거 중...${NC}"
rm -f /var/www/html/www/system.php
rm -f /var/www/html/www/cmd.php
rm -f /var/www/html/www/.system.php
rm -rf /var/www/html/www/downloads/
echo -e "${GREEN}[+] 악성 파일 제거 완료${NC}"
echo ""

# 5. Apache 설정 검사
echo -e "${YELLOW}[5] Apache 설정 검사 중...${NC}"
httpd -t 2>&1 | tee /tmp/httpd_syntax.log
echo ""

if grep -q "Syntax OK" /tmp/httpd_syntax.log; then
    echo -e "${GREEN}[+] Apache 설정 문법 OK${NC}"
else
    echo -e "${RED}[-] Apache 설정 오류!${NC}"
    cat /tmp/httpd_syntax.log
fi
echo ""

# 6. 파일 권한 수정
echo -e "${YELLOW}[6] 파일 권한 복구 중...${NC}"
chown -R apache:apache /var/www/html/
find /var/www/html/ -type f -exec chmod 644 {} \;
find /var/www/html/ -type d -exec chmod 755 {} \;
echo -e "${GREEN}[+] 권한 복구 완료${NC}"
echo ""

# 7. Apache 재시작
echo -e "${YELLOW}[7] Apache 강제 재시작 중...${NC}"
systemctl stop httpd
sleep 2
killall httpd 2>/dev/null
sleep 1
systemctl start httpd
sleep 2

if systemctl is-active --quiet httpd; then
    echo -e "${GREEN}[+] ✅ Apache 시작 성공!${NC}"
else
    echo -e "${RED}[-] Apache 시작 실패!${NC}"
    echo ""
    echo -e "${YELLOW}[*] 에러 로그:${NC}"
    tail -30 /var/log/httpd/error_log
fi
echo ""

# 8. localhost 테스트
echo -e "${YELLOW}[8] localhost 테스트 중...${NC}"
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/ 2>&1)
echo "HTTP Status: $RESPONSE"

if [ "$RESPONSE" = "200" ]; then
    echo -e "${GREEN}[+] ✅ localhost 정상 응답!${NC}"
else
    echo -e "${RED}[-] localhost 응답 없음 (HTTP $RESPONSE)${NC}"
fi
echo ""

# 9. Public IP 확인
echo -e "${YELLOW}[9] Public IP 확인 중...${NC}"
PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)
echo "Public IP: $PUBLIC_IP"
echo ""

# 10. 방화벽 확인
echo -e "${YELLOW}[10] 방화벽 확인 중...${NC}"
iptables -L -n | grep -E "(80|DROP|REJECT)" || echo "방화벽 규칙 없음"
echo ""

# 11. 포트 확인
echo -e "${YELLOW}[11] 포트 80 Listen 확인 중...${NC}"
netstat -tlnp | grep :80 || echo "포트 80 Listen 안함!"
echo ""

# 완료
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   ✅ 복구 작업 완료!                                      ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""
echo -e "${GREEN}[+] 서버 상태 요약:${NC}"
systemctl status httpd --no-pager -l | head -10
echo ""
echo -e "${YELLOW}[*] 외부 접속 테스트:${NC}"
echo "    로컬: curl http://localhost/"
echo "    외부: curl http://$PUBLIC_IP/"
echo ""
echo -e "${YELLOW}[*] 만약 외부 접속이 안되면:${NC}"
echo "    1. AWS Security Group에서 80번 포트 확인"
echo "    2. Public IP가 맞는지 확인"
echo "    3. iptables 확인"
echo ""
