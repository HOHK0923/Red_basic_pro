#!/usr/bin/env python3
"""
로그인 테스트 스크립트 - 실제 로그인 페이지 구조 확인
"""

import requests
from bs4 import BeautifulSoup
import sys

def test_login(target_ip="43.201.154.142"):
    base_url = f"http://{target_ip}"
    login_url = f"{base_url}/login.php"

    print(f"[*] 타겟: {target_ip}")
    print(f"[*] 로그인 URL: {login_url}\n")

    session = requests.Session()

    # 1. 로그인 페이지 GET 요청
    print("[1] 로그인 페이지 GET 요청...")
    try:
        response = session.get(login_url, timeout=10)
        print(f"    Status Code: {response.status_code}")
        print(f"    URL: {response.url}")

        if response.status_code != 200:
            print(f"[-] 로그인 페이지 접근 실패!")
            return

    except Exception as e:
        print(f"[-] 오류: {str(e)}")
        return

    # 2. HTML 파싱
    print("\n[2] 로그인 폼 분석...")
    soup = BeautifulSoup(response.text, 'html.parser')

    # 폼 찾기
    form = soup.find('form')
    if form:
        print(f"    Form Action: {form.get('action', 'N/A')}")
        print(f"    Form Method: {form.get('method', 'N/A')}")

        # Input 필드 찾기
        inputs = form.find_all('input')
        print(f"\n    Input 필드:")
        for inp in inputs:
            name = inp.get('name', 'N/A')
            type_ = inp.get('type', 'N/A')
            value = inp.get('value', '')
            print(f"      - name='{name}', type='{type_}', value='{value}'")
    else:
        print("    [-] Form을 찾을 수 없습니다!")
        print("\n    HTML 일부:")
        print(response.text[:1000])

    # 3. 로그인 시도
    print("\n[3] 로그인 시도 (alice / alice2024)...")

    data = {
        'username': 'alice',
        'password': 'alice2024'
    }

    headers = {
        'Content-Type': 'application/x-www-form-urlencoded',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        'Origin': base_url,
        'Referer': login_url
    }

    try:
        response = session.post(login_url, data=data, headers=headers,
                               allow_redirects=True, timeout=15)

        print(f"    Status Code: {response.status_code}")
        print(f"    최종 URL: {response.url}")
        print(f"    Cookies: {dict(session.cookies)}")

        # 성공 여부 확인
        if 'login.php' in response.url:
            print("\n[-] 로그인 실패 - 여전히 login.php에 있음")

            # 에러 메시지 확인
            error_div = soup.find('div', class_='error')
            if error_div:
                print(f"    에러 메시지: {error_div.get_text(strip=True)}")

            # 응답 일부 출력
            print("\n    응답 HTML 일부:")
            print(response.text[:500])

        else:
            print("\n[+] 로그인 성공!")

            # 로그아웃 버튼 확인
            if 'logout' in response.text.lower() or '로그아웃' in response.text:
                print("    [+] 로그아웃 버튼 발견")

            # 응답 일부 출력
            print("\n    응답 HTML 일부:")
            print(response.text[:500])

    except Exception as e:
        print(f"[-] 로그인 오류: {str(e)}")


if __name__ == "__main__":
    if len(sys.argv) > 1:
        target_ip = sys.argv[1]
    else:
        target_ip = input("타겟 IP (기본: 43.201.154.142): ").strip() or "43.201.154.142"

    test_login(target_ip)
