#!/bin/bash
###############################################################################
# 빠른 진단 스크립트 - 서버가 왜 응답 안하는지 확인
###############################################################################

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   빠른 진단 - 서버 문제 원인 파악                        ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 1. Apache 상태
echo -e "${YELLOW}[1] Apache 프로세스 상태:${NC}"
systemctl status httpd --no-pager | head -10
echo ""

# 2. 포트 확인
echo -e "${YELLOW}[2] 포트 80 상태:${NC}"
netstat -tlnp | grep :80
echo ""

# 3. localhost 테스트
echo -e "${YELLOW}[3] localhost 응답 테스트:${NC}"
curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost/ 2>&1
echo ""

# 4. .htaccess 파일 확인
echo -e "${YELLOW}[4] .htaccess 파일 위치:${NC}"
find /var/www/html -name ".htaccess" -type f -exec ls -lh {} \;
echo ""

# 5. 최근 Apache 에러 로그
echo -e "${YELLOW}[5] 최근 Apache 에러:${NC}"
tail -20 /var/log/httpd/error_log
echo ""

# 6. Public IP 확인
echo -e "${YELLOW}[6] 서버 Public IP:${NC}"
PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null)
echo "Public IP: $PUBLIC_IP"
echo ""

# 7. 방화벽 규칙
echo -e "${YELLOW}[7] iptables 규칙:${NC}"
iptables -L -n | grep -E "(80|DROP|REJECT)" || echo "특별한 규칙 없음"
echo ""

# 8. Apache 설정 문법 검사
echo -e "${YELLOW}[8] Apache 설정 문법:${NC}"
httpd -t 2>&1
echo ""

# 9. 주요 파일 존재 여부
echo -e "${YELLOW}[9] 주요 파일 확인:${NC}"
ls -lh /var/www/html/www/index.php 2>&1
ls -lh /var/www/html/www/.htaccess 2>&1
echo ""

# 10. 간단한 해결책 제시
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   진단 결과 분석                                          ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

if curl -s http://localhost/ > /dev/null 2>&1; then
    echo -e "${GREEN}[+] localhost는 정상 응답 중${NC}"
    echo -e "${YELLOW}[*] 문제: 외부 접속 차단 (AWS Security Group 또는 방화벽)${NC}"
    echo "    해결책: AWS Console에서 Security Group 확인"
else
    echo -e "${RED}[-] localhost도 응답 없음${NC}"
    echo -e "${YELLOW}[*] 문제: Apache 설정 오류 (아마도 .htaccess)${NC}"
    echo "    해결책: 133_fix_broken_server.sh 실행"
fi
echo ""

echo -e "${YELLOW}[*] 빠른 수동 복구 명령어:${NC}"
echo "    # .htaccess 제거"
echo "    sudo rm -f /var/www/html/www/.htaccess"
echo "    sudo rm -f /var/www/html/.htaccess"
echo ""
echo "    # Apache 재시작"
echo "    sudo systemctl restart httpd"
echo ""
