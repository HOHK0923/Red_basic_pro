#!/bin/bash
###############################################################################
# 긴급 복구 스크립트
# 공격으로 인해 서버가 다운되었을 때 실행
###############################################################################

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   긴급 복구 - 서버 살리기                                 ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}[-] root 권한이 필요합니다${NC}"
    exit 1
fi

# 1. 웹 파일 복구
echo -e "${YELLOW}[1] 웹 파일 복구 중...${NC}"

if [ -f /var/www/html/www/index.php.backup ]; then
    cp /var/www/html/www/index.php.backup /var/www/html/www/index.php
    echo -e "${GREEN}[+] index.php 복구${NC}"
fi

# 모든 백업 파일 복구
find /var/www/html/www -name "*.backup" | while read file; do
    original="${file%.backup}"
    cp "$file" "$original"
    echo -e "${GREEN}[+] 복구: $(basename $original)${NC}"
done

# 2. .htaccess 제거
echo -e "${YELLOW}[2] .htaccess 제거 중...${NC}"
rm -f /var/www/html/www/.htaccess
rm -f /var/www/html/.htaccess
echo -e "${GREEN}[+] .htaccess 제거 완료${NC}"

# 3. 악성 파일 제거
echo -e "${YELLOW}[3] 악성 파일 제거 중...${NC}"
rm -rf /var/www/html/www/downloads/
rm -f /var/www/html/www/.system.php
rm -f /var/www/html/www/system.php
rm -f /var/www/html/www/cmd.php
echo -e "${GREEN}[+] 악성 파일 제거 완료${NC}"

# 4. Apache 설정 복구
echo -e "${YELLOW}[4] Apache 설정 확인 중...${NC}"

# httpd.conf 문법 검사
httpd -t 2>&1 | tee /tmp/httpd_test.log

if grep -q "Syntax OK" /tmp/httpd_test.log; then
    echo -e "${GREEN}[+] Apache 설정 OK${NC}"
else
    echo -e "${RED}[-] Apache 설정 오류 발견${NC}"
    cat /tmp/httpd_test.log
fi

# 5. ModSecurity 설정 복구 (예외 제거)
echo -e "${YELLOW}[5] ModSecurity 설정 복구 중...${NC}"

if [ -f /etc/httpd/conf.d/modsecurity.conf ]; then
    # 백업
    cp /etc/httpd/conf.d/modsecurity.conf /etc/httpd/conf.d/modsecurity.conf.backup

    # 예외 제거 (주석 처리)
    sed -i 's/^<LocationMatch "\/api\/health\.php">/#<LocationMatch "\/api\/health\.php">/g' /etc/httpd/conf.d/modsecurity.conf
    sed -i 's/^    SecRuleEngine Off/#    SecRuleEngine Off/g' /etc/httpd/conf.d/modsecurity.conf
    sed -i 's/^<\/LocationMatch>/#<\/LocationMatch>/g' /etc/httpd/conf.d/modsecurity.conf

    echo -e "${GREEN}[+] ModSecurity 예외 제거${NC}"
fi

# 6. 파일 권한 복구
echo -e "${YELLOW}[6] 파일 권한 복구 중...${NC}"
chown -R apache:apache /var/www/html/
find /var/www/html/ -type f -exec chmod 644 {} \;
find /var/www/html/ -type d -exec chmod 755 {} \;
echo -e "${GREEN}[+] 권한 복구 완료${NC}"

# 7. Apache 재시작
echo -e "${YELLOW}[7] Apache 재시작 중...${NC}"
systemctl stop httpd
sleep 2
systemctl start httpd
sleep 2

if systemctl is-active --quiet httpd; then
    echo -e "${GREEN}[+] ✅ Apache 정상 작동!${NC}"
else
    echo -e "${RED}[-] Apache 시작 실패${NC}"
    echo -e "${YELLOW}[*] 로그 확인:${NC}"
    tail -20 /var/log/httpd/error_log

    # 강제 재시작
    echo -e "${YELLOW}[*] 강제 재시작 시도...${NC}"
    killall httpd 2>/dev/null
    sleep 2
    systemctl start httpd
fi

# 8. 웹서버 테스트
echo -e "${YELLOW}[8] 웹서버 테스트 중...${NC}"
curl -s http://localhost/ > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo -e "${GREEN}[+] ✅ 웹서버 정상 응답${NC}"
else
    echo -e "${RED}[-] 웹서버 응답 없음${NC}"
fi

# 9. 백도어 사용자 제거
echo -e "${YELLOW}[9] 백도어 사용자 제거 중...${NC}"
userdel -r sysadmin 2>/dev/null && echo -e "${GREEN}[+] sysadmin 삭제${NC}"
userdel -r hacker 2>/dev/null && echo -e "${GREEN}[+] hacker 삭제${NC}"
rm -f /etc/sudoers.d/sysadmin
rm -f /etc/sudoers.d/hacker

echo ""
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   ✅ 긴급 복구 완료!                                      ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""
echo -e "${GREEN}[+] 서버 상태:${NC}"
systemctl status httpd --no-pager | head -5
echo ""
echo -e "${YELLOW}[*] 외부 접속 테스트:${NC}"
PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null)
if [ -n "$PUBLIC_IP" ]; then
    echo "    curl http://$PUBLIC_IP/"
else
    echo "    curl http://$(hostname -I | awk '{print $1}')/"
fi
echo ""
