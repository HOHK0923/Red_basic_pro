#!/bin/bash
###############################################################################
# 깔끔한 복구 스크립트
# - 백업된 원본 사이트로 완벽하게 복구
# - 캐시 문제 없음
###############################################################################

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

WWW_DIR="/var/www/html/www"

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   원본 사이트 완벽 복구                                   ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

# 루트 권한 확인
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}[-] root 권한이 필요합니다${NC}"
    echo "사용법: sudo bash $0"
    exit 1
fi

# 백업 경로 찾기
if [ -f /tmp/last_backup_path.txt ]; then
    BACKUP_DIR=$(cat /tmp/last_backup_path.txt)
    echo -e "${GREEN}[+] 백업 위치 발견: $BACKUP_DIR${NC}"
else
    # 최신 백업 찾기
    BACKUP_DIR=$(ls -td /tmp/site_backup_* 2>/dev/null | head -1)
    if [ -z "$BACKUP_DIR" ]; then
        echo -e "${RED}[-] 백업을 찾을 수 없습니다${NC}"
        exit 1
    fi
    echo -e "${YELLOW}[*] 최신 백업 사용: $BACKUP_DIR${NC}"
fi

# 1. 현재 파일 삭제 (깔끔하게)
echo ""
echo -e "${YELLOW}[1] 현재 파일 삭제 중...${NC}"
rm -rf $WWW_DIR/*
echo -e "${GREEN}[+] 완료${NC}"

# 2. 백업 복구
echo ""
echo -e "${YELLOW}[2] 백업 파일 복구 중...${NC}"
cp -r $BACKUP_DIR/* $WWW_DIR/
echo -e "${GREEN}[+] 완료${NC}"

# 3. 권한 설정
echo ""
echo -e "${YELLOW}[3] 권한 설정 중...${NC}"
chown -R apache:apache $WWW_DIR
find $WWW_DIR -type f -exec chmod 644 {} \;
find $WWW_DIR -type d -exec chmod 755 {} \;
echo -e "${GREEN}[+] 완료${NC}"

# 4. Apache 재시작 (캐시 제거)
echo ""
echo -e "${YELLOW}[4] Apache 재시작 중...${NC}"
systemctl restart httpd
sleep 2
echo -e "${GREEN}[+] 완료${NC}"

# 5. 완료
echo ""
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   ✅ 원본 사이트 복구 완료!                               ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""
IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo "YOUR_SERVER_IP")
echo -e "${GREEN}[+] 복구된 사이트 확인:${NC}"
echo "    http://$IP"
echo ""
echo -e "${YELLOW}[*] 팁:${NC}"
echo "    • 브라우저에서 Ctrl+F5 (캐시 새로고침)"
echo "    • 또는 시크릿 모드로 접속"
echo ""
