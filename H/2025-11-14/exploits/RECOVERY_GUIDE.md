# ì‹œìŠ¤í…œ ë³µêµ¬ ê°€ì´ë“œ

## ğŸš¨ ê°œìš”

ì´ ë¬¸ì„œëŠ” í•´í‚¹ëœ ì„œë²„ë¥¼ ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

**ì¤‘ìš”:** ì‹¤ì œ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ì „ì²´ ì‹œìŠ¤í…œì„ ì¬ì„¤ì¹˜í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤. ì´ ê°€ì´ë“œëŠ” êµìœ¡/í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ ìœ„í•œ ê²ƒì…ë‹ˆë‹¤.

---

## ğŸ“‹ ë³µêµ¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ì›¹ì‚¬ì´íŠ¸ ì›ë³¸ ë³µêµ¬
- [ ] ë°±ë„ì–´ ì›¹ì‰˜ ì œê±°
- [ ] ë°±ë„ì–´ ì‚¬ìš©ì ê³„ì • ì œê±°
- [ ] SSH authorized_keys ì •ë¦¬
- [ ] sudoers ì„¤ì • ë³µêµ¬
- [ ] ë‹¤ìš´ë¡œë“œ íŒŒì¼ ì œê±°
- [ ] ModSecurity ì„¤ì • ë³µêµ¬
- [ ] Apache ë¡œê·¸ í™•ì¸
- [ ] IMDSv2 ê°•ì œ ì„¤ì •
- [ ] ë³´ì•ˆ ê°ì‚¬ ì‹¤í–‰

---

## ğŸ”§ ì¦‰ì‹œ ë³µêµ¬ (Quick Recovery)

### ì„œë²„ì— SSH ì ‘ì†

```bash
ssh ec2-user@<SERVER_IP>
# ë˜ëŠ” ë£¨íŠ¸ë¡œ
ssh root@<SERVER_IP>
```

### 1ë‹¨ê³„: ì›¹ì‚¬ì´íŠ¸ ì›ë³¸ ë³µêµ¬

```bash
# ì›ë³¸ ë°±ì—…ì´ ìˆëŠ” ê²½ìš°
sudo cp /var/www/html/www/index.php.original /var/www/html/www/index.php

# ì—†ëŠ” ê²½ìš° - ê¸°ë³¸ í˜ì´ì§€ ìƒì„±
sudo bash -c 'cat > /var/www/html/www/index.php << "EOF"
<!DOCTYPE html>
<html>
<head>
    <title>Welcome</title>
</head>
<body>
    <h1>Website Restored</h1>
    <p>The website has been recovered.</p>
</body>
</html>
EOF'

sudo chown apache:apache /var/www/html/www/index.php
sudo chmod 644 /var/www/html/www/index.php
```

### 2ë‹¨ê³„: ë°±ë„ì–´ ì›¹ì‰˜ ì œê±°

```bash
# ëª¨ë“  ì˜ì‹¬ìŠ¤ëŸ¬ìš´ PHP íŒŒì¼ ì œê±°
sudo rm -f /var/www/html/www/.system.php
sudo rm -f /var/www/html/www/system.php
sudo rm -f /var/www/html/www/cmd.php
sudo rm -f /var/www/html/www/api/system.php

# health.php ì›ë³¸ ë³µêµ¬ (SSRF ì·¨ì•½ì  ì œê±°)
sudo bash -c 'cat > /var/www/html/www/api/health.php << "EOF"
<?php
header("Content-Type: application/json");
echo json_encode([
    "status" => "ok",
    "timestamp" => time(),
    "server" => gethostname()
]);
?>
EOF'
```

### 3ë‹¨ê³„: ë°±ë„ì–´ ì‚¬ìš©ì ì œê±°

```bash
# ë°±ë„ì–´ ì‚¬ìš©ì í™•ì¸
sudo cat /etc/passwd | grep -E "(hacker|sysadmin|backdoor)"

# ë°±ë„ì–´ ì‚¬ìš©ì ì‚­ì œ
sudo userdel -r hacker 2>/dev/null
sudo userdel -r sysadmin 2>/dev/null

# sudoers íŒŒì¼ ì •ë¦¬
sudo rm -f /etc/sudoers.d/hacker
sudo rm -f /etc/sudoers.d/sysadmin
sudo rm -f /etc/sudoers.d/.sysadmin
```

### 4ë‹¨ê³„: SSH í‚¤ ì •ë¦¬

```bash
# ëª¨ë“  ì‚¬ìš©ìì˜ authorized_keys í™•ì¸
sudo find /home -name authorized_keys -exec ls -la {} \;
sudo find /root -name authorized_keys -exec ls -la {} \;

# ì˜ì‹¬ìŠ¤ëŸ¬ìš´ SSH í‚¤ ì œê±°
# ec2-userì˜ authorized_keys ë°±ì—…
sudo cp /home/ec2-user/.ssh/authorized_keys /home/ec2-user/.ssh/authorized_keys.backup

# ê³µê²©ìê°€ ì¶”ê°€í•œ í‚¤ ì œê±° (ìˆ˜ë™ìœ¼ë¡œ í™•ì¸ í›„ ì‚­ì œ)
sudo vim /home/ec2-user/.ssh/authorized_keys

# ë˜ëŠ” ì™„ì „íˆ ìƒˆë¡œ ì„¤ì •
# (ì£¼ì˜: ìì‹ ì˜ SSH í‚¤ë¥¼ í™•ì¸ í›„ ì§„í–‰!)
```

### 5ë‹¨ê³„: ë‹¤ìš´ë¡œë“œ íŒŒì¼ ì œê±°

```bash
# ì•…ì„± ë‹¤ìš´ë¡œë“œ íŒŒì¼ ì œê±°
sudo rm -rf /var/www/html/www/downloads/

# Apache ë¡œê·¸ì—ì„œ ë‹¤ìš´ë¡œë“œ ê¸°ë¡ í™•ì¸
sudo grep "downloads/" /var/log/httpd/access_log | tail -20
```

---

## ğŸ”’ ë³´ì•ˆ ê°•í™” (Security Hardening)

### 1. IMDSv2 ê°•ì œ ì„¤ì •

```bash
# AWS CLIë¡œ (ë¡œì»¬ì—ì„œ ì‹¤í–‰)
aws ec2 modify-instance-metadata-options \
    --instance-id i-xxxxxxxxx \
    --http-tokens required \
    --http-endpoint enabled \
    --region ap-northeast-2

# í™•ì¸
aws ec2 describe-instances \
    --instance-ids i-xxxxxxxxx \
    --region ap-northeast-2 \
    --query 'Reservations[0].Instances[0].MetadataOptions'
```

### 2. ModSecurity ì˜ˆì™¸ ìµœì†Œí™”

```bash
# í˜„ì¬ ì˜ˆì™¸ í™•ì¸
sudo grep -r "SecRuleEngine Off" /etc/httpd/conf.d/

# health.php ì˜ˆì™¸ ì œê±° (ë˜ëŠ” ì œí•œ)
sudo vim /etc/httpd/conf.d/modsecurity.conf

# ë‹¤ìŒ ì„¹ì…˜ì„ ì£¼ì„ ì²˜ë¦¬í•˜ê±°ë‚˜ ì‚­ì œ:
# <LocationMatch "/api/health\.php">
#     SecRuleEngine Off
# </LocationMatch>

# ëŒ€ì‹  íŠ¹ì • ê·œì¹™ë§Œ ë¹„í™œì„±í™”:
<LocationMatch "/api/health\.php">
    SecRuleRemoveById 950109  # íŠ¹ì • false positiveë§Œ
</LocationMatch>

# Apache ì¬ì‹œì‘
sudo systemctl restart httpd
```

### 3. PHP ë³´ì•ˆ ê°•í™”

```bash
# disable_functions í™•ì¸
php -i | grep disable_functions

# í•„ìš”ì‹œ ì¶”ê°€ ì œí•œ
sudo vim /etc/php.ini

# ë‹¤ìŒ í•¨ìˆ˜ë“¤ì´ ì°¨ë‹¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸:
# disable_functions = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source
```

### 4. íŒŒì¼ ê¶Œí•œ ì •ë¦¬

```bash
# ì›¹ ë””ë ‰í„°ë¦¬ ê¶Œí•œ ì¬ì„¤ì •
sudo chown -R apache:apache /var/www/html/
sudo find /var/www/html/ -type f -exec chmod 644 {} \;
sudo find /var/www/html/ -type d -exec chmod 755 {} \;

# ìˆ¨ê¹€ íŒŒì¼ ì œê±°
sudo find /var/www/html/ -name ".*" -type f -delete
```

---

## ğŸ” í¬ë Œì‹ ë¶„ì„ (Forensics)

### ê³µê²© í”ì  í™•ì¸

```bash
# 1. Apache ì ‘ê·¼ ë¡œê·¸
sudo tail -100 /var/log/httpd/access_log | grep -E "(health.php|metadata|169.254)"

# 2. ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ê¸°ë¡
sudo last -20
sudo lastlog

# 3. ìµœê·¼ ìƒì„±ëœ íŒŒì¼
sudo find /var/www/html/ -type f -mtime -7 -ls

# 4. ìµœê·¼ ìƒì„±ëœ ì‚¬ìš©ì
sudo cat /etc/passwd | awk -F: '$3 >= 1000 {print $1, $3, $6}'

# 5. sudoers íŒŒì¼ í™•ì¸
sudo ls -la /etc/sudoers.d/

# 6. SSH ë¡œê·¸
sudo grep -i "accepted" /var/log/secure | tail -20

# 7. ì‹¤í–‰ ì¤‘ì¸ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í”„ë¡œì„¸ìŠ¤
ps aux | grep -E "(nc|ncat|socat|python|perl)" | grep -v grep
```

### ê³µê²© íƒ€ì„ë¼ì¸ ì¬êµ¬ì„±

```bash
# ëª¨ë“  ê´€ë ¨ ë¡œê·¸ë¥¼ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬
sudo grep -E "(health.php|169.254|hacker|sysadmin)" \
    /var/log/httpd/access_log \
    /var/log/secure \
    /var/log/messages \
    | sort
```

---

## ğŸ“ ìë™ ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸

### ì™„ì „ ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
###############################################################################
# ìë™ ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸
# ì„œë²„ì—ì„œ root ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰
###############################################################################

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ì‹œìŠ¤í…œ ë³µêµ¬ ì‹œì‘                                        â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ë£¨íŠ¸ ê¶Œí•œ í™•ì¸
if [ "$EUID" -ne 0 ]; then
    echo "[-] root ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤"
    exit 1
fi

echo "[1] ì›¹ì‚¬ì´íŠ¸ ì›ë³¸ ë³µêµ¬ ì¤‘..."
if [ -f /var/www/html/www/index.php.original ]; then
    cp /var/www/html/www/index.php.original /var/www/html/www/index.php
    echo "[+] ì›ë³¸ ë³µêµ¬ ì™„ë£Œ"
else
    echo "[-] ì›ë³¸ ë°±ì—… ì—†ìŒ"
fi

echo "[2] ë°±ë„ì–´ ì›¹ì‰˜ ì œê±° ì¤‘..."
rm -f /var/www/html/www/.system.php
rm -f /var/www/html/www/system.php
rm -f /var/www/html/www/cmd.php
rm -f /var/www/html/www/api/system.php
echo "[+] ì›¹ì‰˜ ì œê±° ì™„ë£Œ"

echo "[3] ë°±ë„ì–´ ì‚¬ìš©ì ì œê±° ì¤‘..."
userdel -r hacker 2>/dev/null
userdel -r sysadmin 2>/dev/null
userdel -r .sysadmin 2>/dev/null
rm -f /etc/sudoers.d/hacker
rm -f /etc/sudoers.d/sysadmin
rm -f /etc/sudoers.d/.sysadmin
echo "[+] ë°±ë„ì–´ ì‚¬ìš©ì ì œê±° ì™„ë£Œ"

echo "[4] ì•…ì„± ë‹¤ìš´ë¡œë“œ íŒŒì¼ ì œê±° ì¤‘..."
rm -rf /var/www/html/www/downloads/
echo "[+] ë‹¤ìš´ë¡œë“œ íŒŒì¼ ì œê±° ì™„ë£Œ"

echo "[5] health.php ì›ë³¸ ë³µêµ¬ ì¤‘..."
cat > /var/www/html/www/api/health.php << 'EOF'
<?php
header('Content-Type: application/json');
echo json_encode([
    'status' => 'ok',
    'timestamp' => time(),
    'server' => gethostname()
]);
?>
EOF
echo "[+] health.php ë³µêµ¬ ì™„ë£Œ"

echo "[6] íŒŒì¼ ê¶Œí•œ ì¬ì„¤ì • ì¤‘..."
chown -R apache:apache /var/www/html/
find /var/www/html/ -type f -exec chmod 644 {} \;
find /var/www/html/ -type d -exec chmod 755 {} \;
echo "[+] ê¶Œí•œ ì¬ì„¤ì • ì™„ë£Œ"

echo "[7] Apache ì¬ì‹œì‘ ì¤‘..."
systemctl restart httpd
echo "[+] Apache ì¬ì‹œì‘ ì™„ë£Œ"

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   âœ… ë³µêµ¬ ì™„ë£Œ!                                           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "[!] ì¶”ê°€ ì‘ì—… í•„ìš”:"
echo "    1. IMDSv2 ê°•ì œ ì„¤ì • (AWS Console)"
echo "    2. ModSecurity ì˜ˆì™¸ ìµœì†Œí™”"
echo "    3. SSH authorized_keys í™•ì¸"
echo "    4. ì „ì²´ ë³´ì•ˆ ê°ì‚¬ ì‹¤í–‰"
echo ""
```

ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ `recovery.sh`ë¡œ ì €ì¥í•˜ê³  ì„œë²„ì—ì„œ ì‹¤í–‰:

```bash
sudo bash recovery.sh
```

---

## âš ï¸ ì‚¬í›„ ì¡°ì¹˜

### 1. ì „ì²´ ì‹œìŠ¤í…œ ì ê²€

```bash
# ë³´ì•ˆ ìŠ¤ìº” ë„êµ¬ ì‹¤í–‰
sudo yum install rkhunter -y
sudo rkhunter --update
sudo rkhunter --check

# ë˜ëŠ” ClamAV
sudo yum install clamav clamav-update -y
sudo freshclam
sudo clamscan -r /var/www/html/
```

### 2. ë¡œê·¸ ë°±ì—…

```bash
# í¬ë Œì‹ìš© ë¡œê·¸ ë°±ì—…
sudo mkdir -p /root/incident_logs_$(date +%Y%m%d)
sudo cp /var/log/httpd/access_log /root/incident_logs_$(date +%Y%m%d)/
sudo cp /var/log/httpd/error_log /root/incident_logs_$(date +%Y%m%d)/
sudo cp /var/log/secure /root/incident_logs_$(date +%Y%m%d)/
sudo tar -czf incident_logs_$(date +%Y%m%d).tar.gz /root/incident_logs_$(date +%Y%m%d)/
```

### 3. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½

```bash
# ëª¨ë“  ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
sudo passwd ec2-user
sudo passwd root
```

### 4. AWS ìê²© ì¦ëª… íšŒì „

```bash
# AWS Consoleì—ì„œ:
# 1. IAM Roleì˜ ì •ì±… ê²€í† 
# 2. CloudTrail ë¡œê·¸ í™•ì¸
# 3. ì˜ì‹¬ìŠ¤ëŸ¬ìš´ API í˜¸ì¶œ í™•ì¸
# 4. í•„ìš”ì‹œ ì„ì‹œ ìê²© ì¦ëª… ë¬´íš¨í™”
```

---

## ğŸ“Š ë³µêµ¬ í™•ì¸

### ëª¨ë“  í•­ëª© í™•ì¸

```bash
# 1. ì›¹ì‚¬ì´íŠ¸ ì •ìƒ ì‘ë™
curl http://<SERVER_IP>/

# 2. ë°±ë„ì–´ ì œê±° í™•ì¸
curl http://<SERVER_IP>/system.php
# â†’ 404 or 403

# 3. health.php ì •ìƒ ì‘ë™
curl http://<SERVER_IP>/api/health.php
# â†’ {"status":"ok",...}

# 4. ë°±ë„ì–´ ì‚¬ìš©ì ì—†ìŒ
sudo cat /etc/passwd | grep -E "(hacker|sysadmin)"
# â†’ ê²°ê³¼ ì—†ìŒ

# 5. sudoers ì •ë¦¬
sudo ls /etc/sudoers.d/
# â†’ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ íŒŒì¼ ì—†ìŒ

# 6. SSH ì ‘ê·¼ ì°¨ë‹¨ í™•ì¸
ssh hacker@<SERVER_IP>
ssh sysadmin@<SERVER_IP>
# â†’ ì ‘ì† ì‹¤íŒ¨
```

---

## ğŸ“ ì¬ë°œ ë°©ì§€

### 1. ë³´ì•ˆ ì •ì±… ìˆ˜ë¦½

- âœ… IMDSv2 ê°•ì œ ì‚¬ìš©
- âœ… ModSecurity ì˜ˆì™¸ ìµœì†Œí™”
- âœ… ì •ê¸°ì ì¸ ë³´ì•ˆ ê°ì‚¬
- âœ… ì¹¨ì… íƒì§€ ì‹œìŠ¤í…œ (IDS) ì„¤ì¹˜
- âœ… íŒŒì¼ ë¬´ê²°ì„± ëª¨ë‹ˆí„°ë§ (FIM)
- âœ… ë¡œê·¸ ì¤‘ì•™ ì§‘ì¤‘í™”

### 2. ëª¨ë‹ˆí„°ë§ ê°•í™”

```bash
# fail2ban ì„¤ì¹˜ (SSH ë¬´ì°¨ë³„ ëŒ€ì… ë°©ì§€)
sudo yum install fail2ban -y
sudo systemctl enable fail2ban
sudo systemctl start fail2ban

# AIDE ì„¤ì¹˜ (íŒŒì¼ ë¬´ê²°ì„± ëª¨ë‹ˆí„°ë§)
sudo yum install aide -y
sudo aide --init
sudo cp /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz
```

### 3. ì •ê¸° ì ê²€ ìŠ¤ì¼€ì¤„

```bash
# cronìœ¼ë¡œ ë§¤ì¼ ë³´ì•ˆ ì ê²€
sudo crontab -e

# ì¶”ê°€:
0 2 * * * /usr/local/bin/security_audit.sh
0 3 * * * rkhunter --check --skip-keypress
```

---

## ğŸ“ ë„ì›€ì´ í•„ìš”í•œ ê²½ìš°

**ê¸´ê¸‰ ìƒí™©:**
1. ëª¨ë“  ì„œë¹„ìŠ¤ ì¤‘ì§€
2. ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬
3. ì „ë¬¸ ë³´ì•ˆ íŒ€ì— ì—°ë½
4. í¬ë Œì‹ ë¶„ì„ ì‹¤í–‰
5. ì „ì²´ ì‹œìŠ¤í…œ ì¬ì„¤ì¹˜ ê³ ë ¤

**ì°¸ê³  ìë£Œ:**
- AWS Security Best Practices
- OWASP Security Guidelines
- CIS Benchmarks

---

**ì¤‘ìš”:** ì´ ë³µêµ¬ ê°€ì´ë“œëŠ” êµìœ¡/í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ ìœ„í•œ ê²ƒì…ë‹ˆë‹¤. ì‹¤ì œ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ì „ë¬¸ ë³´ì•ˆ íŒ€ì˜ ë„ì›€ì„ ë°›ìœ¼ì„¸ìš”.
