#!/usr/bin/env python3
"""
업로드 페이지 구조 확인 스크립트
"""

import requests
from bs4 import BeautifulSoup
import sys

def check_upload_page(target_ip="43.201.154.142", use_tor=True):
    base_url = f"http://{target_ip}"

    session = requests.Session()

    # Tor 프록시 설정
    if use_tor:
        session.proxies = {
            'http': 'socks5h://127.0.0.1:9050',
            'https': 'socks5h://127.0.0.1:9050'
        }
        print("[+] Tor 프록시 사용")

    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
    })

    # 1. 로그인
    print("\n[1] 로그인 중...")
    login_data = {'username': 'alice', 'password': 'alice2024'}
    response = session.post(f"{base_url}/login.php", data=login_data,
                           allow_redirects=True, timeout=30)

    if 'login.php' not in response.url:
        print(f"[+] 로그인 성공: {response.url}")
    else:
        print("[-] 로그인 실패")
        return

    # 2. 업로드 페이지 찾기
    print("\n[2] 업로드 페이지 탐색...")

    possible_pages = [
        'upload.php',
        'profile.php',
        'post.php',
        'write.php',
        'create.php',
        'newpost.php',
        'board.php'
    ]

    for page in possible_pages:
        try:
            url = f"{base_url}/{page}"
            resp = session.get(url, timeout=10)

            print(f"\n[*] {page} - Status: {resp.status_code}")

            if resp.status_code == 200:
                soup = BeautifulSoup(resp.text, 'html.parser')

                # 파일 업로드 폼 찾기
                file_inputs = soup.find_all('input', {'type': 'file'})

                if file_inputs:
                    print(f"    [+] 파일 업로드 폼 발견!")

                    for inp in file_inputs:
                        form = inp.find_parent('form')
                        if form:
                            print(f"    Form action: {form.get('action', 'N/A')}")
                            print(f"    Form method: {form.get('method', 'N/A')}")
                            print(f"    Form enctype: {form.get('enctype', 'N/A')}")
                            print(f"    File input name: {inp.get('name', 'N/A')}")

                            # 다른 input 필드들
                            other_inputs = form.find_all('input')
                            print(f"    기타 input 필드:")
                            for other in other_inputs:
                                name = other.get('name', 'N/A')
                                type_ = other.get('type', 'N/A')
                                value = other.get('value', '')
                                if name != 'N/A':
                                    print(f"      - {name} (type={type_}, value={value})")

                    # 페이지 일부 출력
                    print(f"\n    HTML 일부:")
                    print(resp.text[:1000])

        except Exception as e:
            print(f"    [-] 오류: {str(e)[:50]}")

    # 3. 인덱스 페이지에서 링크 찾기
    print("\n[3] 메인 페이지에서 업로드 링크 찾기...")
    try:
        resp = session.get(f"{base_url}/index.php", timeout=10)
        soup = BeautifulSoup(resp.text, 'html.parser')

        # 모든 링크 출력
        links = soup.find_all('a', href=True)
        print(f"    발견된 링크:")
        for link in links[:20]:
            href = link.get('href')
            text = link.get_text(strip=True)
            if href and not href.startswith('http'):
                print(f"      - {href} ({text})")

    except Exception as e:
        print(f"[-] 오류: {str(e)}")


if __name__ == "__main__":
    target_ip = input("타겟 IP (기본: 43.201.154.142): ").strip() or "43.201.154.142"
    use_tor = input("Tor 사용? (y/N): ").strip().lower() == 'y'

    check_upload_page(target_ip, use_tor)
