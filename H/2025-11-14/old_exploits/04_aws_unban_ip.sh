#!/bin/bash

###############################################################################
# AWS EC2 IP 차단 해제 스크립트
# - 보안 그룹에서 차단된 IP 제거
# - iptables 규칙 초기화
# - fail2ban 차단 해제
###############################################################################

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   AWS EC2 IP 차단 해제 스크립트                           ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

# 타겟 인스턴스 ID
read -p "EC2 인스턴스 ID (예: i-0123456789abcdef0): " INSTANCE_ID

if [ -z "$INSTANCE_ID" ]; then
    echo "[-] 인스턴스 ID가 필요합니다"
    exit 1
fi

# 보안 그룹 ID 가져오기
echo "[*] 보안 그룹 조회 중..."
SECURITY_GROUP_ID=$(aws ec2 describe-instances \
    --instance-ids "$INSTANCE_ID" \
    --query 'Reservations[0].Instances[0].SecurityGroups[0].GroupId' \
    --output text)

if [ -z "$SECURITY_GROUP_ID" ] || [ "$SECURITY_GROUP_ID" == "None" ]; then
    echo "[-] 보안 그룹을 찾을 수 없습니다"
    exit 1
fi

echo "[+] 보안 그룹: $SECURITY_GROUP_ID"

# 현재 보안 그룹 규칙 확인
echo ""
echo "[*] 현재 보안 그룹 규칙:"
echo "─────────────────────────────────────────────────────────────"
aws ec2 describe-security-groups \
    --group-ids "$SECURITY_GROUP_ID" \
    --query 'SecurityGroups[0].IpPermissions[]' \
    --output table

echo ""
read -p "차단된 IP를 제거하시겠습니까? (y/N): " CONFIRM

if [ "$CONFIRM" != "y" ] && [ "$CONFIRM" != "Y" ]; then
    echo "[*] 취소됨"
    exit 0
fi

# 차단된 IP 입력
read -p "제거할 IP 주소 (예: 1.2.3.4 또는 0.0.0.0/0): " BLOCKED_IP

if [ -z "$BLOCKED_IP" ]; then
    echo "[-] IP 주소가 필요합니다"
    exit 1
fi

# CIDR 형식 확인
if [[ ! "$BLOCKED_IP" =~ / ]]; then
    BLOCKED_IP="${BLOCKED_IP}/32"
fi

echo ""
echo "[*] 보안 그룹 규칙 제거 시도..."

# HTTP (80) 차단 해제
echo "[*] HTTP (80) 차단 해제..."
aws ec2 revoke-security-group-ingress \
    --group-id "$SECURITY_GROUP_ID" \
    --protocol tcp \
    --port 80 \
    --cidr "$BLOCKED_IP" 2>/dev/null && \
    echo "[+] HTTP (80) 차단 해제 성공" || \
    echo "[-] HTTP (80) 차단 규칙 없음"

# HTTPS (443) 차단 해제
echo "[*] HTTPS (443) 차단 해제..."
aws ec2 revoke-security-group-ingress \
    --group-id "$SECURITY_GROUP_ID" \
    --protocol tcp \
    --port 443 \
    --cidr "$BLOCKED_IP" 2>/dev/null && \
    echo "[+] HTTPS (443) 차단 해제 성공" || \
    echo "[-] HTTPS (443) 차단 규칙 없음"

# SSH (22) 차단 해제
echo "[*] SSH (22) 차단 해제..."
aws ec2 revoke-security-group-ingress \
    --group-id "$SECURITY_GROUP_ID" \
    --protocol tcp \
    --port 22 \
    --cidr "$BLOCKED_IP" 2>/dev/null && \
    echo "[+] SSH (22) 차단 해제 성공" || \
    echo "[-] SSH (22) 차단 규칙 없음"

echo ""
echo "─────────────────────────────────────────────────────────────"

# 또는 모든 포트 허용 규칙 추가
read -p "모든 트래픽 허용 규칙을 추가하시겠습니까? (y/N): " ADD_RULE

if [ "$ADD_RULE" == "y" ] || [ "$ADD_RULE" == "Y" ]; then
    echo "[*] 모든 트래픽 허용 규칙 추가..."

    # HTTP 허용
    aws ec2 authorize-security-group-ingress \
        --group-id "$SECURITY_GROUP_ID" \
        --protocol tcp \
        --port 80 \
        --cidr 0.0.0.0/0 && \
        echo "[+] HTTP (80) 허용 추가"

    # HTTPS 허용
    aws ec2 authorize-security-group-ingress \
        --group-id "$SECURITY_GROUP_ID" \
        --protocol tcp \
        --port 443 \
        --cidr 0.0.0.0/0 && \
        echo "[+] HTTPS (443) 허용 추가"

    # SSH 허용 (주의!)
    read -p "SSH도 모든 IP에 허용하시겠습니까? (보안 위험) (y/N): " SSH_CONFIRM
    if [ "$SSH_CONFIRM" == "y" ] || [ "$SSH_CONFIRM" == "Y" ]; then
        aws ec2 authorize-security-group-ingress \
            --group-id "$SECURITY_GROUP_ID" \
            --protocol tcp \
            --port 22 \
            --cidr 0.0.0.0/0 && \
            echo "[+] SSH (22) 허용 추가"
    fi
fi

echo ""
echo "[+] 보안 그룹 설정 완료!"
echo ""

# EC2 인스턴스에 접속하여 서버 측 차단 해제
echo "─────────────────────────────────────────────────────────────"
echo "[*] 서버 측 차단 해제를 위해 SSH 연결이 필요합니다"
read -p "SSH로 연결하여 서버 설정을 변경하시겠습니까? (y/N): " SSH_CONNECT

if [ "$SSH_CONNECT" != "y" ] && [ "$SSH_CONNECT" != "Y" ]; then
    echo "[*] 완료"
    echo ""
    echo "수동으로 서버에 접속하여 다음 명령을 실행하세요:"
    echo "  ssh -i ~/.ssh/your-key.pem ec2-user@INSTANCE_IP"
    echo "  sudo iptables -F"
    echo "  sudo fail2ban-client unban --all"
    exit 0
fi

# 인스턴스 퍼블릭 IP 가져오기
INSTANCE_IP=$(aws ec2 describe-instances \
    --instance-ids "$INSTANCE_ID" \
    --query 'Reservations[0].Instances[0].PublicIpAddress' \
    --output text)

if [ -z "$INSTANCE_IP" ] || [ "$INSTANCE_IP" == "None" ]; then
    echo "[-] 인스턴스 IP를 가져올 수 없습니다"
    exit 1
fi

echo "[+] 인스턴스 IP: $INSTANCE_IP"

# SSH 키 경로 입력
read -p "SSH 키 파일 경로 (예: ~/.ssh/mykey.pem): " SSH_KEY

if [ ! -f "$SSH_KEY" ]; then
    echo "[-] SSH 키 파일을 찾을 수 없습니다: $SSH_KEY"
    exit 1
fi

# SSH 사용자 입력
read -p "SSH 사용자 (기본: ec2-user): " SSH_USER
SSH_USER=${SSH_USER:-ec2-user}

echo ""
echo "[*] SSH 연결 중: $SSH_USER@$INSTANCE_IP"

# SSH로 서버 측 차단 해제
ssh -i "$SSH_KEY" "$SSH_USER@$INSTANCE_IP" << 'EOF'
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   서버 측 IP 차단 해제                                    ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

# 1. iptables 차단 해제
echo "[1] iptables 차단 확인..."
sudo iptables -L INPUT -n --line-numbers | grep DROP

read -p "모든 iptables DROP 규칙을 제거하시겠습니까? (y/N): " CLEAR_IPTABLES
if [ "$CLEAR_IPTABLES" == "y" ] || [ "$CLEAR_IPTABLES" == "Y" ]; then
    echo "[*] iptables INPUT 체인 초기화..."
    sudo iptables -F INPUT
    echo "[+] iptables 초기화 완료"

    # 저장
    if command -v iptables-save &> /dev/null; then
        sudo iptables-save > /tmp/iptables-backup
        echo "[+] iptables 백업: /tmp/iptables-backup"
    fi
fi

echo ""

# 2. fail2ban 차단 해제
echo "[2] fail2ban 차단 확인..."
if command -v fail2ban-client &> /dev/null; then
    echo "[*] fail2ban 상태:"
    sudo fail2ban-client status

    read -p "모든 fail2ban 차단을 해제하시겠습니까? (y/N): " UNBAN_ALL
    if [ "$UNBAN_ALL" == "y" ] || [ "$UNBAN_ALL" == "Y" ]; then
        echo "[*] 모든 IP 차단 해제..."

        # 각 jail에 대해 차단 해제
        for jail in $(sudo fail2ban-client status | grep "Jail list" | sed 's/.*://'); do
            jail=$(echo $jail | tr -d ',[:space:]')
            if [ ! -z "$jail" ]; then
                echo "[*] Jail '$jail' 차단 해제..."
                sudo fail2ban-client set $jail unbanip --all 2>/dev/null || \
                sudo fail2ban-client unban --all 2>/dev/null
            fi
        done

        echo "[+] fail2ban 차단 해제 완료"
    fi
else
    echo "[-] fail2ban이 설치되어 있지 않습니다"
fi

echo ""

# 3. 웹 서버 로그 확인
echo "[3] 웹 서버 접근 로그 확인..."
if [ -f /var/log/httpd/access_log ]; then
    echo "[*] Apache 접근 로그 (최근 10줄):"
    sudo tail -10 /var/log/httpd/access_log
elif [ -f /var/log/nginx/access.log ]; then
    echo "[*] Nginx 접근 로그 (최근 10줄):"
    sudo tail -10 /var/log/nginx/access.log
else
    echo "[-] 웹 서버 로그를 찾을 수 없습니다"
fi

echo ""
echo "[+] 서버 측 설정 완료!"

EOF

echo ""
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║   차단 해제 완료!                                         ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""
echo "이제 다음 명령으로 공격을 시도하세요:"
echo "  cd /Users/hwangjunha/Desktop/Red_basic_local/H/2025-11-14/exploits"
echo "  python3 01_detection_bypass_webshell.py"
echo ""
