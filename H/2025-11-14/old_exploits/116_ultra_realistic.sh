#!/bin/bash
# 진짜 현실에서 일어나는 실수들만

echo "=========================================="
echo "초현실적인 개발자 실수"
echo "실제로 자주 발생하는 것들만"
echo "=========================================="
echo ""

# 1. 주석 처리된 디버그 코드를 급하게 풀었다가 커밋
echo "[1] 급하게 주석 푼 디버그 코드 (커밋 실수)"
sed -i.bak 's|// file_put_contents|file_put_contents|' /var/www/html/file.php 2>/dev/null || true
echo "[+] file.php에 숨겨진 로깅 활성화"

# 2. 개발 서버용 엔드포인트를 프로덕션에도 배포
echo ""
echo "[2] 개발 서버용 헬스체크 엔드포인트 (삭제 깜빡)"
cat > /var/www/html/health.php << 'EOF'
<?php
// Health check endpoint for dev/staging
// TODO: Remove from production!!!

if ($_SERVER['REMOTE_ADDR'] == '127.0.0.1' || $_SERVER['REMOTE_ADDR'] == '::1') {
    // 로컬에서만 작동하게 했다고 생각했는데...
    // 실수: X-Forwarded-For 체크 안함
}

// 서버 상태 체크
if (isset($_GET['check'])) {
    switch($_GET['check']) {
        case 'disk':
            echo shell_exec('df -h');
            break;
        case 'memory':
            echo shell_exec('free -m');
            break;
        case 'process':
            // 원래는 ps만 하려고 했는데...
            $cmd = isset($_GET['name']) ? $_GET['name'] : 'apache2';
            echo shell_exec("ps aux | grep $cmd");
            break;
    }
}
?>
EOF
echo "[+] health.php 생성 (헬스체크 엔드포인트)"

# 3. CORS 설정 실수 (급하게 * 박음)
echo ""
echo "[3] CORS 설정 급하게 * 박음 (보안 취약)"
cat > /var/www/html/api/data.php << 'EOF'
<?php
// 프론트엔드 테스트 중에 CORS 에러나서 급하게...
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
header('Access-Control-Allow-Headers: *');

// 원래는 나중에 제한하려고 했는데 깜빡함
if (isset($_GET['query'])) {
    include 'config.php';
    $query = $_GET['query'];
    // prepared statement 쓰려고 했는데 급해서...
    $result = mysqli_query($conn, $query);
    $data = [];
    while($row = mysqli_fetch_assoc($result)) {
        $data[] = $row;
    }
    echo json_encode($data);
}
?>
EOF
mkdir -p /var/www/html/api
echo "[+] api/data.php 생성 (CORS * + SQL Injection)"

# 4. 에러 메시지에 민감한 정보 노출 (개발 습관)
echo ""
echo "[4] 에러 메시지 상세 출력 (개발 습관)"
cat >> /var/www/html/.htaccess << 'EOF'

# 개발할 때 에러 보려고...
php_flag display_errors on
php_flag display_startup_errors on
php_value error_reporting E_ALL

# 나중에 끄려고 했는데 깜빡
EOF
echo "[+] .htaccess 수정 (에러 메시지 노출)"

# 5. Session timeout 없음 (기본값 사용)
echo ""
echo "[5] Session timeout 미설정 (기본값 24분)"
cat > /var/www/html/check_session.php << 'EOF'
<?php
session_start();

// Session timeout 체크하려고 했는데...
// 시간 없어서 나중에 하기로 함

if (isset($_SESSION['user'])) {
    echo json_encode([
        'logged_in' => true,
        'user' => $_SESSION['user'],
        'session_id' => session_id()
    ]);
} else {
    echo json_encode(['logged_in' => false]);
}
?>
EOF
echo "[+] check_session.php 생성 (Session timeout 없음)"

# 6. 파일 업로드 크기 제한만 체크 (타입 검증 안함)
echo ""
echo "[6] 파일 업로드 크기만 체크 (급하게 구현)"
cat > /var/www/html/quick_upload.php << 'EOF'
<?php
// 빨리 만들어달라고 해서 급하게...

if (isset($_FILES['file'])) {
    $size = $_FILES['file']['size'];

    // 크기만 체크 (10MB)
    if ($size < 10 * 1024 * 1024) {
        $filename = $_FILES['file']['name'];
        // 나중에 파일명 검증 추가하기로 함
        $target = '/var/www/html/uploads/' . $filename;

        if (move_uploaded_file($_FILES['file']['tmp_name'], $target)) {
            echo "Success: $filename";
        }
    } else {
        echo "File too large";
    }
}
?>
EOF
echo "[+] quick_upload.php 생성 (검증 부족)"

# 7. 백업 스크립트가 웹 루트에 (위치 잘못)
echo ""
echo "[7] 백업 스크립트 위치 실수"
cat > /var/www/html/backup.sh << 'EOF'
#!/bin/bash
# DB 백업 스크립트
# 원래 /root에 있어야 하는데 잘못 올림

mysqldump -u root -pvulnerable123 vulnerable_sns > /tmp/backup_$(date +%Y%m%d).sql

# 나중에 이동시키기
EOF
chmod +x /var/www/html/backup.sh
echo "[+] backup.sh 생성 (위치 잘못 + 비밀번호 노출)"

# 8. 로그 파일이 웹에서 접근 가능
echo ""
echo "[8] 로그 파일 위치 실수"
touch /var/www/html/uploads/error.log
touch /var/www/html/uploads/access.log
cat > /var/www/html/uploads/debug.log << 'EOF'
[2024-11-14 10:23:45] DB Connection: mysql://root:vulnerable123@localhost/vulnerable_sns
[2024-11-14 10:24:12] API Request: /api/data.php?query=SELECT * FROM users
[2024-11-14 10:25:33] Session created: alice (session_id: abc123def456)
EOF
echo "[+] 로그 파일 생성 (웹에서 접근 가능)"

# 9. 개발용 프록시 설정 남아있음
echo ""
echo "[9] 개발용 프록시/포워드 설정"
cat > /var/www/html/proxy.php << 'EOF'
<?php
// 개발 중에 외부 API 테스트하려고...
// CORS 문제 우회용으로 만들었는데 삭제 깜빡

if (isset($_GET['url'])) {
    $url = $_GET['url'];
    // URL 검증하려고 했는데 시간 없어서...
    $content = file_get_contents($url);
    echo $content;
}
?>
EOF
echo "[+] proxy.php 생성 (SSRF 취약점)"

# 10. 테스트 계정 삭제 안함
echo ""
echo "[10] 테스트 계정 방치"
mysql -u root -pvulnerable123 vulnerable_sns << 'EOF' 2>/dev/null
INSERT IGNORE INTO users (username, password, email, role) VALUES
('testuser', MD5('test123'), 'test@test.com', 'admin'),
('dev', MD5('dev'), 'dev@company.com', 'admin');
EOF
echo "[+] 테스트 계정 추가 (삭제 안함)"

echo ""
echo "=========================================="
echo "[+] 초현실적인 취약점 설치 완료!"
echo "=========================================="
echo ""
echo "[!] 생성된 취약점 (실제로 자주 있는 것들):"
echo ""
echo "  1. /health.php?check=process&name=test;id"
echo "     → 개발용 헬스체크 (command injection)"
echo ""
echo "  2. /api/data.php?query=SELECT * FROM users"
echo "     → CORS * + SQL Injection"
echo ""
echo "  3. /proxy.php?url=http://169.254.169.254/latest/meta-data/"
echo "     → SSRF (개발용 프록시)"
echo ""
echo "  4. /uploads/debug.log"
echo "     → 로그 파일 노출 (DB 비밀번호)"
echo ""
echo "  5. /backup.sh"
echo "     → 백업 스크립트 (비밀번호 하드코딩)"
echo ""
echo "[*] 공격 시나리오:"
echo "  1. /uploads/debug.log 발견 → DB 정보 획득"
echo "  2. /health.php?check=process&name=a;whoami → RCE 확인"
echo "  3. /health.php?check=process&name=a;pkill%20-9%20splunkd → Splunk 죽임"
echo "  4. 리버스 쉘 획득"
echo "  5. 권한 상승"
echo ""
echo "[*] Splunk 우회 포인트:"
echo "  - /health.php는 Splunk가 모름 (새 파일)"
echo "  - check, name 파라미터도 모름"
echo "  - 완전 우회 가능!"
