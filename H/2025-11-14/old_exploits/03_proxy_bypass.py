#!/usr/bin/env python3
"""
프록시/VPN 우회 스크립트
- SOCKS5 프록시 지원 (Tor 등)
- HTTP 프록시 지원
- User-Agent 로테이션
"""

import requests
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry
from bs4 import BeautifulSoup
import random
import sys
import time

class ProxyBypassAttacker:
    def __init__(self, target_ip, proxy_config=None):
        self.target_ip = target_ip
        self.base_url = f"http://{target_ip}"
        self.session = requests.Session()

        # 프록시 설정
        if proxy_config:
            self.session.proxies = proxy_config
            print(f"[+] 프록시 설정: {proxy_config}")

        # User-Agent 풀
        self.user_agents = [
            'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',
            'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',
            'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:122.0) Gecko/20100101 Firefox/122.0',
            'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',
        ]

        self._rotate_user_agent()

        # 재시도 전략
        retry_strategy = Retry(
            total=3,
            backoff_factor=2,
            status_forcelist=[429, 500, 502, 503, 504],
            allowed_methods=["HEAD", "GET", "POST"]
        )
        adapter = HTTPAdapter(max_retries=retry_strategy)
        self.session.mount("http://", adapter)
        self.session.mount("https://", adapter)

        # 헤더 설정
        self.session.headers.update({
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
            'Accept-Language': 'en-US,en;q=0.9',
            'Accept-Encoding': 'gzip, deflate',
            'Connection': 'keep-alive',
            'DNT': '1'
        })

        self.logged_in = False

    def _rotate_user_agent(self):
        ua = random.choice(self.user_agents)
        self.session.headers.update({'User-Agent': ua})

    def test_connection(self):
        """서버 접근 테스트"""
        print(f"\n[*] 서버 접근 테스트: {self.base_url}")

        try:
            response = self.session.get(self.base_url, timeout=15)
            print(f"[+] 연결 성공!")
            print(f"    Status Code: {response.status_code}")
            print(f"    Response Length: {len(response.text)} bytes")

            if response.status_code == 200:
                print(f"[+] 서버 정상 작동 중")
                return True
            else:
                print(f"[-] 비정상 응답: {response.status_code}")
                return False

        except requests.exceptions.ProxyError as e:
            print(f"[-] 프록시 오류: {str(e)[:100]}")
            return False
        except requests.exceptions.Timeout:
            print(f"[-] 타임아웃 - 서버 응답 없음")
            return False
        except requests.exceptions.ConnectionError as e:
            print(f"[-] 연결 오류: {str(e)[:100]}")
            return False
        except Exception as e:
            print(f"[-] 오류: {str(e)[:100]}")
            return False

    def login(self, username="alice", password="alice2024"):
        """로그인 시도"""
        print(f"\n[*] 로그인 시도: {username}")

        login_url = f"{self.base_url}/login.php"

        try:
            # GET 요청
            self._rotate_user_agent()
            get_response = self.session.get(login_url, timeout=15)
            print(f"    GET 응답: {get_response.status_code}")

            time.sleep(random.uniform(1, 2))

            # POST 요청
            self._rotate_user_agent()
            data = {'username': username, 'password': password}
            headers = {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Origin': self.base_url,
                'Referer': login_url
            }

            response = self.session.post(login_url, data=data, headers=headers,
                                        allow_redirects=True, timeout=15)

            print(f"    POST 응답: {response.status_code}")
            print(f"    최종 URL: {response.url}")

            # 성공 확인
            if 'login.php' not in response.url:
                print(f"[+] 로그인 성공!")
                self.logged_in = True
                return True

            if 'logout' in response.text.lower():
                print(f"[+] 로그인 성공! (로그아웃 버튼 발견)")
                self.logged_in = True
                return True

            print(f"[-] 로그인 실패")
            return False

        except Exception as e:
            print(f"[-] 로그인 오류: {str(e)[:100]}")
            return False


def get_proxy_config():
    """프록시 설정 입력"""
    print("\n프록시 설정:")
    print("1. Tor (SOCKS5: 127.0.0.1:9050)")
    print("2. 커스텀 SOCKS5 프록시")
    print("3. 커스텀 HTTP 프록시")
    print("4. 프록시 없음")

    choice = input("\n선택 (1-4): ").strip()

    if choice == "1":
        # Tor
        return {
            'http': 'socks5h://127.0.0.1:9050',
            'https': 'socks5h://127.0.0.1:9050'
        }

    elif choice == "2":
        # 커스텀 SOCKS5
        host = input("SOCKS5 호스트 (예: 127.0.0.1): ").strip()
        port = input("SOCKS5 포트 (예: 1080): ").strip()
        return {
            'http': f'socks5h://{host}:{port}',
            'https': f'socks5h://{host}:{port}'
        }

    elif choice == "3":
        # 커스텀 HTTP
        host = input("HTTP 프록시 호스트: ").strip()
        port = input("HTTP 프록시 포트: ").strip()
        return {
            'http': f'http://{host}:{port}',
            'https': f'http://{host}:{port}'
        }

    else:
        # 프록시 없음
        return None


def main():
    print("""
    ╔═══════════════════════════════════════════════════════════╗
    ║   프록시/VPN 우회 스크립트                                ║
    ║   - Tor SOCKS5 지원                                       ║
    ║   - HTTP/SOCKS5 프록시 지원                               ║
    ║   - 연결 테스트 및 로그인                                 ║
    ╚═══════════════════════════════════════════════════════════╝
    """)

    # 타겟 IP
    if len(sys.argv) > 1:
        target_ip = sys.argv[1]
    else:
        target_ip = input("타겟 IP (기본: 43.201.154.142): ").strip() or "43.201.154.142"

    # 프록시 설정
    proxy_config = get_proxy_config()

    # 공격 시작
    attacker = ProxyBypassAttacker(target_ip, proxy_config)

    # 연결 테스트
    if not attacker.test_connection():
        print("\n[-] 서버 연결 실패!")
        print("\n추가 확인 사항:")
        print("1. 서버가 실행 중인지 확인")
        print("2. IP 주소가 올바른지 확인")
        print("3. 방화벽/보안 그룹 설정 확인")
        print("4. VPN 또는 프록시 필요 여부 확인")

        if proxy_config:
            print("\n프록시 확인:")
            print("- Tor 사용 시: brew services list | grep tor")
            print("- Tor 시작: brew services start tor")

        return

    # 로그인 시도
    attacker.login()

    print("\n" + "="*60)
    print("테스트 완료")
    print("="*60)
    print(f"서버 접근: {'성공' if attacker.test_connection() else '실패'}")
    print(f"로그인: {'성공' if attacker.logged_in else '실패'}")

    if attacker.logged_in:
        print("\n[+] 이제 메인 스크립트를 실행할 수 있습니다:")
        print(f"    python3 01_detection_bypass_webshell.py")


if __name__ == "__main__":
    # requests[socks] 패키지 확인
    try:
        import socks
    except ImportError:
        print("[!] SOCKS5 지원을 위해 패키지 설치 필요:")
        print("    pip3 install requests[socks]")
        print("    또는")
        print("    pip3 install PySocks\n")

    main()
