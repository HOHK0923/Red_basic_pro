#!/bin/bash
# 진짜 현실적인 개발자 실수들

echo "=========================================="
echo "진짜 현실적인 개발자 실수"
echo "=========================================="
echo ""

# 1. API 파라미터 이름 오타 (매우 흔함)
echo "[1] API 파라미터 이름 오타로 인한 취약점"
cat > /var/www/html/api/system.php << 'EOF'
<?php
// System monitoring API
header('Content-Type: application/json');

// 정상 파라미터
if (isset($_GET['status'])) {
    echo json_encode(['status' => 'OK', 'uptime' => exec('uptime')]);
}

// 개발자 실수: 'command'를 체크하려고 했는데 오타로 'cmd'를 못 막음
if (isset($_GET['command'])) {
    // 여기서 막으려고 했음
    die(json_encode(['error' => 'Unauthorized']));
}

// 실수로 cmd도 작동하게 됨 (오타)
if (isset($_GET['cmd'])) {
    // 개발자는 위에서 막았다고 생각함
    $output = shell_exec($_GET['cmd']);
    echo json_encode(['result' => $output]);
}
?>
EOF
echo "[+] /api/system.php 생성 (파라미터 오타 취약점)"

# 2. Rate Limiting 로직 버그
echo ""
echo "[2] Rate Limiting 버그 (조건문 실수)"
cat > /var/www/html/api/upload.php << 'EOF'
<?php
session_start();

// Rate limiting 체크 (버그 있음)
$max_uploads = 5;
$time_window = 60; // 60초

if (!isset($_SESSION['upload_count'])) {
    $_SESSION['upload_count'] = 0;
    $_SESSION['upload_start'] = time();
}

// 개발자 실수: && 대신 || 사용 (논리 오류)
if ($_SESSION['upload_count'] >= $max_uploads || time() - $_SESSION['upload_start'] > $time_window) {
    // 원래는 리셋해야 하는데... 실수로 카운트만 증가
    $_SESSION['upload_count']++;
    // 실수: die()를 안 넣어서 아래 코드가 계속 실행됨
}

// 파일 업로드 처리 (제한 없이 계속 됨)
if (isset($_FILES['file'])) {
    $target = '/var/www/html/uploads/' . basename($_FILES['file']['name']);
    move_uploaded_file($_FILES['file']['tmp_name'], $target);
    echo "Uploaded!";
}
?>
EOF
echo "[+] /api/upload.php 생성 (Rate Limiting 버그)"

# 3. 개발 중 console.log 같은 디버그 코드 남김
echo ""
echo "[3] 디버그 코드 방치 (프로덕션에 남음)"
cat > /var/www/html/process.php << 'EOF'
<?php
// Request processing

// 개발 디버깅용 (삭제 깜빡함)
file_put_contents('/tmp/debug.log', print_r($_REQUEST, true), FILE_APPEND);

// 원래 코드...
if (isset($_GET['action'])) {
    // ...
}
?>
EOF
echo "[+] process.php 생성 (디버그 로그 방치)"

# 4. 조건문 순서 실수로 인한 인증 우회
echo ""
echo "[4] 조건문 순서 실수 (인증 우회)"
cat > /var/www/html/admin/tools.php << 'EOF'
<?php
// Admin tools page

// 개발자 실수: 인증 체크 전에 action 실행
if (isset($_GET['action']) && $_GET['action'] == 'health_check') {
    // Health check는 인증 없이도 되게 하려고 했는데...
    if (isset($_GET['cmd'])) {
        // 실수로 여기서 cmd도 실행됨
        system($_GET['cmd']);
    }
}

// 인증 체크 (너무 늦음)
session_start();
if (!isset($_SESSION['admin'])) {
    die('Unauthorized');
}

// 나머지 관리자 기능...
?>
EOF
mkdir -p /var/www/html/admin
echo "[+] /admin/tools.php 생성 (인증 우회 버그)"

# 5. 파일 업로드 검증 우회 (확장자만 체크)
echo ""
echo "[5] 파일 업로드 검증 취약점"
cat > /var/www/html/upload_avatar.php << 'EOF'
<?php
// Avatar upload

if (isset($_FILES['avatar'])) {
    $filename = $_FILES['avatar']['name'];

    // 개발자 실수: 확장자만 체크 (MIME type 체크 안함)
    $ext = strtolower(pathinfo($filename, PATHINFO_EXTENSION));
    $allowed = ['jpg', 'png', 'gif'];

    if (in_array($ext, $allowed)) {
        // 실수: Content-Type 체크 안함
        // 실수: 파일 내용 검증 안함
        $target = '/var/www/html/uploads/' . $filename;
        move_uploaded_file($_FILES['avatar']['tmp_name'], $target);
        echo "Avatar uploaded!";
    } else {
        echo "Invalid file type";
    }
}
?>
EOF
echo "[+] upload_avatar.php 생성 (확장자 검증만)"

# 6. SQL Injection 방어 불완전 (따옴표만 필터)
echo ""
echo "[6] 불완전한 SQL Injection 필터"
cat > /var/www/html/search.php << 'EOF'
<?php
include 'config.php';

if (isset($_GET['q'])) {
    $query = $_GET['q'];

    // 개발자 실수: 작은따옴표만 필터링
    $query = str_replace("'", "", $query);

    // 하지만 큰따옴표나 UNION은 안 막음
    $sql = "SELECT * FROM posts WHERE title LIKE '%$query%'";
    $result = mysqli_query($conn, $sql);

    // ...
}
?>
EOF
echo "[+] search.php 생성 (불완전한 SQLi 필터)"

# 7. 환경변수 노출 (httpd.conf 실수)
echo ""
echo "[7] Apache 설정 실수 (.htaccess)"
cat > /var/www/html/.htaccess << 'EOF'
# Apache config

# 개발자 실수: 환경변수 노출
SetEnv DB_PASS vulnerable123
SetEnv API_KEY sk_test_abc123def456

# 디버그 모드 (배포 시 꺼야 했는데...)
php_flag display_errors on
php_flag log_errors on

# 디렉토리 리스팅 (실수로 켜짐)
Options +Indexes
EOF
echo "[+] .htaccess 생성 (환경변수 노출)"

# 8. Swagger/API 문서 방치
echo ""
echo "[8] API 문서 노출 (삭제 안함)"
cat > /var/www/html/api/docs.json << 'EOF'
{
  "swagger": "2.0",
  "info": {
    "title": "Internal API",
    "version": "1.0.0"
  },
  "paths": {
    "/api/debug.php": {
      "get": {
        "parameters": [
          {
            "name": "exec",
            "in": "query",
            "description": "Execute system command (dev only)",
            "required": false,
            "type": "string"
          }
        ]
      }
    },
    "/admin/tools.php": {
      "get": {
        "parameters": [
          {
            "name": "action",
            "in": "query"
          },
          {
            "name": "cmd",
            "in": "query",
            "description": "Command for health_check action"
          }
        ]
      }
    }
  }
}
EOF
echo "[+] /api/docs.json 생성 (API 문서 노출)"

# 9. Git 디렉토리 노출 (.git 삭제 안함)
echo ""
echo "[9] .git 디렉토리 노출"
cd /var/www/html
git init 2>/dev/null
git config user.email "dev@company.com"
git config user.name "Developer"
echo "DB_PASS=vulnerable123" > .env.example
git add .env.example
git commit -m "Initial commit" 2>/dev/null
echo "[+] .git 디렉토리 생성 (삭제 안함)"

# 10. Session 고정 취약점 (세션 재생성 안함)
echo ""
echo "[10] Session Fixation 취약점"
cat > /var/www/html/login_simple.php << 'EOF'
<?php
session_start();

if (isset($_POST['username']) && isset($_POST['password'])) {
    // 개발자 실수: 로그인 성공 후 session_regenerate_id() 안함
    if ($_POST['username'] == 'admin' && $_POST['password'] == 'admin123') {
        $_SESSION['user'] = 'admin';
        // 실수: 세션 ID를 새로 만들지 않음
        header('Location: dashboard.php');
    }
}
?>
EOF
echo "[+] login_simple.php 생성 (Session Fixation)"

echo ""
echo "=========================================="
echo "[+] 현실적인 취약점 생성 완료!"
echo "=========================================="
echo ""
echo "[!] 생성된 취약점 (진짜 개발자 실수):"
echo ""
echo "  1. /api/system.php?cmd=id"
echo "     → 파라미터명 오타 (command vs cmd)"
echo ""
echo "  2. /admin/tools.php?action=health_check&cmd=whoami"
echo "     → 조건문 순서 실수 (인증 우회)"
echo ""
echo "  3. /api/docs.json"
echo "     → API 문서 방치 (엔드포인트 노출)"
echo ""
echo "  4. /.git/"
echo "     → Git 디렉토리 노출"
echo ""
echo "  5. /.htaccess"
echo "     → 환경변수 노출"
echo ""
echo "[*] 간지나는 공격 시나리오:"
echo "  1. /api/docs.json 발견 (API 문서 발견)"
echo "  2. /api/system.php?cmd=id 발견 (파라미터 오타)"
echo "  3. Splunk 무력화"
echo "  4. 리버스 쉘"
echo "  5. 권한 상승"
